import{aO as T,aP as A,A as i,B as x,C as F,bv as M,Q as C,S as u,a6 as s,a5 as a,av as w,a3 as f,ad as m,aF as h,R as q,a4 as b,a8 as r,aD as U,aE as _,af as k,ab as $,ay as G,aS as H,ax as O}from"./index-Bl2lQPd7.js";import{Q as W}from"./QToolbarTitle-C8APieXG.js";import{Q as y}from"./QTooltip-r7WoEuzy.js";import{Q as j}from"./QToolbar-DR-_wX4W.js";import{Q as J}from"./QSpace-CKKoNTi_.js";import{Q as K}from"./QBanner-xBGiroIy.js";import{Q as X}from"./QBtnGroup-CdugIB7Z.js";import{Q as Y}from"./QSpinnerDots-BW9ZsFNG.js";import{C as E}from"./ClosePopup-BY_YGFBZ.js";const Z={key:1,class:"camera-controls qrscanner"},ee={key:0,class:"scan-status bg-transparent"},ae={key:2,class:"text-center q-mt-lg text-white qrscanner"},fe={__name:"StaffScan",emits:["staff-selected"],setup(se,{emit:B}){const z=B,d=T(),v=A(),l=i(""),o=i("error"),p=i(!1),g=i(!1),c=i(!1),Q=i(!1);x(()=>v.getters["user/current"].annee);const D=x(()=>v.getters["ecole/id"]),L=async()=>{await v.dispatch("ecole/getId")},V=n=>{let e="EP-"+D.value+"-PERS-";return n.startsWith(e)?n.substring(e.length):null};function I(){p.value=!p.value,p.value?QRScanner.useFrontCamera():QRScanner.useBackCamera()}function N(){g.value=!g.value,g.value?QRScanner.enableLight():QRScanner.disableLight()}function S(){QRScanner.destroy(()=>{}),c.value=!1,document.body.classList.remove("ecp-scanner")}async function P(){l.value="",d.platform.is.cordova&&(d.platform.is.ios&&QRScanner.prepare((n,e)=>{n&&(console.error(n),l.value="Erreur de préparation du scanner",o.value="error"),e.authorized||(l.value="Accès à la caméra non autorisé",o.value="error")}),QRScanner.scan(async(n,e)=>{if(c.value=!1,n){l.value="Erreur de scan: "+n._message,o.value="error",console.error(n._message);return}try{const t=V(e);if(console.log("staffId",t),isNaN(t)||!t)throw new Error("Code QR invalide");const R=await v.dispatch("user/getData",{page:1,filter:{id:t}});if(R.data?.data?.[0])z("staff-selected",R.data.data[0]),S();else throw new Error("Staff non trouvé")}catch(t){l.value=t.message||"Erreur lors de la lecture du code QR",o.value="error"}}),c.value=!0,document.body.classList.add("ecp-scanner"),QRScanner.show())}return F(async()=>{d.platform.is.cordova&&(await L(),P())}),M(()=>{d.platform.is.cordova&&S()}),(n,e)=>(u(),C(_,{class:"staff-scan-card"},{default:s(()=>[a(j,{class:"bg-primary text-white qrscanner"},{default:s(()=>[w(a(f,{flat:"",round:"",dense:"",icon:"arrow_back",class:"qrscanner"},null,512),[[E]]),a(W,{class:"qrscanner"},{default:s(()=>e[2]||(e[2]=[m("Scanner le code QR de l'Staff")])),_:1}),a(f,{flat:"",round:"",dense:"",icon:"help",onClick:e[0]||(e[0]=t=>Q.value=!0),class:"qrscanner"},{default:s(()=>[a(y,{class:"qrscanner"},{default:s(()=>e[3]||(e[3]=[m("Aide")])),_:1})]),_:1})]),_:1}),a(h,{class:"scanner-container qrscanner"},{default:s(()=>[a(U,{modelValue:Q.value,"onUpdate:modelValue":e[1]||(e[1]=t=>Q.value=t),class:"qrscanner"},{default:s(()=>[a(_,{style:{width:"300px"}},{default:s(()=>[a(h,{class:"row items-center qrscanner"},{default:s(()=>[e[4]||(e[4]=r("div",{class:"text-h6 qrscanner"},"Comment scanner ?",-1)),a(J,{class:"qrscanner"}),w(a(f,{icon:"close",flat:"",round:"",dense:"",class:"qrscanner"},null,512),[[E]])]),_:1}),a(h,{class:"q-pt-none qrscanner"},{default:s(()=>e[5]||(e[5]=[r("ol",{class:"text-body1 qrscanner"},[r("li",{class:"q-mb-sm qrscanner"},"Assurez-vous que le code QR est bien visible"),r("li",{class:"q-mb-sm qrscanner"},"Centrez le code QR dans le cadre"),r("li",{class:"q-mb-sm qrscanner"},"Maintenez votre appareil stable"),r("li",{class:"qrscanner"},"Le scan se fera automatiquement")],-1)])),_:1})]),_:1})]),_:1},8,["modelValue"]),l.value?(u(),C(K,{key:0,class:k([o.value==="error"?"bg-negative":"bg-positive","text-white banner-animation qrscanner"]),rounded:""},{avatar:s(()=>[a(G,{name:o.value==="error"?"error":"check_circle",class:"qrscanner"},null,8,["name"])]),default:s(()=>[m(" "+$(l.value),1)]),_:1},8,["class"])):q("",!0),H(d).platform.is.cordova?(u(),b("div",Z,[a(X,{rounded:"",class:"bg-dark"},{default:s(()=>[a(f,{flat:"",color:p.value?"primary":"grey-7",icon:"camera_front",onClick:I,class:"qrscanner"},{default:s(()=>[a(y,{class:"qrscanner"},{default:s(()=>e[6]||(e[6]=[m("Changer de caméra")])),_:1})]),_:1},8,["color"]),a(O,{vertical:"",class:""}),a(f,{flat:"",color:g.value?"primary":"grey-7",icon:"flashlight_on",onClick:N,class:"qrscanner"},{default:s(()=>[a(y,{class:"qrscanner"},{default:s(()=>e[7]||(e[7]=[m("Activer/Désactiver la lampe")])),_:1})]),_:1},8,["color"])]),_:1})])):q("",!0),r("div",{class:k(["scanner-area qrscanner",{"hide-scanner":!c.value}])},[e[9]||(e[9]=r("div",{class:"scan-region qrscanner"},[r("div",{class:"scan-region-highlight qrscanner"},[r("div",{class:"corner-highlight top-left qrscanner"}),r("div",{class:"corner-highlight top-right qrscanner"}),r("div",{class:"corner-highlight bottom-left qrscanner"}),r("div",{class:"corner-highlight bottom-right qrscanner"}),r("div",{class:"scanning-line qrscanner"})])],-1)),c.value?(u(),b("div",ee,[a(Y,{color:"primary",size:"40px",class:"qrscanner"}),e[8]||(e[8]=r("div",{class:"text-subtitle1 text-grey-8 q-mt-sm qrscanner"},"Recherche de code QR...",-1))])):q("",!0)],2),c.value?q("",!0):(u(),b("div",ae,e[10]||(e[10]=[r("div",{class:"text-subtitle1"},"Placez le code QR dans le cadre",-1),r("div",{class:"text-caption"},"Le scan démarrera automatiquement",-1)])))]),_:1})]),_:1}))}};export{fe as _};
