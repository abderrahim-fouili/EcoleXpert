import{_ as oe,d8 as le,aP as se,aO as re,A as f,B as p,C as ne,Y,Q as k,S as c,a6 as a,a8 as s,a5 as o,a4 as y,aE as C,aF as L,ad as _,ab as m,ay as v,a2 as F,av as N,a3 as x,b7 as ie,a9 as ce,aa as de,ac as me,R as ue,aC as pe,N as I}from"./index-Bl2lQPd7.js";import{Q as fe,a as ye}from"./QItem-De3v03wU.js";import{Q as _e}from"./QSelect-DchnWyXK.js";import{Q as z}from"./QDate-C_jC-zMt.js";import{Q as B}from"./QPopupProxy-CQ30ymZI.js";import{Q as ve}from"./QBanner-xBGiroIy.js";import{Q as P}from"./QChip-C9OfA2gn.js";import{Q as g}from"./QTd-CpEgdqvP.js";import{Q as ge}from"./QTable-D-OlObRI.js";import{C as E}from"./ClosePopup-BY_YGFBZ.js";import{q as h}from"./date-C1Mon-Jj.js";import{u as be}from"./composables-CAkrP3jA.js";import"./QItemLabel-BkJiB6aE.js";import"./QMenu-BNr9Tzvf.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./rtl-DFPa-2ov.js";import"./format-IcNrutKL.js";import"./use-render-cache-DLxPkVnQ.js";import"./use-datetime-hbLWgGn4.js";import"./QVirtualScroll-CENgsPEr.js";import"./QList-CMzNTEGD.js";import"./QLinearProgress-DW1NPbfx.js";const he={class:"row q-col-gutter-md items-end"},ke={class:"col-12 col-md-4"},xe={class:"col-12 col-md-3"},we={class:"row items-center justify-end q-mt-sm"},De={class:"col-12 col-md-3"},Se={class:"row items-center justify-end q-mt-sm"},Te={class:"col-12 col-md-2"},Me={key:0,class:"text-center q-my-xl"},Ce={key:2,class:"q-my-lg"},Pe={key:3},Ve={class:"row q-col-gutter-lg q-mb-xl"},Qe={class:"row items-center no-wrap"},qe={class:"col"},Ae={class:"text-caption opacity-80"},Re={class:"text-h5 text-weight-bold"},Ye={key:0,class:"text-subtitle2 opacity-90"},Le={class:"col-auto"},Fe={key:4,class:"text-center text-primary-7 q-my-xl"},Ne="#8FA1B3",Ie={__name:"StaffTicketManagementPage",setup(ze){const{lighten:w,getPaletteColor:V,changeAlpha:Q}=le,q=V("primary")||"#113e7f",D=V("secondary")||"#85b9e8",r=se(),O=re(),{setTitle:U,showFooter:j}=be(),d=f(null),$=h.subtractFromDate(Date.now(),{days:30}),n=f(h.formatDate($,"YYYY-MM-DD")),u=f(h.formatDate(Date.now(),"YYYY-MM-DD")),S=f(""),T=p(()=>r.getters["canteenStaffTicketManagement/staffList"]),G=p(()=>r.getters["canteenStaffTicketManagement/isLoadingStaffList"]),i=p(()=>r.getters["canteenStaffTicketManagement/ticketReportData"]),M=p(()=>r.getters["canteenStaffTicketManagement/isLoadingReport"]),A=p(()=>r.getters["canteenStaffTicketManagement/reportError"]),H=p(()=>r.getters["user/current"]?.annee),R=f([]),J=(l,t,e)=>{S.value=l,r.dispatch("canteenStaffTicketManagement/fetchStaffList",{searchTerm:l}).then(()=>{t(()=>{R.value=T.value})}).catch(()=>{e()})},K=p(()=>{if(!d.value||!T.value)return"N/A";const l=T.value.find(t=>t.idpers===d.value);return l?l.nom_complet:"N/A"}),W=()=>{if(!d.value||!n.value||!u.value){I.create({type:"warning",message:"Veuillez sélectionner tous les champs."});return}if(h.getDateDiff(u.value,n.value,"days")<0){I.create({type:"negative",message:"La date de fin ne peut pas être antérieure à la date de début."});return}r.dispatch("canteenStaffTicketManagement/fetchStaffTicketReport",{staffId:d.value,startDate:n.value,endDate:u.value})},X=l=>{O.dialog({title:"Confirmer Paiement",message:"Voulez-vous vraiment marquer ce ticket comme payé ?",cancel:!0,persistent:!0,ok:{label:"Oui, Marquer Payé",color:"secondary",textColor:"primary",unelevated:!0},cancel:{label:"Annuler",color:"grey-7",flat:!0}}).onOk(()=>{r.dispatch("canteenStaffTicketManagement/markTicketAsPaid",{staffTicketId:l,currentReportParams:{staffId:d.value,startDate:n.value,endDate:u.value}})})},b=l=>l==null||isNaN(l)?"0.00 MAD":new Intl.NumberFormat("fr-MA",{style:"currency",currency:"MAD",minimumFractionDigits:2}).format(l),Z=p(()=>{if(!i.value||!i.value.summary)return[];const l=i.value.summary,t=l.total_paid_value-l.total_reserved_value;return[{title:"Total Réservé",value:l.total_reserved_count,subValue:b(l.total_reserved_value),icon:"sym_o_bookmarks",bgColor:Ne},{title:"Total Payé",value:l.total_paid_count,subValue:b(l.total_paid_value),icon:"sym_o_price_check",bgColor:Q(q,.8)},{title:"Total Impayé",value:l.total_unpaid_count,subValue:b(l.total_unpaid_value),icon:"sym_o_hourglass_empty",bgColor:w(D,5)},{title:"Solde Personnel",value:b(Math.abs(t)),subValue:t<0?"Montant Dû":t>0?"Crédit":"Réglé",icon:"sym_o_account_balance_wallet",bgColor:t<0?Q(D,.9):t>0?w(D,10):w(q,-25)}]}),ee=f([{name:"program_date",label:"Date Prog.",field:"program_date",align:"left",sortable:!0,style:"width: 120px"},{name:"program_description",label:"Description Programme",field:"program_description",align:"left",style:"min-width: 200px; max-width: 300px; white-space: normal;"},{name:"tarif",label:"Tarif",field:"tarif",align:"right",sortable:!0,style:"width: 100px"},{name:"payed",label:"Statut",field:"payed",align:"center",sortable:!0,style:"width: 120px"},{name:"created_at",label:"Réservé le",field:"created_at",align:"center",sortable:!0,style:"width: 150px"},{name:"actions",label:"Actions",field:"actions",align:"center",style:"width: 150px"}]),te=f({sortBy:"program_date",descending:!0,rowsPerPage:10}),ae=l=>!n.value||h.getDateDiff(l,n.value,"days")>=0;return ne(()=>{U("Gestion Tickets Cantine Personnel"),j(!1),r.dispatch("canteenStaffTicketManagement/fetchStaffList")}),Y(H,(l,t)=>{l&&t&&l.idannee!==t.idannee?(d.value=null,r.commit("canteenStaffTicketManagement/CLEAR_REPORT_DATA"),r.dispatch("canteenStaffTicketManagement/fetchStaffList")):l&&!t&&r.dispatch("canteenStaffTicketManagement/fetchStaffList")}),Y(d,()=>{r.commit("canteenStaffTicketManagement/CLEAR_REPORT_DATA")}),(l,t)=>(c(),k(pe,{padding:"",class:"staff-ticket-management-page"},{default:a(()=>[t[9]||(t[9]=s("div",{class:"text-h5 q-mb-md text-primary text-weight-medium"},"Gestion des Tickets Cantine du Personnel",-1)),o(C,{flat:"",bordered:"",class:"filter-card q-mb-lg shadow-2"},{default:a(()=>[o(L,{class:"q-pa-md"},{default:a(()=>[s("div",he,[s("div",ke,[o(_e,{filled:"",dense:"",modelValue:d.value,"onUpdate:modelValue":t[0]||(t[0]=e=>d.value=e),options:R.value,label:"Sélectionner un membre du personnel","use-input":"","hide-selected":"","fill-input":"","input-debounce":"300",onFilter:J,loading:G.value,"option-value":"idpers","option-label":"nom_complet","emit-value":"","map-options":"",clearable:"",standout:"bg-primary-1 text-primary-10","label-color":"primary-8"},{prepend:a(()=>[o(v,{name:"sym_o_person_search",color:"primary"})]),"no-option":a(()=>[o(fe,null,{default:a(()=>[o(ye,{class:"text-grey-7"},{default:a(()=>[_(" Aucun personnel trouvé"+m(S.value?` pour "${S.value}"`:"")+". ",1)]),_:1})]),_:1})]),_:1},8,["modelValue","options","loading"])]),s("div",xe,[o(F,{dense:"",filled:"",modelValue:n.value,"onUpdate:modelValue":t[2]||(t[2]=e=>n.value=e),label:"Date de début",mask:"####-##-##",clearable:"",standout:"bg-primary-1 text-primary-10","label-color":"primary-8"},{prepend:a(()=>[o(v,{name:"sym_o_event",class:"cursor-pointer",color:"primary"},{default:a(()=>[o(B,{cover:"","transition-show":"scale","transition-hide":"scale"},{default:a(()=>[o(z,{modelValue:n.value,"onUpdate:modelValue":t[1]||(t[1]=e=>n.value=e),mask:"YYYY-MM-DD",minimal:"",color:"primary"},{default:a(()=>[s("div",we,[N(o(x,{label:"Fermer",color:"primary",flat:""},null,512),[[E]])])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),s("div",De,[o(F,{dense:"",filled:"",modelValue:u.value,"onUpdate:modelValue":t[4]||(t[4]=e=>u.value=e),label:"Date de fin",mask:"####-##-##",clearable:"",standout:"bg-primary-1 text-primary-10","label-color":"primary-8"},{prepend:a(()=>[o(v,{name:"sym_o_event",class:"cursor-pointer",color:"primary"},{default:a(()=>[o(B,{cover:"","transition-show":"scale","transition-hide":"scale"},{default:a(()=>[o(z,{modelValue:u.value,"onUpdate:modelValue":t[3]||(t[3]=e=>u.value=e),mask:"YYYY-MM-DD",minimal:"",options:ae,color:"primary"},{default:a(()=>[s("div",Se,[N(o(x,{label:"Fermer",color:"primary",flat:""},null,512),[[E]])])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),s("div",Te,[o(x,{label:"Afficher",color:"primary","text-color":"white",onClick:W,icon:"sym_o_analytics",loading:M.value,disable:!d.value||!n.value||!u.value||M.value,class:"full-width",unelevated:"",rounded:""},null,8,["loading","disable"])])])]),_:1})]),_:1}),M.value?(c(),y("div",Me,[o(ie,{color:"primary",size:"3.5em"}),t[5]||(t[5]=s("div",{class:"q-mt-md text-primary-8"},"Chargement du rapport...",-1))])):A.value?(c(),k(ve,{key:1,"inline-actions":"",class:"text-white bg-negative q-mb-lg rounded-borders shadow-2"},{avatar:a(()=>[o(v,{name:"sym_o_error"})]),default:a(()=>[s("div",null,[t[6]||(t[6]=s("strong",null,"Erreur:",-1)),_(" "+m(A.value),1)])]),_:1})):i.value&&i.value.message&&(!i.value.tickets||i.value.tickets.length===0)?(c(),y("div",Ce,[o(P,{outline:"",color:"secondary","text-color":"secondary-10",icon:"sym_o_info",class:"q-pa-md text-body1"},{default:a(()=>[_(m(i.value.message),1)]),_:1})])):i.value&&i.value.summary?(c(),y("div",Pe,[s("div",Ve,[(c(!0),y(ce,null,de(Z.value,e=>(c(),y("div",{class:"col-12 col-sm-6 col-md-3",key:e.title},[o(C,{class:"summary-card full-height shadow-3 text-white",style:me({backgroundColor:e.bgColor})},{default:a(()=>[o(L,null,{default:a(()=>[s("div",Qe,[s("div",qe,[s("div",Ae,m(e.title),1),s("div",Re,m(e.value),1),e.subValue?(c(),y("div",Ye,m(e.subValue),1)):ue("",!0)]),s("div",Le,[o(v,{name:e.icon,size:"2.8em",class:"opacity-50"},null,8,["name"])])])]),_:2},1024)]),_:2},1032,["style"])]))),128))]),o(C,{flat:"",bordered:"",class:"shadow-2 table-card"},{default:a(()=>[o(ge,{title:`Détail des Tickets pour ${K.value}`,rows:i.value.tickets,columns:ee.value,"row-key":"id",flat:"",pagination:te.value,"no-data-label":"Aucun ticket trouvé pour cette sélection.",class:"q-table-sticky-header","title-class":"text-primary text-h6"},{"body-cell-actions":a(e=>[o(g,{props:e},{default:a(()=>[e.row.payed?(c(),k(P,{key:1,dense:"",square:"",color:"secondary-1","text-color":"secondary-10",icon:"sym_o_check_circle",label:"Payé",size:"sm",class:"status-chip"})):(c(),k(x,{key:0,label:"Marquer Payé",color:"secondary","text-color":"primary",size:"sm",onClick:Be=>X(e.row.id),dense:"",unelevated:"",rounded:"",icon:"sym_o_price_check"},null,8,["onClick"]))]),_:2},1032,["props"])]),"body-cell-tarif":a(e=>[o(g,{props:e,class:"text-right text-primary-10"},{default:a(()=>[_(m(b(e.row.tarif)),1)]),_:2},1032,["props"])]),"body-cell-payed":a(e=>[o(g,{props:e,class:"text-center"},{default:a(()=>[o(P,{dense:"",square:"",color:e.row.payed?"secondary-1":"warning-light-bg","text-color":e.row.payed?"secondary-10":"warning-dark-text",icon:e.row.payed?"sym_o_check_circle":"sym_o_warning",label:e.row.payed?"Payé":"Impayé",size:"sm",class:"status-chip"},null,8,["color","text-color","icon","label"])]),_:2},1032,["props"])]),"body-cell-program_description":a(e=>[o(g,{props:e,style:{"white-space":"normal","min-width":"200px"},class:"text-primary-9"},{default:a(()=>[_(m(e.row.program_description),1)]),_:2},1032,["props"])]),"body-cell-program_date":a(e=>[o(g,{props:e,class:"text-primary-9"},{default:a(()=>[_(m(e.row.program_date),1)]),_:2},1032,["props"])]),"body-cell-created_at":a(e=>[o(g,{props:e,class:"text-primary-9"},{default:a(()=>[_(m(e.row.created_at),1)]),_:2},1032,["props"])]),_:1},8,["title","rows","columns","pagination"])]),_:1})])):(c(),y("div",Fe,[o(v,{name:"sym_o_receipt_long",size:"4em",class:"q-mb-sm opacity-40"}),t[7]||(t[7]=s("div",{class:"text-h6"},"Veuillez sélectionner un membre du personnel et une période.",-1)),t[8]||(t[8]=s("div",{class:"text-body1 opacity-70"},"Les détails des tickets s'afficheront ici.",-1))]))]),_:1}))}},mt=oe(Ie,[["__scopeId","data-v-09466a8e"]]);export{mt as default};
