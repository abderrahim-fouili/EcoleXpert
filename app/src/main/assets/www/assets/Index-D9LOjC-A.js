import{_ as q,ar as j,b4 as P,as as N,at as A,aB as S,aY as T,b5 as Y,aW as I,J as x,Q as c,S as m,a6 as l,a5 as t,av as v,a3 as o,ad as f,ab as p,b6 as B,aF as O,a8 as d,a7 as z,a2 as g,ay as w,R as h,b7 as E,aG as J,aE as L,ag as _,a4 as R,aD as G,aC as W,a9 as H,b3 as Q}from"./index-Bl2lQPd7.js";import{Q as K}from"./QToolbarTitle-C8APieXG.js";import{Q as X}from"./QBadge-Bjfo5tRO.js";import{Q as Z}from"./QToolbar-DR-_wX4W.js";import{Q as ee}from"./QImg-BMvxJu3S.js";import{Q as te,a as k}from"./QItem-De3v03wU.js";import{Q as C}from"./QDate-C_jC-zMt.js";import{Q as V}from"./QPopupProxy-CQ30ymZI.js";import{Q as b}from"./QTooltip-r7WoEuzy.js";import{Q as se}from"./QUploaderAddTrigger-OZIUWg9a.js";import{Q as le}from"./QUploader-Dwk8_y__.js";import{Q as re}from"./QForm-Dk45GsL9.js";import{C as y}from"./ClosePopup-BY_YGFBZ.js";import{g as U}from"./index-CCBxiyaS.js";import{f as D}from"./index-C9ZTL5MN.js";import"./use-render-cache-DLxPkVnQ.js";import"./use-datetime-hbLWgGn4.js";import"./date-C1Mon-Jj.js";import"./format-IcNrutKL.js";import"./QMenu-BNr9Tzvf.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./QCircularProgress-C_b7NmsY.js";import"./index-BXMW6yyY.js";import"./index-CbPSoDvq.js";const ae={data(){return{cfiles:0,step:null,steps:[],options:[]}},props:{title:{default:()=>"Nouveau absence"}},computed:{...A({user:"user/user",config:"user/config",current:"user/current",form:"absence/form"}),eleve(){if(this.current&&this.current.hasOwnProperty("eleve"))return this.current.eleve},annee(){if(this.current&&this.current.hasOwnProperty("annee"))return this.current.annee},headers(){return[{name:"Authorization",value:x.defaults.headers.common.Authorization}]},url(){return I("api")+"/absences/pj"}},methods:{...N({create:"absence/create",update:"absence/update"}),isDate:P,openURL:j,isImage(e){return Y(this.fileUrl(e))},fileUrl(e){return T(e)},personAvatar(e){return S(e)},added(e){this.cfiles=e.length},removed(e){this.cfiles-=e.length},attach(){this.$nextTick(()=>{this.$refs.uploader.pickFiles()})},send(){this.$refs.form.validate().then(e=>{if(!e)return this.$q.notify({color:"negative",message:this.$t("stats.fields"),position:"bottom",icon:"error_outline",actions:[{label:this.$q.lang.label.close,color:"yellow"}]}),!1;this.cfiles>0?this.$refs.uploader.upload():this.sendMessage()})},sendMessage(e){let s=[],n=this.form;e&&(s=JSON.parse(e.xhr.response).result),this.form.personne_id=this.eleve.idpers;let u={files:s,...n};u.au=U(new Date(u.au))/1e3,u.du=U(new Date(u.du))/1e3,this.form.id?this.update(u).then(i=>{this.$emit("notif:sent",i)}).catch(i=>{this.$q.notify({color:"negative",message:this.$t("stats.fields"),position:"bottom",icon:"error_outline",actions:[{label:this.$q.lang.label.close,color:"yellow"}]}),this.$emit("notif:error",i)}):this.create(u).then(i=>{this.$emit("notif:sent",i)}).catch(i=>{this.$q.notify({color:"negative",message:this.$t("stats.fields"),position:"bottom",icon:"error_outline",actions:[{label:this.$q.lang.label.close,color:"yellow"}]}),this.$emit("absence:error",i)})},choice(e){this.step=e.value.step,this.$nextTick(()=>{if(this.form.destinataire=this.destinataire.map(n=>n.value.idpers?{type:"personne",id:n.value.idpers,value:"personne_"+n.value.idpers,label:n.label}:n),this.step!=="personnes"&&e.value.value)this.destinataire=null,this.setOptions(),this.$refs.dest.refresh(),this.steps.push(e.value);else if(e.value.value===0)for(var s=0;s<this.steps.length;s++)this.steps[s].step===e.value.step&&delete this.steps[s]})},clear(){this.destinataire=null,this.step=null,this.steps=[],this.setOptions()},hasDiscs(e){return e.value.disciplines&&e.value.disciplines.length},discs(e){return e.value.disciplines[0].description}},mounted(){}},ie={class:"row items-center justify-end"},oe={class:"row items-center justify-end"},ne={class:"row"},ue={class:"col-xs-12"},de={class:"row no-wrap items-center q-pa-sm q-gutter-xs",style:{}},fe={class:"col"},me={class:"q-uploader__subtitle"};function ce(e,s,n,u,i,a){return m(),c(L,null,{default:l(()=>[t(Z,{class:"bg-secondary text-white shadow-2"},{default:l(()=>[v(t(o,{flat:"",dense:"",icon:"arrow_back"},null,512),[[y]]),t(K,null,{default:l(()=>[f(p(n.title),1)]),_:1}),t(o,{flat:"",dense:"",icon:"attach_file",onClick:a.attach},{default:l(()=>[v(t(X,{floating:"",color:"yellow-9"},{default:l(()=>[f(p(i.cfiles),1)]),_:1},512),[[B,i.cfiles>0]])]),_:1},8,["onClick"]),t(o,{class:"q-ml-lg",flat:"",icon:"send",onClick:a.send},null,8,["onClick"])]),_:1}),t(O,{style:{"overflow-y":"scroll"}},{default:l(()=>[t(re,{class:"q-gutter-lg",ref:"form"},{default:l(()=>[t(te,null,{default:l(()=>[t(k,{avatar:""},{default:l(()=>[t(z,null,{default:l(()=>[t(ee,{src:a.personAvatar(a.eleve)},null,8,["src"])]),_:1})]),_:1}),t(k,null,{default:l(()=>[f(p(a.eleve.nom)+" "+p(a.eleve.prenom),1)]),_:1})]),_:1}),t(g,{label:"Du",filled:"",modelValue:e.form.du,"onUpdate:modelValue":s[2]||(s[2]=r=>e.form.du=r),mask:"####-##-##",rules:[a.isDate]},{append:l(()=>[t(w,{name:"event",class:"cursor-pointer"},{default:l(()=>[t(V,{ref:"du",cover:"","transition-show":"scale","transition-hide":"scale"},{default:l(()=>[t(C,{minimal:"",modelValue:e.form.du,"onUpdate:modelValue":[s[0]||(s[0]=r=>e.form.du=r),s[1]||(s[1]=r=>e.$refs.du.hide())],mask:"YYYY-MM-DD"},{default:l(()=>[d("div",ie,[v(t(o,{label:"Fermer",color:"primary",flat:""},null,512),[[y]])])]),_:1},8,["modelValue"])]),_:1},512)]),_:1})]),_:1},8,["modelValue","rules"]),t(g,{label:"Au",filled:"",modelValue:e.form.au,"onUpdate:modelValue":s[5]||(s[5]=r=>e.form.au=r),mask:"####-##-##",rules:[a.isDate]},{append:l(()=>[t(w,{name:"event",class:"cursor-pointer"},{default:l(()=>[t(V,{ref:"au",cover:"","transition-show":"scale","transition-hide":"scale"},{default:l(()=>[t(C,{minimal:"",modelValue:e.form.au,"onUpdate:modelValue":[s[3]||(s[3]=r=>e.form.au=r),s[4]||(s[4]=r=>e.$refs.au.hide())],mask:"YYYY-MM-DD"},{default:l(()=>[d("div",oe,[v(t(o,{label:"Fermer",color:"primary",flat:""},null,512),[[y]])])]),_:1},8,["modelValue"])]),_:1},512)]),_:1})]),_:1},8,["modelValue","rules"]),t(g,{filled:"",modelValue:e.form.motif,"onUpdate:modelValue":s[6]||(s[6]=r=>e.form.motif=r),autogrow:"",type:"textarea",label:"Motif",rules:[r=>!!r||"Champ requis"],"lazy-rules":"","input-style":"min-height:150px"},null,8,["modelValue","rules"]),d("div",ne,[d("div",ue,[t(le,{"field-name":r=>"pieces_jointe[]",style:{width:"100%"},url:a.url,flat:"",multiple:"",headers:a.headers,ref:"uploader",batch:"",onAdded:a.added,onRemoved:a.removed,onUploaded:a.sendMessage},{header:l(r=>[d("div",de,[r.queuedFiles.length>0?(m(),c(o,{key:0,icon:"clear_all",onClick:r.removeQueuedFiles,round:"",dense:"",flat:""},{default:l(()=>[t(b,null,{default:l(()=>s[7]||(s[7]=[f("Supprimer tous")])),_:1})]),_:2},1032,["onClick"])):h("",!0),r.uploadedFiles.length>0?(m(),c(o,{key:1,icon:"done_all",onClick:r.removeUploadedFiles,round:"",dense:"",flat:""},{default:l(()=>[t(b,null,{default:l(()=>s[8]||(s[8]=[f("Supprimer")])),_:1})]),_:2},1032,["onClick"])):h("",!0),r.isUploading?(m(),c(E,{key:2,class:"q-uploader__spinner"})):h("",!0),d("div",fe,[s[9]||(s[9]=d("div",{class:"q-uploader__title"},"Justificatif",-1)),d("div",me,p(r.uploadSizeLabel)+" / "+p(r.uploadProgressLabel),1)]),r.canAddFiles?(m(),c(o,{key:3,type:"a",icon:"add_box",round:"",dense:"",flat:""},{default:l(()=>[t(se),t(b,null,{default:l(()=>s[10]||(s[10]=[f("Ajouter des fichiers")])),_:1})]),_:1})):h("",!0),r.isUploading?(m(),c(o,{key:4,icon:"clear",onClick:r.abort,round:"",dense:"",flat:""},{default:l(()=>[t(b,null,{default:l(()=>s[11]||(s[11]=[f("Annuler")])),_:1})]),_:2},1032,["onClick"])):h("",!0)])]),_:1},8,["url","headers","onAdded","onRemoved","onUploaded"])])])]),_:1},512)]),_:1}),t(J,{align:"right",class:""},{default:l(()=>[t(o,{label:"Envoyer",icon:"send",onClick:a.send},null,8,["onClick"])]),_:1})]),_:1})}const pe=q(ae,[["render",ce]]),he={data(){return{show:!1,title:"Notifier une absence"}},components:{Notifier:pe},computed:{...A({user:"user/user",config:"user/config",current:"user/current",form:"absence/form"}),eleve(){if(this.current&&this.current.hasOwnProperty("eleve"))return this.current.eleve},annee(){if(this.current&&this.current.hasOwnProperty("annee"))return this.current.annee}},methods:{...N({resetForm:"absence/resetForm",getNotifs:"absence/getNotifs"}),notifEnvoye(){this.getNotifs({page:1,filter:{eleve_id:this.eleve.idpers}}),this.show=!1,this.$q.notify({color:"positive",message:this.$t("stats.success"),position:"bottom",icon:"check",actions:[{label:this.$q.lang.label.close,color:"white"}]})},showDialog(){this.show=!0,this.title="Notifier une absence",this.form.du=null,this.form.au=null,this.form.motif=null},justifier(e){this.form.motif=null,this.form.du=D(Q(e.abs.date_absence),"yyyy-MM-dd"),this.form.au=D(Q(e.abs.date_absence),"yyyy-MM-dd"),this.title=e.title?e.title:this.title,this.show=!0},edit(e){this.title=e.title?e.title:this.title,this.show=!0}},mounted(){}};function ve(e,s,n,u,i,a){const r=_("router-view"),F=_("notifier"),M=_("ep-footer");return m(),R(H,null,[t(W,{padding:"",class:"page-content"},{default:l(()=>[t(r,{"onAbs:justifier":a.justifier,"onNotif:edit":a.edit},null,8,["onAbs:justifier","onNotif:edit"]),t(G,{modelValue:i.show,"onUpdate:modelValue":s[0]||(s[0]=$=>i.show=$),maximized:"",position:"bottom"},{default:l(()=>[t(F,{"onNotif:sent":a.notifEnvoye,title:i.title},null,8,["onNotif:sent","title"])]),_:1},8,["modelValue"])]),_:1}),t(M,{to:"#footer-portal"},{default:l(()=>[t(o,{flat:"",onClick:a.showDialog,icon:"icon_absences_prevue",label:"Notifier une absence"},null,8,["onClick"])]),_:1})],64)}const Oe=q(he,[["render",ve]]);export{Oe as default};
