import{aP as at,aO as ot,A as $,B as J,C as nt,bv as lt,Y as ne,aR as X,Q as i,S as o,a6 as n,a8 as K,a5 as r,R as d,a4 as h,ad as f,b7 as Te,ab as L,a3 as P,ay as A,a9 as S,aa as fe,aF as me,ax as ge,a7 as Ce,aD as st,aE as rt,av as it,aC as ut,aB as qe,b8 as Oe}from"./index-Bl2lQPd7.js";import{Q as Pe}from"./QBanner-xBGiroIy.js";import{Q as W}from"./QChip-C9OfA2gn.js";import{Q as Z}from"./QItemLabel-BkJiB6aE.js";import{Q as le,a as F}from"./QItem-De3v03wU.js";import{Q as G}from"./QBadge-Bjfo5tRO.js";import{Q as ct}from"./QExpansionItem-EMhshZ_3.js";import{Q as Fe}from"./QList-CMzNTEGD.js";import{Q as dt}from"./QToolbarTitle-C8APieXG.js";import{Q as vt}from"./QToolbar-DR-_wX4W.js";import{C as pt}from"./ClosePopup-BY_YGFBZ.js";import{L as T}from"./leaflet-src-BmGqNqGH.js";import"./QSlideTransition-CrdUnXBf.js";import"./_commonjsHelpers-D6-XlEtG.js";const ft={style:{padding:"0"}},mt={class:"map-container q-pa-sm"},gt={key:0,class:"map-status-panel"},yt={key:0,class:"q-gutter-sm row justify-center"},bt={key:1,class:"q-gutter-sm row justify-center"},ht=["src"],kt={class:"q-mb-sm"},wt={key:0,class:"q-gutter-xs"},_t={key:1,style:{"padding-top":"10px"}},Ct={key:4,class:"q-pa-md text-center text-grey"},Pt=["src"],Lt={key:0,class:"q-gutter-sm row justify-center"},Et={key:1,class:"q-gutter-sm row justify-center items-center"},$t=["src"],zt={__name:"Index",setup(St){const D=at(),v=ot(),ye=v.platform.is.cordova,se=$(!1),c=$(null),q=$(null),te=$(null),Le=$(["","Aller","Retour","Aller-Retour"]),k=$(!1),m=$(!1),E=$(""),z=$({}),b=$({}),O=$({}),I=$({}),w=$({}),ae=$({}),oe=$(!1),B=$(null),Q=$(null),Ee=$(null),g=J(()=>D.state.transport.activeTrip),_=J(()=>D.state.transport.data),H=J(()=>D.getters["transport/isTripInProgress"]),Me=J(()=>D.getters["transport/allStudentsAreProcessed"]),U=J(()=>D.getters["ecole-geo/geoData"]),Be=J(()=>{const e=new Map,t=g.value?.idauto;if(t&&_.value?.autos){const a=_.value.autos.find(l=>l.idauto===t);a&&a.secteur&&a.secteur.forEach(l=>{l.eleve&&l.eleve.forEach(s=>{e.set(s.idpers,s)})})}return e}),$e=e=>J(()=>w.value[e]&&Object.keys(w.value[e]).length>0),C=e=>D.getters["transport/getStudentStatus"](e),M=e=>D.getters["transport/hasActiveTripForAuto"](e),Ue=()=>D.dispatch("transport/loadActiveTrip"),be=()=>D.dispatch("transport/getData"),Re=e=>D.dispatch("transport/startTrip",e),je=e=>D.dispatch("transport/recordEvent",e),Ne=e=>D.dispatch("transport/endTrip",e),Se=()=>D.dispatch("ecole-geo/fetchGeoData"),re=()=>new Promise((e,t)=>{k.value=!0;const a=u=>{k.value=!1;const p={latitude:u.coords.latitude,longitude:u.coords.longitude,accuracy:u.coords.accuracy};console.log("Location fetched:",p),e(p)},l=u=>{k.value=!1,console.error("Geolocation Error:",u);let p="Impossible d'obtenir la localisation.";u.code===u.PERMISSION_DENIED?p="Permission de localisation refusée.":u.code===u.POSITION_UNAVAILABLE?p="Localisation non disponible.":u.code===u.TIMEOUT&&(p="Timeout de localisation dépassé."),v.notify({type:"negative",message:p}),t(new Error(p))},s={enableHighAccuracy:!0,timeout:15e3,maximumAge:6e4};window.cordova&&navigator.geolocation?(console.log("Using Cordova Geolocation"),navigator.geolocation.getCurrentPosition(a,l,s)):"geolocation"in navigator?(console.log("Using Web Geolocation"),navigator.geolocation.getCurrentPosition(a,l,s)):(k.value=!1,console.warn("Geolocation not available."),v.notify({type:"warning",message:"Service de localisation non disponible."}),t(new Error("Geolocation not available")))}),ze=()=>T.divIcon({html:'<i class="material-icons" style="color: #0277BD; font-size: 36px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">directions_bus</i>',className:"custom-div-icon",iconSize:[36,36],iconAnchor:[18,36]}),Qe=()=>T.divIcon({html:'<i class="material-icons" style="color: #32D305; font-size: 36px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">school</i>',className:"custom-div-icon",iconSize:[36,36],iconAnchor:[18,18]}),ee=e=>{const t=z.value[e];if(!t){console.warn(`Map container not found for auto ${e} during init.`),X(()=>{z.value[e]&&!b.value[e]&&(console.log(`Retrying map init for ${e}`),ee(e))});return}if(b.value[e]){console.log(`Map already initialized for auto ${e}.`),X(()=>b.value[e].invalidateSize());return}const a=U.value&&typeof parseFloat(U.value.latitude)=="number"&&typeof parseFloat(U.value.longitude)=="number",l=a?[U.value.latitude,U.value.longitude]:[31.7917,-7.0926],s=a?14:5;console.log(`Initializing map for auto ${e} with center: ${l}`);try{const u=T.map(t,{zoomControl:!1,attributionControl:!1}).setView(l,s);T.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',subdomains:"abcd",maxZoom:20}).addTo(u),T.control.zoom({position:"topright"}).addTo(u),T.control.scale({imperial:!1,position:"bottomleft"}).addTo(u),b.value[e]=u,a?xe(e):console.warn(`School location is invalid or missing for auto ${e}. School marker not added.`),w.value[e]={},console.log(`Map initialized successfully for auto ${e}`)}catch(u){console.error(`Error initializing map for auto ${e}:`,u),v.notify({type:"negative",message:`Erreur initialisation carte pour véhicule ${e}.`})}},xe=e=>{const t=b.value[e],a=U.value;if(!t)return;if(!a||typeof parseFloat(a.latitude)!="number"||typeof parseFloat(a.longitude)!="number"){I.value[e]&&(I.value[e].remove(),delete I.value[e]);return}const l=[a.latitude,a.longitude];I.value[e]?I.value[e].setLatLng(l):I.value[e]=T.marker(l,{icon:Qe(),alt:"École"}).addTo(t).bindPopup("École")},ie=(e,t,a)=>{const l=b.value[e];if(!l||typeof t!="number"||typeof a!="number")return;const s=[t,a];ae.value[e]={lat:t,lng:a},O.value[e]?O.value[e].setLatLng(s):O.value[e]=T.marker(s,{icon:ze(),alt:"Bus"}).addTo(l).bindPopup("Position Actuelle"),Q.value||ue(e)},ue=e=>{const t=b.value[e];if(!t)return;if(Q.value){console.log("Skipping fitMapBounds because selectedStudentLine is active.");return}const a=[];if(I.value[e]&&a.push(I.value[e].getLatLng()),O.value[e]&&a.push(O.value[e].getLatLng()),w.value[e]&&Object.values(w.value[e]).forEach(l=>{l&&typeof l.getLatLng=="function"&&a.push(l.getLatLng())}),a.length>=1)try{if(a.length>=2){const l=T.latLngBounds(a);l.isValid()?t.fitBounds(l,{padding:[50,50],maxZoom:17}):t.setView(a[0],15)}else t.setView(a[0],15)}catch(l){console.error(`Error fitting bounds for auto ${e}:`,l),O.value[e]?t.setView(O.value[e].getLatLng(),15):I.value[e]&&t.setView(I.value[e].getLatLng(),15)}},he=()=>{const e=g.value?.idauto;if(!e){De();return}const t=b.value[e];if(!t){console.warn(`Map instance not found for active auto ${e} when updating student markers.`);return}const a=g.value?.studentsLastKnownLocation;if(!a||!Array.isArray(a)){console.warn(`No valid student locations array found for active auto ${e}. Clearing existing markers.`),w.value[e]&&(Object.values(w.value[e]).forEach(p=>{try{p.remove()}catch{}}),w.value[e]={});return}const l=w.value[e]||{},s={},u=new Set;console.log(`Updating student markers for auto ${e}. Locations:`,a.length),a.forEach(p=>{if(p&&p.latitude!==null&&p.longitude!==null&&p.student_idpers){const y=p.student_idpers;u.add(y);const x=[parseFloat(p.latitude),parseFloat(p.longitude)],j=Be.value.get(y),V=j?`${j.nom} ${j.prenom}`:`Élève ${y}`,we=j?ve(j):qe(),N=T.divIcon({html:`<img src="${we}" alt="${V}" style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid #FF7043; box-shadow: 0 1px 3px rgba(0,0,0,0.5); object-fit: cover; background-color: #fff;">`,className:"student-avatar-marker",iconSize:[32,32],iconAnchor:[16,32]});if(l[y])l[y].setLatLng(x).setIcon(N).bindPopup(V),s[y]=l[y];else try{const _e=T.marker(x,{icon:N,alt:V}).addTo(t).bindPopup(V);s[y]=_e}catch(_e){console.error(`Error adding student marker ${y} for auto ${e}:`,_e)}}else p?.student_idpers?console.log(`Student ${p.student_idpers} has null location, will be removed if marker exists.`):console.warn("Invalid student location data entry:",p)}),Object.keys(l).forEach(p=>{const y=parseInt(p,10);if(!u.has(y)){console.log(`Removing stale marker for student ${y} from auto ${e}`);try{l[y].remove()}catch{}}}),w.value[e]=s,console.log(`Finished updating student markers for auto ${e}. Count: ${Object.keys(s).length}`),Q.value||ue(e),Object.keys(w.value).forEach(p=>{const y=parseInt(p,10);y!==e&&w.value[y]&&Object.keys(w.value[y]).length>0&&(console.log(`Clearing stale student markers for inactive auto ${y}`),Object.values(w.value[y]).forEach(x=>{try{x.remove()}catch{}}),w.value[y]={})})},De=()=>{console.log("Clearing all student markers from all maps."),Object.keys(w.value).forEach(e=>{w.value[e]&&Object.values(w.value[e]).forEach(t=>{try{t.remove()}catch{}}),w.value[e]={}})},ce=async e=>{if(!b.value[e])if(console.warn(`Map instance for ${e} not found on refresh request.`),z.value[e]){if(console.log(`Attempting late map init for ${e} during refresh.`),ee(e),await X(),!b.value[e]){v.notify({type:"warning",message:"Carte non prête. Réessayez."});return}}else{v.notify({type:"warning",message:"Conteneur de carte introuvable."});return}B.value=e,console.log(`Refreshing map location for auto ${e}`);try{const t=await re();ie(e,t.latitude,t.longitude)}catch(t){console.error(`Failed to refresh map location for auto ${e}:`,t)}finally{B.value=null}},Ve=()=>{console.log("Retrying initial load..."),R(),pe()},Ke=(e,t)=>_.value?.data?.[e.idauto]?.sorties?_.value.data[e.idauto].sorties.includes(t.idpers):!1,ke=(e,t)=>_.value?.data?.[e.idauto]?.statues?_.value.data[e.idauto].statues.some(a=>a.idpers===t.idpers):!1,Ge=(e,t)=>{if(M(e.idauto))return!0;if(_.value?.data?.[e.idauto]?.statues){const a=_.value.data[e.idauto].absences?.some(u=>u.idpers===t.idpers),l=_.value.data[e.idauto].sorties?.includes(t.idpers);return _.value.data[e.idauto].statues.some(u=>u.idpers===t.idpers)||!a&&!l}return!1},We=(e,t)=>!M(e.idauto)&&_.value?.data?.[e.idauto]?.absences?_.value.data[e.idauto].absences.some(a=>a.idpers===t.idpers):!1,Ze=async(e,t)=>{await D.dispatch("transport/valid",{idauto:e.idauto,idpers:t.idpers}),be()},de=(e,t)=>{if(H.value){v.notify({type:"warning",message:"Un autre trajet est déjà en cours."});return}if(!b.value[e]){v.notify({type:"warning",message:"Carte non initialisée pour ce véhicule. Veuillez patienter."}),z.value[e]&&ee(e);return}R(),v.dialog({title:"Confirmer",message:`Démarrer le trajet de ${t==="PICKUP"?"ramassage":"dépose"} pour ce véhicule ?`,cancel:!0,persistent:!0}).onOk(async()=>{const a=`start_${t.toLowerCase()}_${e}`;E.value=a,m.value=!0,B.value=e,v.loading.show({message:"Obtention localisation..."});try{const l=await re();ie(e,l.latitude,l.longitude),v.loading.show({message:"Démarrage trajet..."}),await Re({idauto:e,tripType:t,location:l})}catch(l){console.error("Failed to start trip:",l)}finally{v.loading.hide(),m.value=!1,E.value="",B.value=null}})},Y=(e,t,a)=>{if(!b.value[a]){v.notify({type:"warning",message:"Carte non initialisée. Impossible d'enregistrer l'événement."});return}let l="",s=!1;switch(e){case"PICKUP":l="ramassé",s=!0;break;case"DROPPED_OFF":l="déposé",s=!0;break;case"BUS_STOP":l="bus en arrêt",s=!0;break;case"STUDENT_ABSENT":l="absent",s=!1;break;default:l=e}v.dialog({title:"Confirmer",message:`Marquer cet élève comme ${l} ?`,cancel:!0,persistent:!0}).onOk(async()=>{const u=`${e.toLowerCase()}_${t}`;E.value=u,m.value=!0;let p=null,y=!1;try{if(s){B.value=a,v.loading.show({message:"Obtention localisation..."});try{p=await re(),y=!0,ie(a,p.latitude,p.longitude),v.loading.show({message:"Enregistrement..."})}catch(x){console.error("Location fetch failed during event recording:",x),v.notify({type:"negative",message:"Impossible d'obtenir la localisation. Événement non enregistré."}),m.value=!1,E.value="",B.value=null,v.loading.hide();return}}else v.loading.show({message:"Enregistrement..."});await je({eventType:e,studentId:t,location:p})}catch(x){console.error("Failed to record event:",x)}finally{(!s||y)&&(v.loading.hide(),m.value=!1,E.value="",B.value=null)}})},He=()=>{if(!g.value||!g.value.idauto){v.notify({type:"warning",message:"Aucun trajet actif trouvé."});return}const e=g.value.idauto;if(!b.value[e]){v.notify({type:"warning",message:"Carte non initialisée. Impossible de terminer le trajet."});return}R(),v.dialog({title:"Confirmer",message:"Voulez-vous vraiment terminer ce trajet ?",cancel:!0,persistent:!0}).onOk(async()=>{E.value="end_trip",m.value=!0,B.value=e,v.loading.show({message:"Obtention localisation finale..."});let t=null,a=!1;try{try{t=await re(),a=!0,ie(e,t.latitude,t.longitude),v.loading.show({message:"Fin du trajet..."})}catch(l){console.warn("Location fetch failed during end trip, proceeding without final location:",l),v.loading.show({message:"Fin du trajet (sans loc)..."})}if(await Ne({location:t}),be(),console.log(`Trip ended for ${e}. Clearing relevant map markers.`),O.value[e]){try{O.value[e].remove()}catch{}delete O.value[e],delete ae.value[e]}De()}catch(l){console.error("Failed to end trip:",l)}finally{v.loading.hide(),m.value=!1,E.value="",B.value=null}})},Ie=(e,t)=>{c.value=e,q.value=t,te.value=null,se.value=!0,R()},Ye=e=>{R();const t=g.value,a=q.value;if(!t||!t.idauto||!a||a.idauto!==t.idauto){console.warn("Cannot show student line: No active trip or selected auto doesn't match active trip."),v.notify({type:"info",message:"Le trajet actif ne correspond pas à ce véhicule."});return}const l=t.idauto,s=b.value[l],u=O.value[l];if(!s){v.notify({type:"warning",message:"Carte non prête."});return}if(!u||!u.getLatLng()){v.notify({type:"warning",message:"Position actuelle du bus inconnue. Actualisez la carte."});return}const p=u.getLatLng(),y=e.idpers,x=t.studentsLastKnownLocation?.find(N=>N.student_idpers===y);if(!x||x.latitude===null||x.longitude===null){v.notify({type:"warning",message:`Localisation de l'élève ${e.prenom} inconnue pour ce trajet.`});return}const j=T.latLng(parseFloat(x.latitude),parseFloat(x.longitude));te.value=e;try{const N=T.polyline([p,j],{color:"red",weight:3,opacity:.8,dashArray:"5, 10"}).addTo(s);Q.value=N}catch(N){console.error("Error drawing polyline:",N),v.notify({type:"negative",message:"Erreur lors du dessin du trajet."});return}const V=s.distance(p,j);Ee.value=V;const we=V>1e3?`${(V/1e3).toFixed(1)} km`:`${Math.round(V)} m`;v.notify({message:`Distance jusqu'à ${e.prenom}: ~${we}`,color:"primary",position:"top",timeout:5e3,icon:"route"});try{s.fitBounds(T.latLngBounds([p,j]),{padding:[60,60],maxZoom:17})}catch(N){console.error("Error fitting bounds for student line:",N),s.setView(p,16)}},R=()=>{if(Q.value){try{Q.value.remove()}catch(e){console.warn("Error removing selected student line:",e)}Q.value=null}Ee.value=null},ve=e=>qe(e),Je=e=>e.trip&&e.trip>0&&e.trip<Le.value.length?Le.value[e.trip]:"",Ae=e=>{if(e&&e.length>=9){const t=(""+e).replace(/\s+/g,"");return t.startsWith("212")?"0"+t.substring(3):t.startsWith("+212")?"0"+t.substring(4):t.length===9&&!t.startsWith("0")?"0"+t:t}return e},Xe=e=>{const t=Ae(e);return t?`tel:${t}`:null},et=e=>{if(e){const a=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(e)}`;window.cordova&&window.cordova.InAppBrowser?window.cordova.InAppBrowser.open(a,"_system"):ye?window.open(a,"_system"):Oe(a)}else v.notify({type:"info",message:"Adresse non disponible."})},tt=()=>{const e=g.value?.studentsLastKnownLocation;if(e&&e.length>0){const t=e.find(u=>u.student_idpers===te.value?.idpers);if(!t?.latitude||!t?.longitude){v.notify({type:"info",message:"Destination non disponible."});return}const a=`${t.latitude},${t.longitude}`,s=`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(a)}`;Oe(s);return}v.notify({type:"info",message:"Destination non disponible."})},pe=async()=>{console.log("Starting initial load..."),oe.value=!0,R();try{console.log("Fetching school location...");const e=Se?Se():Promise.resolve();console.log("Loading active trip..."),await Ue(),console.log("Fetching initial data..."),await be(),console.log("School location promise resolved. Current value:",U.value),await X(),console.log("nextTick finished after data load."),_.value?.autos&&_.value.autos.length>0?(console.log(`Found ${_.value.autos.length} autos. Initializing maps...`),_.value.autos.forEach(a=>{z.value[a.idauto]?ee(a.idauto):console.warn(`Container for auto ${a.idauto} not found during initial map init loop.`)})):console.log("No autos found in initial data."),await X(),he();let t=g.value?.idauto;t?(console.log(`Active trip auto: ${t}. Getting initial location.`),setTimeout(()=>{b.value[t]?ce(t):(console.warn(`Map instance for initial auto ${t} not ready for location refresh.`),z.value[t]&&(console.log(`Retrying map init for active auto ${t} before location refresh.`),ee(t),setTimeout(()=>ce(t),200)))},100)):console.log("No active trip identified for initial location refresh.")}catch(e){console.error("Initial load failed:",e),v.notify({type:"negative",message:"Erreur lors du chargement initial."})}finally{console.log("Initial load finished."),oe.value=!1}};return nt(()=>{console.log("Transport Index component mounted."),ye?(document.addEventListener("deviceready",pe,!1),console.log("Cordova detected. Waiting for deviceready...")):(console.log("Non-Cordova environment. Running initialLoad directly."),pe())}),lt(()=>{console.log("Transport Index component unmounted."),ye&&document.removeEventListener("deviceready",pe,!1),R(),console.log("Cleaning up map instances..."),Object.keys(b.value).forEach(e=>{if(b.value[e])try{b.value[e].remove(),console.log(`Removed map instance for auto ${e}`)}catch(t){console.error(`Error removing map instance for auto ${e}:`,t)}}),b.value={},z.value={},O.value={},I.value={},w.value={},ae.value={}}),ne(()=>_.value?.autos,(e,t)=>{e&&Array.isArray(e)&&(console.log("Autos data changed, checking for new maps to initialize..."),X(()=>{e.forEach(a=>{a&&a.idauto&&z.value[a.idauto]&&!b.value[a.idauto]&&(console.log(`Initializing map for dynamically added/detected auto: ${a.idauto}`),ee(a.idauto),M(a.idauto)&&(console.log(`Auto ${a.idauto} is active, updating map state.`),setTimeout(()=>ce(a.idauto),150),setTimeout(()=>he(),250)))})}))},{deep:!1,immediate:!1}),ne(U,e=>{R(),e&&typeof parseFloat(e.latitude)=="number"&&typeof parseFloat(e.longitude)=="number"?(console.log("School location changed, updating markers on initialized maps:",e),Object.keys(b.value).forEach(t=>{b.value[t]&&(xe(t),Q.value||ue(t))})):(console.log("School location became invalid or null, potentially removing markers."),Object.keys(b.value).forEach(t=>{if(b.value[t]&&I.value[t]){try{I.value[t].remove()}catch{}delete I.value[t],Q.value||ue(t)}}))}),ne(()=>g.value?.studentsLastKnownLocation,(e,t)=>{console.log("Detected change in studentsLastKnownLocation, triggering marker update."),X(()=>{he()})},{deep:!0,immediate:!1}),ne(()=>g.value?.id,(e,t)=>{console.log(`Active trip ID changed from ${t} to ${e}. Clearing student line.`),R()}),ne(se,(e,t)=>{!e&&t&&(console.log("Dialog closed, clearing selected student line."),R())}),(e,t)=>(o(),i(ut,{class:"page-content"},{default:n(()=>[K("div",ft,[oe.value?(o(),i(Pe,{key:0,class:"bg-info text-white absolute-bottom"},{avatar:n(()=>[r(Te,{color:"white",size:"sm"})]),default:n(()=>[t[10]||(t[10]=f(" Chargement de la carte et localisation... "))]),_:1})):d("",!0),g.value.loading||k.value&&!oe.value?(o(),i(Pe,{key:1,class:"bg-info text-white absolute-bottom"},{avatar:n(()=>[r(Te,{color:"white",size:"sm"})]),default:n(()=>[f(" "+L(k.value?"Obtention de la localisation...":"Chargement du trajet..."),1)]),_:1})):d("",!0),g.value.error?(o(),i(Pe,{key:2,class:"bg-negative text-white"},{avatar:n(()=>[r(A,{name:"warning",color:"white"})]),action:n(()=>[r(P,{flat:"",color:"white",label:"Réessayer",onClick:Ve})]),default:n(()=>[f(" "+L(g.value.error)+" ",1)]),_:1})):d("",!0),_.value&&_.value.autos?(o(),i(Fe,{key:3,style:{margin:"0"},flat:""},{default:n(()=>[(o(!0),h(S,null,fe(_.value.autos,a=>(o(),i(ct,{key:a.idauto,"expand-icon-class":"text-white",class:"shadow-1 overflow-hidden q-mb-md",icon:"icon_bus","header-class":"bg-secondary text-white","expand-separator":"","default-opened":"",label:a.marque+" | "+a.matricule},{default:n(()=>[M(a.idauto)||!H.value?(o(),i(me,{key:0,class:"q-pa-none"},{default:n(()=>[K("div",mt,[K("div",{ref_for:!0,ref:l=>z.value[a.idauto]=l,class:"map rounded-borders"},null,512),r(P,{"fab-mini":"",color:"primary",icon:"my_location",class:"map-refresh-btn",loading:k.value&&B.value===a.idauto,disable:k.value,onClick:l=>ce(a.idauto),title:"Actualiser ma position sur la carte"},null,8,["loading","disable","onClick"]),ae.value[a.idauto]||U.value||$e(a.idauto)?(o(),h("div",gt,[ae.value[a.idauto]?(o(),h(S,{key:0},[r(A,{name:"circle",color:"blue",size:"sm",class:"q-mr-xs"}),t[11]||(t[11]=f(" Bus "))],64)):d("",!0),U.value?(o(),h(S,{key:1},[r(A,{name:"school",color:"primary",size:"sm",class:"q-ml-sm q-mr-xs"}),t[12]||(t[12]=f(" École "))],64)):d("",!0),$e(a.idauto)?(o(),h(S,{key:2},[r(A,{name:"person_pin_circle",color:"deep-orange",size:"sm",class:"q-ml-sm q-mr-xs"}),t[13]||(t[13]=f(" Élèves "))],64)):d("",!0)])):d("",!0)]),r(ge)]),_:2},1024)):d("",!0),!g.value.loading&&!g.value.error?(o(),i(me,{key:1,class:"q-pa-sm"},{default:n(()=>[M(a.idauto)?(o(),h("div",bt,[r(W,{square:"",color:"green","text-color":"white",icon:"directions_bus"},{default:n(()=>[f(" Trajet "+L(g.value.trip_type==="PICKUP"?"Ramassage":"Dépose")+" en cours... ",1)]),_:1}),r(P,{color:"negative",icon:"stop",label:"Terminer Trajet",onClick:He,disable:k.value||!Me.value,loading:m.value&&E.value==="end_trip"},null,8,["disable","loading"])])):(o(),h("div",yt,[r(P,{color:"primary",icon:"play_arrow",label:"Démarrer Ramassage",onClick:l=>de(a.idauto,"PICKUP"),disable:H.value||k.value,loading:m.value&&E.value==="start_pickup_"+a.idauto},null,8,["onClick","disable","loading"]),r(P,{color:"info",icon:"play_arrow",label:"Démarrer Dépose",onClick:l=>de(a.idauto,"DROPOFF"),disable:H.value||k.value,loading:m.value&&E.value==="start_dropoff_"+a.idauto},null,8,["onClick","disable","loading"])]))]),_:2},1024)):d("",!0),!g.value.loading&&!g.value.error?(o(),i(ge,{key:2})):d("",!0),(o(!0),h(S,null,fe(a.secteur,l=>(o(),h(S,{key:"s"+l.idsecteur},[r(Z,{header:""},{default:n(()=>[f(L(l.description),1)]),_:2},1024),(o(!0),h(S,null,fe(l.eleve,s=>(o(),h(S,{key:"e"+s.idpers},[Ge(a,s)?(o(),i(le,{key:0},{default:n(()=>[r(F,{avatar:"",onClick:u=>Ie(s,a)},{default:n(()=>[r(Ce,{square:"",size:"xl"},{default:n(()=>[K("img",{src:ve(s)},null,8,ht)]),_:2},1024)]),_:2},1032,["onClick"]),r(F,{onClick:u=>Ie(s,a)},{default:n(()=>[r(Z,{lines:"1",style:{"font-weight":"600"}},{default:n(()=>[f(L(s.nom)+" "+L(s.prenom),1)]),_:2},1024),r(Z,{lines:"2"},{default:n(()=>[s.trip>0?(o(),i(G,{key:0,color:"grey"},{default:n(()=>[f(L(Je(s)),1)]),_:2},1024)):d("",!0),t[14]||(t[14]=f()),t[15]||(t[15]=K("br",null,null,-1)),s.classes&&s.classes.length?(o(),i(G,{key:1,color:"secondary"},{default:n(()=>[f(L(s.classes[0].bref),1)]),_:2},1024)):d("",!0)]),_:2},1024)]),_:2},1032,["onClick"]),r(F,{side:""},{default:n(()=>[K("div",kt,[M(a.idauto)&&C(s.idpers)==="PICKED_UP"?(o(),i(G,{key:0,color:"positive",class:"q-mr-xs"},{default:n(()=>[r(A,{name:"check_circle",class:"q-mr-xs"}),t[16]||(t[16]=f(" Ramassé "))]),_:1})):d("",!0),M(a.idauto)&&C(s.idpers)==="BUS_STOPPED"?(o(),i(G,{key:1,color:"secondary",class:"q-mr-xs"},{default:n(()=>[r(A,{name:"directions_bus",class:"q-mr-xs"}),t[17]||(t[17]=f(" Bus en arrêt "))]),_:1})):d("",!0),M(a.idauto)&&C(s.idpers)==="DROPPED_OFF"?(o(),i(G,{key:2,color:"info",class:"q-mr-xs"},{default:n(()=>[r(A,{name:"check_circle",class:"q-mr-xs"}),t[18]||(t[18]=f(" Déposé "))]),_:1})):d("",!0),M(a.idauto)&&C(s.idpers)==="ABSENT"?(o(),i(G,{key:3,color:"negative",class:"q-mr-xs"},{default:n(()=>[r(A,{name:"cancel",class:"q-mr-xs"}),t[19]||(t[19]=f(" Absent "))]),_:1})):d("",!0),!H.value&&We(a,s)?(o(),i(G,{key:4,color:"negative"},{default:n(()=>[r(A,{name:"icon_absences",class:"q-mr-xs"}),t[20]||(t[20]=f(" Absent (École)"))]),_:1})):d("",!0),!H.value&&Ke(a,s)?(o(),i(G,{key:5,color:"info"},{default:n(()=>[r(A,{name:"icon_voiture",class:"q-mr-xs"}),t[21]||(t[21]=f(" Sortie (École)"))]),_:1})):d("",!0)]),M(a.idauto)?(o(),h("div",wt,[g.value.trip_type==="PICKUP"&&(C(s.idpers)==="PENDING"||C(s.idpers)==="BUS_STOPPED")?(o(),h(S,{key:0},[ke(a,s)?(o(),h(S,{key:0},[r(P,{dense:"",unelevated:"",color:"positive",icon:"check",onClick:u=>Y("PICKUP",s.idpers,a.idauto),disable:k.value||m.value,loading:m.value&&E.value==="pickup_"+s.idpers,title:"Marquer comme ramassé"},null,8,["onClick","disable","loading"]),r(P,{dense:"",unelevated:"",color:"negative",icon:"close",onClick:u=>Y("STUDENT_ABSENT",s.idpers,a.idauto),disable:k.value||m.value,loading:m.value&&E.value==="absent_"+s.idpers,title:"Marquer comme absent"},null,8,["onClick","disable","loading"])],64)):d("",!0)],64)):d("",!0),g.value.trip_type==="DROPOFF"&&(C(s.idpers)==="PICKED_UP"||C(s.idpers)==="BUS_STOPPED")?(o(),i(P,{key:1,dense:"",unelevated:"",color:"info",icon:"check",onClick:u=>Y("DROPPED_OFF",s.idpers,a.idauto),disable:k.value||m.value,loading:m.value&&E.value==="dropoff_"+s.idpers,title:"Marquer comme déposé"},null,8,["onClick","disable","loading"])):d("",!0),g.value.trip_type==="DROPOFF"&&C(s.idpers)==="PENDING"?(o(),i(W,{key:2,outline:"",square:"",size:"sm",color:"orange","text-color":"white",icon:"schedule"},{default:n(()=>t[22]||(t[22]=[f(" En attente ")])),_:1})):d("",!0)])):(o(),h("div",_t,[ke(a,s)?(o(),i(G,{key:0,color:"positive"},{default:n(()=>[r(A,{name:"done",class:"q-mr-xs"}),t[23]||(t[23]=f(" Validé"))]),_:1})):(o(),i(P,{key:1,onClick:u=>Ze(a,s),dense:"",unelevated:"",color:"primary"},{default:n(()=>[r(A,{name:"done"})]),_:2},1032,["onClick"]))]))]),_:2},1024)]),_:2},1024)):d("",!0)],64))),128)),r(ge)],64))),128))]),_:2},1032,["label"]))),128))]),_:1})):!g.value.loading&&!g.value.error&&!k.value&&!oe.value?(o(),h("div",Ct," Aucun véhicule assigné ou données non chargées. ")):d("",!0)]),r(st,{modelValue:se.value,"onUpdate:modelValue":t[9]||(t[9]=a=>se.value=a),position:"bottom",seamless:"",maximized:""},{default:n(()=>[c.value?(o(),i(rt,{key:0},{default:n(()=>[r(vt,{class:"bg-primary text-white"},{default:n(()=>[r(Ce,{square:"",size:"lg"},{default:n(()=>[K("img",{src:ve(c.value)},null,8,Pt)]),_:1}),r(dt,null,{default:n(()=>[f(L(c.value.nom)+" "+L(c.value.prenom),1)]),_:1}),it(r(P,{flat:"",round:"",dense:"",icon:"close"},null,512),[[pt]])]),_:1}),r(me,{class:"q-pa-sm"},{default:n(()=>[M(q.value?.idauto)?ke(q.value,c.value)?(o(),h("div",Et,[te.value?d("",!0):(o(),i(P,{key:0,unelevated:"",label:"Localiser l'élève ",icon:"route",color:"primary",onClick:t[2]||(t[2]=a=>Ye(c.value)),disable:k.value||m.value},null,8,["disable"])),te.value?(o(),i(P,{key:1,unelevated:"",label:"Google Maps",icon:"map",color:"primary",onClick:t[3]||(t[3]=a=>tt()),disable:k.value||m.value},null,8,["disable"])):d("",!0),C(c.value.idpers)!=="DROPPED_OFF"&&C(c.value.idpers)!=="PICKED_UP"?(o(),h(S,{key:2},[C(c.value.idpers)!=="BUS_STOPPED"?(o(),i(P,{key:0,unelevated:"",label:"Bus en arrêt",icon:"directions_bus",color:"secondary",onClick:t[4]||(t[4]=a=>Y("BUS_STOP",c.value.idpers,q.value.idauto))})):(o(),i(W,{key:1,square:"",color:"secondary","text-color":"white",icon:"directions_bus"},{default:n(()=>t[25]||(t[25]=[f(" Bus en arrêt ")])),_:1}))],64)):d("",!0),g.value.trip_type==="DROPOFF"?(o(),h(S,{key:3},[C(c.value.idpers)==="DROPPED_OFF"?(o(),i(W,{key:0,square:"",color:"info","text-color":"white",icon:"check_circle"},{default:n(()=>t[26]||(t[26]=[f(" Déposé ")])),_:1})):C(c.value.idpers)==="PICKED_UP"||C(c.value.idpers)==="BUS_STOPPED"?(o(),i(P,{key:1,unelevated:"",color:"info",icon:"check",label:"Marquer Déposé",onClick:t[5]||(t[5]=a=>Y("DROPPED_OFF",c.value.idpers,q.value.idauto)),disable:k.value||m.value,loading:m.value&&E.value==="dropoff_"+c.value.idpers,title:"Marquer comme déposé"},null,8,["disable","loading"])):C(c.value.idpers)==="PENDING"?(o(),i(W,{key:2,square:"",color:"orange","text-color":"white",icon:"schedule"},{default:n(()=>t[27]||(t[27]=[f(" En attente de ramassage ")])),_:1})):d("",!0)],64)):g.value.trip_type==="PICKUP"?(o(),h(S,{key:4},[C(c.value.idpers)==="PICKED_UP"?(o(),i(W,{key:0,square:"",color:"positive","text-color":"white",icon:"check_circle"},{default:n(()=>t[28]||(t[28]=[f(" Ramassé ")])),_:1})):C(c.value.idpers)==="PENDING"||C(c.value.idpers)==="BUS_STOPPED"?(o(),h(S,{key:1},[r(P,{unelevated:"",color:"positive",icon:"check",label:"Marquer Ramassé",onClick:t[6]||(t[6]=a=>Y("PICKUP",c.value.idpers,q.value.idauto)),disable:k.value||m.value,loading:m.value&&E.value==="pickup_"+c.value.idpers,title:"Marquer comme ramassé"},null,8,["disable","loading"]),r(P,{unelevated:"",color:"negative",icon:"close",label:"Marquer Absent",onClick:t[7]||(t[7]=a=>Y("STUDENT_ABSENT",c.value.idpers,q.value.idauto)),disable:k.value||m.value,loading:m.value&&E.value==="absent_"+c.value.idpers,title:"Marquer comme absent"},null,8,["disable","loading"])],64)):C(c.value.idpers)==="ABSENT"?(o(),i(W,{key:2,square:"",color:"negative","text-color":"white",icon:"cancel"},{default:n(()=>t[29]||(t[29]=[f(" Absent ")])),_:1})):d("",!0)],64)):d("",!0)])):d("",!0):(o(),h("div",Lt,[H.value?(o(),i(W,{key:1,square:"",color:"warning","text-color":"white",icon:"warning"},{default:n(()=>t[24]||(t[24]=[f(" Trajet en cours sur un autre véhicule. ")])),_:1})):(o(),h(S,{key:0},[r(P,{color:"primary",icon:"play_arrow",label:"Démarrer Ramassage",onClick:t[0]||(t[0]=a=>de(q.value.idauto,"PICKUP")),disable:k.value,loading:m.value&&E.value==="start_pickup_"+q.value.idauto},null,8,["disable","loading"]),r(P,{color:"info",icon:"play_arrow",label:"Démarrer Dépose",onClick:t[1]||(t[1]=a=>de(q.value.idauto,"DROPOFF")),disable:k.value,loading:m.value&&E.value==="start_dropoff_"+q.value.idauto},null,8,["disable","loading"])],64))]))]),_:1}),r(ge),r(me,null,{default:n(()=>[r(Fe,{dense:""},{default:n(()=>[c.value.classes&&c.value.classes.length?(o(),i(le,{key:0},{default:n(()=>[r(F,{avatar:""},{default:n(()=>[r(A,{name:"school"})]),_:1}),r(F,null,{default:n(()=>[f(L(c.value.classes[0].description)+" ("+L(c.value.classes[0].bref)+")",1)]),_:1})]),_:1})):d("",!0),c.value.adresse?(o(),i(le,{key:1},{default:n(()=>[r(F,{avatar:""},{default:n(()=>[r(A,{name:"home"})]),_:1}),r(F,null,{default:n(()=>[K("div",null,L(c.value.adresse),1),c.value.secteur&&c.value.secteur.length?(o(),i(Z,{key:0,caption:""},{default:n(()=>[f(" Secteur: "+L(c.value.secteur[0].description),1)]),_:1})):d("",!0)]),_:1}),r(F,{side:""},{default:n(()=>[r(P,{flat:"",round:"",color:"info",icon:"map",onClick:t[8]||(t[8]=a=>et(c.value.adresse)),title:"Ouvrir dans Maps"})]),_:1})]),_:1})):d("",!0),r(Z,{header:""},{default:n(()=>t[30]||(t[30]=[f("Contacts Parents")])),_:1}),c.value.parents&&c.value.parents.length?(o(!0),h(S,{key:2},fe(c.value.parents,a=>(o(),i(le,{key:a.idpers},{default:n(()=>[r(F,{avatar:""},{default:n(()=>[r(Ce,null,{default:n(()=>[K("img",{src:ve(a)},null,8,$t)]),_:2},1024)]),_:2},1024),r(F,null,{default:n(()=>[r(Z,null,{default:n(()=>[f(L(a.nom)+" "+L(a.prenom)+" ("+L(a?.pivot?.presentation)+")",1)]),_:2},1024),a.gsm?(o(),i(Z,{key:0,caption:""},{default:n(()=>[f(L(Ae(a.gsm)),1)]),_:2},1024)):d("",!0),a.email?(o(),i(Z,{key:1,caption:""},{default:n(()=>[f(L(a.email),1)]),_:2},1024)):d("",!0)]),_:2},1024),a.gsm?(o(),i(F,{key:0,side:""},{default:n(()=>[r(P,{flat:"",round:"",color:"positive",icon:"phone",href:Xe(a.gsm),title:"Appeler"},null,8,["href"])]),_:2},1024)):d("",!0)]),_:2},1024))),128)):(o(),i(le,{key:3},{default:n(()=>[r(F,{class:"text-grey"},{default:n(()=>t[31]||(t[31]=[f("Aucun contact parent trouvé.")])),_:1})]),_:1}))]),_:1})]),_:1})]),_:1})):d("",!0)]),_:1},8,["modelValue"])]),_:1}))}};export{zt as default};
