const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./CanteenBeneficiariesReport-DezIk4y7.js","./index-Bl2lQPd7.js","./index-B-uS9A6y.css","./date-C1Mon-Jj.js","./format-IcNrutKL.js","./CanteenBeneficiariesReport-5Hp-Viip.css"])))=>i.map(i=>d[i]);
import{_ as he,aP as xe,A as m,B as n,aM as Z,Y as De,C as be,Q as h,S as i,a6 as s,a5 as r,a8 as o,aE as we,aF as Ye,a4 as x,R as U,a2 as Ce,ay as v,av as ee,a3 as ae,aS as qe,a$ as Ae,ab as f,ad as k,a7 as Se,aw as Ee,aC as Qe,a as $,N as g,b0 as Te}from"./index-Bl2lQPd7.js";import{Q as Be}from"./QDate-C_jC-zMt.js";import{Q as ke}from"./QPopupProxy-CQ30ymZI.js";import{Q as Ie}from"./QSelect-DchnWyXK.js";import{Q as Me}from"./QSpinnerDots-BW9ZsFNG.js";import{Q as L}from"./QItemLabel-BkJiB6aE.js";import{Q as Ve,a as O}from"./QItem-De3v03wU.js";import{Q as j}from"./QChip-C9OfA2gn.js";import{Q as Le}from"./QTooltip-r7WoEuzy.js";import{Q as Pe}from"./QVirtualScroll-CENgsPEr.js";import{Q as Fe}from"./QList-CMzNTEGD.js";import{C as ze}from"./ClosePopup-BY_YGFBZ.js";import{q as D}from"./date-C1Mon-Jj.js";import{u as Ne}from"./composables-CAkrP3jA.js";import{E as Re}from"./ExportControls-UOL0zNKZ.js";import"./use-render-cache-DLxPkVnQ.js";import"./use-datetime-hbLWgGn4.js";import"./format-IcNrutKL.js";import"./QMenu-BNr9Tzvf.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./rtl-DFPa-2ov.js";import"./_commonjsHelpers-D6-XlEtG.js";const Ue={class:"grid grid-cols-1 lg:grid-cols-3 gap-3 lg:gap-5 items-end"},$e={class:"date-picker-container"},Oe={class:"row items-center justify-end q-mt-sm"},je={class:"filter-select-container"},Ke={key:0,class:"mt-4 row items-center justify-between"},Ge={class:"col-auto"},He={class:"col-auto export-controls-container shadow-1 q-pa-xs rounded-borders"},We={class:"beneficiaries-list-container"},Je={key:0,class:"text-center q-pa-xl"},Xe={class:"text-neutral-mid-grey q-mt-md"},Ze={key:1,class:"text-center q-pa-xl"},ea={class:"text-grey-7"},aa={key:2,class:"text-center q-pa-xl"},ta={key:3,class:"text-center q-pa-xl"},ra=["src"],sa={key:5,class:"text-center q-pa-xl text-neutral-mid-grey"},la={__name:"CanteenBeneficiaries",setup(oa){const A=xe(),{setTitle:te,showFooter:re}=Ne(),se=Ae(()=>Te(()=>import("./CanteenBeneficiariesReport-DezIk4y7.js"),__vite__mapDeps([0,1,2,3,4,5]),import.meta.url)),K=m(!1),I=m(!1),P=m(!1),b=m(null),G=D.formatDate(new Date,"YYYY-MM-DD"),l=m(G),u=m(null),_=m("ALL"),w=m([]),S=m([]),c=m([]),Y=m(""),F=n(()=>A.getters["user/current"]),H=n(()=>A.getters["user/current"]?.annee),y=n(()=>H.value?.idannee),p=n(()=>A.getters["ecole/info"]),E=n(()=>A.getters["ecole/invoiceSettings"]),le=n(()=>!!E.value),oe=n(()=>{if(F.value&&F.value.hasOwnProperty("classe"))return F.value.classe}),M=n(()=>oe.value?.idclasse||null),Q=(e,a="YYYY-MM-DD")=>e?D.formatDate(e,a):"",z=n(()=>{if(!l.value)return"N/A";const e=Q(l.value,"DD/MM/YYYY");if(u.value&&u.value!==l.value){const a=Q(u.value,"DD/MM/YYYY");return`${e} au ${a}`}return e}),N=n(()=>l.value&&u.value&&l.value!==u.value),ne=n(()=>S.value.map(e=>({label:e.classe_fr||e.bref||`Classe ${e.idclasse}`,value:e.idclasse}))),R=m([{label:"Tous Types",value:"ALL"},{label:"Abonnés",value:"SUBSCRIBED"},{label:"Ticket",value:"TICKET"}]),ie=e=>{if(P.value||!w.value.length)return!0;const a=e.replace(/\//g,"");return w.value.some(t=>D.formatDate(t.date_cantine,"YYYYMMDD")===a)},ue=e=>w.value.length?w.value.find(a=>D.formatDate(a.date_cantine,"YYYYMMDD")===e):null,C=n(()=>{if(!c.value.length)return[];let e=[...c.value];return M.value&&(e=e.filter(a=>a.classe_id===M.value)),_.value&&_.value!=="ALL"&&(e=e.filter(a=>a.status===_.value)),N.value?e.sort((a,t)=>{const d=new Date(a.program_date).getTime(),T=new Date(t.program_date).getTime();return d<T?-1:d>T?1:a.full_name.localeCompare(t.full_name)}):e.sort((a,t)=>a.full_name.localeCompare(t.full_name)),e}),ce=n(()=>`Bénéficiaires Cantine: ${z.value}`),de=n(()=>C.value.length?{students:C.value,reportDateRange:z.value,reportDate:l.value,filters:{classe:M.value?ne.value.find(e=>e.value===M.value)?.label:"Toutes",type:R.value.find(e=>e.value===_.value)?.label||"Tous"},schoolInfo:{},partnerInfo:{},isRange:N.value,schoolInfo:{name:p.value.description||"",addressLine1:p.value.adresse||"",city:p.value.ville||"",contactEmail:p.value.email||"",paymentEmail:E.value?.payment_email??(p.value.email||""),phone:p.value.telephone?"+"+p.value.telephone:"",logoUrl:E.value?.logo_path??(p.value.logo?Z(p.value.logo):"")},partnerInfo:{logoUrl:le.value&&E.value.partner_logo_path?Z(E.value.partner_logo_path):null}}:{}),W=async()=>{P.value=!0,w.value=[];try{const{data:e}=await $("get","/canteen/programs/active",{params:{annee_id:y.value}});e?.status==="success"&&Array.isArray(e.data)?w.value=e.data:g.create({type:"warning",message:"Impossible de charger les programmes actifs."})}catch(e){console.error("Error fetching active canteen programs:",e),g.create({type:"negative",message:"Erreur chargement des programmes."})}finally{P.value=!1}},J=async()=>{if(y.value){K.value=!0,S.value=[];try{const{data:e}=await $("get",`/filters/classes/${y.value}`);Array.isArray(e)?S.value=e:e?.data&&Array.isArray(e.data)?S.value=e.data:g.create({type:"warning",message:"Format de réponse des classes inattendu."})}catch(e){console.error("Error fetching classes:",e),g.create({type:"negative",message:"Erreur lors du chargement des classes."})}finally{K.value=!1}}},me=async(e,a)=>{if(!e||!y.value)return[];try{const{data:t}=await $("get",`/canteen/programs/${e}/students-expected?annee_id=${y.value}`);return t?.status==="success"&&Array.isArray(t.data)?t.data.map(d=>({...d,photo_url:d.photo_url&&!d.photo_url.endsWith("-")?d.photo_url:null,program_date:a})):(g.create({type:"warning",message:`Impossible de charger les élèves pour le programme du ${Q(a,"DD/MM/YYYY")}.`}),[])}catch(t){return console.error(`Error fetching students for program ${e}:`,t),g.create({type:"negative",message:`Erreur technique pour le programme du ${Q(a,"DD/MM/YYYY")}.`}),[]}},V=async()=>{if(!l.value){g.create({type:"info",message:"Veuillez sélectionner une date de début."});return}if(u.value&&D.getDateDiff(u.value,l.value,"days")<0){g.create({type:"negative",message:"La date de fin ne peut pas être antérieure à la date de début."});return}b.value="apply_range",I.value=!0,c.value=[],Y.value="";const e=[];let a=new Date(l.value.replace(/-/g,"/"));const t=u.value?new Date(u.value.replace(/-/g,"/")):new Date(l.value.replace(/-/g,"/"));for(;a<=t;)e.push(D.formatDate(a,"YYYYMMDD")),a=D.addToDate(a,{days:1});let d=[];const T=[];for(const q of e){const B=ue(q);B?T.push(me(B.idcantine,q)):console.warn(`No active program found for date: ${q}`)}try{(await Promise.all(T)).forEach(B=>{B.length>0&&(d=d.concat(B))}),c.value=d,c.value.length===0&&e.length>0&&(Y.value="Aucun bénéficiaire trouvé pour la période et les programmes actifs sélectionnés.")}catch(q){console.error("Error aggregating student data for range:",q),Y.value="Une erreur est survenue lors de la récupération des données pour la période.",c.value=[]}finally{I.value=!1,b.value=null}},X=()=>{!u.value&&l.value?V():l.value&&u.value||(c.value=[])},pe=()=>{l.value=G,u.value=null,_.value="ALL",c.value=[],Y.value="",b.value=null,V()},ve=e=>{const a=e.target.closest(".q-avatar");if(a){const t=a.querySelector(".q-icon");t&&(t.style.display="inline-flex")}e.target.style.display="none"},fe=e=>{const a=R.value.find(t=>t.value===e);return a?a.label.replace(" Tous Types",""):e},ge=e=>{switch(e){case"SUBSCRIBED":return"sym_o_event_available";case"TICKET":return"sym_o_confirmation_number";case"ADD_MANUAL":return"sym_o_person_add";default:return"sym_o_help"}},_e=e=>{switch(e){case"SUBSCRIBED":return"primary";case"TICKET":return"secondary";case"ADD_MANUAL":return"accent";default:return"neutral-mid-grey"}},ye=async()=>{if(H.value)try{await A.dispatch("ecole/fetchInvoiceSettings")}catch{}};return De(y,e=>{e?(J(),W().then(()=>{V()})):(S.value=[],c.value=[])},{immediate:!0}),be(async()=>{te("Liste des Bénéficiaires Cantine"),ye(),re(!1),await W(),y.value&&await J(),V()}),(e,a)=>(i(),h(Qe,{padding:"",class:"page-content beneficiaries-container"},{default:s(()=>[r(we,{flat:"",bordered:"",class:"filter-card q-mb-lg"},{default:s(()=>[r(Ye,{class:"bg-neutral-light"},{default:s(()=>[a[3]||(a[3]=o("div",{class:"q-mb-md text-weight-bold text-primary"},"Filtrer les Bénéficiaires",-1)),o("div",Ue,[o("div",$e,[r(Ce,{dense:"",filled:"",modelValue:l.value,"onUpdate:modelValue":a[1]||(a[1]=t=>l.value=t),label:"Date",mask:"####-##-##",clearable:"",class:"date-input",standout:"","bg-color":"accent-light-blue"},{prepend:s(()=>[r(v,{name:"sym_o_event",class:"cursor-pointer text-primary"},{default:s(()=>[r(ke,{cover:"","transition-show":"scale","transition-hide":"scale"},{default:s(()=>[r(Be,{modelValue:l.value,"onUpdate:modelValue":[a[0]||(a[0]=t=>l.value=t),X],mask:"YYYY-MM-DD",minimal:"",options:ie,"today-btn":"",color:"primary"},{default:s(()=>[o("div",Oe,[ee(r(ae,{label:"Fermer",color:"primary",flat:""},null,512),[[ze]])])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),o("div",je,[r(Ie,{dense:"",filled:"",modelValue:_.value,"onUpdate:modelValue":[a[2]||(a[2]=t=>_.value=t),X],options:R.value,label:"Type Bénéficiaire","emit-value":"","map-options":"","options-dense":"",standout:"","bg-color":"accent-light-blue",class:"filter-q-select"},null,8,["modelValue","options"])])]),c.value.length>0?(i(),x("div",Ke,[o("div",Ge,[r(ae,{label:"Effacer Filtres",color:"neutral-mid-grey",flat:"",onClick:pe,icon:"clear",disable:I.value,class:"q-pl-sm q-pr-md",rounded:""},null,8,["disable"])]),o("div",He,[r(Re,{"report-component":qe(se),"report-data":de.value,"report-component-styles":[{url:"/reports/cantine.css?v=1.0.1"}],"pdf-filename-prefix":"Beneficiaires_Cantine","pdf-title":ce.value},null,8,["report-component","report-data","pdf-title"])])])):U("",!0)]),_:1})]),_:1}),o("div",We,[I.value?(i(),x("div",Je,[r(Me,{color:"primary",size:"50px"}),o("p",Xe,f(b.value==="apply_range"?"Chargement des données pour la période...":"Chargement..."),1)])):Y.value?(i(),x("div",Ze,[r(v,{name:"sym_o_error",size:"4em",color:"negative"}),a[4]||(a[4]=o("p",{class:"text-negative q-mt-md text-h6"},"Erreur de chargement",-1)),o("p",ea,f(Y.value),1)])):!c.value.length&&(b.value==="apply_range"||b.value==="today")?(i(),x("div",aa,[r(v,{name:"sym_o_no_food",size:"4em",color:"neutral-mid-grey"}),a[5]||(a[5]=o("p",{class:"text-neutral-mid-grey q-mt-md text-h6"},"Aucun bénéficiaire trouvé pour la sélection.",-1)),a[6]||(a[6]=o("p",{class:"text-neutral-mid-grey"},"Vérifiez les dates ou les programmes actifs.",-1))])):!C.value.length&&c.value.length?(i(),x("div",ta,[r(v,{name:"sym_o_filter_alt_off",size:"4em",color:"neutral-mid-grey"}),a[7]||(a[7]=o("p",{class:"text-neutral-mid-grey q-mt-md text-h6"},"Aucun élève ne correspond aux filtres de classe/type.",-1))])):C.value.length?(i(),h(Fe,{key:4,bordered:"",separator:"",class:"rounded-lg shadow-1"},{default:s(()=>[r(L,{header:"",class:"bg-accent-light-blue text-primary text-weight-medium rounded-t-lg q-px-md"},{default:s(()=>[r(v,{name:"sym_o_restaurant_menu",class:"q-mr-sm"}),k(" "+f(C.value.length)+" élève(s) affiché(s) pour la période du "+f(z.value),1)]),_:1}),r(Pe,{items:C.value,separator:"",style:{"max-height":"70vh"}},{default:s(({item:t,index:d})=>[ee((i(),h(Ve,{key:t.idpers+"_"+t.program_date,clickable:"",class:"beneficiary-item"},{default:s(()=>[r(O,{avatar:"",top:"",class:"q-pt-sm"},{default:s(()=>[r(Se,{size:"48px"},{default:s(()=>[t.photo_url?(i(),x("img",{key:0,src:t.photo_url,onError:ve,alt:"Photo de l'élève"},null,40,ra)):(i(),h(v,{key:1,name:"sym_o_person",size:"md",color:"neutral-mid-grey"}))]),_:2},1024)]),_:2},1024),r(O,null,{default:s(()=>[r(L,{class:"text-weight-bold text-text-dark"},{default:s(()=>[k(f(t.full_name),1)]),_:2},1024),r(L,{caption:"",class:"text-neutral-mid-grey"},{default:s(()=>[r(v,{name:"sym_o_class",size:"xs",class:"q-mr-xs"}),k(" Classe: "+f(t.classe_name||"N/A"),1)]),_:2},1024),N.value?(i(),h(L,{key:0,caption:"",class:"text-neutral-mid-grey"},{default:s(()=>[r(v,{name:"sym_o_calendar_today",size:"xs",class:"q-mr-xs"}),k(" Date Prog: "+f(Q(t.program_date,"DD/MM/YYYY")),1)]),_:2},1024)):U("",!0)]),_:2},1024),r(O,{side:"",top:"",class:"q-pt-sm q-gutter-y-xs items-end"},{default:s(()=>[r(j,{dense:"",square:"",icon:ge(t.status),label:fe(t.status),color:_e(t.status),"text-color":"white",class:"status-chip"},null,8,["icon","label","color"]),t.is_served?(i(),h(j,{key:0,dense:"",square:"",color:"positive","text-color":"white",icon:"sym_o_check_circle",label:"Servi",class:"served-chip"},{default:s(()=>[r(Le,{anchor:"top middle",self:"bottom middle"},{default:s(()=>[k("Servi à "+f(t.served_at_display),1)]),_:2},1024)]),_:2},1024)):(i(),h(j,{key:1,dense:"",square:"",color:"neutral-mid-grey","text-color":"white",icon:"sym_o_radio_button_unchecked",label:"Non Servi",class:"served-chip"}))]),_:2},1024)]),_:2},1024)),[[Ee]])]),_:1},8,["items"])]),_:1})):l.value?U("",!0):(i(),x("div",sa,[r(v,{name:"sym_o_edit_calendar",size:"4em",color:"neutral-mid-grey"}),a[8]||(a[8]=o("p",{class:"q-mt-md text-h6"},"Veuillez sélectionner une date de début pour afficher les bénéficiaires.",-1))]))])]),_:1}))}},Qa=he(la,[["__scopeId","data-v-422be531"]]);export{Qa as default};
