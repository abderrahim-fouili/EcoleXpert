import{Q as me}from"./QLinearProgress-DW1NPbfx.js";import{_ as ge,bt as pe,Q as C,S as g,a6 as l,a8 as o,a5 as r,a4 as w,R,aE as $,ab as y,af as Y,ay as D,aF as T,a3 as F,a9 as N,ad as _,a7 as fe,aC as he,aP as ye,aO as _e,A as f,B as u,C as be,bv as we,aB as ke,e as qe,aM as Re}from"./index-Bl2lQPd7.js";import{Q as U}from"./QTooltip-r7WoEuzy.js";import{Q as Me}from"./QBadge-Bjfo5tRO.js";import{Q as Se}from"./QBanner-xBGiroIy.js";import{q as Ce}from"./date-C1Mon-Jj.js";import{L as d}from"./leaflet-src-BmGqNqGH.js";import{u as De}from"./composables-CAkrP3jA.js";import{i as Ie}from"./stomp-SbqQEsfg.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./format-IcNrutKL.js";import"./_commonjsHelpers-D6-XlEtG.js";const Le=pe({name:"DistanceCalculatorPage",setup(){const e=ye(),s=_e(),M=f(null),n=f(null),a=f([]),h=f(null),k=f(!1),p=f(null),S=f(null),Q=f(null),{setTitle:G}=De(),q=f(null),B=u(()=>e.getters["ecole/info"]),i=u(()=>e.getters["ecole-geo/geoData"]),I=u(()=>i.value?.proximity_threshold||200),L=u(()=>{const t=e.getters["user/current"]?.eleve||null;return console.log(t),t||null}),P=u(()=>h.value!==null&&h.value<=I.value);u(()=>e.getters["presence/todayPresences"]||[]);const X=t=>t<1e3?`${Math.round(t)} m`:`${(t/1e3).toFixed(2)} km`,Z=u(()=>{if(!h.value)return 0;const t=1-h.value/(I.value*2);return Math.max(0,Math.min(1,t))}),j=u(()=>h.value?P.value?"positive":"warning":"grey"),J=()=>{if(!M.value)return;const t=[31.7917,-7.0926];n.value=d.map(M.value,{zoomControl:!1,attributionControl:!1}).setView(t,5),d.control.zoom({position:"topright"}).addTo(n.value),d.control.attribution({position:"bottomright",prefix:'© <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'}).addTo(n.value),d.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{subdomains:"abcd",maxZoom:20}).addTo(n.value),d.control.scale({imperial:!1,position:"bottomleft"}).addTo(n.value)},K=(t,c)=>{if(a.value[1]&&a.value[1].remove(),a.value[1]=d.marker([t,c],{icon:oe()}).addTo(n.value),a.value[0]&&a.value[1]){const m=d.latLngBounds([a.value[0].getLatLng(),a.value[1].getLatLng()]);n.value.fitBounds(m,{padding:[50,50]})}else n.value.setView([t,c],12);W()},x=()=>{if(!(!i.value?.latitude||!i.value?.longitude)){if(a.value[0]&&a.value[0].remove(),a.value[0]=d.marker([i.value.latitude,i.value.longitude],{icon:te()}).addTo(n.value),n.value.setView([i.value.latitude,i.value.longitude],12),S.value){const t=d.latLngBounds([[i.value.latitude,i.value.longitude],[S.value.latitude,S.value.longitude]]);n.value.fitBounds(t,{padding:[50,50]})}W()}},ee=()=>B.value?.logo?`<img src="${Re(B.value.logo)}" style="width: 32px; height: 32px; border-radius: 50%;">`:'<i class="material-icons" style="color: #1976D2; font-size: 32px;">school</i>',te=()=>d.divIcon({html:ee(),className:"custom-div-icon",iconSize:[32,32],iconAnchor:[16,16]}),oe=()=>d.divIcon({html:'<i class="material-icons" style="color: #21BA45; font-size: 32px;">person_pin_circle</i>',className:"custom-div-icon",iconSize:[32,32],iconAnchor:[16,32]}),W=()=>{if(a.value[2]&&a.value[2].remove(),a.value[0]&&a.value[1]){const t=[a.value[0].getLatLng(),a.value[1].getLatLng()];a.value[2]=d.polyline(t,{color:"red"}).addTo(n.value)}},ae=(t,c)=>{if(!i.value){s.notify({type:"negative",message:"Les coordonnées de l'école ne sont pas définies"});return}try{const v=i.value.latitude*Math.PI/180,b=t*Math.PI/180,A=(t-i.value.latitude)*Math.PI/180,H=(c-i.value.longitude)*Math.PI/180,O=Math.sin(A/2)*Math.sin(A/2)+Math.cos(v)*Math.cos(b)*Math.sin(H/2)*Math.sin(H/2),ve=2*Math.atan2(Math.sqrt(O),Math.sqrt(1-O));h.value=6371e3*ve}catch(m){console.error("Error calculating distance:",m),s.notify({type:"negative",message:"Erreur lors du calcul de la distance"})}},V=()=>{k.value=!0,p.value&&(s.platform.is.cordova,navigator.geolocation.clearWatch(p.value),p.value=null);const t=v=>{S.value={latitude:v.coords.latitude,longitude:v.coords.longitude},K(v.coords.latitude,v.coords.longitude),ae(v.coords.latitude,v.coords.longitude),k.value=!1},c=v=>{console.error("Error getting location:",v),k.value=!1;let b="Erreur lors de la localisation";switch(v.code){case 1:b="Permission de localisation refusée";break;case 2:b="Position indisponible";break;case 3:b="Délai d'attente dépassé";break}s.notify({type:"negative",message:b})},m={enableHighAccuracy:!0,timeout:1e4,maximumAge:0};s.platform.is.cordova||"geolocation"in navigator?p.value=navigator.geolocation.watchPosition(t,c,m):(k.value=!1,s.notify({type:"negative",message:"Géolocalisation non supportée par votre navigateur"}))},se=async()=>{try{await Promise.all([e.dispatch("ecole-geo/fetchGeoData")]),J(),i.value&&x(),V()}catch(t){console.error("Error loading school location:",t),s.notify({type:"negative",message:"Erreur lors du chargement des données de l'école"})}},ne=u(()=>e.getters["ecole/id"]);u(()=>e.getters["notifications/notifications"]);const z=u(()=>e.getters["notifications/lastNotification"]),ie=()=>e.dispatch("ecole/getId"),le=t=>{for(const[c,m]of Object.entries(t))e.dispatch("notifications/setFilter",{filter:c,value:m})},E=()=>e.dispatch("notifications/fetchNotifications"),re=async()=>{try{let t=await e.dispatch("badge/getInfo","EP-"+ne.value+"-PERS-"+L.value?.idpers);return Q.value=t,t}catch(t){console.error("Erreur lors de la creation de sortie:",t)}},ce=async()=>{let t=await re();t?.success&&(e.dispatch("notifications/resetCache"),E(),q.value&&q.value.subscribe("/topic/"+qe()+"-scan-"+t.data.notif,c=>{e.dispatch("notifications/resetCache"),E()}))},ue=t=>Ce.formatDate(t*1e3,"DD/MM/YYYY HH:mm"),de=u(()=>{if(!P.value)return!1;if(!z.value)return!0;const t=z.value.created_at*1e3,c=60*60*1e3;return Date.now()-t>=c});return be(()=>{G("Demande de sortie"),se(),ie(),le({eleve:L.value?.idpers,date:"last_hour"}),E(),Ie(t=>{q.value=t})}),we(()=>{p.value&&(s.platform.is.cordova,navigator.geolocation.clearWatch(p.value)),n.value&&n.value.remove(),q.value&&q.value.deactivate()}),{currentStudent:L,mapContainer:M,loading:k,distance:h,sortieInfo:Q,getCurrentLocation:V,userPhotoUrl:ke,isWithinRange:P,PROXIMITY_THRESHOLD:I,formatDistance:X,progressValue:Z,progressColor:j,submitDepartureRequest:ce,lastNotification:z,formatDate:ue,canRequestSortie:de}}}),Pe={class:"row q-col-gutter-md q-pa-md"},ze={class:"col-12"},Ee={class:"map-container"},Te={ref:"mapContainer",class:"map rounded-borders"},Ne={key:0,class:"distance-panel"},Qe={class:"text-h5 text-weight-bold"},Be={class:"text-weight-medium"},We={class:"row q-col-gutter-md"},Ve={class:"col-12 col-sm-6"},Ae={class:"row items-center no-wrap"},He={class:"text-weight-medium"},Oe={class:"col-12 col-sm-6"},$e={class:"row items-center no-wrap"},Ye={class:"text-weight-medium"},Fe={key:0,class:"row q-col-gutter-md q-mt-xs"},Ue={class:"col-12"},Ge={class:"row items-center no-wrap"},Xe={class:"col-auto"},Ze=["src"],je={class:"col q-ml-md"},Je={class:"text-h6"},Ke={class:"text-body2"},xe={class:"text-caption q-mt-xs"},et={key:0,class:"text-negative q-mt-xs"};function tt(e,s,M,n,a,h){return g(),C(he,{class:"page-content bg-grey-2"},{default:l(()=>[o("div",Pe,[o("div",ze,[r($,{flat:"",bordered:"",class:"map-card"},{default:l(()=>[o("div",Ee,[o("div",Te,null,512),e.distance!==null?(g(),w("div",Ne,[o("div",Qe,y(e.formatDistance(e.distance)),1),s[0]||(s[0]=o("div",{class:"text-caption text-grey-7"}," de l'école ",-1)),r(me,{value:e.progressValue,color:e.progressColor,class:"q-mt-sm",size:"xs",rounded:""},null,8,["value","color"])])):R("",!0),o("div",{class:Y(["status-panel",{"status-within-range":e.isWithinRange}])},[r(D,{name:e.isWithinRange?"check_circle":"location_off",color:e.isWithinRange?"positive":"grey",size:"24px",class:"q-mr-sm"},null,8,["name","color"]),o("span",Be,y(e.isWithinRange?"Zone valide":"Hors zone"),1)],2)]),r(T,null,{default:l(()=>[o("div",We,[o("div",Ve,[r(F,{class:"full-width location-btn",color:e.loading?"grey":"primary",loading:e.loading,onClick:e.getCurrentLocation},{default:l(()=>[o("div",Ae,[r(D,{name:e.loading?void 0:"my_location",size:"24px",class:"q-mr-sm"},null,8,["name"]),o("div",He,y(e.loading?"Localisation en cours...":"Actualiser ma position"),1)])]),_:1},8,["color","loading","onClick"])]),o("div",Oe,[r(F,{class:Y(["full-width presence-btn",{"presence-btn-active":e.isWithinRange}]),color:e.isWithinRange?"positive":"grey",disable:!e.canRequestSortie,onClick:e.submitDepartureRequest},{default:l(()=>[o("div",$e,[r(D,{name:"exit_to_app",size:"24px",class:"q-mr-sm"}),o("div",Ye,[e.isWithinRange?e.canRequestSortie?(g(),w(N,{key:2},[_("Envoyer une demande de sortie")],64)):(g(),w(N,{key:1},[_("Attendez une heure")],64)):(g(),w(N,{key:0},[_("Trop loin de l'école")],64))])]),e.isWithinRange?e.canRequestSortie?R("",!0):(g(),C(U,{key:1},{default:l(()=>s[1]||(s[1]=[_(" Vous devez attendre une heure entre chaque demande ")])),_:1})):(g(),C(U,{key:0},{default:l(()=>[_(" Vous devez être à moins de "+y(e.formatDistance(e.PROXIMITY_THRESHOLD.value))+" de l'école ",1)]),_:1}))]),_:1},8,["class","color","disable","onClick"])])])]),_:1})]),_:1}),e.currentStudent?(g(),w("div",Fe,[o("div",Ue,[r($,{class:"student-card"},{default:l(()=>[r(T,null,{default:l(()=>[o("div",Ge,[o("div",Xe,[r(fe,{size:"56px"},{default:l(()=>[o("img",{src:e.currentStudent.photo?e.userPhotoUrl(e.currentStudent):"default-avatar.png"},null,8,Ze)]),_:1})]),o("div",je,[o("div",Je,y(e.currentStudent.prenom)+" "+y(e.currentStudent.nom),1)])])]),_:1}),e.lastNotification?(g(),C(T,{key:0,class:"q-pt-none"},{default:l(()=>[r(Se,{dense:"",rounded:"",class:"bg-grey-2"},{avatar:l(()=>[r(D,{name:"notifications",color:"primary"})]),default:l(()=>[o("div",Ke,[_(" Dernière demande de sortie: "+y(e.formatDate(e.lastNotification.created_at))+" ",1),o("div",xe,[s[2]||(s[2]=_(" Status: ")),r(Me,{color:e.lastNotification.status===1?"positive":e.lastNotification.status===0?"warning":"negative"},{default:l(()=>[_(y(e.lastNotification.status===1?"Approuvée":e.lastNotification.status===0?"En attente":"Refusée"),1)]),_:1},8,["color"]),e.canRequestSortie?R("",!0):(g(),w("div",et," Vous devez attendre une heure entre chaque demande "))])])]),_:1})]),_:1})):R("",!0)]),_:1})])])):R("",!0)])])]),_:1})}const pt=ge(Le,[["render",tt]]);export{pt as default};
