import{Q as y}from"./QImg-BMvxJu3S.js";import{_ as I,b9 as B,ba as M,aB as T,b2 as L,b8 as P,as as R,at as V,ag as f,a4 as o,S as l,a5 as r,a6 as a,R as c,a8 as b,ab as d,aE as q,aF as E,a9 as g,aa as S,Q as m,a7 as k,ay as N,ad as p,ax as H,af as A,aD as j,aC as D,a3 as z,a as F,bc as O,aY as G,b5 as Y}from"./index-Bl2lQPd7.js";import{Q as J,a as v}from"./QItem-De3v03wU.js";import{Q as K}from"./QItemLabel-BkJiB6aE.js";import{Q as W}from"./QList-CMzNTEGD.js";import{Q as X}from"./QBadge-Bjfo5tRO.js";import{Q as Z}from"./QPopupProxy-CQ30ymZI.js";import{Q as $,l as ee}from"./linkify-html.es-DZPJD58y.js";import te from"./New-zUMJuIKd.js";import{_ as se}from"./Sender-NQvRmfc6.js";import"./QMenu-BNr9Tzvf.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./QToolbarTitle-C8APieXG.js";import"./QToolbar-DR-_wX4W.js";import"./QBreadcrumbs-D5k8AHhT.js";import"./QSelect-DchnWyXK.js";import"./QChip-C9OfA2gn.js";import"./rtl-DFPa-2ov.js";import"./format-IcNrutKL.js";import"./QTooltip-r7WoEuzy.js";import"./QUploaderAddTrigger-OZIUWg9a.js";import"./QUploader-Dwk8_y__.js";import"./QCircularProgress-C_b7NmsY.js";import"./QForm-Dk45GsL9.js";import"./ClosePopup-BY_YGFBZ.js";const{getScrollTarget:ae,setVerticalScrollPosition:re}=O,ie={data(){return{globalSettings:null,history,showReply:!1,log:""}},components:{NewMessage:te,SenderInfo:se},computed:{...V({user:"user/user",config:"user/config",current:"user/current",message:"message/message"}),eleve(){if(this.current&&this.current.hasOwnProperty("eleve"))return this.current.eleve},annee(){if(this.current&&this.current.hasOwnProperty("annee"))return this.current.annee}},methods:{...R({setStatus:"message/setStatus",setBar:"setBar",getMessage:"message/load",getMessages:"message/getInbox",messageStatus:"message/setStatus"}),openURL:P,toNow:L,userPhotoUrl:T,LetterAvatar:M,fileIcon:B,isImage(e){return Y(this.fileUrl(e))},messageEnvoye(e){this.show=!1,this.log=e,e&&e.id&&(this.$router.push("/admin/messages/view/"+e.id),this.$nextTick(()=>{this.setBar(!0),this.getMessage(e.id).then(()=>{this.message&&(this.scrollToElement(this.message),this.setBar(!1))})}))},canSee(e){return e.type_sender==="prof"?e.sender.id===this.user.id:!0},lu(e){e.sender_id!==this.user.id&&this.messageStatus({id:e.id,status:1}).then(i=>{})},fileUrl(e){return G(e)},text(e){let i=this.$cleanHtml(e.message);return e.quote&&(i="<blockquote>"+e.quote+"</blockquote>"+i),ee(i,{defaultProtocol:"https",target:"_blank"})},sub(e){return this.$cleanHtml(e)},isSent(e){return e.sender.idpers!==this.user.idpers},scrollToElement(e){this.$nextTick(()=>{let i=this.$refs["m-"+e.id][0].$el;const h=ae(i),_=i.offsetTop;re(h,_,500)})}},mounted(){this.$route.params.id&&this.getMessage(this.$route.params.id).then(()=>{this.message&&(this.scrollToElement(this.message),this.message.etat.length||this.lu(this.message))}),this.setTitle("Messagerie"),this.globalSettings||F("post","/settings").then(e=>{this.globalSettings=e.data})}},le={key:0},ne={class:"text-bold",style:{padding:"20px 16px 20px"}},oe=["innerHTML"];function me(e,i,h,_,u,s){const Q=f("sender-info"),w=f("new-message"),x=f("ep-footer");return l(),o(g,null,[r(D,{padding:"",class:"page-content"},{default:a(()=>[e.message?(l(),o("div",le,[b("div",ne,d(e.message.objet),1),r(q,{style:{margin:"0 -8px 0"}},{default:a(()=>[r(E,null,{default:a(()=>[(l(!0),o(g,null,S(e.message.thread.messages,(t,ue)=>(l(),o(g,{key:"m-"+t.id},[s.canSee(t)?(l(),m($,{key:0,stamp:s.toNow(t.created_at*1e3),sent:s.isSent(t),"text-color":"white","bg-color":s.isSent(t)?"green":"blue",ref_for:!0,ref:"m-"+t.id,class:"q-mb-lg"},{name:a(()=>[p(d(t.sender.nom+" "+t.sender.prenom),1)]),avatar:a(()=>[r(k,{class:A({"q-message-avatar":!0,"q-message-avatar--sent":s.isSent(t),"q-message-avatar--received":!s.isSent(t)})},{default:a(()=>[r(y,{ratio:"1",src:s.userPhotoUrl(t.sender),"placeholder-src":s.LetterAvatar(t.sender.nom)},null,8,["src","placeholder-src"]),s.isSent(t)?(l(),m(X,{key:0,floating:""},{default:a(()=>[p(d(t.type_sender),1)]),_:2},1024)):c("",!0),t.type_sender==="parent"?(l(),m(Z,{key:1},{default:a(()=>[r(Q,{data:t,first:e.message},null,8,["data","first"])]),_:2},1024)):c("",!0)]),_:2},1032,["class"])]),default:a(()=>[b("div",{innerHTML:s.text(t),style:{"max-width":"58vw"},class:"contained"},null,8,oe),t.fichiers.length?(l(),m(W,{key:0},{default:a(()=>[(l(!0),o(g,null,S(t.fichiers,(n,C)=>(l(),o(g,{key:C},[s.isImage(n)?(l(),m(y,{key:0,src:s.fileUrl(n),onClick:U=>s.openURL(s.fileUrl(n))},null,8,["src","onClick"])):(l(),m(J,{key:1,clickable:"",onClick:U=>s.openURL(s.fileUrl(n))},{default:a(()=>[r(v,{avatar:""},{default:a(()=>[r(k,{color:"white"},{default:a(()=>[r(N,{name:"img:"+s.fileIcon(n.fichier)},null,8,["name"])]),_:2},1024)]),_:2},1024),r(v,null,{default:a(()=>[r(K,{line:"1",class:"ellipsis",style:{"max-width":"30vw"}},{default:a(()=>[p(d(n.fichier),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"])),r(H)],64))),128))]),_:2},1024)):c("",!0)]),_:2},1032,["stamp","sent","bg-color"])):c("",!0)],64))),128))]),_:1})]),_:1})])):c("",!0),r(j,{modelValue:u.showReply,"onUpdate:modelValue":i[0]||(i[0]=t=>u.showReply=t),position:"bottom",maximized:!0},{default:a(()=>[r(w,{message:e.message,title:"Répondre","onMessage:sent":s.messageEnvoye,"global-settings":u.globalSettings},null,8,["message","onMessage:sent","global-settings"])]),_:1},8,["modelValue"])]),_:1}),r(x,{to:"#footer-portal"},{default:a(()=>[r(z,{onClick:i[1]||(i[1]=t=>u.showReply=!0),flat:"",icon:"reply",label:"répondre"})]),_:1})],64)}const Ee=I(ie,[["render",me]]);export{Ee as default};
