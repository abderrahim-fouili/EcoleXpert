import{_ as w,as as x,at as q,aW as T,J as b,Q as d,S as o,a6 as a,a5 as r,av as _,a3 as u,ad as p,ab as f,b6 as A,aF as F,a4 as y,a9 as U,aa as V,ay as j,R as m,a8 as c,cW as O,cX as S,a2 as k,b7 as B,aG as L,aE as M}from"./index-Bl2lQPd7.js";import{Q as N}from"./QToolbarTitle-C8APieXG.js";import{Q as v}from"./QBadge-Bjfo5tRO.js";import{Q as P}from"./QToolbar-DR-_wX4W.js";import{Q as z,a as E}from"./QBreadcrumbs-D5k8AHhT.js";import{Q as D}from"./QItemLabel-BkJiB6aE.js";import{Q as I,a as Q}from"./QItem-De3v03wU.js";import{Q as R}from"./QSelect-DchnWyXK.js";import{Q as g}from"./QTooltip-r7WoEuzy.js";import{Q as H}from"./QUploaderAddTrigger-OZIUWg9a.js";import{Q as G}from"./QUploader-Dwk8_y__.js";import{Q as J}from"./QForm-Dk45GsL9.js";import{C as W}from"./ClosePopup-BY_YGFBZ.js";import"./QChip-C9OfA2gn.js";import"./QMenu-BNr9Tzvf.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./rtl-DFPa-2ov.js";import"./format-IcNrutKL.js";import"./QCircularProgress-C_b7NmsY.js";const X={data(){return console.log(b.defaults.headers.common),{form:{objet:null,message:null,quote:null,destinataire:null,thread_id:null},destinataire:null,cfiles:0,step:null,steps:[],options:[]}},props:{message:{default:()=>null},title:{default:()=>"Nouveau message"}},computed:{...q({user:"user/user",config:"user/config",current:"user/current"}),headers(){return[{name:"Authorization",value:b.defaults.headers.common.Authorization}]},url(){return T("api")+"/messages/pj"}},methods:{...x({envoyer:"message/send"}),added(l){this.cfiles=l.length},removed(l){this.cfiles-=l.length},attach(){this.$nextTick(()=>{this.$refs.uploader.pickFiles()})},send(){this.$refs.form.validate().then(l=>{if(!l)return this.$q.notify({color:"negative",message:this.$t("stats.fields"),position:"bottom",icon:"error_outline",actions:[{label:this.$q.lang.label.close,color:"yellow"}]}),!1;this.cfiles>0?this.$refs.uploader.upload():this.sendMessage()})},sendMessage(l){let t=[];l&&(t=JSON.parse(l.xhr.response).result),console.log(this.steps),this.message&&this.message.thread_id&&(this.form.thread_id=this.message.thread_id,this.form.objet=this.message.objet),this.envoyer({form:this.form,files:t,filter:this.steps.map(s=>s.step==="service"?{type:"service",value:s.value?s.value.idrole:0,id:s.value?s.value.idrole:0,label:s.label}:s)}).then(s=>{this.$emit("message:sent",s)}).catch(s=>{this.$emit("message:error",s)})},choice(l){this.step=l.value.step,this.$nextTick(()=>{if(this.form.destinataire=this.destinataire.map(s=>s.value.idpers?{type:"personne",id:s.value.idpers,value:"personne_"+s.value.idpers,label:s.label}:s),this.step!=="personnes"&&l.value.value)this.destinataire=null,this.setOptions(),this.$refs.dest.refresh(),this.steps.push(l.value);else if(l.value.value===0)for(var t=0;t<this.steps.length;t++)this.steps[t].step===l.value.step&&delete this.steps[t]})},clear(){this.destinataire=null,this.step=null,this.steps=[],this.setOptions()},filterFn(l,t){if(console.log(l),!l||l===""){t(()=>{this.setOptions()});return}t(()=>{const s=l.toLowerCase();this.setOptions(),this.options=this.options.filter(h=>h.label.toLowerCase().indexOf(s)>-1)})},setOptions(){let l=[{label:"Profs",id:"prof",value:"prof",type:"type",step:"profs"},{label:"Administration",type:"type",value:"admin",id:"admin",step:"admin"}];if(this.config&&this.config.hasOwnProperty("meta")){let t=this.config.meta,s=[];this.form.destinataire&&this.form.destinataire.length>1&&(this.form.destinataire=[this.form.destinataire[this.form.destinataire.length-1]]);let h=this.form.destinataire;if(this.step)switch(this.step){case"admin":s=t.admins.map(i=>({label:i.description,value:i,step:"service",type:"service"})),this.options=[{label:"Tous les services",step:"service",type:"service",value:0,id:0},...s];break;case"service":h[0].value&&(s=h[0].value.utilisateurs.map(i=>({label:i.personnes.nom+" "+i.personnes.prenom,value:i.personnes,step:"personnes"})),this.options=[{label:"Tous les administrateurs",value:0,id:0,step:"personnes",type:"personne",ids:h[0].value.utilisateurs.map(i=>i.idpers)},...s]);break;case"profs":this.current.annee&&(s=this.current.annee.profs.map(i=>({label:i.nom+" "+i.prenom,value:i,step:"personnes"})),this.options=[{label:"Tous les profs",value:0,id:0,type:"personne",step:"personnes",ids:this.current.annee.profs.map(i=>i.idpers)},...s],this.$nextTick(()=>{this.steps.push({type:"eleve",step:"eleve",id:this.current.eleve.idpers,value:"eleve_"+this.current.eleve.idpers,label:this.current.eleve.nom+" "+this.current.eleve.prenom})}));break}else this.options=l}},hasDiscs(l){return l.value.disciplines&&l.value.disciplines.length},discs(l){return l.value.disciplines[0].description}},mounted(){this.setOptions()}},K={key:2},Y={class:"row"},Z={class:"col-xs-12"},$={class:"row no-wrap items-center q-pa-sm q-gutter-xs",style:{}},ee={class:"col"},se={class:"q-uploader__subtitle"};function te(l,t,s,h,i,n){return o(),d(M,null,{default:a(()=>[r(P,{class:"bg-secondary text-white shadow-2"},{default:a(()=>[_(r(u,{flat:"",dense:"",icon:"arrow_back"},null,512),[[W]]),r(N,null,{default:a(()=>[p(f(s.title),1)]),_:1}),r(u,{flat:"",dense:"",icon:"attach_file",onClick:n.attach},{default:a(()=>[_(r(v,{floating:"",color:"yellow-9"},{default:a(()=>[p(f(i.cfiles),1)]),_:1},512),[[A,i.cfiles>0]])]),_:1},8,["onClick"]),r(u,{class:"q-ml-lg",flat:"",icon:"send",onClick:n.send},null,8,["onClick"])]),_:1}),r(F,{style:{"overflow-y":"scroll"}},{default:a(()=>[r(z,{gutter:"none"},{separator:a(()=>[r(j,{name:"arrow_forward",color:"grey-9"})]),default:a(()=>[(o(!0),y(U,null,V(i.steps,(e,C)=>(o(),d(E,{key:"s-"+C},{default:a(()=>[r(v,{color:"grey-4","text-color":"grey-9"},{default:a(()=>[p(f(e.label),1)]),_:2},1024)]),_:2},1024))),128))]),_:1}),r(J,{class:"q-gutter-lg",ref:"form"},{default:a(()=>[s.message?m("",!0):(o(),d(R,{key:0,ref:"dest",behavior:"menu",filled:"",modelValue:i.destinataire,"onUpdate:modelValue":t[0]||(t[0]=e=>i.destinataire=e),options:i.options,"use-chips":"",multiple:"",label:"Destinataire","lazy-rules":"",rules:[e=>!!e||"Champ requis"],onAdd:n.choice},{option:a(e=>[r(I,O(e.itemProps,S(e.itemEvents)),{default:a(()=>[r(Q,null,{default:a(()=>[r(D,{innerHTML:e.opt.label},null,8,["innerHTML"])]),_:2},1024),e.opt.step==="personnes"?(o(),d(Q,{key:0,side:""},{default:a(()=>[n.hasDiscs(e.opt)?(o(),d(v,{key:0},{default:a(()=>[p(f(n.discs(e.opt)),1)]),_:2},1024)):m("",!0)]),_:2},1024)):m("",!0)]),_:2},1040)]),_:1},8,["modelValue","options","rules","onAdd"])),s.message?(o(),y("div",K," RE:"+f(s.message.objet),1)):(o(),d(k,{key:1,filled:"",modelValue:i.form.objet,"onUpdate:modelValue":t[1]||(t[1]=e=>i.form.objet=e),label:"Objet",hint:"","lazy-rules":"",rules:[e=>!!e||"Champ requis"]},null,8,["modelValue","rules"])),r(k,{filled:"",modelValue:i.form.message,"onUpdate:modelValue":t[2]||(t[2]=e=>i.form.message=e),autogrow:"",type:"textarea",label:"Message",rules:[e=>!!e||"Champ requis"],"lazy-rules":"","input-style":"min-height:150px"},null,8,["modelValue","rules"]),c("div",Y,[c("div",Z,[r(G,{"field-name":e=>"pieces_jointe[]",style:{width:"100%"},url:n.url,flat:"",multiple:"",headers:n.headers,ref:"uploader",batch:"",onAdded:n.added,onRemoved:n.removed,onUploaded:n.sendMessage},{header:a(e=>[c("div",$,[e.queuedFiles.length>0?(o(),d(u,{key:0,icon:"clear_all",onClick:e.removeQueuedFiles,round:"",dense:"",flat:""},{default:a(()=>[r(g,null,{default:a(()=>t[3]||(t[3]=[p("Clear All")])),_:1})]),_:2},1032,["onClick"])):m("",!0),e.uploadedFiles.length>0?(o(),d(u,{key:1,icon:"done_all",onClick:e.removeUploadedFiles,round:"",dense:"",flat:""},{default:a(()=>[r(g,null,{default:a(()=>t[4]||(t[4]=[p("Remove Uploaded Files")])),_:1})]),_:2},1032,["onClick"])):m("",!0),e.isUploading?(o(),d(B,{key:2,class:"q-uploader__spinner"})):m("",!0),c("div",ee,[t[5]||(t[5]=c("div",{class:"q-uploader__title"},"Fichiers joint",-1)),c("div",se,f(e.uploadSizeLabel)+" / "+f(e.uploadProgressLabel),1)]),e.canAddFiles?(o(),d(u,{key:3,type:"a",icon:"add_box",round:"",dense:"",flat:""},{default:a(()=>[r(H),r(g,null,{default:a(()=>t[6]||(t[6]=[p("Pick Files")])),_:1})]),_:1})):m("",!0),e.isUploading?(o(),d(u,{key:4,icon:"clear",onClick:e.abort,round:"",dense:"",flat:""},{default:a(()=>[r(g,null,{default:a(()=>t[7]||(t[7]=[p("Abort Upload")])),_:1})]),_:2},1032,["onClick"])):m("",!0)])]),_:1},8,["url","headers","onAdded","onRemoved","onUploaded"])])])]),_:1},512)]),_:1}),r(L,{align:"right",class:""},{default:a(()=>[r(u,{label:"Envoyer",icon:"send",onClick:n.send},null,8,["onClick"])]),_:1})]),_:1})}const Ce=w(X,[["render",te]]);export{Ce as default};
