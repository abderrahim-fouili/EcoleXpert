import{_ as J,aP as K,aO as W,A as m,B as T,Y as O,C as X,Q as v,S as r,a6 as a,a5 as t,aE as h,aF as p,a4 as f,ad as _,ay as q,a8 as o,av as A,a7 as C,aw as $,R as P,a3 as E,ab as u,ac as ee,af as te,ax as ae,a9 as se,aa as le,aD as H,aS as oe,aZ as ne,a_ as re,aG as ie,aC as de,a as D}from"./index-Bl2lQPd7.js";import{Q as ue}from"./QTooltip-r7WoEuzy.js";import{Q as ce}from"./QBadge-Bjfo5tRO.js";import{Q as z}from"./QItemLabel-BkJiB6aE.js";import{Q as B,a as V}from"./QItem-De3v03wU.js";import{Q as me}from"./QList-CMzNTEGD.js";import{Q as ve}from"./QSpinnerGears-DmolwAR1.js";import{Q as pe}from"./QInnerLoading-WxvcYHvS.js";import{Q as fe}from"./QSelect-DchnWyXK.js";import{C as ge}from"./ClosePopup-BY_YGFBZ.js";import{q as Y}from"./date-C1Mon-Jj.js";import{_ as _e}from"./StudentScan-BWckmCLy.js";import{_ as ye}from"./StudentScanBrowser-ChZDgZVt.js";import{u as xe}from"./composables-CAkrP3jA.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./QChip-C9OfA2gn.js";import"./QMenu-BNr9Tzvf.js";import"./rtl-DFPa-2ov.js";import"./format-IcNrutKL.js";import"./QToolbarTitle-C8APieXG.js";import"./QToolbar-DR-_wX4W.js";import"./QSpace-CKKoNTi_.js";import"./QBanner-xBGiroIy.js";import"./QBtnGroup-CdugIB7Z.js";import"./QSpinnerDots-BW9ZsFNG.js";import"./_commonjsHelpers-D6-XlEtG.js";const he={key:0,class:"q-mb-md bg-red-1 q-pa-md rounded-borders text-negative"},be={key:1,class:"q-gutter-md q-pa-md"},we={key:0},Se={class:"row q-col-gutter-md"},Qe={class:"col-12 col-sm-6"},ke={class:"col-12 col-sm-6"},qe={key:1},Ce={class:"row items-center justify-between"},Ee={class:"row items-center q-col-gutter-md"},ze={class:"col-auto"},Ve=["src"],Re={class:"col"},Ie={class:"text-h6 text-weight-bold text-primary"},Ae={class:"text-subtitle1 text-grey-8"},Pe={class:"text-subtitle1"},De={key:0,class:"q-mt-md"},Be={class:"row items-center q-gutter-x-md"},Le={class:"text-h5 text-weight-bold"},Ne={class:"text-body1"},Ue={key:0,class:"q-mt-md"},Te={class:"text-subtitle1 text-weight-bold"},Oe={class:"q-mt-md text-center"},$e=["src"],He={__name:"Index",setup(Ye){const F=K(),c=W(),{setTitle:M}=xe(),b=m(!1),w=m(!1),Q=m(!1),R=m(!1),S=m([]),y=m(null),d=m(null),k=m(!1),n=m(null),g=T(()=>F.getters["user/current"]?.annee),j=T(()=>Y.formatDate(Date.now(),"HH:mm")),L=l=>{l?document.body.classList.add("scan-active"):document.body.classList.remove("scan-active")},N=async l=>{if(w.value=!1,l&&l.idpers&&g.value?.idannee){b.value=!0;try{const{data:e}=await D("get",`/student-exit/info/${l.idpers}`,{params:{annee_id:g.value.idannee}});e?.status==="success"&&e.data?(d.value=e.data,n.value=null,I()):(c.notify({type:"warning",message:e?.message||"Élève non trouvé ou données incomplètes.",icon:"warning"}),x())}catch(e){console.error("Error fetching student info after scan:",e),c.notify({type:"negative",message:e.response?.data?.message||"Erreur lors de la récupération des informations de l'élève.",icon:"error"}),x()}finally{b.value=!1}}else c.notify({type:"negative",message:"Code QR invalide ou année scolaire non sélectionnée.",icon:"error"}),x()},G=async(l,e,s)=>{if(l.length<2){s();return}if(!g.value?.idannee){c.notify({type:"warning",message:"Veuillez sélectionner une année scolaire d'abord.",icon:"warning"}),s();return}R.value=!0;try{const{data:i}=await D("get","/student-exit/search",{params:{search:l,annee_id:g.value.idannee}});e(()=>{i?.status==="success"&&Array.isArray(i.data)?S.value=i.data:S.value=[]})}catch(i){console.error("Error filtering students:",i),e(()=>{S.value=[]}),c.notify({type:"negative",message:i.response?.data?.message||"Erreur lors de la recherche des élèves.",icon:"error"})}finally{R.value=!1}},Z=()=>{y.value&&(d.value=y.value,Q.value=!1,y.value=null,n.value=null,I())},x=()=>{d.value=null,n.value=null,y.value=null,S.value=[]},I=async()=>{if(!d.value||!g.value?.idannee){c.notify({type:"warning",message:"Veuillez sélectionner un élève et une année scolaire.",icon:"warning"});return}k.value=!0,b.value=!0;try{const{data:l}=await D("post","/student-exit/check",{student_id:d.value.idpers,annee_id:g.value.idannee,check_time:Y.formatDate(Date.now(),"YYYY-MM-DD HH:mm:ss")});l?.status==="success"&&l.data?n.value=l.data:(n.value=null,c.notify({type:"negative",message:l?.message||"Erreur lors de la vérification de la permission.",icon:"error"}))}catch(l){console.error("Error checking exit permission:",l),n.value=null,c.notify({type:"negative",message:l.response?.data?.message||"Échec de la vérification de la permission de sortie.",icon:"error"})}finally{k.value=!1,b.value=!1}},U=l=>{l.target.src="",l.target.onerror=null;const e=l.target,s=e.closest(".q-avatar");if(s){e.style.display="none";let i=s.querySelector(".q-icon");i?i.style.display="":(i=document.createElement("i"),i.classList.add("q-icon","material-icons"),i.textContent="person",s.appendChild(i),i.classList.add("text-grey"),i.style.fontSize="80px")}};return O(()=>g.value?.idannee,l=>{l?x():(x(),c.notify({type:"warning",message:"Aucune année scolaire sélectionnée.",icon:"warning"}))},{immediate:!0}),O(()=>w.value,l=>{l&&L(l)}),X(()=>{M("Vérification Sortie Élève")}),(l,e)=>(r(),v(de,{class:"page-content"},{default:a(()=>[t(h,{flat:""},{default:a(()=>[t(p,null,{default:a(()=>[g.value?.idannee?(r(),f("div",be,[d.value?(r(),f("div",qe,[t(h,{flat:"",bordered:"",class:"student-info-card"},{default:a(()=>[t(p,{class:"bg-primary text-white"},{default:a(()=>[o("div",Ce,[e[13]||(e[13]=o("div",{class:"text-h6 text-weight-bold"},"Élève sélectionné",-1)),t(E,{flat:"",round:"",dense:"",color:"white",icon:"close",onClick:x},{default:a(()=>[t(ue,null,{default:a(()=>e[12]||(e[12]=[_("Sélectionner un autre élève")])),_:1})]),_:1})])]),_:1}),t(p,null,{default:a(()=>[o("div",Ee,[o("div",ze,[t(C,{size:"80px"},{default:a(()=>[d.value.photoUrl?(r(),f("img",{key:0,src:d.value.photoUrl,onError:U},null,40,Ve)):(r(),v(q,{key:1,name:"person",size:"80px",color:"grey"}))]),_:1})]),o("div",Re,[o("div",Ie,u(d.value.nom_complet),1),o("div",Ae,u(d.value.classe_display),1),o("div",Pe,[e[14]||(e[14]=_(" Régime: ")),t(ce,{style:ee({backgroundColor:d.value.regime_color||"#000000",color:"#ffffff"}),label:d.value.regime_display||"Non assigné",class:"q-ml-sm"},null,8,["style","label"])])])])]),_:1})]),_:1}),n.value?(r(),f("div",De,[t(h,{class:te(["permission-result-card",n.value.status==="allowed"?"bg-green-1 text-green-10":n.value.status==="not_allowed"?"bg-red-1 text-red-10":"bg-grey-2 text-grey-9"])},{default:a(()=>[t(p,null,{default:a(()=>[o("div",Be,[t(q,{name:n.value.status==="allowed"?"check_circle":n.value.status==="not_allowed"?"block":"info",size:"xl",color:n.value.status==="allowed"?"positive":n.value.status==="not_allowed"?"negative":"grey"},null,8,["name","color"]),o("div",Le,u(n.value.status==="allowed"?"SORTIE AUTORISÉE":n.value.status==="not_allowed"?"SORTIE NON AUTORISÉE":"VÉRIFICATION NON APPLICABLE"),1)])]),_:1}),t(ae),t(p,null,{default:a(()=>[o("div",Ne,u(n.value.reason),1),n.value.remaining_sessions&&n.value.remaining_sessions.length>0?(r(),f("div",Ue,[o("div",Te,"Séances restantes aujourd'hui après "+u(j.value)+":",1),t(me,{dense:"",bordered:"",separator:"",class:"q-mt-sm rounded-borders"},{default:a(()=>[(r(!0),f(se,null,le(n.value.remaining_sessions,s=>(r(),v(B,{key:s.emploi_classe_id},{default:a(()=>[t(V,null,{default:a(()=>[t(z,null,{default:a(()=>[_(u(s.matiere),1)]),_:2},1024),t(z,{caption:""},{default:a(()=>[_(u(s.debut)+" - "+u(s.fin)+" | Salle: "+u(s.salle),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})])):P("",!0)]),_:1})]),_:1},8,["class"])])):P("",!0),o("div",Oe,[t(E,{size:"lg",color:"secondary",label:"Vérifier la Permission de Sortie",onClick:I,loading:k.value,disable:!d.value||k.value},null,8,["loading","disable"])])])):(r(),f("div",we,[e[11]||(e[11]=o("div",{class:"text-subtitle1 q-mb-md"},"Sélectionner un élève :",-1)),o("div",Se,[o("div",Qe,[A((r(),v(h,{flat:"",bordered:"",class:"selection-option-card cursor-pointer",onClick:e[0]||(e[0]=s=>w.value=!0)},{default:a(()=>[t(p,{class:"text-center q-pa-lg"},{default:a(()=>[t(C,{size:"72px",color:"secondary","text-color":"white",icon:"qr_code_scanner"}),e[7]||(e[7]=o("div",{class:"text-h6 text-secondary q-mt-md"},"Scanner Badge QR",-1)),e[8]||(e[8]=o("div",{class:"text-subtitle2 text-grey-7"},"Utiliser la caméra pour scanner le code QR du badge de l'élève.",-1))]),_:1})]),_:1})),[[$]])]),o("div",ke,[A((r(),v(h,{flat:"",bordered:"",class:"selection-option-card cursor-pointer",onClick:e[1]||(e[1]=s=>Q.value=!0)},{default:a(()=>[t(p,{class:"text-center q-pa-lg"},{default:a(()=>[t(C,{size:"72px",color:"primary","text-color":"white",icon:"search"}),e[9]||(e[9]=o("div",{class:"text-h6 text-primary q-mt-md"},"Rechercher Manuellement",-1)),e[10]||(e[10]=o("div",{class:"text-subtitle2 text-grey-7"},"Rechercher un élève par nom ou matricule.",-1))]),_:1})]),_:1})),[[$]])])])]))])):(r(),f("div",he,[t(q,{name:"warning",color:"negative",class:"q-mr-sm"}),e[6]||(e[6]=_(" Veuillez sélectionner une année scolaire dans le menu de navigation pour effectuer la vérification de sortie. "))]))]),_:1}),t(pe,{showing:b.value},{default:a(()=>[t(ve,{size:"50px",color:"primary"})]),_:1},8,["showing"])]),_:1}),t(H,{modelValue:w.value,"onUpdate:modelValue":e[2]||(e[2]=s=>w.value=s),maximized:"","transition-show":"slide-left","transition-hide":"slide-right",onHide:e[3]||(e[3]=s=>L(!1))},{default:a(()=>[oe(c).platform.is.cordova?(r(),v(_e,{key:0,onStudentSelected:N})):(r(),v(ye,{key:1,onStudentSelected:N}))]),_:1},8,["modelValue"]),t(H,{modelValue:Q.value,"onUpdate:modelValue":e[5]||(e[5]=s=>Q.value=s)},{default:a(()=>[t(h,{style:{width:"90vw","max-width":"600px"}},{default:a(()=>[t(p,null,{default:a(()=>e[15]||(e[15]=[o("div",{class:"text-h6"},"Rechercher et sélectionner un élève",-1)])),_:1}),t(p,{class:"q-pt-none"},{default:a(()=>[t(fe,{filled:"",modelValue:y.value,"onUpdate:modelValue":e[4]||(e[4]=s=>y.value=s),options:S.value,"option-label":"nom_complet","option-value":"idpers",label:"Entrez le nom ou prénom de l'élève","use-input":"","hide-selected":"","fill-input":"","input-debounce":"300",onFilter:G,loading:R.value,clearable:""},{"no-option":a(()=>[t(B,null,{default:a(()=>[t(V,{class:"text-grey"},{default:a(()=>e[16]||(e[16]=[_(" Aucun élève trouvé. Essayez une autre recherche. ")])),_:1})]),_:1})]),option:a(s=>[t(B,ne(re(s.itemProps)),{default:a(()=>[t(V,{avatar:""},{default:a(()=>[t(C,{size:"md"},{default:a(()=>[s.opt.photoUrl?(r(),f("img",{key:0,src:s.opt.photoUrl,onError:U},null,40,$e)):(r(),v(q,{key:1,name:"person",size:"md",color:"grey"}))]),_:2},1024)]),_:2},1024),t(V,null,{default:a(()=>[t(z,null,{default:a(()=>[_(u(s.opt.nom_complet),1)]),_:2},1024),s.opt.classe_display?(r(),v(z,{key:0,caption:""},{default:a(()=>[_(u(s.opt.classe_display),1)]),_:2},1024)):P("",!0)]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","options","loading"])]),_:1}),t(ie,{align:"right"},{default:a(()=>[A(t(E,{flat:"",label:"Annuler",color:"primary"},null,512),[[ge]]),t(E,{flat:"",label:"Sélectionner",color:"primary",onClick:Z,disable:!y.value},null,8,["disable"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}},yt=J(He,[["__scopeId","data-v-1d2ef036"]]);export{yt as default};
