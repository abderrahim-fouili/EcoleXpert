import{Q as R}from"./QImg-BMvxJu3S.js";import{_ as B,as as E,at as P,aW as Y,J as M,Q as m,S as d,a6 as r,a5 as e,av as S,a3 as v,ad as i,ab as a,b6 as O,aF as A,a8 as h,a2 as G,R as _,b7 as H,aG as j,aE as q,ba as J,aB as F,bb as W,b2 as K,b8 as X,ag as T,a4 as g,a7 as V,af as Z,a9 as y,ax as D,aa as U,ay as L,aD as $,aC as ee,bc as te,aY as N}from"./index-Bl2lQPd7.js";import{Q,a as c}from"./QItem-De3v03wU.js";import{Q as p}from"./QItemLabel-BkJiB6aE.js";import{Q as x}from"./QList-CMzNTEGD.js";import{Q as b}from"./QTooltip-r7WoEuzy.js";import{q as re}from"./date-C1Mon-Jj.js";import{Q as le}from"./QToolbarTitle-C8APieXG.js";import{Q as se}from"./QBadge-Bjfo5tRO.js";import{Q as ae}from"./QToolbar-DR-_wX4W.js";import{Q as ie}from"./QUploaderAddTrigger-OZIUWg9a.js";import{Q as oe}from"./QUploader-Dwk8_y__.js";import{Q as de}from"./QForm-Dk45GsL9.js";import{C as ne}from"./ClosePopup-BY_YGFBZ.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./format-IcNrutKL.js";import"./QCircularProgress-C_b7NmsY.js";const ue={data(){return{form:{message:null,meta:{},devoir_id:null},destinataire:null,cfiles:0,options:[]}},props:{devoir:{default:()=>null},title:{default:()=>"Nouveau devoir"}},computed:{...P({user:"user/user",config:"user/config",current:"user/current"}),headers(){return[{name:"Authorization",value:M.defaults.headers.common.Authorization}]},url(){return Y("api")+"/devoirs/pj"}},methods:{...E({envoyer:"devoirs/send"}),added(t){this.cfiles=t.length},removed(t){this.cfiles-=t.length},attach(){this.$nextTick(()=>{this.$refs.uploader.pickFiles()})},send(){this.$refs.form.validate().then(t=>{if(!t)return this.$q.notify({color:"negative",message:this.$t("stats.fields"),position:"bottom",icon:"error_outline",actions:[{label:this.$q.lang.label.close,color:"yellow"}]}),!1;this.cfiles>0?this.$refs.uploader.upload():this.sendDevoir()})},sendDevoir(t){let l=[];t&&(l=JSON.parse(t.xhr.response).result),this.devoir&&(this.form.devoir_id=this.devoir.id),this.form.eleve_id=this.current.eleve.idpers,this.envoyer({form:this.form,files:l}).then(n=>{this.$emit("devoir:sent",n)}).catch(n=>{this.$emit("devoir:error",n)})},hasDiscs(t){return t.value.disciplines&&t.value.disciplines.length},discs(t){return t.value.disciplines[0].description}},mounted(){}},fe={class:"row"},ce={class:"col-xs-12"},ve={class:"row no-wrap items-center q-pa-sm q-gutter-xs",style:{}},pe={class:"col"},me={class:"q-uploader__subtitle"};function he(t,l,n,k,f,s){return d(),m(q,null,{default:r(()=>[e(ae,{class:"bg-secondary text-white shadow-2"},{default:r(()=>[S(e(v,{flat:"",dense:"",icon:"arrow_back"},null,512),[[ne]]),e(le,null,{default:r(()=>[i(a(n.title),1)]),_:1}),e(v,{flat:"",dense:"",icon:"attach_file",onClick:s.attach},{default:r(()=>[S(e(se,{floating:"",color:"yellow-9"},{default:r(()=>[i(a(f.cfiles),1)]),_:1},512),[[O,f.cfiles>0]])]),_:1},8,["onClick"]),e(v,{class:"q-ml-lg",flat:"",icon:"send",onClick:s.send},null,8,["onClick"])]),_:1}),e(A,{style:{"overflow-y":"scroll"}},{default:r(()=>[e(de,{class:"q-gutter-lg",ref:"form"},{default:r(()=>[e(G,{filled:"",modelValue:f.form.message,"onUpdate:modelValue":l[0]||(l[0]=o=>f.form.message=o),autogrow:"",type:"textarea",label:"Message",rules:[o=>!!o||"Champ requis"],"input-style":"min-height:150px"},null,8,["modelValue","rules"]),h("div",fe,[h("div",ce,[e(oe,{"field-name":o=>"pieces_jointe[]",style:{width:"100%"},url:s.url,flat:"",multiple:"",headers:s.headers,ref:"uploader",batch:"",onAdded:s.added,onRemoved:s.removed,onUploaded:s.sendDevoir},{header:r(o=>[h("div",ve,[o.queuedFiles.length>0?(d(),m(v,{key:0,icon:"clear_all",onClick:o.removeQueuedFiles,round:"",dense:"",flat:""},{default:r(()=>[e(b,null,{default:r(()=>l[1]||(l[1]=[i("Clear All")])),_:1})]),_:2},1032,["onClick"])):_("",!0),o.uploadedFiles.length>0?(d(),m(v,{key:1,icon:"done_all",onClick:o.removeUploadedFiles,round:"",dense:"",flat:""},{default:r(()=>[e(b,null,{default:r(()=>l[2]||(l[2]=[i("Remove Uploaded Files")])),_:1})]),_:2},1032,["onClick"])):_("",!0),o.isUploading?(d(),m(H,{key:2,class:"q-uploader__spinner"})):_("",!0),h("div",pe,[l[3]||(l[3]=h("div",{class:"q-uploader__title"},"Fichiers joint",-1)),h("div",me,a(o.uploadSizeLabel)+" / "+a(o.uploadProgressLabel),1)]),o.canAddFiles?(d(),m(v,{key:3,type:"a",icon:"add_box",round:"",dense:"",flat:""},{default:r(()=>[e(ie),e(b,null,{default:r(()=>l[4]||(l[4]=[i("Pick Files")])),_:1})]),_:1})):_("",!0),o.isUploading?(d(),m(v,{key:4,icon:"clear",onClick:o.abort,round:"",dense:"",flat:""},{default:r(()=>[e(b,null,{default:r(()=>l[5]||(l[5]=[i("Abort Upload")])),_:1})]),_:2},1032,["onClick"])):_("",!0)])]),_:1},8,["url","headers","onAdded","onRemoved","onUploaded"])])]),e(j,{align:"right",class:""},{default:r(()=>[e(v,{label:"Envoyer",icon:"send",onClick:s.send},null,8,["onClick"])]),_:1})]),_:1},512)]),_:1})]),_:1})}const _e=B(ue,[["render",he]]),{getScrollTarget:ge,setVerticalScrollPosition:ke}=te,ye={data(){return{history,showReply:!1,log:""}},components:{NewDevoir:_e},computed:{...P({user:"user/user",config:"user/config",current:"user/current",devoir:"devoirs/devoir",reponses:"devoirs/reponses"}),eleve(){if(this.current&&this.current.hasOwnProperty("eleve"))return this.current.eleve},annee(){if(this.current&&this.current.hasOwnProperty("annee"))return this.current.annee}},methods:{...E({setStatus:"devoir/setStatus",setBar:"setBar",getDevoir:"devoirs/load",getDevoirs:"devoirs/getDevoirs",getReponses:"devoirs/getReponses",devoirStatus:"devoirs/setStatus"}),openURL:X,toNow:K,isArabic:W,userPhotoUrl:F,LetterAvatar:J,personAvatar(t){return F(t)},fileUrl(t){return N(t)},disc(t){let l="";for(var n=0;n<this.annee.profs.length;n++){let k=this.annee.profs[n];if(k.idpers===t.idpers&&k.disciplines.length)return k.disciplines.map(f=>f.description).join(", ")}return l},devoirEnvoye(t){this.showReply=!1,this.getReponses({devoir_id:this.devoir.id,eleve_id:this.eleve.idpers}).then(()=>{})},canSee(t){return!0},lu(t){t.personne_id!==this.user.id&&this.devoirStatus({id:t.id,status:1}).then(l=>{this.getDevoirs({page:1,filter:{annee:this.annee.idannee,classe:this.annee.pivot.idclasse}})})},fileUrl(t){return N(t)},text(t){let l=t.devoir;return t.quote&&(l="<blockquote>"+t.quote+"</blockquote>"+l),[l]},sub(t){return this.$cleanHtml(t)},isSent(t){return t.sender.idpers!==this.user.idpers},scrollToElement(t){this.$nextTick(()=>{let l=this.$refs["m-"+t.id][0].$el;const n=ge(l),k=l.offsetTop;ke(n,k,500)})},date(t){return re.formatDate(t*1e3,"YYYY-MM-DD")}},mounted(){this.$route.params.id&&this.getDevoir(this.$route.params.id).then(()=>{this.devoir&&(this.devoir.etat.length||this.lu(this.devoir),this.getReponses({devoir_id:this.devoir.id,eleve_id:this.eleve.idpers}))}),this.setTitle("Devoirs")}},be={key:0},Qe={class:"text-bold",style:{padding:"20px 16px 20px"}},Ce={key:1};function we(t,l,n,k,f,s){const o=T("new-devoir"),I=T("ep-footer");return d(),g(y,null,[e(ee,{padding:"",class:"page-content"},{default:r(()=>[t.devoir?(d(),g("div",be,[h("div",Qe,a(t.devoir.objet),1),e(q,{style:{margin:"0 -8px 0"}},{default:r(()=>[e(Q,null,{default:r(()=>[e(c,{avatar:""},{default:r(()=>[e(V,null,{default:r(()=>[e(R,{src:s.personAvatar(t.devoir.prof),"placeholder-src":s.LetterAvatar(t.devoir.prof.nom)},null,8,["src","placeholder-src"])]),_:1})]),_:1}),e(c,null,{default:r(()=>[e(p,null,{default:r(()=>[i(a(t.devoir.prof.nom)+" "+a(t.devoir.prof.prenom),1)]),_:1}),e(p,{caption:""},{default:r(()=>[i(a(s.disc(t.devoir.prof)),1)]),_:1})]),_:1}),e(c,{side:""},{default:r(()=>[e(p,{caption:""},{default:r(()=>[i(a(s.toNow(t.devoir.created_at*1e3)),1)]),_:1}),e(p,null,{default:r(()=>l[2]||(l[2]=[i("   ")])),_:1})]),_:1})]),_:1}),e(A,null,{default:r(()=>[h("pre",{class:Z({rtl:s.isArabic(t.devoir.descriptif)})},a(t.devoir.descriptif),3)]),_:1}),t.devoir.fichiers&&t.devoir.fichiers.length?(d(),g(y,{key:0},[e(D),e(x,{separator:""},{default:r(()=>[(d(!0),g(y,null,U(t.devoir.fichiers,(u,C)=>(d(),m(Q,{clickable:"",onClick:w=>s.openURL(s.fileUrl(u)),key:"f-"+C},{default:r(()=>[e(c,{avatar:""},{default:r(()=>[e(L,{name:"attachment"})]),_:1}),e(c,null,{default:r(()=>[e(p,null,{default:r(()=>[i(a(u.fichier),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})],64)):_("",!0),e(D),e(j,{align:"right"},{default:r(()=>[e(v,{flat:"",icon:"event",color:"positive"},{default:r(()=>[i("  A RENDRE: "+a(s.date(t.devoir.rendre_le)),1)]),_:1})]),_:1})]),_:1})])):_("",!0),t.reponses.length?(d(),g("div",Ce,[(d(!0),g(y,null,U(t.reponses,(u,C)=>(d(),m(q,{class:"q-mt-md",key:"rk-"+C},{default:r(()=>[e(Q,null,{default:r(()=>[e(c,{avatar:""},{default:r(()=>[e(V,null,{default:r(()=>[e(R,{src:s.personAvatar(s.eleve),"placeholder-src":s.LetterAvatar(s.eleve.nom)},null,8,["src","placeholder-src"])]),_:1})]),_:1}),e(c,null,{default:r(()=>[e(p,null,{default:r(()=>[i(a(s.eleve.nom)+" "+a(s.eleve.prenom),1)]),_:1})]),_:1}),e(c,{side:""},{default:r(()=>[e(p,{caption:""},{default:r(()=>[i(a(s.toNow(u.created_at*1e3))+" ",1),e(b,null,{default:r(()=>[i(a(s.date(u.created_at)),1)]),_:2},1024)]),_:2},1024),e(p,null,{default:r(()=>l[3]||(l[3]=[i("   ")])),_:1})]),_:2},1024)]),_:2},1024),e(A,null,{default:r(()=>[i(a(u.message),1)]),_:2},1024),u.fichiers&&u.fichiers.length?(d(),g(y,{key:0},[e(D),e(x,{separator:""},{default:r(()=>[(d(!0),g(y,null,U(u.fichiers,(w,z)=>(d(),m(Q,{clickable:"",onClick:De=>s.openURL(s.fileUrl(w)),key:"f-"+z},{default:r(()=>[e(c,{avatar:""},{default:r(()=>[e(L,{name:"attachment"})]),_:1}),e(c,null,{default:r(()=>[e(p,null,{default:r(()=>[i(a(w.fichier),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:2},1024)],64)):_("",!0)]),_:2},1024))),128))])):_("",!0),l[4]||(l[4]=h("div",{style:{height:"50px"}},null,-1)),e($,{modelValue:f.showReply,"onUpdate:modelValue":l[0]||(l[0]=u=>f.showReply=u),position:"bottom",maximized:!0},{default:r(()=>[e(o,{devoir:t.devoir,title:"Répondre","onDevoir:sent":s.devoirEnvoye},null,8,["devoir","onDevoir:sent"])]),_:1},8,["modelValue"])]),_:1}),e(I,{to:"#footer-portal"},{default:r(()=>[e(v,{onClick:l[1]||(l[1]=u=>f.showReply=!0),flat:"",icon:"reply",label:"répondre"})]),_:1})],64)}const Me=B(ye,[["render",we]]);export{Me as default};
