import{bV as Tt,bX as Ct,_ as dt,aO as ut,aP as mt,B as se,A as h,aW as Mt,J as St,aU as fe,aX as je,a as Y,aB as ke,N as k,Y as ve,a4 as V,S as n,a5 as t,a6 as s,aE as Se,av as F,a3 as g,ad as v,ab as x,b6 as Dt,ah as De,Q as f,R as y,aF as pe,a8 as r,aS as I,aZ as At,a_ as Pt,a7 as ie,a9 as G,aa as Fe,ay as D,a2 as A,ax as oe,aV as Oe,b5 as Ee,aY as ot,b9 as Nt,b7 as Ut,aG as ct,aD as Ye,ac as st,b8 as qt,aR as It,C as Qt,aM as $t,aC as Rt}from"./index-Bl2lQPd7.js";import{Q as ye}from"./QDate-C_jC-zMt.js";import{Q as ee}from"./QPopupProxy-CQ30ymZI.js";import{Q as re}from"./QSelect-DchnWyXK.js";import{Q as U}from"./QItemLabel-BkJiB6aE.js";import{Q as Z,a as P}from"./QItem-De3v03wU.js";import{Q as Ke}from"./QChip-C9OfA2gn.js";import{Q as z}from"./QTooltip-r7WoEuzy.js";import{Q as Ft}from"./QVirtualScroll-CENgsPEr.js";import{Q as Ot}from"./QPagination-UgiQF7o2.js";import{Q as _t}from"./QList-CMzNTEGD.js";import{C as O}from"./ClosePopup-BY_YGFBZ.js";import{q as ge}from"./date-C1Mon-Jj.js";import{Q as Ae}from"./QSpinnerDots-BW9ZsFNG.js";import{u as Yt}from"./composables-CAkrP3jA.js";import{Q as it}from"./QToolbarTitle-C8APieXG.js";import{Q as zt}from"./QBadge-Bjfo5tRO.js";import{Q as rt}from"./QToolbar-DR-_wX4W.js";import{Q as ze}from"./QTime-DY-qDies.js";import{Q as Bt}from"./QBanner-xBGiroIy.js";import{Q as nt}from"./QImg-BMvxJu3S.js";import{Q as Ht}from"./QUploaderAddTrigger-OZIUWg9a.js";import{Q as Lt}from"./QUploader-Dwk8_y__.js";import{Q as jt}from"./QForm-Dk45GsL9.js";import{Q as Kt}from"./QSpace-CKKoNTi_.js";import{_ as Wt}from"./StaffScan-AD3bmvlA.js";import{u as Gt}from"./vue-i18n.runtime-CqbAde2-.js";import"./use-render-cache-DLxPkVnQ.js";import"./use-datetime-hbLWgGn4.js";import"./format-IcNrutKL.js";import"./QMenu-BNr9Tzvf.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./rtl-DFPa-2ov.js";import"./TouchPan-jBhMORlX.js";import"./touch-BjYP5sR0.js";import"./QCircularProgress-C_b7NmsY.js";import"./QBtnGroup-CdugIB7Z.js";function Jt(te){const Q=document.createElement("textarea");Q.value=te,Q.contentEditable="true",Q.style.position="fixed";const c=()=>{};Tt(c),document.body.appendChild(Q),Q.focus(),Q.select();const j=document.execCommand("copy");return Q.remove(),Ct(c),j}function Xt(te){return navigator.clipboard!==void 0?navigator.clipboard.writeText(te):new Promise((Q,c)=>{const j=Jt(te);j?Q(!0):c(j)})}const Zt={key:0,class:"text-center"},ea={key:1,class:"grid grid-cols-1 md:grid-cols-6 gap-4"},ta={class:"md:col-span-5"},aa=["src"],la={key:0},oa=["src"],sa={key:0},ia={class:"text-weight-medium"},ra={key:2,class:"q-pa-md text-grey-7 bg-grey-2 rounded-borders text-center"},na={key:3,class:"q-pa-md text-red-7 bg-red-1 rounded-borders row items-center justify-center"},da={class:"flex items-start justify-end"},ua={class:"md:col-span-2"},ma={class:"row items-center justify-end"},ca={class:""},_a={class:"row items-center justify-end"},pa={class:"md:col-span-6"},fa={class:"md:col-span-6"},va={class:"md:col-span-2"},ya={class:"md:col-span-2"},ga={class:"row items-center justify-end"},ba={class:""},Va={class:"row items-center justify-end"},ha={class:"md:col-span-6"},wa={class:"md:col-span-3"},xa={class:"md:col-span-3"},ka={key:0,class:"md:col-span-6"},Ea={key:1,class:"md:col-span-6"},Ta={class:"md:col-span-3"},Ca={class:"md:col-span-3"},Ma={class:"md:col-span-2"},Sa={class:"row items-center justify-end"},Da={class:""},Aa={class:"row items-center justify-end"},Pa={class:"md:col-span-3"},Na={class:"md:col-span-3"},Ua={class:"md:col-span-6"},qa={class:"md:col-span-6"},Ia={class:"md:col-span-6"},Qa={class:"md:col-span-3"},$a={class:"md:col-span-3"},Ra={class:"md:col-span-3"},Fa={class:"md:col-span-3"},Oa={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"},Ya={key:0,class:""},za={key:1,class:"md:col-span-2 lg:col-span-3"},Ba={class:"grid grid-cols-1 gap-4"},Ha={class:""},La={class:"row no-wrap items-center q-pa-sm q-gutter-xs",style:{}},ja={class:"col"},Ka={class:"q-uploader__subtitle"},Wa=["src"],Ga=["href"],Ja={key:2,class:"flex flex-center fit column"},q="ELEV",Be="USER",He="ADMIN",Le="PROF",Xa={__name:"InfirmaryVisitFormDialog",props:{isDialogVisible:Boolean,visitId:[Number,String,null],isViewMode:Boolean},emits:["update:isDialogVisible","visitSaved"],setup(te,{emit:Q}){const c=te,j=Q,me=ut(),B=mt(),$=se(()=>B.getters["user/currentAnnee"]?.idannee||B.getters["user/current"]?.annee?.idannee),J=se(()=>B.getters["user/user"]?.idpers),T=h(!0),w=h(Mt("api")+"/infirmary/pj"),C=h([{name:"Authorization",value:St.defaults.headers.common.Authorization}]),ce=()=>({id_person_visited:null,id_person_visited_model:null,idannee:$.value||null,visit_datetime:null,visit_date:ge.formatDate(Date.now(),"YYYY-MM-DD"),visit_time:ge.formatDate(Date.now(),"HH:mm"),motif_visit:"",care_provided:"",outcome_type:null,outcome_datetime:null,outcome_date:null,outcome_time:null,outcome_details:"",id_accompanying_adult_internal:null,accompanying_adult_outsider_name:"",family_contact_attempted:!1,family_contact_successful:!1,family_contact_datetime:null,family_contact_date:null,family_contact_time:null,family_contact_person_name:"",family_contact_method:null,family_contact_notes:"",formal_notification_sent:!1,id_infirmary_staff:J.value||null,created_at:null,updated_at:null,created_by_user_name:null,updated_by_user_name:null,fichiers:[]}),o=fe(ce()),_=h(null),H=h(!1),M=fe({form:!1,staff:!1,outcomeTypes:!1,familyContactMethods:!1}),i=h({}),X=h(0),K=h(null),L=h(null),{t:Pe}=Gt(),Ne=l=>{X.value=l.length},be=l=>{X.value-=l.length},Ue=()=>{It(()=>{K.value?K.value.pickFiles():console.warn("Uploader ref not yet available")})},qe=async()=>{if(!L.value){console.warn("Form ref not yet available");return}if(!await L.value.validate())return me.notify({color:"negative",message:Pe("stats.fields"),position:"bottom",icon:"error_outline",actions:[{label:me.lang.label.close,color:"yellow"}]}),!1;X.value>0?K.value?K.value.upload():console.warn("Uploader ref not yet available for upload"):Ze()},Ve=()=>{i.value={}},W=h([]),ae=h([]),S=h([]),he=h([]),we=h([]),_e=se({get:()=>c.isDialogVisible,set:l=>j("update:isDialogVisible",l)}),R=se(()=>c.isViewMode),p=se(()=>!!c.visitId&&!c.isViewMode),d=se(()=>c.isViewMode?"Détails de la Visite":p.value?"Modifier Visite Infirmerie":"Nouvelle Visite Infirmerie"),m=h(!1),N=h(""),ne=h(""),We=l=>{const e=ot(l);e?(N.value=e,ne.value=l.fichier||"Document",m.value=!0):k.create({type:"negative",message:"Impossible de générer l'URL du fichier pour l'aperçu.",position:"top"})},pt=()=>{N.value="",ne.value=""},Ie=(l,e)=>l&&e?`${l} ${e}:00`:null,Qe=l=>{if(l){const[e,a]=l.split(" "),u=a?a.substring(0,5):null;return{date:e,time:u}}return{date:null,time:null}},Ge=()=>{Object.assign(o,ce()),_.value=null,S.value=[],ae.value=[...W.value],T.value=!0,Ve(),K.value&&K.value.reset(),X.value=0},xe=h(!1),ft=()=>{xe.value=!0},vt=l=>{if(!l||!l.idpers){k.create({type:"warning",message:"Données personne invalides.",position:"top"});return}const e={idpers:l.idpers,displayName:`${l.nom} ${l.prenom}`,type:l.type,photo_url:l.photo?ke(l):null,classe_bref:l.visited_person_class||(l.type===q&&l.classe?l.classe.BREF:l.type===q?"N/A":null)};o.id_person_visited_model=e,S.value.some(a=>a.idpers===e.idpers)||S.value.unshift(e),$e(e,!1),xe.value=!1},yt=async()=>{if(Ge(),M.form=!0,await Promise.all([bt(),Vt(),ht()]),c.visitId)try{const{data:l}=await Y("get",`/infirmary/visits/${c.visitId}`);if(l){if(o.id_person_visited=l.id_person_visited,l.person_visited){const E={idpers:l.person_visited.idpers,displayName:`${l.person_visited.nom} ${l.person_visited.prenom}`,type:l.person_visited.type,photo_url:l.person_visited.photo?ke(l.person_visited):null,classe_bref:l.visited_person_class||(l.person_visited.type===q&&l.person_visited.classe?l.person_visited.classe.BREF:l.person_visited.type===q?"N/A":null)};o.id_person_visited_model=E,S.value.some(b=>b.idpers===E.idpers)||S.value.unshift(E),await $e(E,!1),_.value?T.value=!1:T.value=!0}else T.value=!0;o.idannee=l.idannee;const e=Qe(l.visit_datetime);o.visit_date=e.date,o.visit_time=e.time,o.motif_visit=l.motif_visit,o.care_provided=l.care_provided,o.outcome_type=l.outcome_type;const a=Qe(l.outcome_datetime);o.outcome_date=a.date,o.outcome_time=a.time,o.outcome_details=l.outcome_details,o.id_accompanying_adult_internal=l.id_accompanying_adult_internal,o.accompanying_adult_outsider_name=l.accompanying_adult_outsider_name,o.family_contact_attempted=!!l.family_contact_attempted,o.family_contact_successful=!!l.family_contact_successful;const u=Qe(l.family_contact_datetime);o.family_contact_date=u.date,o.family_contact_time=u.time,o.family_contact_person_name=l.family_contact_person_name,o.family_contact_method=l.family_contact_method,o.family_contact_notes=l.family_contact_notes,o.formal_notification_sent=!!l.formal_notification_sent,o.id_infirmary_staff=l.id_infirmary_staff,o.fichiers=l.fichiers||[],c.isViewMode&&(o.created_at=l.created_at,o.updated_at=l.updated_at,o.created_by_user_name=l.created_by_user?`${l.created_by_user.nom} ${l.created_by_user.prenom}`:"N/A",o.updated_by_user_name=l.updated_by_user?`${l.updated_by_user.nom} ${l.updated_by_user.prenom}`:"N/A",_.value||(T.value=!1))}else T.value=!0}catch(l){console.error("Error fetching visit details:",l),k.create({type:"negative",message:"Erreur lors du chargement des détails de la visite.",position:"top"}),T.value=!0}else o.id_infirmary_staff=J.value||null,o.idannee=$.value||null,o.fichiers=[];M.form=!1},gt=()=>{Ge()},bt=async()=>{M.staff=!0;try{const{data:l}=await Y("get","/infirmary/form-data/staff-list");W.value=l.map(e=>({...e,displayName:`${e.nom} ${e.prenom}`})),ae.value=[...W.value]}catch(l){console.error("Staff Error:",l),k.create({type:"warning",message:"Impossible de charger la liste du personnel.",position:"top"})}finally{M.staff=!1}},Vt=async()=>{M.outcomeTypes=!0;try{const{data:l}=await Y("get","/infirmary/form-data/outcome-types");he.value=l.map(e=>({label:xt(e),value:e}))}catch(l){console.error("OutcomeType Error:",l),k.create({type:"warning",message:"Impossible de charger les types de suivi.",position:"top"})}finally{M.outcomeTypes=!1}},ht=async()=>{M.familyContactMethods=!0;try{const{data:l}=await Y("get","/infirmary/form-data/family-contact-methods");we.value=l.map(e=>({label:kt(e),value:e}))}catch(l){console.error("ContactMethod Error:",l),k.create({type:"warning",message:"Impossible de charger les méthodes de contact.",position:"top"})}finally{M.familyContactMethods=!1}},Je=je(async(l,e,a)=>{if(l.length<2&&!c.visitId){a();return}try{const{data:u}=await Y("get",`/filters/persons/${o.idannee||$.value}`,{params:{query:l,types:"ELEV,USER,PROF,ADMIN"}});if(u.status==="success"){const E=u.data.map(b=>({idpers:b.idpers,displayName:b.nom_complet??`${b.nom} ${b.prenom}`,type:b.type,photo_url:b.photo?ke(b):null,classe_bref:b.classe_bref||(b.type===q&&b.classe?b.classe.BREF:b.type===q?"Classe N/A":null)}));e(()=>{S.value=E})}else e(()=>{S.value=[]}),a()}catch(u){console.error("Error searching persons:",u),k.create({type:"negative",message:"Erreur lors de la recherche de personnes.",position:"top"}),e(()=>{S.value=[]}),a()}},500),wt=je((l,e)=>{if(!l){e(()=>{ae.value=[...W.value]});return}const a=l.toLowerCase();e(()=>{ae.value=W.value.filter(u=>u.displayName.toLowerCase().includes(a))})},300),$e=async(l,e=!0)=>{if(!l){_.value=null,o.id_person_visited=null,e&&!p.value&&(o.idannee=$.value||null),c.isViewMode||(T.value=!0);return}const a=l.idpers;o.id_person_visited=a;try{M.form=!0;const{data:u}=await Y("get",`/infirmary/form-data/person-info/${a}`),E={...u,idpers:a,displayName:u.nom_complet||`${u.nom} ${u.prenom}`||l.displayName,photo_url:u.photo?ke(u):l.photo_url||null,type:u.type||l.type,classe_bref:u.classe_bref||(u.type===q&&u.classe?u.classe.BREF:null)||(l.type===q?l.classe_bref:null)||(u.type===q?"N/A":null),idinterne:u.idinterne||null};if(_.value=E,E){e&&!p.value&&(o.idannee=u.idannee_current||$.value||o.idannee);const b={idpers:E.idpers,displayName:E.displayName,type:E.type,photo_url:E.photo_url,classe_bref:E.classe_bref};o.id_person_visited_model=b;const le=S.value.findIndex(de=>de.idpers===b.idpers);le>-1?S.value.splice(le,1,b):S.value.unshift(b)}_.value&&!c.isViewMode?T.value=!1:!_.value&&!c.isViewMode&&(T.value=!0)}catch(u){console.error("Error fetching person details:",u),_.value=null,o.id_person_visited=null,o.id_person_visited_model=null,k.create({type:"negative",message:"Erreur lors du chargement des détails de la personne.",position:"top"}),c.isViewMode||(T.value=!0)}finally{M.form=!1}},Xe=()=>{if(!c.isViewMode){if(T.value=!0,o.id_person_visited_model&&!S.value.some(l=>l.idpers===o.id_person_visited_model.idpers))S.value.unshift(o.id_person_visited_model);else if(!o.id_person_visited_model&&_.value){const l={idpers:_.value.idpers,displayName:_.value.displayName,type:_.value.type,photo_url:_.value.photo_url,classe_bref:_.value.classe_bref};o.id_person_visited_model=l,S.value.some(e=>e.idpers===l.idpers)||S.value.unshift(l)}S.value.length===0&&!o.id_person_visited_model&&Je("",l=>{S.value=l},()=>{})}},Ze=async l=>{Ve(),H.value=!0;let e=[];if(l&&l.xhr&&l.xhr.response)try{const u=JSON.parse(l.xhr.response);u&&u.result&&(e=u.result)}catch(u){console.error("Error parsing uploader response:",u)}const a={...o};a.files=e,delete a.id_person_visited_model,delete a.fichiers,a.visit_datetime=Ie(o.visit_date,o.visit_time),a.outcome_datetime=Ie(o.outcome_date,o.outcome_time),a.family_contact_datetime=Ie(o.family_contact_date,o.family_contact_time),["visit_date","visit_time","outcome_date","outcome_time","family_contact_date","family_contact_time","created_at","updated_at","created_by_user_name","updated_by_user_name"].forEach(u=>delete a[u]),a.family_contact_attempted=a.family_contact_attempted?1:0,a.family_contact_successful=a.family_contact_successful?1:0,a.formal_notification_sent=a.formal_notification_sent?1:0;for(const u in a)(a[u]===void 0||a[u]==="")&&(a[u]=null);try{let u;p.value?u=await Y("put",`/infirmary/visits/${c.visitId}`,a):u=await Y("post","/infirmary/visits",a),k.create({type:"positive",message:u.data.message||"Visite enregistrée avec succès.",position:"top"}),j("visitSaved"),Re()}catch(u){if(console.error("Error saving visit:",u),u.response){const E=u.response.status,b=u.response.data;if(E===422&&b&&b.errors){k.create({type:"negative",message:b.message||"Veuillez corriger les erreurs indiquées dans le formulaire.",position:"top",timeout:3e3});const le=b.errors;for(const de in le)le[de]&&le[de].length>0&&(i.value[de]=le[de][0]);i.value.visit_datetime&&(i.value.visit_date||(i.value.visit_date=i.value.visit_datetime),i.value.visit_time||(i.value.visit_time=i.value.visit_datetime)),i.value.outcome_datetime&&(i.value.outcome_date||(i.value.outcome_date=i.value.outcome_datetime),i.value.outcome_time||(i.value.outcome_time=i.value.outcome_datetime)),i.value.family_contact_datetime&&(i.value.family_contact_date||(i.value.family_contact_date=i.value.family_contact_datetime),i.value.family_contact_time||(i.value.family_contact_time=i.value.family_contact_datetime))}else b&&b.message?k.create({type:"negative",message:b.message,position:"top"}):E===401?k.create({type:"negative",message:"Non autorisé. Veuillez vous reconnecter.",position:"top"}):E===403?k.create({type:"negative",message:"Accès refusé à cette ressource.",position:"top"}):E>=500?k.create({type:"negative",message:"Une erreur est survenue côté serveur. Veuillez réessayer plus tard.",position:"top"}):k.create({type:"negative",message:`Erreur lors de l'enregistrement (Code: ${E}). Veuillez réessayer.`,position:"top"})}else u.request?k.create({type:"negative",message:"Erreur de réseau. Vérifiez votre connexion et réessayez.",position:"top"}):k.create({type:"negative",message:"Une erreur inattendue est survenue lors de la préparation de la requête.",position:"top"})}finally{H.value=!1}},Re=()=>{_e.value=!1},xt=l=>({RETURNED_TO_CLASS:"Retourné(e) en Classe",RETURNED_TO_WORK:"Retourné(e) au Travail",SENT_HOME:"Renvoyé(e) à Domicile",EVACUATED_HOSPITAL:"Évacué(e) Hôpital",AWAITING_PARENT:"En Attente Parent",OTHER:"Autre"})[l]||l,kt=l=>({PHONE:"Téléphone",SMS:"SMS",EMAIL:"Email",IN_PERSON_NOTE:"Note Remise en Main Propre",OTHER:"Autre"})[l]||l,et=l=>l?{[q]:"Élève",[Be]:"Personnel",[He]:"Admin",[Le]:"Professeur"}[l]||l:"N/A",tt=l=>({[q]:"sym_o_school",[Be]:"sym_o_badge",[He]:"sym_o_admin_panel_settings",[Le]:"sym_o_history_edu"})[l]||"sym_o_person",at=l=>({[q]:"primary",[Be]:"secondary",[He]:"accent",[Le]:"info"})[l]||"grey",lt=l=>l?ge.formatDate(l,"DD/MM/YYYY HH:mm:ss"):"N/A",Et=l=>{Xt(l).then(()=>k.create({type:"positive",message:`Numéro '${l}' copié!`,position:"top",timeout:1500})).catch(()=>k.create({type:"negative",message:"Erreur copie.",position:"top"}))};return ve(()=>o.family_contact_attempted,l=>{l||(o.family_contact_successful=!1)}),ve(()=>o.family_contact_successful,l=>{l||(o.family_contact_date=null,o.family_contact_time=null,o.family_contact_person_name="",o.family_contact_method=null,o.family_contact_notes="")}),ve(()=>o.id_person_visited_model,(l,e)=>{l===null&&T.value&&(_.value=null,o.id_person_visited=null,p.value||(o.idannee=$.value||null))}),(l,e)=>(n(),V(G,null,[t(Ye,{modelValue:_e.value,"onUpdate:modelValue":e[43]||(e[43]=a=>_e.value=a),persistent:"",onBeforeShow:yt,onHide:gt,maximized:"",position:"bottom"},{default:s(()=>[t(Se,{style:{"min-width":"70vw"}},{default:s(()=>[t(rt,{class:"bg-secondary text-white shadow-2"},{default:s(()=>[F(t(g,{flat:"",dense:"",icon:"arrow_back"},null,512),[[O]]),t(it,null,{default:s(()=>[v(x(d.value),1)]),_:1}),t(g,{flat:"",dense:"",icon:"attach_file",onClick:Ue},{default:s(()=>[F(t(zt,{floating:"",color:"yellow-9"},{default:s(()=>[v(x(X.value),1)]),_:1},512),[[Dt,X.value>0]])]),_:1})]),_:1}),t(jt,{onSubmit:De(qe,["prevent"]),ref_key:"formulaire",ref:L},{default:s(()=>[t(pe,{class:"scroll"},{default:s(()=>[M.form?(n(),V("div",Zt,[t(I(Ae),{color:"primary",size:"40px"}),e[48]||(e[48]=r("p",null,"Chargement des données...",-1))])):(n(),V("div",ea,[r("div",ta,[T.value&&!R.value?(n(),f(re,{key:0,dense:"",filled:"","use-input":"",modelValue:o.id_person_visited_model,"onUpdate:modelValue":[e[0]||(e[0]=a=>o.id_person_visited_model=a),$e],label:"Personne Concernée (Élève/Personnel) *",options:S.value,onFilter:I(Je),"option-value":"idpers","option-label":"displayName",clearable:"",rules:[a=>!!a||"Personne requise"],standout:"","bg-color":"accent-light-blue",error:!!i.value.id_person_visited_model||!!i.value.id_person_visited,"error-message":i.value.id_person_visited_model||i.value.id_person_visited,onBlur:e[1]||(e[1]=()=>{i.value.id_person_visited_model&&delete i.value.id_person_visited_model,i.value.id_person_visited&&delete i.value.id_person_visited})},{"no-option":s(()=>[t(Z,null,{default:s(()=>[t(P,{class:"text-grey"},{default:s(()=>e[49]||(e[49]=[v("Aucun résultat. Tapez pour rechercher.")])),_:1})]),_:1})]),option:s(a=>[t(Z,At(Pt(a.itemProps)),{default:s(()=>[a.opt.photo_url?(n(),f(P,{key:0,avatar:""},{default:s(()=>[t(ie,{size:"sm"},{default:s(()=>[r("img",{src:a.opt.photo_url},null,8,aa)]),_:2},1024)]),_:2},1024)):(n(),f(P,{key:1,avatar:""},{default:s(()=>[t(ie,{icon:tt(a.opt.type),color:at(a.opt.type),"text-color":"white",size:"sm"},null,8,["icon","color"])]),_:2},1024)),t(P,null,{default:s(()=>[t(U,null,{default:s(()=>[v(x(a.opt.displayName),1)]),_:2},1024),t(U,{caption:""},{default:s(()=>[v(x(et(a.opt.type))+" ",1),a.opt.classe_bref&&a.opt.classe_bref!=="N/A"?(n(),V("span",la," - "+x(a.opt.classe_bref),1)):y("",!0)]),_:2},1024)]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","options","onFilter","rules","error","error-message"])):_.value?(n(),f(Se,{key:1,flat:"",bordered:"",class:"bg-light-grey-1 q-pa-none rounded-borders"},{default:s(()=>[t(Z,null,{default:s(()=>[t(P,{avatar:""},{default:s(()=>[_.value.photo_url?(n(),f(ie,{key:0,size:"md"},{default:s(()=>[r("img",{src:_.value.photo_url},null,8,oa)]),_:1})):(n(),f(ie,{key:1,icon:tt(_.value.type),color:at(_.value.type),"text-color":"white",size:"md"},null,8,["icon","color"]))]),_:1}),t(P,null,{default:s(()=>[t(U,{class:"text-weight-bold text-primary-dark"},{default:s(()=>[v(x(_.value.displayName||`${_.value.nom}
                        ${_.value.prenom}`),1)]),_:1}),t(U,{caption:""},{default:s(()=>[v(x(et(_.value.type))+" ",1),_.value.type===q&&_.value.classe_bref&&_.value.classe_bref!=="N/A"?(n(),V("span",sa," - Classe: "+x(_.value.classe_bref),1)):y("",!0)]),_:1}),_.value.idinterne?(n(),f(U,{key:0,caption:""},{default:s(()=>[v("ID: "+x(_.value.idinterne),1)]),_:1})):y("",!0)]),_:1}),R.value?y("",!0):(n(),f(P,{key:0,side:""},{default:s(()=>[t(g,{flat:"",round:"",dense:"",icon:"sym_o_edit",onClick:Xe,color:"grey-8"},{default:s(()=>[t(z,{class:"bg-primary text-white shadow-2"},{default:s(()=>e[50]||(e[50]=[v("Changer la personne")])),_:1})]),_:1})]),_:1}))]),_:1}),_.value.maladies&&_.value.maladies.length?(n(),f(_t,{key:0,separator:"",bordered:"",class:"rounded-borders shadow-1 q-mt-sm"},{default:s(()=>[(n(!0),V(G,null,Fe(_.value.maladies,(a,u)=>(n(),f(Z,{key:u,clickable:"",class:"q-py-md"},{default:s(()=>[t(P,null,{default:s(()=>[t(U,{class:"text-weight-bold text-subtitle1 text-primary"},{default:s(()=>[v(x(a.maladies.description),1)]),_:2},1024),t(U,{class:"q-mt-sm row items-center"},{default:s(()=>[t(D,{name:"sym_o_medication",color:"deep-orange",size:"sm",class:"q-mr-xs"}),r("span",ia,x(a.traitement.description),1)]),_:2},1024),a.idreport>1?(n(),f(U,{key:0,class:"q-mt-xs"},{default:s(()=>[v(x(a.report.description),1)]),_:2},1024)):y("",!0)]),_:2},1024),a.idtype>1?(n(),f(P,{key:0,side:"",top:""},{default:s(()=>[t(Ke,{dense:"",color:"secondary","text-color":"white",size:"sm"},{default:s(()=>[v(x(a.type.description),1)]),_:2},1024)]),_:2},1024)):y("",!0)]),_:2},1024))),128))]),_:1})):y("",!0)]),_:1})):R.value&&!_.value?(n(),V("div",ra,[t(D,{name:"sym_o_person_off",size:"sm",class:"q-mr-sm"}),e[51]||(e[51]=v(" Aucune personne concernée n'a été enregistrée pour cette visite. "))])):!R.value&&!_.value&&!T.value?(n(),V("div",na,[t(D,{name:"sym_o_error",class:"q-mr-sm",size:"sm"}),e[52]||(e[52]=r("span",null,"Aucune personne sélectionnée.",-1)),t(g,{flat:"",dense:"",color:"primary",label:"Sélectionner",onClick:Xe,class:"q-ml-md",size:"sm"})])):y("",!0)]),r("div",da,[t(g,{round:"",icon:"qr_code_scanner",onClick:ft,disable:R.value||!T.value},{default:s(()=>[t(z,null,{default:s(()=>e[53]||(e[53]=[v("Scanner")])),_:1})]),_:1},8,["disable"])]),r("div",ua,[t(A,{dense:"",filled:"",modelValue:o.visit_date,"onUpdate:modelValue":e[3]||(e[3]=a=>o.visit_date=a),label:"Date Visite *",mask:"####-##-##",rules:[a=>!!a||"Date requise"],readonly:c.isViewMode,standout:"","bg-color":"accent-light-blue",error:!!i.value.visit_date||!!i.value.visit_datetime,"error-message":i.value.visit_date||i.value.visit_datetime,onBlur:e[4]||(e[4]=()=>{i.value.visit_date&&delete i.value.visit_date,i.value.visit_datetime&&delete i.value.visit_datetime})},{prepend:s(()=>[t(D,{name:"sym_o_event",class:"cursor-pointer text-primary"},{default:s(()=>[c.isViewMode?y("",!0):(n(),f(ee,{key:0,cover:"","transition-show":"scale","transition-hide":"scale"},{default:s(()=>[t(ye,{modelValue:o.visit_date,"onUpdate:modelValue":e[2]||(e[2]=a=>o.visit_date=a),mask:"YYYY-MM-DD",minimal:""},{default:s(()=>[r("div",ma,[F(t(g,{label:"OK",color:"primary",flat:""},null,512),[[O]])])]),_:1},8,["modelValue"])]),_:1}))]),_:1})]),_:1},8,["modelValue","rules","readonly","error","error-message"])]),r("div",ca,[t(A,{dense:"",filled:"",modelValue:o.visit_time,"onUpdate:modelValue":e[6]||(e[6]=a=>o.visit_time=a),label:"Heure Visite *",mask:"##:##",rules:[a=>!!a||"Heure requise"],readonly:c.isViewMode,standout:"","bg-color":"accent-light-blue",error:!!i.value.visit_time||!!i.value.visit_datetime,"error-message":i.value.visit_time||i.value.visit_datetime,onBlur:e[7]||(e[7]=()=>{i.value.visit_time&&delete i.value.visit_time,i.value.visit_datetime&&delete i.value.visit_datetime})},{prepend:s(()=>[t(D,{name:"sym_o_schedule",class:"cursor-pointer text-primary"},{default:s(()=>[c.isViewMode?y("",!0):(n(),f(ee,{key:0,cover:"","transition-show":"scale","transition-hide":"scale"},{default:s(()=>[t(ze,{modelValue:o.visit_time,"onUpdate:modelValue":e[5]||(e[5]=a=>o.visit_time=a),mask:"HH:mm",format24h:""},{default:s(()=>[r("div",_a,[F(t(g,{label:"OK",color:"primary",flat:""},null,512),[[O]])])]),_:1},8,["modelValue"])]),_:1}))]),_:1})]),_:1},8,["modelValue","rules","readonly","error","error-message"])]),r("div",pa,[t(A,{modelValue:o.motif_visit,"onUpdate:modelValue":e[8]||(e[8]=a=>o.motif_visit=a),type:"textarea",label:"Motif de la visite *",autogrow:"",dense:"",filled:"",rules:[a=>!!a||"Motif requis"],readonly:c.isViewMode,standout:"","bg-color":"accent-light-blue",error:!!i.value.motif_visit,"error-message":i.value.motif_visit,onBlur:e[9]||(e[9]=()=>{i.value.motif_visit&&delete i.value.motif_visit})},null,8,["modelValue","rules","readonly","error","error-message"])]),r("div",fa,[t(A,{modelValue:o.care_provided,"onUpdate:modelValue":e[10]||(e[10]=a=>o.care_provided=a),type:"textarea",label:"Soins prodigués *",autogrow:"",dense:"",filled:"",rules:[a=>!!a||"Soins requis"],readonly:c.isViewMode,standout:"","bg-color":"accent-light-blue",error:!!i.value.care_provided,"error-message":i.value.care_provided,onBlur:e[11]||(e[11]=()=>{i.value.care_provided&&delete i.value.care_provided})},null,8,["modelValue","rules","readonly","error","error-message"])]),t(oe,{class:"md:col-span-6 q-my-sm"}),e[60]||(e[60]=r("div",{class:"md:col-span-6 text-subtitle2 text-primary"},"Suivi",-1)),r("div",va,[t(re,{dense:"",filled:"",modelValue:o.outcome_type,"onUpdate:modelValue":e[12]||(e[12]=a=>o.outcome_type=a),options:he.value,label:"Type de Suivi *","emit-value":"","map-options":"",rules:[a=>!!a||"Suivi requis"],loading:M.outcomeTypes,readonly:c.isViewMode,standout:"","bg-color":"accent-light-blue",error:!!i.value.outcome_type,"error-message":i.value.outcome_type,onBlur:e[13]||(e[13]=()=>{i.value.outcome_type&&delete i.value.outcome_type})},null,8,["modelValue","options","rules","loading","readonly","error","error-message"])]),r("div",ya,[t(A,{dense:"",filled:"",modelValue:o.outcome_date,"onUpdate:modelValue":e[15]||(e[15]=a=>o.outcome_date=a),label:"Date Suivi",mask:"####-##-##",clearable:"",readonly:c.isViewMode,standout:"","bg-color":"accent-light-blue",error:!!i.value.outcome_date||!!i.value.outcome_datetime,"error-message":i.value.outcome_date||i.value.outcome_datetime,onBlur:e[16]||(e[16]=()=>{i.value.outcome_date&&delete i.value.outcome_date,i.value.outcome_datetime&&delete i.value.outcome_datetime})},{prepend:s(()=>[t(D,{name:"sym_o_event",class:"cursor-pointer text-primary"},{default:s(()=>[c.isViewMode?y("",!0):(n(),f(ee,{key:0,cover:"","transition-show":"scale","transition-hide":"scale"},{default:s(()=>[t(ye,{modelValue:o.outcome_date,"onUpdate:modelValue":e[14]||(e[14]=a=>o.outcome_date=a),mask:"YYYY-MM-DD",minimal:""},{default:s(()=>[r("div",ga,[F(t(g,{label:"OK",color:"primary",flat:""},null,512),[[O]])])]),_:1},8,["modelValue"])]),_:1}))]),_:1})]),_:1},8,["modelValue","readonly","error","error-message"])]),r("div",ba,[t(A,{dense:"",filled:"",modelValue:o.outcome_time,"onUpdate:modelValue":e[18]||(e[18]=a=>o.outcome_time=a),label:"Heure Suivi",mask:"##:##",clearable:"",readonly:c.isViewMode,standout:"","bg-color":"accent-light-blue",error:!!i.value.outcome_time||!!i.value.outcome_datetime,"error-message":i.value.outcome_time||i.value.outcome_datetime,onBlur:e[19]||(e[19]=()=>{i.value.outcome_time&&delete i.value.outcome_time,i.value.outcome_datetime&&delete i.value.outcome_datetime})},{prepend:s(()=>[t(D,{name:"sym_o_schedule",class:"cursor-pointer text-primary"},{default:s(()=>[c.isViewMode?y("",!0):(n(),f(ee,{key:0,cover:"","transition-show":"scale","transition-hide":"scale"},{default:s(()=>[t(ze,{modelValue:o.outcome_time,"onUpdate:modelValue":e[17]||(e[17]=a=>o.outcome_time=a),mask:"HH:mm",format24h:""},{default:s(()=>[r("div",Va,[F(t(g,{label:"OK",color:"primary",flat:""},null,512),[[O]])])]),_:1},8,["modelValue"])]),_:1}))]),_:1})]),_:1},8,["modelValue","readonly","error","error-message"])]),r("div",ha,[t(A,{modelValue:o.outcome_details,"onUpdate:modelValue":e[20]||(e[20]=a=>o.outcome_details=a),type:"textarea",label:"Détails du suivi",autogrow:"",dense:"",filled:"",readonly:c.isViewMode,standout:"","bg-color":"accent-light-blue",error:!!i.value.outcome_details,"error-message":i.value.outcome_details,onBlur:e[21]||(e[21]=()=>{i.value.outcome_details&&delete i.value.outcome_details})},null,8,["modelValue","readonly","error","error-message"])]),t(oe,{class:"md:col-span-6 q-my-sm"}),e[61]||(e[61]=r("div",{class:"md:col-span-6 text-subtitle2 text-primary"},"Accompagnateur",-1)),r("div",wa,[t(re,{dense:"",filled:"","use-input":"",modelValue:o.id_accompanying_adult_internal,"onUpdate:modelValue":e[22]||(e[22]=a=>o.id_accompanying_adult_internal=a),label:"Adulte Accompagnant (Interne)",options:ae.value,onFilter:I(wt),"option-value":"idpers","option-label":"displayName","emit-value":"","map-options":"",clearable:"",readonly:c.isViewMode,standout:"","bg-color":"accent-light-blue",error:!!i.value.id_accompanying_adult_internal,"error-message":i.value.id_accompanying_adult_internal,onBlur:e[23]||(e[23]=()=>{i.value.id_accompanying_adult_internal&&delete i.value.id_accompanying_adult_internal})},{"no-option":s(()=>[t(Z,null,{default:s(()=>[t(P,{class:"text-grey"},{default:s(()=>e[54]||(e[54]=[v("Aucun résultat. Tapez pour rechercher.")])),_:1})]),_:1})]),_:1},8,["modelValue","options","onFilter","readonly","error","error-message"])]),r("div",xa,[t(A,{modelValue:o.accompanying_adult_outsider_name,"onUpdate:modelValue":e[24]||(e[24]=a=>o.accompanying_adult_outsider_name=a),label:"Adulte Accompagnant (Externe)",dense:"",filled:"",readonly:c.isViewMode,standout:"","bg-color":"accent-light-blue",error:!!i.value.accompanying_adult_outsider_name,"error-message":i.value.accompanying_adult_outsider_name,onBlur:e[25]||(e[25]=()=>{i.value.accompanying_adult_outsider_name&&delete i.value.accompanying_adult_outsider_name})},null,8,["modelValue","readonly","error","error-message"])]),_.value&&_.value.type===q||o.id_person_visited&&!_.value&&p.value?(n(),V(G,{key:0},[t(oe,{class:"md:col-span-6 q-my-sm"}),e[57]||(e[57]=r("div",{class:"md:col-span-6 text-subtitle2 text-primary"},"Communication Famille",-1)),_.value&&_.value.telephones&&_.value.telephones.length?(n(),V("div",ka,[e[55]||(e[55]=r("span",{class:"text-weight-medium"},"Contacts Parents:",-1)),(n(!0),V(G,null,Fe(_.value.telephones,a=>(n(),V(G,{key:a.idtel},[a.idtel=="gsm"?(n(),f(Ke,{key:0,icon:"sym_o_phone",label:"+"+a.tel,color:"blue-1","text-color":"primary",clickable:"",onClick:u=>Et("00"+a.tel)},null,8,["label","onClick"])):y("",!0)],64))),128))])):p.value&&!M.form&&(!_.value||!_.value.telephones||!_.value.telephones.length)?(n(),V("div",Ea,[t(Bt,{"inline-actions":"",rounded:"",class:"bg-orange-1 text-orange-9"},{avatar:s(()=>[t(D,{name:"sym_o_contact_phone",color:"orange-9"})]),default:s(()=>[e[56]||(e[56]=v(" Aucun numéro de téléphone parent n'est enregistré pour cette personne. "))]),_:1})])):y("",!0),r("div",Ta,[t(Oe,{modelValue:o.family_contact_attempted,"onUpdate:modelValue":e[26]||(e[26]=a=>o.family_contact_attempted=a),label:"Tentative de contact famille",disable:c.isViewMode},null,8,["modelValue","disable"])]),r("div",Ca,[t(Oe,{modelValue:o.family_contact_successful,"onUpdate:modelValue":e[27]||(e[27]=a=>o.family_contact_successful=a),label:"Contact famille réussi",disable:c.isViewMode||!o.family_contact_attempted},null,8,["modelValue","disable"])]),o.family_contact_successful&&o.family_contact_attempted?(n(),V(G,{key:2},[r("div",Ma,[t(A,{dense:"",filled:"",modelValue:o.family_contact_date,"onUpdate:modelValue":e[29]||(e[29]=a=>o.family_contact_date=a),label:"Date Contact Famille",mask:"####-##-##",clearable:"",readonly:c.isViewMode,standout:"","bg-color":"accent-light-blue",error:!!i.value.family_contact_date||!!i.value.family_contact_datetime,"error-message":i.value.family_contact_date||i.value.family_contact_datetime,onBlur:e[30]||(e[30]=()=>{i.value.family_contact_date&&delete i.value.family_contact_date,i.value.family_contact_datetime&&delete i.value.family_contact_datetime})},{prepend:s(()=>[t(D,{name:"sym_o_event",class:"cursor-pointer text-primary"},{default:s(()=>[c.isViewMode?y("",!0):(n(),f(ee,{key:0,cover:"","transition-show":"scale","transition-hide":"scale"},{default:s(()=>[t(ye,{modelValue:o.family_contact_date,"onUpdate:modelValue":e[28]||(e[28]=a=>o.family_contact_date=a),mask:"YYYY-MM-DD",minimal:""},{default:s(()=>[r("div",Sa,[F(t(g,{label:"OK",color:"primary",flat:""},null,512),[[O]])])]),_:1},8,["modelValue"])]),_:1}))]),_:1})]),_:1},8,["modelValue","readonly","error","error-message"])]),r("div",Da,[t(A,{dense:"",filled:"",modelValue:o.family_contact_time,"onUpdate:modelValue":e[32]||(e[32]=a=>o.family_contact_time=a),label:"Heure Contact Famille",mask:"##:##",clearable:"",readonly:c.isViewMode,standout:"","bg-color":"accent-light-blue",error:!!i.value.family_contact_time||!!i.value.family_contact_datetime,"error-message":i.value.family_contact_time||i.value.family_contact_datetime,onBlur:e[33]||(e[33]=()=>{i.value.family_contact_time&&delete i.value.family_contact_time,i.value.family_contact_datetime&&delete i.value.family_contact_datetime})},{prepend:s(()=>[t(D,{name:"sym_o_schedule",class:"cursor-pointer text-primary"},{default:s(()=>[c.isViewMode?y("",!0):(n(),f(ee,{key:0,cover:"","transition-show":"scale","transition-hide":"scale"},{default:s(()=>[t(ze,{modelValue:o.family_contact_time,"onUpdate:modelValue":e[31]||(e[31]=a=>o.family_contact_time=a),mask:"HH:mm",format24h:""},{default:s(()=>[r("div",Aa,[F(t(g,{label:"OK",color:"primary",flat:""},null,512),[[O]])])]),_:1},8,["modelValue"])]),_:1}))]),_:1})]),_:1},8,["modelValue","readonly","error","error-message"])]),r("div",Pa,[t(A,{modelValue:o.family_contact_person_name,"onUpdate:modelValue":e[34]||(e[34]=a=>o.family_contact_person_name=a),label:"Personne contactée",dense:"",filled:"",readonly:c.isViewMode,standout:"","bg-color":"accent-light-blue",error:!!i.value.family_contact_person_name,"error-message":i.value.family_contact_person_name,onBlur:e[35]||(e[35]=()=>{i.value.family_contact_person_name&&delete i.value.family_contact_person_name})},null,8,["modelValue","readonly","error","error-message"])]),r("div",Na,[t(re,{dense:"",filled:"",modelValue:o.family_contact_method,"onUpdate:modelValue":e[36]||(e[36]=a=>o.family_contact_method=a),options:we.value,label:"Méthode de Contact","emit-value":"","map-options":"",clearable:"",loading:M.familyContactMethods,readonly:c.isViewMode,standout:"","bg-color":"accent-light-blue",error:!!i.value.family_contact_method,"error-message":i.value.family_contact_method,onBlur:e[37]||(e[37]=()=>{i.value.family_contact_method&&delete i.value.family_contact_method})},null,8,["modelValue","options","loading","readonly","error","error-message"])]),r("div",Ua,[t(A,{modelValue:o.family_contact_notes,"onUpdate:modelValue":e[38]||(e[38]=a=>o.family_contact_notes=a),type:"textarea",label:"Notes sur le contact famille",autogrow:"",dense:"",filled:"",readonly:c.isViewMode,standout:"","bg-color":"accent-light-blue",error:!!i.value.family_contact_notes,"error-message":i.value.family_contact_notes,onBlur:e[39]||(e[39]=()=>{i.value.family_contact_notes&&delete i.value.family_contact_notes})},null,8,["modelValue","readonly","error","error-message"])])],64)):y("",!0),r("div",qa,[t(Oe,{modelValue:o.formal_notification_sent,"onUpdate:modelValue":e[40]||(e[40]=a=>o.formal_notification_sent=a),label:"Envoyer une Notification",disable:c.isViewMode},null,8,["modelValue","disable"])])],64)):y("",!0),t(oe,{class:"md:col-span-6 q-my-sm"}),e[62]||(e[62]=r("div",{class:"md:col-span-6 text-subtitle2 text-primary"},"Gestionnaire de la Visite",-1)),r("div",Ia,[t(re,{dense:"",filled:"",modelValue:o.id_infirmary_staff,"onUpdate:modelValue":e[41]||(e[41]=a=>o.id_infirmary_staff=a),options:W.value,label:"Personnel Infirmerie Gérant *","option-value":"idpers","option-label":"displayName","emit-value":"","map-options":"",rules:[a=>!!a||"Personnel requis"],loading:M.staff,readonly:c.isViewMode,standout:"","bg-color":"accent-light-blue",error:!!i.value.id_infirmary_staff,"error-message":i.value.id_infirmary_staff,onBlur:e[42]||(e[42]=()=>{i.value.id_infirmary_staff&&delete i.value.id_infirmary_staff})},{"no-option":s(()=>[t(Z,null,{default:s(()=>[t(P,{class:"text-grey"},{default:s(()=>e[58]||(e[58]=[v("Aucun personnel trouvé.")])),_:1})]),_:1})]),_:1},8,["modelValue","options","rules","loading","readonly","error","error-message"])]),R.value&&o.created_at?(n(),V(G,{key:1},[t(oe,{class:"md:col-span-6 q-my-sm"}),e[59]||(e[59]=r("div",{class:"md:col-span-6 text-subtitle2 text-primary"},"Informations d'Audit",-1)),r("div",Qa,[t(A,{dense:"",filled:"",readonly:"",label:"Créé le","model-value":lt(o.created_at),standout:"","bg-color":"blue-grey-1"},null,8,["model-value"])]),r("div",$a,[t(A,{dense:"",filled:"",readonly:"",label:"Créé par","model-value":o.created_by_user_name||"N/A",standout:"","bg-color":"blue-grey-1"},null,8,["model-value"])]),r("div",Ra,[t(A,{dense:"",filled:"",readonly:"",label:"Mis à jour le","model-value":lt(o.updated_at),standout:"","bg-color":"blue-grey-1"},null,8,["model-value"])]),r("div",Fa,[t(A,{dense:"",filled:"",readonly:"",label:"Mis à jour par","model-value":o.updated_by_user_name||"N/A",standout:"","bg-color":"blue-grey-1"},null,8,["model-value"])])],64)):y("",!0)]))]),_:1}),t(oe),(R.value||p.value)&&o?.fichiers?.length?(n(),f(pe,{key:0},{default:s(()=>[r("div",Oa,[(n(!0),V(G,null,Fe(o.fichiers,(a,u)=>(n(),V(G,{key:a.id||a.fichier||u},[I(Ee)(a.fichier)?(n(),V("div",Ya,[t(nt,{src:I(ot)(a),onClick:E=>We(a),style:{cursor:"pointer",height:"400px","object-fit":"cover"}},{default:s(()=>[t(z,{class:"bg-black text-white"},{default:s(()=>e[63]||(e[63]=[v("Cliquer pour agrandir")])),_:1})]),_:2},1032,["src","onClick"])])):(n(),V("div",za,[t(Z,{clickable:"",onClick:E=>We(a),class:"rounded-borders",style:{border:"1px solid #e0e0e0","min-height":"80px"}},{default:s(()=>[t(P,{avatar:""},{default:s(()=>[t(ie,{color:"white","text-color":"primary"},{default:s(()=>[t(D,{name:"img:"+I(Nt)(a.fichier)},null,8,["name"])]),_:2},1024)]),_:2},1024),t(P,null,{default:s(()=>[t(U,{lines:"2",class:"ellipsis text-body2",style:{"max-width":"100%"}},{default:s(()=>[v(x(a.fichier),1)]),_:2},1024),t(U,{caption:""},{default:s(()=>e[64]||(e[64]=[v("Cliquer pour prévisualiser")])),_:1})]),_:2},1024),t(P,{side:"",top:""},{default:s(()=>[t(D,{name:"sym_o_visibility",color:"grey-7",class:"q-mt-xs"})]),_:1})]),_:2},1032,["onClick"])]))],64))),128))])]),_:1})):y("",!0),R.value?y("",!0):(n(),f(pe,{key:1},{default:s(()=>[r("div",Ba,[r("div",Ha,[t(Lt,{"field-name":a=>"pieces_jointe[]",style:{width:"100%"},url:w.value,flat:"",multiple:"",headers:C.value,ref_key:"uploader",ref:K,batch:"",onAdded:Ne,onRemoved:be,onUploaded:Ze},{header:s(a=>[r("div",La,[a.queuedFiles.length>0?(n(),f(g,{key:0,icon:"clear_all",onClick:a.removeQueuedFiles,round:"",dense:"",flat:""},{default:s(()=>[t(z,null,{default:s(()=>e[65]||(e[65]=[v("Supprimer tous")])),_:1})]),_:2},1032,["onClick"])):y("",!0),a.uploadedFiles.length>0?(n(),f(g,{key:1,icon:"done_all",onClick:a.removeUploadedFiles,round:"",dense:"",flat:""},{default:s(()=>[t(z,null,{default:s(()=>e[66]||(e[66]=[v("Supprimer")])),_:1})]),_:2},1032,["onClick"])):y("",!0),a.isUploading?(n(),f(Ut,{key:2,class:"q-uploader__spinner"})):y("",!0),r("div",ja,[e[67]||(e[67]=r("div",{class:"q-uploader__title"},"Pièce(s) jointe(s)",-1)),r("div",Ka,x(a.uploadSizeLabel)+" / "+x(a.uploadProgressLabel),1)]),a.canAddFiles?(n(),f(g,{key:3,type:"a",icon:"add_box",round:"",dense:"",flat:""},{default:s(()=>[t(Ht),t(z,null,{default:s(()=>e[68]||(e[68]=[v("Ajouter des fichiers")])),_:1})]),_:1})):y("",!0),a.isUploading?(n(),f(g,{key:4,icon:"clear",onClick:a.abort,round:"",dense:"",flat:""},{default:s(()=>[t(z,null,{default:s(()=>e[69]||(e[69]=[v("Annuler")])),_:1})]),_:2},1032,["onClick"])):y("",!0)])]),_:1},8,["url","headers"])])])]),_:1})),t(oe),t(ct,{align:"right",class:"q-pa-md"},{default:s(()=>[t(g,{label:"Annuler",color:"grey-7",flat:"",onClick:Re}),R.value?y("",!0):(n(),f(g,{key:0,label:p.value?"Sauvegarder":"Enregistrer",type:"submit",color:"primary",loading:H.value,class:"btn-elevated"},null,8,["label","loading"])),R.value?(n(),f(g,{key:1,label:"Fermer",color:"primary",onClick:Re,class:"btn-elevated"})):y("",!0)]),_:1})]),_:1},512)]),_:1})]),_:1},8,["modelValue"]),t(Ye,{modelValue:xe.value,"onUpdate:modelValue":e[45]||(e[45]=a=>xe.value=a),maximized:"","transition-show":"slide-left","transition-hide":"slide-right"},{default:s(()=>[I(me).platform.is.cordova?(n(),f(Wt,{key:0,onStaffSelected:e[44]||(e[44]=a=>vt(a))})):y("",!0)]),_:1},8,["modelValue"]),t(Ye,{modelValue:m.value,"onUpdate:modelValue":e[47]||(e[47]=a=>m.value=a),maximized:"",persistent:"",position:"bottom",onHide:pt},{default:s(()=>[t(Se,{style:st({height:I(Ee)(N.value)?"auto":"100vh "})},{default:s(()=>[t(rt,{class:"bg-secondary text-white shadow-2"},{default:s(()=>[F(t(g,{flat:"",round:"",dense:"",icon:"arrow_back"},null,512),[[O]]),t(it,{class:"ellipsis"},{default:s(()=>[v(" Aperçu: "+x(ne.value),1)]),_:1}),t(Kt),N.value?(n(),f(g,{key:0,flat:"",round:"",dense:"",icon:"open_in_new",onClick:e[46]||(e[46]=a=>I(qt)(N.value))},{default:s(()=>[t(z,{class:"bg-black text-white"},{default:s(()=>e[70]||(e[70]=[v("Ouvrir dans un nouvel onglet")])),_:1})]),_:1})):y("",!0),F(t(g,{flat:"",round:"",dense:"",icon:"close"},null,512),[[O]])]),_:1}),t(pe,{class:"q-pa-none",style:st({height:I(Ee)(N.value)?"auto":"calc(100%  - 55.8px) "})},{default:s(()=>[I(Ee)(N.value)?(n(),f(nt,{key:0,src:N.value},null,8,["src"])):N.value?(n(),V("iframe",{key:1,src:`https://docs.google.com/gview?embedded=true&url=${encodeURIComponent(N.value)}`,style:{width:"100%",height:"100%",border:"none"},frameborder:"0"},[r("p",null,[e[71]||(e[71]=v("Votre navigateur ne supporte pas les iframes. Vous pouvez ")),r("a",{href:N.value,target:"_blank",class:"text-white"},"télécharger le document ici",8,Ga),e[72]||(e[72]=v("."))])],8,Wa)):(n(),V("div",Ja,[t(I(Ae),{color:"primary",size:"xl"}),e[73]||(e[73]=r("p",{class:"q-mt-md text-grey-8"},"Chargement de l'aperçu...",-1))]))]),_:1},8,["style"])]),_:1},8,["style"])]),_:1},8,["modelValue"])],64))}},Za=dt(Xa,[["__scopeId","data-v-13b76c9c"]]),el={class:"row q-col-gutter-md items-end"},tl={class:"col-12 col-md-3"},al={class:"row items-center justify-end q-mt-sm"},ll={class:"col-12 col-md-3"},ol={class:"row items-center justify-end q-mt-sm"},sl={class:"col-12 col-md-3"},il={class:"col-12 col-md-3"},rl={class:"col-12 col-md-2"},nl={class:"q-mb-md row justify-end"},dl={key:0,class:"text-center q-pa-xl"},ul={key:1,class:"text-center q-pa-xl"},ml={class:"text-grey-7"},cl={key:2,class:"text-center q-pa-xl"},_l=["src"],pl={key:0},fl={key:1},vl={class:"q-gutter-xs"},ue="ELEV",Te="USER",Ce="ADMIN",Me="PROF",yl={__name:"InfirmaryVisitsPage",setup(te){const Q=mt(),c=ut(),{setTitle:j,showFooter:me}=Yt(),B=h([]),$=fe({visits:!1,academicYears:!1,outcomeTypes:!1}),J=h(""),T=se(()=>Q.getters["user/current"]?.annee?.idannee),w=fe({idannee:T.value||null,date_from:null,date_to:null,person_type:null,outcome_type:null}),C=fe({current_page:1,per_page:15,total:0,last_page:1}),ce=h([]),o=h([]),_=h([{label:"Tous",value:null},{label:"Élève",value:ue},{label:"Personnel",value:Te},{label:"Professeur",value:Me},{label:"Admin/Autre Staff",value:Ce}]),H=h(!1),M=h(null),i=h(!1),X=p=>w.date_from?ge.getDateDiff(p,w.date_from,"days")>=0:!0,K=(p,d="YYYY-MM-DD")=>p?ge.formatDate(p,d):"",L=async(p=1)=>{$.visits=!0,J.value="",C.current_page=p;try{const d={...w,page:C.current_page,per_page:C.per_page};Object.keys(d).forEach(N=>{(d[N]===null||d[N]==="")&&delete d[N]});const{data:m}=await Y("get","/infirmary/visits",{params:d});m&&m.data?(B.value=m.data,C.total=m.total,C.last_page=m.last_page,C.current_page=m.current_page,C.per_page=m.per_page):(B.value=[],C.total=0)}catch(d){console.error("Error fetching infirmary visits:",d),J.value=d.response?.data?.message||"Erreur lors du chargement des visites.",k.create({type:"negative",message:J.value}),B.value=[],C.total=0}finally{$.visits=!1}},Pe=je(()=>L(1),500),Ne=async()=>{$.outcomeTypes=!0;try{const{data:p}=await Y("get","/infirmary/form-data/outcome-types");o.value=p.map(d=>({label:be(d),value:d}))}catch(p){console.error("Error fetching outcome types:",p),k.create({type:"negative",message:"Erreur chargement types de suivi."})}finally{$.outcomeTypes=!1}},be=p=>p?{RETURNED_TO_CLASS:"Retourné(e) en Classe",RETURNED_TO_WORK:"Retourné(e) au Travail",SENT_HOME:"Renvoyé(e) à Domicile",EVACUATED_HOSPITAL:"Évacué(e) Hôpital",AWAITING_PARENT:"En Attente Parent",OTHER:"Autre"}[p]||p.replace(/_/g," ").toLowerCase().replace(/\b\w/g,m=>m.toUpperCase()):"N/A",Ue=p=>({RETURNED_TO_CLASS:"positive",RETURNED_TO_WORK:"positive",SENT_HOME:"warning",EVACUATED_HOSPITAL:"negative",AWAITING_PARENT:"info",OTHER:"grey"})[p]||"grey",qe=p=>p?{[ue]:"Élève",[Te]:"Personnel",[Ce]:"Admin",[Me]:"Professeur"}[p]||p:"N/A",Ve=p=>({[ue]:"sym_o_school",[Te]:"sym_o_badge",[Ce]:"sym_o_admin_panel_settings",[Me]:"sym_o_history_edu"})[p]||"sym_o_person",W=p=>({[ue]:"primary",[Te]:"secondary",[Ce]:"accent",[Me]:"info"})[p]||"grey",ae=()=>{w.idannee=T.value||(ce.value.length>0?ce.value[0].value:null),w.date_from=null,w.date_to=null,w.person_type=null,w.outcome_type=null,L(1)},S=()=>{M.value=null,i.value=!1,H.value=!0},he=p=>{M.value=p.id_visit,i.value=!1,H.value=!0},we=p=>{M.value=p.id_visit,i.value=!0,H.value=!0},_e=()=>{H.value=!1,L(C.current_page)},R=p=>{c.dialog({title:"Confirmer Suppression",message:"Êtes-vous sûr de vouloir supprimer cette visite d'infirmerie ? Cette action est irréversible.",cancel:{label:"Annuler",color:"grey"},ok:{label:"Supprimer",color:"negative"},persistent:!0}).onOk(async()=>{c.loading.show({spinner:Ae,message:"Suppression en cours..."});try{await Y("delete",`/infirmary/visits/${p}`),k.create({type:"positive",message:"Visite supprimée avec succès."}),L(B.value.length===1&&C.current_page>1?C.current_page-1:C.current_page)}catch(d){console.error("Error deleting visit:",d),k.create({type:"negative",message:d.response?.data?.message||"Erreur lors de la suppression."})}finally{c.loading.hide()}})};return ve(w,()=>{Pe()},{deep:!1}),ve(T,p=>{p&&!w.idannee&&(w.idannee=p)}),Qt(async()=>{j("Suivi Infirmerie"),me(!1),await Ne(),await L(1),c.loading.hide()}),(p,d)=>(n(),f(Rt,{padding:"",class:"page-content infirmary-visits-container bg-white"},{default:s(()=>[t(Se,{flat:"",bordered:"",class:"filter-card q-mb-lg"},{default:s(()=>[t(pe,{class:"bg-neutral-light"},{default:s(()=>[d[8]||(d[8]=r("div",{class:"text-h6 q-mb-md text-primary"},"Visites à l'Infirmerie",-1)),r("div",el,[r("div",tl,[t(A,{dense:"",filled:"",modelValue:w.date_from,"onUpdate:modelValue":d[1]||(d[1]=m=>w.date_from=m),label:"Date Début",mask:"####-##-##",clearable:"",standout:"","bg-color":"accent-light-blue"},{prepend:s(()=>[t(D,{name:"sym_o_event",class:"cursor-pointer text-primary"},{default:s(()=>[t(ee,{cover:"","transition-show":"scale","transition-hide":"scale"},{default:s(()=>[t(ye,{modelValue:w.date_from,"onUpdate:modelValue":d[0]||(d[0]=m=>w.date_from=m),mask:"YYYY-MM-DD",minimal:"",color:"primary"},{default:s(()=>[r("div",al,[F(t(g,{label:"Fermer",color:"primary",flat:""},null,512),[[O]])])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),r("div",ll,[t(A,{dense:"",filled:"",modelValue:w.date_to,"onUpdate:modelValue":d[3]||(d[3]=m=>w.date_to=m),label:"Date Fin",mask:"####-##-##",clearable:"",standout:"","bg-color":"accent-light-blue"},{prepend:s(()=>[t(D,{name:"sym_o_event",class:"cursor-pointer text-primary"},{default:s(()=>[t(ee,{cover:"","transition-show":"scale","transition-hide":"scale"},{default:s(()=>[t(ye,{modelValue:w.date_to,"onUpdate:modelValue":d[2]||(d[2]=m=>w.date_to=m),mask:"YYYY-MM-DD",minimal:"",options:X,color:"primary"},{default:s(()=>[r("div",ol,[F(t(g,{label:"Fermer",color:"primary",flat:""},null,512),[[O]])])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),r("div",sl,[t(re,{dense:"",filled:"",modelValue:w.outcome_type,"onUpdate:modelValue":d[4]||(d[4]=m=>w.outcome_type=m),options:o.value,label:"Type de Suivi","emit-value":"","map-options":"",clearable:"",loading:$.outcomeTypes,"options-dense":"",standout:"","bg-color":"accent-light-blue"},null,8,["modelValue","options","loading"])]),r("div",il,[t(re,{dense:"",filled:"",modelValue:w.person_type,"onUpdate:modelValue":d[5]||(d[5]=m=>w.person_type=m),options:_.value,label:"Type de Personne","emit-value":"","map-options":"",clearable:"","options-dense":"",standout:"","bg-color":"accent-light-blue"},null,8,["modelValue","options"])]),r("div",rl,[t(g,{label:"Effacer Filtres",color:"neutral-mid-grey",flat:"",onClick:ae,icon:"clear",class:"full-width",rounded:""})])])]),_:1})]),_:1}),r("div",nl,[t(g,{color:"primary",icon:"sym_o_add_circle",label:"Nouvelle Visite",onClick:S,class:"btn-elevated",rounded:""})]),$.visits?(n(),V("div",dl,[t(I(Ae),{color:"primary",size:"50px"}),d[9]||(d[9]=r("p",{class:"text-neutral-mid-grey q-mt-md"},"Chargement des visites...",-1))])):J.value?(n(),V("div",ul,[t(D,{name:"sym_o_error",size:"4em",color:"negative"}),d[10]||(d[10]=r("p",{class:"text-negative q-mt-md text-h6"},"Erreur de chargement",-1)),r("p",ml,x(J.value),1)])):B.value.length?(n(),f(_t,{key:3,bordered:"",separator:"",class:"rounded-lg shadow-1"},{default:s(()=>[t(U,{header:"",class:"bg-neutral-mid-grey text-accent-light-blue text-weight-medium rounded-t-lg q-px-md"},{default:s(()=>[t(D,{name:"sym_o_list_alt",class:"q-mr-sm"}),v(" "+x(C.total)+" visite(s) trouvée(s) ",1)]),_:1}),t(Ft,{items:B.value,separator:"",style:{"max-height":"70vh"}},{default:s(({item:m,index:N})=>[(n(),f(Z,{key:m.id_visit,clickable:"",class:"visit-item"},{default:s(()=>[t(P,{avatar:"",top:"",class:"q-pt-sm"},{default:s(()=>[m.person_visited?.photo?(n(),f(ie,{key:0,color:W(m.person_visited?.type),"text-color":"white"},{default:s(()=>[r("img",{src:I($t)(m.person_visited.photo)},null,8,_l)]),_:2},1032,["color"])):(n(),f(ie,{key:1,icon:Ve(m.person_visited?.type),color:W(m.person_visited?.type),"text-color":"white"},null,8,["icon","color"]))]),_:2},1024),t(P,null,{default:s(()=>[t(U,{class:"text-weight-bold text-text-dark"},{default:s(()=>[v(x(m.person_visited_name)+" ",1),m.person_visited?.type===ue&&m.visited_person_class_name&&m.visited_person_class_name!=="N/A"?(n(),V("span",pl," ("+x(m.visited_person_class_name)+") ",1)):m.person_visited?.type!==ue?(n(),V("span",fl," ("+x(qe(m.person_visited?.type))+") ",1)):y("",!0)]),_:2},1024),t(U,{caption:"",class:"text-neutral-mid-grey"},{default:s(()=>[t(D,{name:"sym_o_calendar_today",size:"xs",class:"q-mr-xs"}),v(" "+x(K(m.visit_datetime,"DD/MM/YYYY HH:mm")),1)]),_:2},1024),t(U,{caption:"",class:"text-neutral-mid-grey ellipsis-2-lines"},{default:s(()=>[t(D,{name:"sym_o_sick",size:"xs",class:"q-mr-xs"}),v(" Motif: "+x(m.motif_visit),1)]),_:2},1024)]),_:2},1024),t(P,{side:"",top:"",class:"q-pt-sm q-gutter-y-xs items-end"},{default:s(()=>[t(Ke,{dense:"",square:"",label:be(m.outcome_type),color:Ue(m.outcome_type),"text-color":"white",class:"status-chip"},null,8,["label","color"]),t(U,{caption:"",class:"text-neutral-mid-grey"},{default:s(()=>[v(" Par: "+x(m.infirmary_staff_name),1)]),_:2},1024),r("div",vl,[t(g,{flat:"",dense:"",round:"",icon:"sym_o_visibility",onClick:De(ne=>we(m),["stop"]),color:"info",size:"sm"},{default:s(()=>[t(z,null,{default:s(()=>d[13]||(d[13]=[v("Voir Détails")])),_:1})]),_:2},1032,["onClick"]),t(g,{flat:"",dense:"",round:"",icon:"sym_o_edit",onClick:De(ne=>he(m),["stop"]),color:"secondary",size:"sm"},{default:s(()=>[t(z,null,{default:s(()=>d[14]||(d[14]=[v("Modifier")])),_:1})]),_:2},1032,["onClick"]),t(g,{flat:"",dense:"",round:"",icon:"sym_o_delete",onClick:De(ne=>R(m.id_visit),["stop"]),color:"negative",size:"sm"},{default:s(()=>[t(z,null,{default:s(()=>d[15]||(d[15]=[v("Supprimer")])),_:1})]),_:2},1032,["onClick"])])]),_:2},1024)]),_:2},1024))]),_:1},8,["items"]),C.last_page>1?(n(),f(ct,{key:0,align:"center",class:"q-pa-md"},{default:s(()=>[t(Ot,{modelValue:C.current_page,"onUpdate:modelValue":[d[6]||(d[6]=m=>C.current_page=m),L],max:C.last_page,"direction-links":"",flat:"",color:"primary","active-color":"primary"},null,8,["modelValue","max"])]),_:1})):y("",!0)]),_:1})):(n(),V("div",cl,[t(D,{name:"sym_o_medication",size:"4em",color:"neutral-mid-grey"}),d[11]||(d[11]=r("p",{class:"text-neutral-mid-grey q-mt-md text-h6"},"Aucune visite d'infirmerie trouvée.",-1)),d[12]||(d[12]=r("p",{class:"text-neutral-mid-grey"},"Utilisez les filtres ou ajoutez une nouvelle visite.",-1))])),t(Za,{isDialogVisible:H.value,"onUpdate:isDialogVisible":d[7]||(d[7]=m=>H.value=m),"visit-id":M.value,"is-view-mode":i.value,onVisitSaved:_e},null,8,["isDialogVisible","visit-id","is-view-mode"])]),_:1}))}},ao=dt(yl,[["__scopeId","data-v-2c2de493"]]);export{ao as default};
