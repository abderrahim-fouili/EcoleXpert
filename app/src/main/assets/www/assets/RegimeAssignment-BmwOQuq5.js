import{_ as M,aP as O,B as F,A as n,Y as P,N as r,C as Z,Q as H,S as g,a6 as l,a5 as a,aE as J,aF as T,a8 as c,a4 as _,ad as v,ay as I,ab as p,aZ as B,a_ as N,ac as $,a3 as K,R as W,b7 as X,aC as ee,a as V}from"./index-Bl2lQPd7.js";import{Q as k}from"./QItemLabel-BkJiB6aE.js";import{Q as x,a as b}from"./QItem-De3v03wU.js";import{Q as q}from"./QSelect-DchnWyXK.js";import{Q as se}from"./QChip-C9OfA2gn.js";import{Q as ae}from"./QBadge-Bjfo5tRO.js";import{Q as le}from"./QTd-CpEgdqvP.js";import{Q as te}from"./QTable-D-OlObRI.js";import{Q as ne}from"./QSpinnerGears-DmolwAR1.js";import{Q as re}from"./QInnerLoading-WxvcYHvS.js";import"./QMenu-BNr9Tzvf.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./rtl-DFPa-2ov.js";import"./format-IcNrutKL.js";import"./QVirtualScroll-CENgsPEr.js";import"./QList-CMzNTEGD.js";import"./QLinearProgress-DW1NPbfx.js";const oe={key:0,class:"q-mb-md bg-red-1 q-pa-md rounded-borders text-negative"},ie={key:1,class:"pl-md q-gutter-md"},ue={class:"grid grid-cols-1 lg:grid-cols-2 gap-2 lg:gap-4"},de={class:""},ce={class:""},me={key:0},ge={key:1},ve={class:"grid grid-cols-1 lg:grid-cols-2 gap-2 lg:gap-4 items-center"},pe={class:""},fe={class:""},_e={key:0},ye={key:0,class:"text-center text-grey-6 q-pa-md"},be={class:"text-subtitle1"},he={key:1,class:"text-center q-pa-md"},Qe={__name:"RegimeAssignment",setup(xe){const L=O(),h=F(()=>L.getters["user/current"]?.annee),f=n({classes:!1,regimes:!1,students:!1}),w=n(!1),A=n(!1),C=n([]),Q=n([]),o=n([]),y=n([]),d=n([]),i=n(null),S=F(()=>{if(d.value&&d.value.length>0){const t=new Set(d.value);return o.value.filter(s=>t.has(s.idpers))}return o.value}),u=n([]),U=[{name:"nom_complet",label:"Nom Complet",field:"nom_complet",align:"left",sortable:!0},{name:"classe_display",label:"Classe",field:"classe_display",align:"left",sortable:!0},{name:"regime_display",label:"Régime Actuel",field:"regime_display",align:"center",sortable:!0}],m=n([]),R=n(""),D=(t,s)=>{if(R.value=t,t===null||t===""){s(()=>{m.value=o.value});return}s(()=>{const e=t.toLowerCase();m.value=o.value.filter(z=>z.nom_complet.toLowerCase().includes(e))})},Y=async t=>{if(t){f.value.classes=!0;try{const{data:s}=await V("get",`/filters/classes/${t}`);s?.status==="success"&&Array.isArray(s.data)?C.value=s.data.map(e=>({idclasse:e.idclasse,classe_fr:e.classe_fr||e.name,bref:e.bref})):(C.value=[],r.create({type:"warning",message:s?.message||"Impossible de charger la liste des classes."}))}catch(s){console.error("Error fetching available classes:",s),C.value=[],r.create({type:"negative",message:"Erreur lors du chargement des classes."})}finally{f.value.classes=!1}}},j=async()=>{f.value.regimes=!0;try{const{data:t}=await V("get","/regimes/list");t?.status==="success"&&Array.isArray(t.data)?Q.value=t.data:(Q.value=[],r.create({type:"warning",message:t?.message||"Impossible de charger la liste des régimes."}))}catch(t){console.error("Error fetching available regimes:",t),Q.value=[],r.create({type:"negative",message:"Erreur lors du chargement des régimes."})}finally{f.value.regimes=!1}},E=async()=>{const t=h.value?.idannee;if(!t){o.value=[],u.value=[],d.value=[],m.value=[];return}w.value=!0;try{const s=y.value.length>0?{class_ids:y.value}:{},{data:e}=await V("get",`/regimes/students/${t}`,{params:s});e?.status==="success"&&Array.isArray(e.data)?(o.value=e.data,R.value="",m.value=o.value):(o.value=[],r.create({type:"warning",message:e?.message||"Impossible de charger la liste des élèves."})),u.value=[],d.value=[],i.value=null}catch(s){console.error("Error fetching students with regimes:",s),o.value=[],r.create({type:"negative",message:"Erreur lors du chargement des élèves et de leurs régimes."}),u.value=[],d.value=[],m.value=[],i.value=null}finally{w.value=!1}},G=async()=>{if(u.value.length===0){r.create({type:"warning",message:"Veuillez sélectionner les élèves auxquels assigner un régime."});return}if(i.value===null||i.value===void 0){r.create({type:"warning",message:"Veuillez sélectionner le régime à assigner."});return}A.value=!0;const t=u.value.map(e=>e.idpers),s=i.value?.id_regime;try{const{data:e}=await V("post","/regimes/assign",{student_ids:t,regime_id:s});e?.status==="success"?(r.create({type:"success",message:e.message}),E()):r.create({type:"negative",message:e?.message||"Erreur lors de l'assignation du régime."})}catch(e){console.error("Error assigning regime:",e),r.create({type:"negative",message:`Échec de l'assignation du régime : ${e.message||"Erreur inconnue"}`})}finally{A.value=!1,i.value=null}};return P(()=>h.value?.idannee,(t,s)=>{t&&t>0?(console.log(`Year changed to ${t}. Fetching classes and students.`),y.value=[],u.value=[],d.value=[],o.value=[],m.value=[],i.value=null,Y(t),E(),j()):t||(y.value=[],u.value=[],d.value=[],o.value=[],m.value=[],Q.value=[],i.value=null,r.create({type:"warning",message:"Aucune année scolaire sélectionnée."}))},{immediate:!0}),P(S,()=>{u.value=[]}),Z(()=>{}),(t,s)=>(g(),H(ee,{class:"page-content"},{default:l(()=>[a(J,{flat:""},{default:l(()=>[a(T,null,{default:l(()=>s[4]||(s[4]=[c("div",{class:"text-h6"},"Assigner Régimes aux Élèves",-1)])),_:1}),a(T,null,{default:l(()=>[h.value?.idannee?(g(),_("div",ie,[c("div",ue,[c("div",de,[a(q,{dense:"",filled:"",modelValue:y.value,"onUpdate:modelValue":[s[0]||(s[0]=e=>y.value=e),E],options:C.value,label:"Filtrer par Classe(s)","option-label":"classe_fr","option-value":"idclasse",multiple:"","use-chips":"","emit-value":"","map-options":"",clearable:"",loading:f.value.classes},{option:l(e=>[a(x,B(N(e.itemProps)),{default:l(()=>[a(b,null,{default:l(()=>[a(k,null,{default:l(()=>[v(p(e.opt.classe_fr),1)]),_:2},1024),a(k,{caption:""},{default:l(()=>[v(p(e.opt.bref),1)]),_:2},1024)]),_:2},1024)]),_:2},1040)]),"no-option":l(()=>[a(x,null,{default:l(()=>[a(b,{class:"text-grey"},{default:l(()=>[v(" Aucune classe trouvée"+p(h.value?.idannee?" pour l'année "+h.value.description:"")+". ",1)]),_:1})]),_:1})]),_:1},8,["modelValue","options","loading"])]),c("div",ce,[a(q,{dense:"",filled:"",modelValue:d.value,"onUpdate:modelValue":s[1]||(s[1]=e=>d.value=e),options:m.value,label:"Rechercher un élève","option-label":"nom_complet","option-value":"idpers",multiple:"","use-chips":"","emit-value":"","map-options":"",clearable:"",loading:f.value.students,"use-input":"","hide-selected":"","input-debounce":"300",onFilter:D},{"no-option":l(()=>[a(x,null,{default:l(()=>[a(b,{class:"text-grey"},{default:l(()=>[R.value?(g(),_("span",me,'Aucun élève correspondant à "'+p(R.value)+'"',1)):(g(),_("span",ge,"Entrez le nom d'un élève pour chercher."))]),_:1})]),_:1})]),"selected-item":l(e=>[a(se,{removable:"",dense:"",onRemove:z=>e.toggleOption(e.index),tabindex:e.tabindex,color:"primary","text-color":"white",class:"q-ma-none"},{default:l(()=>[v(p(e.opt.nom_complet),1)]),_:2},1032,["onRemove","tabindex"])]),_:1},8,["modelValue","options","loading"])])]),c("div",ve,[c("div",pe,[a(q,{dense:"",filled:"",modelValue:i.value,"onUpdate:modelValue":s[2]||(s[2]=e=>i.value=e),options:Q.value,label:"Régime à assigner aux sélectionnés","option-label":"nom_regime","option-value":"id_regime",clearable:"",loading:f.value.regimes},{"no-option":l(()=>[a(x,null,{default:l(()=>[a(b,{class:"text-grey"},{default:l(()=>s[6]||(s[6]=[v("Aucun régime disponible.")])),_:1})]),_:1})]),option:l(e=>[a(x,B(N(e.itemProps)),{default:l(()=>[a(b,{avatar:""},{default:l(()=>[a(I,{name:"circle",style:$({color:e.opt.color||"#000000"})},null,8,["style"])]),_:2},1024),a(b,null,{default:l(()=>[a(k,null,{default:l(()=>[v(p(e.opt.nom_regime),1)]),_:2},1024),a(k,{caption:""},{default:l(()=>[v(p(e.opt.code_regime),1)]),_:2},1024)]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","options","loading"])]),c("div",fe,[a(K,{color:"primary",onClick:G,disable:u.value.length===0||i.value===null||A.value,loading:A.value,icon:"assignment",label:"Assigner le Régime aux Élèves Sélectionnés"},null,8,["disable","loading"])])]),w.value?(g(),_("div",he,[a(X,{color:"primary",size:"2em"}),s[9]||(s[9]=c("div",null,"Chargement des élèves...",-1))])):(g(),_("div",_e,[S.value.length===0?(g(),_("div",ye,[a(I,{name:"person_search",size:"2em"}),s[7]||(s[7]=c("div",{class:"q-mt-sm"},"Aucun élève trouvé pour les filtres appliqués.",-1))])):W("",!0),a(te,{rows:S.value,columns:U,"row-key":"idpers",selection:"multiple",selected:u.value,"onUpdate:selected":s[3]||(s[3]=e=>u.value=e),dense:"",pagination:{rowsPerPage:15},"rows-per-page-options":[15,30,50,0]},{"body-cell-regime_display":l(e=>[a(le,{props:e},{default:l(()=>[a(ae,{style:$({backgroundColor:e.row.regime_color||"#000000",color:"#ffffff"}),label:e.value},null,8,["style","label"])]),_:2},1032,["props"])]),"top-left":l(()=>[c("div",be,"Élèves Trouvés ("+p(S.value.length)+")",1)]),"top-right":l(()=>s[8]||(s[8]=[])),_:1},8,["rows","selected"])]))])):(g(),_("div",oe,[a(I,{name:"warning",color:"negative",class:"q-mr-sm"}),s[5]||(s[5]=v(" Veuillez sélectionner une année scolaire dans le menu de navigation pour gérer les régimes des élèves. "))]))]),_:1}),a(re,{showing:w.value},{default:l(()=>[a(ne,{size:"50px",color:"primary"})]),_:1},8,["showing"])]),_:1})]),_:1}))}},Ue=M(Qe,[["__scopeId","data-v-db2c7a02"]]);export{Ue as default};
