import{_ as C,as as w,at as x,a as T,aW as q,J as A,Q as d,S as o,a6 as r,a5 as i,av as b,a3 as u,ad as p,ab as f,b6 as F,aF as U,a4 as _,a9 as V,aa as j,ay as O,R as m,a8 as c,aZ as S,a_ as B,a2 as y,b7 as L,aG as P,aE as z}from"./index-Bl2lQPd7.js";import{Q as M}from"./QToolbarTitle-C8APieXG.js";import{Q as v}from"./QBadge-Bjfo5tRO.js";import{Q as N}from"./QToolbar-DR-_wX4W.js";import{Q as D,a as E}from"./QBreadcrumbs-D5k8AHhT.js";import{Q as I}from"./QItemLabel-BkJiB6aE.js";import{Q as R,a as k}from"./QItem-De3v03wU.js";import{Q as G}from"./QSelect-DchnWyXK.js";import{Q as g}from"./QTooltip-r7WoEuzy.js";import{Q as H}from"./QUploaderAddTrigger-OZIUWg9a.js";import{Q as J}from"./QUploader-Dwk8_y__.js";import{Q as W}from"./QForm-Dk45GsL9.js";import{C as Z}from"./ClosePopup-BY_YGFBZ.js";import"./QChip-C9OfA2gn.js";import"./QMenu-BNr9Tzvf.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./rtl-DFPa-2ov.js";import"./format-IcNrutKL.js";import"./QCircularProgress-C_b7NmsY.js";const K={data(){return{form:{objet:null,message:null,quote:null,destinataire:null,thread_id:null},destinataire:null,cfiles:0,step:null,steps:[],options:[]}},props:{message:{default:()=>null},title:{default:()=>"Nouveau message"}},computed:{...x({user:"user/user",config:"user/config",current:"user/current"}),headers(){return[{name:"Authorization",value:A.defaults.headers.common.Authorization}]},url(){return q("api")+"/messages/pj"}},methods:{...w({envoyer:"message/send"}),added(a){this.cfiles=a.length},removed(a){this.cfiles-=a.length},attach(){this.$nextTick(()=>{this.$refs.uploader.pickFiles()})},send(){this.$refs.form.validate().then(a=>{if(!a)return this.$q.notify({color:"negative",message:this.$t("stats.fields"),position:"bottom",icon:"error_outline",actions:[{label:this.$q.lang.label.close,color:"yellow"}]}),!1;this.cfiles>0?this.$refs.uploader.upload():this.sendMessage()})},sendMessage(a){let t=[];a&&(t=JSON.parse(a.xhr.response).result),console.log(this.steps),this.message&&this.message.thread_id&&(this.form.thread_id=this.message.thread_id,this.form.objet=this.message.objet),this.envoyer({form:this.form,files:t,filter:this.steps.map(e=>e.step==="service"?{type:"service",value:e.value?e.value.idrole:0,id:e.value?e.value.idrole:0,label:e.label}:e)}).then(e=>{this.$emit("message:sent",e)}).catch(e=>{this.$emit("message:error",e)})},choice(a){this.step=a.value.step,this.$nextTick(()=>{if(this.form.destinataire=this.destinataire.map(e=>e.value.idpers?{type:"personne",id:e.value.idpers,value:"personne_"+e.value.idpers,label:e.label}:e),this.step!=="personnes"&&a.value.value)this.destinataire=null,this.setOptions(),this.$refs.dest.refresh(),this.steps.push(a.value);else if(a.value.value===0)for(var t=0;t<this.steps.length;t++)this.steps[t].step===a.value.step&&delete this.steps[t]})},clear(){this.destinataire=null,this.step=null,this.steps=[],this.setOptions()},filterFn(a,t){if(console.log(a),!a||a===""){t(()=>{this.setOptions()});return}t(()=>{const e=a.toLowerCase();this.setOptions(),this.options=this.options.filter(h=>h.label.toLowerCase().indexOf(e)>-1)})},setOptions(){let a=[{label:"Parents",id:"parent",value:"parent",type:"type",step:"parent"},{label:"Administration",type:"type",value:"admin",id:"admin",step:"admin"}];if(this.config&&this.config.hasOwnProperty("meta")){let t=this.config.meta,e=[];this.form.destinataire&&this.form.destinataire.length>1&&(this.form.destinataire=[this.form.destinataire[this.form.destinataire.length-1]]);let h=this.form.destinataire;if(this.step)switch(this.step){case"admin":e=t.admins.map(l=>({label:l.description,value:l,step:"service",type:"service"})),this.options=[{label:"Tous les services",step:"service",type:"service",value:0,id:0},...e];break;case"service":h[0].value&&(e=h[0].value.utilisateurs.map(l=>({label:l.personnes.nom+" "+l.personnes.prenom,value:l.personnes,step:"personnes"})),this.options=[{label:"Tous les administrateurs",value:0,id:0,step:"personnes",type:"personne",ids:h[0].value.utilisateurs.map(l=>l.idpers)},...e]);break;case"profs":this.current.annee&&(e=this.current.annee.profs.map(l=>({label:l.nom+" "+l.prenom,value:l,step:"personnes"})),this.options=[{label:"Tous les profs",value:0,id:0,type:"personne",step:"personnes",ids:this.current.annee.profs.map(l=>l.idpers)},...e],this.$nextTick(()=>{this.steps.push({type:"eleve",step:"eleve",id:this.current.eleve.idpers,value:"eleve_"+this.current.eleve.idpers,label:this.current.eleve.nom+" "+this.current.eleve.prenom})}));break;case"parent":this.current.annee&&T("post","/messages/dest",{classe:this.current.classe.idclasse,annee:this.current.annee.idannee}).then(({data:l})=>{e=l.map(n=>({label:n.nom+" "+n.prenom,value:n,step:"personnes"})),this.options=[{label:"Tous les parents",value:0,id:0,type:"personne",step:"personnes",ids:l.map(n=>n.idpers)},...e],this.$nextTick(()=>{this.steps.push({type:"classe",step:"classe",id:this.current.classe.idclasse,value:"classe_"+this.current.classe.idclasse,label:this.current.classe.classe_fr})})});break}else this.options=a}},hasDiscs(a){return a.value.disciplines&&a.value.disciplines.length},discs(a){return a.value.disciplines[0].description}},mounted(){this.setOptions()}},X={key:2},Y={class:"row"},$={class:"col-xs-12"},ee={class:"row no-wrap items-center q-pa-sm q-gutter-xs",style:{}},se={class:"col"},te={class:"q-uploader__subtitle"};function le(a,t,e,h,l,n){return o(),d(z,null,{default:r(()=>[i(N,{class:"bg-secondary text-white shadow-2"},{default:r(()=>[b(i(u,{flat:"",dense:"",icon:"arrow_back"},null,512),[[Z]]),i(M,null,{default:r(()=>[p(f(e.title),1)]),_:1}),i(u,{flat:"",dense:"",icon:"attach_file",onClick:n.attach},{default:r(()=>[b(i(v,{floating:"",color:"yellow-9"},{default:r(()=>[p(f(l.cfiles),1)]),_:1},512),[[F,l.cfiles>0]])]),_:1},8,["onClick"]),i(u,{class:"q-ml-lg",flat:"",icon:"send",onClick:n.send},null,8,["onClick"])]),_:1}),i(U,{style:{"overflow-y":"scroll"}},{default:r(()=>[i(D,{gutter:"none"},{separator:r(()=>[i(O,{name:"arrow_forward",color:"grey-9"})]),default:r(()=>[(o(!0),_(V,null,j(l.steps,(s,Q)=>(o(),d(E,{key:"s-"+Q},{default:r(()=>[i(v,{color:"grey-4","text-color":"grey-9"},{default:r(()=>[p(f(s.label),1)]),_:2},1024)]),_:2},1024))),128))]),_:1}),i(W,{class:"q-gutter-lg",ref:"form"},{default:r(()=>[e.message?m("",!0):(o(),d(G,{key:0,ref:"dest",behavior:"menu",filled:"",modelValue:l.destinataire,"onUpdate:modelValue":t[0]||(t[0]=s=>l.destinataire=s),options:l.options,"use-chips":"",multiple:"",label:"Destinataire","lazy-rules":"",rules:[s=>!!s||"Champ requis"],onAdd:n.choice},{option:r(s=>[i(R,S(B(s.itemProps)),{default:r(()=>[i(k,null,{default:r(()=>[i(I,{innerHTML:s.opt.label},null,8,["innerHTML"])]),_:2},1024),s.opt.step==="personnes"?(o(),d(k,{key:0,side:""},{default:r(()=>[n.hasDiscs(s.opt)?(o(),d(v,{key:0},{default:r(()=>[p(f(n.discs(s.opt)),1)]),_:2},1024)):m("",!0)]),_:2},1024)):m("",!0)]),_:2},1040)]),_:1},8,["modelValue","options","rules","onAdd"])),e.message?(o(),_("div",X," RE:"+f(e.message.objet),1)):(o(),d(y,{key:1,filled:"",modelValue:l.form.objet,"onUpdate:modelValue":t[1]||(t[1]=s=>l.form.objet=s),label:"Objet",hint:"","lazy-rules":"",rules:[s=>!!s||"Champ requis"]},null,8,["modelValue","rules"])),i(y,{filled:"",modelValue:l.form.message,"onUpdate:modelValue":t[2]||(t[2]=s=>l.form.message=s),autogrow:"",type:"textarea",label:"Message",rules:[s=>!!s||"Champ requis"],"lazy-rules":"","input-style":"min-height:150px"},null,8,["modelValue","rules"]),c("div",Y,[c("div",$,[i(J,{"field-name":s=>"pieces_jointe[]",style:{width:"100%"},url:n.url,flat:"",multiple:"",headers:n.headers,ref:"uploader",batch:"",onAdded:n.added,onRemoved:n.removed,onUploaded:n.sendMessage},{header:r(s=>[c("div",ee,[s.queuedFiles.length>0?(o(),d(u,{key:0,icon:"clear_all",onClick:s.removeQueuedFiles,round:"",dense:"",flat:""},{default:r(()=>[i(g,null,{default:r(()=>t[3]||(t[3]=[p("Clear All")])),_:1})]),_:2},1032,["onClick"])):m("",!0),s.uploadedFiles.length>0?(o(),d(u,{key:1,icon:"done_all",onClick:s.removeUploadedFiles,round:"",dense:"",flat:""},{default:r(()=>[i(g,null,{default:r(()=>t[4]||(t[4]=[p("Remove Uploaded Files")])),_:1})]),_:2},1032,["onClick"])):m("",!0),s.isUploading?(o(),d(L,{key:2,class:"q-uploader__spinner"})):m("",!0),c("div",se,[t[5]||(t[5]=c("div",{class:"q-uploader__title"},"Fichiers joint",-1)),c("div",te,f(s.uploadSizeLabel)+" / "+f(s.uploadProgressLabel),1)]),s.canAddFiles?(o(),d(u,{key:3,type:"a",icon:"add_box",round:"",dense:"",flat:""},{default:r(()=>[i(H),i(g,null,{default:r(()=>t[6]||(t[6]=[p("Pick Files")])),_:1})]),_:1})):m("",!0),s.isUploading?(o(),d(u,{key:4,icon:"clear",onClick:s.abort,round:"",dense:"",flat:""},{default:r(()=>[i(g,null,{default:r(()=>t[7]||(t[7]=[p("Abort Upload")])),_:1})]),_:2},1032,["onClick"])):m("",!0)])]),_:1},8,["url","headers","onAdded","onRemoved","onUploaded"])])])]),_:1},512)]),_:1}),i(P,{align:"right",class:""},{default:r(()=>[i(u,{label:"Envoyer",icon:"send",onClick:n.send},null,8,["onClick"])]),_:1})]),_:1})}const we=C(K,[["render",le]]);export{we as default};
