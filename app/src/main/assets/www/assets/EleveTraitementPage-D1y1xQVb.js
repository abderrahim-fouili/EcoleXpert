const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./EleveTraitementReport-BqYxTa-6.js","./date-C1Mon-Jj.js","./index-Bl2lQPd7.js","./index-B-uS9A6y.css","./format-IcNrutKL.js","./EleveTraitementReport-C3wJLcZ8.css"])))=>i.map(i=>d[i]);
import{a4 as F,Q as V,S as p,a6 as a,a9 as Te,aa as Ye,a5 as e,ay as W,R as w,ad as j,ab as h,a3 as C,_ as pt,aO as Pe,aT as Ke,A as M,aU as fe,B as E,Y as Ve,aE as $e,av as ge,aF as xe,aS as R,a8 as _,a2 as I,aV as Ze,aD as He,N as $,a as te,aP as We,aW as ct,J as vt,aX as Qe,ah as Me,aY as _t,aM as Re,C as ft,aZ as gt,a_ as yt,a7 as Ie,a$ as bt,aG as Vt,aC as xt,aB as ht,b0 as Dt}from"./index-Bl2lQPd7.js";import{Q as X}from"./QSelect-DchnWyXK.js";import{Q as oe,a as H}from"./QItem-De3v03wU.js";import{Q as J}from"./QItemLabel-BkJiB6aE.js";import{Q as wt}from"./QSpinnerDots-BW9ZsFNG.js";import{Q as qe}from"./QChip-C9OfA2gn.js";import{Q as ye}from"./QTooltip-r7WoEuzy.js";import{Q as kt}from"./QVirtualScroll-CENgsPEr.js";import{Q as Ee}from"./QList-CMzNTEGD.js";import{Q as Mt}from"./QPagination-UgiQF7o2.js";import{q as Z}from"./date-C1Mon-Jj.js";import{Q as Ne}from"./QToolbarTitle-C8APieXG.js";import{Q as et}from"./QSpace-CKKoNTi_.js";import{Q as Be}from"./QToolbar-DR-_wX4W.js";import{Q as Je,a as pe}from"./QTabs-yl5EIOig.js";import{Q as Xe}from"./QDate-C_jC-zMt.js";import{Q as je}from"./QPopupProxy-CQ30ymZI.js";import{Q as $t,a as Fe}from"./QTabPanels-Bqg1c7oo.js";import{Q as Et}from"./QUploader-Dwk8_y__.js";import{Q as tt}from"./QForm-Dk45GsL9.js";import{Q as jt}from"./QImg-BMvxJu3S.js";import{C as be}from"./ClosePopup-BY_YGFBZ.js";import{u as at,a as Oe,b as St}from"./app-B6uniWGw.js";import{Q as Ge}from"./QTime-DY-qDies.js";import{E as At}from"./ExportControls-UOL0zNKZ.js";import"./QMenu-BNr9Tzvf.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./rtl-DFPa-2ov.js";import"./format-IcNrutKL.js";import"./use-render-cache-DLxPkVnQ.js";import"./use-datetime-hbLWgGn4.js";import"./TouchSwipe-jpsGI2FR.js";import"./touch-BjYP5sR0.js";import"./QCircularProgress-C_b7NmsY.js";import"./TouchPan-jBhMORlX.js";import"./_commonjsHelpers-D6-XlEtG.js";const Ut={key:0,class:"un-text-center un-p-4 un-text-gray-500 un-bg-gray-50 un-rounded-md"},Ct={key:0,class:"un-mt-1 un-flex un-gap-1"},It={__name:"HorairesList",props:{horaires:Array,isViewMode:Boolean},emits:["editHoraire","deleteHoraire"],setup(x){const ae=c=>c?c.replace(/_/g," ").toLowerCase().replace(/\b\w/g,A=>A.toUpperCase()):"N/A",S=c=>{if(!c||c.length===0)return"Tous les jours actifs du protocole";const A={1:"Lun",2:"Mar",3:"Mer",4:"Jeu",5:"Ven",6:"Sam",7:"Dim"};return c.map(T=>String(T)).map(T=>A[T]||T).join(", ")},P=c=>{switch(c.type_horaire){case"FIXED_TIME":return`À ${c.heure_fixe||"N/D"}, ${S(c.jours_semaine)}`;case"EVENT_BASED":return`Événement: ${c.description_evenement||"N/D"}`;case"AS_NEEDED":return`Déclencheur: ${c.description_declencheur_as_needed||"N/D"}. Max: ${c.frequence_max_as_needed||"Non spécifié"}`;case"INTERVAL":return`Début à ${c.heure_debut_intervalle||"N/D"}, toutes les ${c.intervalle_valeur||"?"} ${c.intervalle_unite?.toLowerCase()||"N/D"}. Doses/jour: ${c.doses_par_jour_intervalle||"?"}. Jours: ${S(c.jours_semaine)}`;default:return"Détails non disponibles"}};return(c,A)=>!x.horaires||x.horaires.length===0?(p(),F("div",Ut," Aucun horaire défini pour ce protocole de traitement. ")):(p(),V(Ee,{key:1,bordered:"",separator:"",class:"un-rounded-md"},{default:a(()=>[(p(!0),F(Te,null,Ye(x.horaires,y=>(p(),V(oe,{key:y.id_horaire,class:"un-py-3 hover:un-bg-slate-50"},{default:a(()=>[e(H,{avatar:""},{default:a(()=>[e(W,{name:"sym_o_alarm",color:y.is_active?"primary":"grey-5"},null,8,["color"])]),_:2},1024),e(H,null,{default:a(()=>[e(J,{class:"un-font-medium un-text-slate-700"},{default:a(()=>[j(h(ae(y.type_horaire)),1)]),_:2},1024),e(J,{caption:""},{default:a(()=>[j(h(P(y)),1)]),_:2},1024),y.notes_specifiques_horaire?(p(),V(J,{key:0,caption:"",class:"un-text-sm un-italic un-text-gray-500"},{default:a(()=>[j(" Note: "+h(y.notes_specifiques_horaire),1)]),_:2},1024)):w("",!0)]),_:2},1024),e(H,{side:"",top:""},{default:a(()=>[e(qe,{dense:"",label:y.is_active?"Actif":"Inactif",color:y.is_active?"positive":"grey-6","text-color":"white",class:"un-text-sm"},null,8,["label","color"]),x.isViewMode?w("",!0):(p(),F("div",Ct,[e(C,{flat:"",dense:"",round:"",icon:"sym_o_edit",color:"secondary",size:"sm",onClick:T=>c.$emit("editHoraire",y)},{default:a(()=>[e(ye,null,{default:a(()=>A[0]||(A[0]=[j("Modifier")])),_:1})]),_:2},1032,["onClick"]),e(C,{flat:"",dense:"",round:"",icon:"sym_o_delete",color:"negative",size:"sm",onClick:T=>c.$emit("deleteHoraire",y.id_horaire)},{default:a(()=>[e(ye,null,{default:a(()=>A[1]||(A[1]=[j("Supprimer")])),_:1})]),_:2},1032,["onClick"])]))]),_:2},1024)]),_:2},1024))),128))]),_:1}))}},Ft={key:0,class:"space-y-4 p-3 border border-sky-200 rounded-md bg-sky-50"},Tt={key:1,class:"space-y-4 p-3 border border-teal-200 rounded-md bg-teal-50"},Yt={key:2,class:"space-y-4 p-3 border border-orange-200 rounded-md bg-orange-50"},Ht={key:3,class:"space-y-4 p-3 border border-indigo-200 rounded-md bg-indigo-50"},Qt={class:"grid grid-cols-2 gap-4"},qt={__name:"EleveTraitementHoraireDialog",props:{isDialogVisible:Boolean,traitementId:[Number,String,null],horaireData:Object},emits:["update:isDialogVisible","horaireSaved"],setup(x,{emit:ae}){const S=x,P=ae;Pe();const c=at(),{user:A}=Ke(c),y=M(null),T=()=>({id_traitement_eleve:S.traitementId,type_horaire:null,heure_fixe:null,jours_semaine:[],description_evenement:null,evenement_cle_systeme:null,description_declencheur_as_needed:null,frequence_max_as_needed:null,heure_debut_intervalle:null,intervalle_valeur:null,intervalle_unite:null,doses_par_jour_intervalle:null,notes_specifiques_horaire:null,is_active:!0,created_by:null,updated_by:null,jours_semaine_interval:[]}),i=fe(T()),Q=M(!1),v=M({}),{horaireTypeOptions:N,intervalUnitOptions:O,fetchHoraireTypes:ie,fetchHoraireIntervalUnits:l}=Oe(),b=[{label:"Lundi",value:"1"},{label:"Mardi",value:"2"},{label:"Mercredi",value:"3"},{label:"Jeudi",value:"4"},{label:"Vendredi",value:"5"},{label:"Samedi",value:"6"},{label:"Dimanche",value:"7"}],D=E({get:()=>S.isDialogVisible,set:k=>P("update:isDialogVisible",k)}),f=E(()=>!!S.horaireData?.id_horaire),B=E(()=>f.value?"Modifier Horaire d'Administration":"Nouvel Horaire d'Administration"),z=async()=>{if(L(),await Promise.all([ie(),l()]),S.horaireData){if(Object.assign(i,S.horaireData),i.type_horaire==="INTERVAL"&&Array.isArray(i.jours_semaine))i.jours_semaine_interval=[...i.jours_semaine],i.jours_semaine=[];else if(i.type_horaire==="FIXED_TIME"&&Array.isArray(i.jours_semaine))i.jours_semaine_interval=[];else if(!Array.isArray(i.jours_semaine)){const k=i.jours_semaine?String(i.jours_semaine).split(","):[];i.type_horaire==="INTERVAL"?(i.jours_semaine_interval=k,i.jours_semaine=[]):(i.jours_semaine=k,i.jours_semaine_interval=[])}}!i.id_traitement_eleve&&S.traitementId&&(i.id_traitement_eleve=S.traitementId)},L=()=>{Object.assign(i,T()),v.value={}},Y=()=>{L()},U=k=>{v.value[k]&&delete v.value[k]},ce=async()=>{if(!i.id_traitement_eleve){$.create({type:"negative",message:"ID du protocole de traitement parent manquant.",position:"top"});return}if(!await y.value.validate()){$.create({type:"warning",message:"Veuillez corriger les erreurs.",position:"top"});return}Q.value=!0,v.value={};const o={...i};A.value&&(f.value||(o.created_by=A.value.idpers),o.updated_by=A.value.idpers),o.type_horaire==="INTERVAL"&&(o.jours_semaine=o.jours_semaine_interval||[]),delete o.jours_semaine_interval,["heure_fixe","description_evenement","evenement_cle_systeme","description_declencheur_as_needed","frequence_max_as_needed","heure_debut_intervalle","notes_specifiques_horaire"].forEach(s=>{o[s]===""&&(o[s]=null)}),["intervalle_valeur","doses_par_jour_intervalle"].forEach(s=>{o[s]===""||o[s]===null||isNaN(parseInt(o[s]))?o[s]=null:o[s]=parseInt(o[s])});try{let s;const G=`/eleve-traitements/${i.id_traitement_eleve}/horaires`;f.value?s=await te("put",`${G}/${S.horaireData.id_horaire}`,o):s=await te("post",G,o),$.create({type:"positive",message:"Horaire sauvegardé avec succès.",position:"top"}),P("horaireSaved",s.data.data),D.value=!1}catch(s){console.error("Error saving horaire:",s.response),s.response&&s.response.status===422&&s.response.data.errors?(v.value=s.response.data.errors,$.create({type:"negative",message:"Veuillez vérifier les champs.",position:"top"})):$.create({type:"negative",message:s.response?.data?.message||"Erreur sauvegarde horaire.",position:"top"})}finally{Q.value=!1}};return Ve(()=>i.type_horaire,k=>{k!=="FIXED_TIME"&&(i.heure_fixe=null,k!=="INTERVAL"&&(i.jours_semaine=[])),k!=="EVENT_BASED"&&(i.description_evenement=null,i.evenement_cle_systeme=null),k!=="AS_NEEDED"&&(i.description_declencheur_as_needed=null,i.frequence_max_as_needed=null),k!=="INTERVAL"&&(i.heure_debut_intervalle=null,i.intervalle_valeur=null,i.intervalle_unite=null,i.doses_par_jour_intervalle=null,i.jours_semaine_interval=[],k!=="FIXED_TIME"&&(i.jours_semaine=[])),v.value={}}),Ve(()=>S.traitementId,k=>{k&&(i.id_traitement_eleve=k)}),(k,o)=>(p(),V(He,{modelValue:D.value,"onUpdate:modelValue":o[28]||(o[28]=s=>D.value=s),persistent:"",onBeforeShow:z,onHide:Y,maximized:""},{default:a(()=>[e($e,{class:"un-flex flex-col h-full"},{default:a(()=>[e(Be,{class:"bg-secondary text-white shadow-md"},{default:a(()=>[ge(e(C,{flat:"",dense:"",icon:"sym_o_arrow_back"},null,512),[[be]]),e(Ne,null,{default:a(()=>[j(h(B.value),1)]),_:1}),e(et),e(C,{label:"Sauvegarder Horaire",icon:"sym_o_save",onClick:ce,loading:Q.value,class:"mr-sm rounded-md",unelevated:""},null,8,["loading"]),ge(e(C,{flat:"",dense:"",icon:"sym_o_close"},null,512),[[be]])]),_:1}),e(xe,{class:"flex-grow overflow-auto p-4"},{default:a(()=>[e(tt,{ref_key:"horaireFormRef",ref:y,class:"space-y-4"},{default:a(()=>[e(X,{dense:"",filled:"",required:"",modelValue:i.type_horaire,"onUpdate:modelValue":o[0]||(o[0]=s=>i.type_horaire=s),options:R(N),label:"Type d'Horaire *","emit-value":"","map-options":"",rules:[s=>!!s||"Type d'horaire requis"],error:!!v.value.type_horaire,"error-message":v.value.type_horaire,onBlur:o[1]||(o[1]=s=>U("type_horaire")),standout:"bg-sky-50",class:"rounded-md"},null,8,["modelValue","options","rules","error","error-message"]),i.type_horaire==="FIXED_TIME"?(p(),F("div",Ft,[o[29]||(o[29]=_("div",{class:"text-md font-medium text-sky-700"},"Détails pour Heure Fixe",-1)),e(I,{dense:"",filled:"",required:"",modelValue:i.heure_fixe,"onUpdate:modelValue":o[3]||(o[3]=s=>i.heure_fixe=s),label:"Heure Fixe (HH:MM) *",mask:"##:##",rules:[s=>!!s||"Heure fixe requise",s=>/^([01]\d|2[0-3]):([0-5]\d)$/.test(s)||"Format HH:MM invalide"],error:!!v.value.heure_fixe,"error-message":v.value.heure_fixe,onBlur:o[4]||(o[4]=s=>U("heure_fixe")),standout:"bg-white",class:"rounded-md"},{prepend:a(()=>[e(W,{name:"sym_o_schedule",class:"cursor-pointer"},{default:a(()=>[e(je,null,{default:a(()=>[e(Ge,{modelValue:i.heure_fixe,"onUpdate:modelValue":o[2]||(o[2]=s=>i.heure_fixe=s),format24h:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue","rules","error","error-message"]),e(X,{dense:"",filled:"",modelValue:i.jours_semaine,"onUpdate:modelValue":o[5]||(o[5]=s=>i.jours_semaine=s),options:b,label:"Jours de la Semaine (Optionnel, si vide = tous les jours actifs du protocole)",multiple:"","use-chips":"","stack-label":"","emit-value":"","map-options":"",error:!!v.value.jours_semaine,"error-message":v.value.jours_semaine,onBlur:o[6]||(o[6]=s=>U("jours_semaine")),standout:"bg-white",class:"rounded-md"},null,8,["modelValue","error","error-message"])])):w("",!0),i.type_horaire==="EVENT_BASED"?(p(),F("div",Tt,[o[30]||(o[30]=_("div",{class:"text-md font-medium text-teal-700"},"Détails pour Basé sur Événement",-1)),e(I,{dense:"",filled:"",required:"",modelValue:i.description_evenement,"onUpdate:modelValue":o[7]||(o[7]=s=>i.description_evenement=s),label:"Description Événement (ex: Avant Déjeuner) *",rules:[s=>!!s||"Description requise"],error:!!v.value.description_evenement,"error-message":v.value.description_evenement,onBlur:o[8]||(o[8]=s=>U("description_evenement")),standout:"bg-white",class:"rounded-md"},null,8,["modelValue","rules","error","error-message"]),e(I,{dense:"",filled:"",modelValue:i.evenement_cle_systeme,"onUpdate:modelValue":o[9]||(o[9]=s=>i.evenement_cle_systeme=s),label:"Clé Système Événement (Optionnel)",error:!!v.value.evenement_cle_systeme,"error-message":v.value.evenement_cle_systeme,onBlur:o[10]||(o[10]=s=>U("evenement_cle_systeme")),standout:"bg-white",class:"rounded-md"},null,8,["modelValue","error","error-message"])])):w("",!0),i.type_horaire==="AS_NEEDED"?(p(),F("div",Yt,[o[31]||(o[31]=_("div",{class:"text-md font-medium text-orange-700"},"Détails pour Au Besoin",-1)),e(I,{type:"textarea",autogrow:"",dense:"",filled:"",required:"",modelValue:i.description_declencheur_as_needed,"onUpdate:modelValue":o[11]||(o[11]=s=>i.description_declencheur_as_needed=s),label:"Description Déclencheur (ex: Si respiration sifflante) *",rules:[s=>!!s||"Description requise"],error:!!v.value.description_declencheur_as_needed,"error-message":v.value.description_declencheur_as_needed,onBlur:o[12]||(o[12]=s=>U("description_declencheur_as_needed")),standout:"bg-white",class:"rounded-md"},null,8,["modelValue","rules","error","error-message"]),e(I,{dense:"",filled:"",modelValue:i.frequence_max_as_needed,"onUpdate:modelValue":o[13]||(o[13]=s=>i.frequence_max_as_needed=s),label:"Fréquence Max (ex: Max 3 fois/jour)",error:!!v.value.frequence_max_as_needed,"error-message":v.value.frequence_max_as_needed,onBlur:o[14]||(o[14]=s=>U("frequence_max_as_needed")),standout:"bg-white",class:"rounded-md"},null,8,["modelValue","error","error-message"])])):w("",!0),i.type_horaire==="INTERVAL"?(p(),F("div",Ht,[o[32]||(o[32]=_("div",{class:"text-md font-medium text-indigo-700"},"Détails pour Intervalle",-1)),e(I,{dense:"",filled:"",required:"",modelValue:i.heure_debut_intervalle,"onUpdate:modelValue":o[16]||(o[16]=s=>i.heure_debut_intervalle=s),label:"Heure de Début Intervalle (HH:MM) *",mask:"##:##",rules:[s=>!!s||"Heure de début requise",s=>/^([01]\d|2[0-3]):([0-5]\d)$/.test(s)||"Format HH:MM invalide"],error:!!v.value.heure_debut_intervalle,"error-message":v.value.heure_debut_intervalle,onBlur:o[17]||(o[17]=s=>U("heure_debut_intervalle")),standout:"bg-white",class:"rounded-md"},{prepend:a(()=>[e(W,{name:"sym_o_schedule",class:"cursor-pointer"},{default:a(()=>[e(je,null,{default:a(()=>[e(Ge,{modelValue:i.heure_debut_intervalle,"onUpdate:modelValue":o[15]||(o[15]=s=>i.heure_debut_intervalle=s),format24h:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue","rules","error","error-message"]),_("div",Qt,[e(I,{dense:"",filled:"",required:"",type:"number",modelValue:i.intervalle_valeur,"onUpdate:modelValue":o[18]||(o[18]=s=>i.intervalle_valeur=s),modelModifiers:{number:!0},label:"Valeur Intervalle *",min:1,rules:[s=>s!==null&&s>=1||"Valeur invalide"],error:!!v.value.intervalle_valeur,"error-message":v.value.intervalle_valeur,onBlur:o[19]||(o[19]=s=>U("intervalle_valeur")),standout:"bg-white",class:"rounded-md"},null,8,["modelValue","rules","error","error-message"]),e(X,{dense:"",filled:"",required:"",modelValue:i.intervalle_unite,"onUpdate:modelValue":o[20]||(o[20]=s=>i.intervalle_unite=s),options:R(O),label:"Unité Intervalle *","emit-value":"","map-options":"",rules:[s=>!!s||"Unité requise"],error:!!v.value.intervalle_unite,"error-message":v.value.intervalle_unite,onBlur:o[21]||(o[21]=s=>U("intervalle_unite")),standout:"bg-white",class:"rounded-md"},null,8,["modelValue","options","rules","error","error-message"])]),e(I,{dense:"",filled:"",required:"",type:"number",modelValue:i.doses_par_jour_intervalle,"onUpdate:modelValue":o[22]||(o[22]=s=>i.doses_par_jour_intervalle=s),modelModifiers:{number:!0},label:"Doses par Jour *",min:1,rules:[s=>s!==null&&s>=1||"Nombre de doses invalide"],error:!!v.value.doses_par_jour_intervalle,"error-message":v.value.doses_par_jour_intervalle,onBlur:o[23]||(o[23]=s=>U("doses_par_jour_intervalle")),standout:"bg-white",class:"rounded-md"},null,8,["modelValue","rules","error","error-message"]),e(X,{dense:"",filled:"",modelValue:i.jours_semaine_interval,"onUpdate:modelValue":o[24]||(o[24]=s=>i.jours_semaine_interval=s),options:b,label:"Jours de la Semaine pour Intervalle (Optionnel)",multiple:"","use-chips":"","stack-label":"","emit-value":"","map-options":"",standout:"bg-white",class:"rounded-md"},null,8,["modelValue"])])):w("",!0),e(I,{type:"textarea",autogrow:"",dense:"",filled:"",modelValue:i.notes_specifiques_horaire,"onUpdate:modelValue":o[25]||(o[25]=s=>i.notes_specifiques_horaire=s),label:"Notes Spécifiques pour cet Horaire (Optionnel)",error:!!v.value.notes_specifiques_horaire,"error-message":v.value.notes_specifiques_horaire,onBlur:o[26]||(o[26]=s=>U("notes_specifiques_horaire")),standout:"bg-sky-50",class:"rounded-md"},null,8,["modelValue","error","error-message"]),e(Ze,{modelValue:i.is_active,"onUpdate:modelValue":o[27]||(o[27]=s=>i.is_active=s),label:"Cet horaire est actif"},null,8,["modelValue"])]),_:1},512)]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},Nt=pt(qt,[["__scopeId","data-v-e73bf359"]]),Bt={class:"flex-grow flex flex-col md:flex-row"},Pt={class:"gt-sm md:basis-1/5"},Ot={class:"grid grid-cols-1 md:un-grid-cols-2 gap-4"},zt={class:"row items-center justify-end"},Lt={class:"row items-center justify-end"},Rt={key:1,class:"mt-4 p-3 bg-slate-100 rounded-md text-sm text-slate-600 space-y-1"},Jt={class:"un-flex justify-between items-center"},Xt=["src"],Gt={key:1,class:"mt-4"},Kt={key:2,class:"text-center text-gray-500 p-4 bg-gray-50 rounded-md"},Zt=["src"],Wt={__name:"EleveTraitementFormDialog",props:{isDialogVisible:Boolean,traitementId:[Number,String,null],isViewMode:Boolean},emits:["update:isDialogVisible","traitementSaved"],setup(x,{emit:ae}){const S=We(),P=E(()=>S.getters["user/current"]?.annee?.idannee),c=x,A=ae,y=Pe(),T=at(),{user:i}=Ke(T),Q=E(()=>S.getters["user/current"]),v=M(null),N=M(null),O=M("general"),ie=()=>({id_traitement:null,id_eleve:Q.value?.eleve?.idpers||null,idannee:P.value,type_maladie:0,condition_medicale:"",nom_medicament_procedure:"",instructions_dosage:"",date_debut:Z.formatDate(Date.now(),"YYYY-MM-DD"),date_fin:null,instructions_generales_notes:"",statut:"ACTIF",administration_par_personnel:!0,details_auto_administration:"",created_by:null,updated_by:null,horaires:[],pieces_jointes:[],uploaded_files:[],eleve:null,annee_scolaire:null,created_by_user:null,updated_by_user:null}),l=fe(ie()),b=M(!1),D=M(!1),f=M({}),B=M(!1),z=M(null),L=M(null),{studentOptions:Y,academicYearOptions:U,statutOptions:ce,fetchStudents:k,fetchAcademicYears:o,fetchTraitementStatuts:s}=Oe(),G=M(!1),ee=M(null),he=M(0),ne=M(!1),le=M(""),de=M(""),De=E(()=>`${ct("api")}/eleve-traitements/upload-files`),we=E(()=>{const u=vt.defaults.headers.common.Authorization;return u?[{name:"Authorization",value:u}]:[]}),Se=u=>new Promise(t=>{t({url:De.value,method:"POST",headers:we.value,fieldName:"files[]"})}),ve=E({get:()=>c.isDialogVisible,set:u=>A("update:isDialogVisible",u)}),re=E(()=>!c.traitementId&&!l.id_traitement),Ae=E(()=>c.isViewMode?"Détails du Protocole de Traitement":B.value?`Modifier Protocole: ${l.eleve?.nom||""} - Horaires & Fichiers`:re.value?"Nouveau Protocole de Traitement":"Modifier Protocole de Traitement"),ke=(u,t="DD/MM/YYYY HH:mm")=>u?Z.formatDate(u,t):"",Ue=u=>!l.date_debut||Z.extractDate(u,"YYYY/MM/DD")>=Z.extractDate(l.date_debut,"YYYY-MM-DD"),_e=async()=>{if(D.value=!0,O.value="general",B.value=!1,m(),await Promise.all([k("",""),o(),s()]),c.traitementId)await ue(c.traitementId),c.isViewMode||(B.value=!!l.id_traitement);else{const u=U.value.find(t=>t.courant===1||t.courant===!0);l.idannee=u?u.idannee:U.value[0]?.idannee||null}D.value=!1},ue=async u=>{try{const t=await te("get",`/eleve-traitements/${u}`);Object.assign(l,t.data),l.id_traitement=t.data.id_traitement,l.date_debut=Z.formatDate(l.date_debut,"YYYY-MM-DD"),l.date_fin&&(l.date_fin=Z.formatDate(l.date_fin,"YYYY-MM-DD")),l.eleve&&!Y.value.some(r=>r.idpers===l.eleve.idpers)&&Y.value.unshift({idpers:l.eleve.idpers,nom:l.eleve.nom,prenom:l.eleve.prenom,code:l.eleve.code}),l.id_eleve=t.data.id_eleve}catch(t){console.error("Error fetching traitement details:",t),$.create({type:"negative",message:"Erreur chargement des détails.",position:"top"}),q()}},Ce=Qe((u,t,r)=>{k(u,l.idannee).then(g=>{t(()=>{Y.value=g})}).catch(()=>r())},500),m=()=>{Object.assign(l,ie()),l.uploaded_files=[],f.value={},N.value&&N.value.reset()},n=()=>{m(),B.value=!1},d=()=>{!c.isViewMode&&v.value?.isDirty?y.dialog({title:"Modifications non sauvegardées",message:"Voulez-vous vraiment quitter sans sauvegarder vos modifications ?",cancel:{label:"Rester",color:"grey",flat:!0},ok:{label:"Quitter",color:"negative",unelevated:!0},persistent:!0}).onOk(()=>{q()}):q()},q=()=>{ve.value=!1},K=u=>{f.value[u]&&delete f.value[u]},lt=async()=>{if(!await v.value.validate()){$.create({type:"warning",message:"Veuillez corriger les erreurs dans le formulaire.",position:"top"});return}b.value=!0,f.value={};const t=N.value;if(!c.isViewMode&&t&&t.queuedFiles.length>0){y.loading.show({message:"Téléversement des fichiers..."});try{await new Promise((g,se)=>{z.value=g,L.value=se,t.upload()})}catch(g){$.create({type:"negative",message:g.message||"Erreur lors du téléversement des fichiers."}),b.value=!1,y.loading.hide(),z.value=null,L.value=null;return}}const r={...l};delete r.eleve,delete r.annee_scolaire,delete r.created_by_user,delete r.updated_by_user,delete r.horaires;try{let g;const se=re.value;se?g=await te("post","/eleve-traitements",r):g=await te("put",`/eleve-traitements/${l.id_traitement||c.traitementId}`,r),$.create({type:"positive",message:"Protocole de traitement sauvegardé avec succès.",position:"top"});const me=g.data.data||g.data;l.id_traitement=me.id_traitement,me.eleve&&(l.eleve=me.eleve),me.pieces_jointes&&(l.pieces_jointes=me.pieces_jointes),l.uploaded_files=[],N.value&&N.value.reset(),A("traitementSaved",me),se&&!c.isViewMode?(B.value=!0,O.value="horaires"):c.isViewMode&&q()}catch(g){console.error("Error saving traitement:",g.response),g.response&&g.response.status===422&&g.response.data.errors?(f.value=g.response.data.errors,$.create({type:"negative",message:"Veuillez vérifier les champs.",position:"top"})):$.create({type:"negative",message:g.response?.data?.message||"Erreur lors de la sauvegarde.",position:"top"})}finally{b.value=!1}},rt=()=>{const u=N.value;u&&z.value!==null&&(u.failedFiles.length>0&&L.value?L.value(new Error("Un ou plusieurs fichiers n'ont pas pu être téléversés.")):z.value&&z.value()),z.value=null,L.value=null,y.loading.isActive&&y.loading.hide()},ze=(u=null)=>{if(!l.id_traitement&&!c.traitementId){$.create({type:"warning",message:"Sauvegardez d'abord le protocole de traitement général."});return}ee.value=u?{...u}:null,he.value++,G.value=!0},st=async u=>{l.id_traitement&&await ue(l.id_traitement),G.value=!1},ot=u=>{y.dialog({title:"Confirmer Suppression Horaire",message:"Êtes-vous sûr de vouloir supprimer cet horaire ?",cancel:{label:"Annuler",color:"grey",flat:!0},ok:{label:"Supprimer",color:"negative",unelevated:!0}}).onOk(async()=>{try{await te("delete",`/eleve-traitements/${l.id_traitement}/horaires/${u}`),$.create({type:"positive",message:"Horaire supprimé.",position:"top"}),l.id_traitement&&await ue(l.id_traitement)}catch{$.create({type:"negative",message:"Erreur suppression horaire.",position:"top"})}})},it=u=>{try{const t=JSON.parse(u.xhr.responseText);t.data&&t.data.uploaded_files?(t.data.uploaded_files.forEach(r=>{const g=typeof r=="string"?r:r.name;l.uploaded_files.includes(g)||l.uploaded_files.push(g),l.pieces_jointes.some(se=>se.fichier===g)||l.pieces_jointes.push({fichier:g,isNew:!0,id:`new_${Date.now()}_${g}`})}),$.create({type:"positive",message:`${t.data.uploaded_files.length} fichier(s) prêt(s) à être associé(s). Sauvegardez le protocole.`,position:"top",multiLine:!0,timeout:4e3})):$.create({type:"negative",message:"Réponse du serveur invalide après téléversement.",position:"top"})}catch(t){console.error("Upload response parsing error:",t,u.xhr.responseText),$.create({type:"negative",message:"Erreur de traitement de la réponse du serveur.",position:"top"})}},nt=u=>{let t="Échec du téléversement.";try{const r=JSON.parse(u.xhr.responseText);r.message&&(t=r.message)}catch{}$.create({type:"negative",message:t,position:"top"})},dt=u=>{y.dialog({title:"Confirmer Suppression Fichier",message:`Êtes-vous sûr de vouloir supprimer le fichier "${u.fichier}"? La suppression sera effective après sauvegarde du protocole. Si le fichier vient d'être ajouté et non sauvegardé, il sera juste retiré de la liste.`,cancel:{label:"Annuler",color:"grey",flat:!0},ok:{label:"Supprimer de la liste",color:"negative",unelevated:!0}}).onOk(()=>{if(l.pieces_jointes=l.pieces_jointes.filter(t=>(t.id||t.fichier)!==(u.id||u.fichier)),u.isNew){if(l.uploaded_files=l.uploaded_files.filter(t=>t!==u.fichier),N.value){const t=N.value.files.find(r=>r.name===u.fichier);t&&N.value.removeFile(t)}}else l.pieces_jointes=l.pieces_jointes.filter(t=>(t.id||t.fichier)!==(u.id||u.fichier)),$.create({type:"info",message:`Le fichier "${u.fichier}" sera dissocié lors de la prochaine sauvegarde du protocole.`,position:"top"})})},ut=u=>{if(!u)return"sym_o_draft";const t=u.split(".").pop().toLowerCase();return["jpg","jpeg","png","gif","webp"].includes(t)?"sym_o_image":["pdf"].includes(t)?"sym_o_picture_as_pdf":["doc","docx","odt"].includes(t)?"sym_o_description":["xls","xlsx","ods"].includes(t)?"sym_o_spreadsheet":["ppt","pptx","odp"].includes(t)?"sym_o_slideshow":"sym_o_draft"},Le=u=>{if(!u)return!1;const t=u.split(".").pop().toLowerCase();return["jpg","jpeg","png","gif","webp"].includes(t)},mt=u=>{le.value=_t(u),de.value=u.fichier,ne.value=!0};return Ve(()=>c.traitementId,u=>{c.isDialogVisible&&_e()}),Ve(()=>l.idannee,(u,t)=>{u!==t&&!re.value&&B.value}),(u,t)=>(p(),V(He,{modelValue:ve.value,"onUpdate:modelValue":t[29]||(t[29]=r=>ve.value=r),persistent:"",maximized:"",onBeforeShow:_e,onHide:n},{default:a(()=>[e($e,{class:"un-flex flex-col h-full"},{default:a(()=>[e(Be,{class:"bg-primary text-white shadow-2"},{default:a(()=>[e(C,{flat:"",dense:"",icon:"sym_o_arrow_back",onClick:d}),e(Ne,null,{default:a(()=>[j(h(Ae.value),1)]),_:1}),e(et),x.isViewMode?w("",!0):(p(),V(C,{key:0,label:"Sauvegarder Protocole",icon:"sym_o_save",onClick:lt,loading:b.value,class:"mr-sm rounded-md",unelevated:""},null,8,["loading"])),e(C,{flat:"",dense:"",icon:"sym_o_close",onClick:d})]),_:1}),e(xe,{class:"flex-grow overflow-auto p-0 un-flex flex-col"},{default:a(()=>[e(tt,{ref_key:"mainFormRef",ref:v,class:"h-full flex flex-col"},{default:a(()=>[e(Je,{modelValue:O.value,"onUpdate:modelValue":t[0]||(t[0]=r=>O.value=r),dense:"",class:"lt-md text-primary-dark bg-slate-50","active-bg-color":"primary-light","active-color":"primary","indicator-color":"primary",align:"justify"},{default:a(()=>[e(pe,{name:"general",icon:"sym_o_description",label:"Général"}),e(pe,{name:"horaires",icon:"sym_o_event_repeat",label:"Horaires",disable:!l.id_traitement},null,8,["disable"]),e(pe,{name:"fichiers",icon:"sym_o_attach_file",label:"Fichiers"})]),_:1},8,["modelValue"]),_("div",Bt,[_("div",Pt,[e(Je,{modelValue:O.value,"onUpdate:modelValue":t[1]||(t[1]=r=>O.value=r),vertical:"",class:"gt-sm md:flex text-primary-dark bg-slate-50","active-bg-color":"primary-light","active-color":"primary","indicator-color":"primary"},{default:a(()=>[e(pe,{name:"general",icon:"sym_o_description",label:"Informations Générales"}),e(pe,{name:"horaires",icon:"sym_o_event_repeat",label:"Horaires",disable:!l.id_traitement},null,8,["disable"]),e(pe,{name:"fichiers",icon:"sym_o_attach_file",label:"Fichiers Joints"})]),_:1},8,["modelValue"])]),e($t,{modelValue:O.value,"onUpdate:modelValue":t[26]||(t[26]=r=>O.value=r),animated:"",swipeable:"","transition-prev":"jump-up","transition-next":"jump-up",class:"flex-grow h-full p-4 overflow-y-auto md:basis-4/5"},{default:a(()=>[e(Fe,{name:"general",class:"space-y-4"},{default:a(()=>[t[31]||(t[31]=_("div",{class:"text-lg font-semibold text-slate-700"},"Informations Générales du Protocole",-1)),_("div",Ot,[Q.value.eleve?w("",!0):(p(),V(X,{key:0,dense:"",filled:"",required:"",modelValue:l.id_eleve,"onUpdate:modelValue":t[2]||(t[2]=r=>l.id_eleve=r),options:R(Y),label:"Élève *","use-input":"","emit-value":"","map-options":"",onFilter:R(Ce),"option-value":"idpers","option-label":r=>`${r.nom} ${r.prenom} (${r.code||"N/A"})`,rules:[r=>!!r||"Élève requis"],readonly:x.isViewMode,error:!!f.value.id_eleve,"error-message":f.value.id_eleve,onBlur:t[3]||(t[3]=r=>K("id_eleve")),standout:"bg-sky-50",class:"rounded-md"},{"no-option":a(()=>[e(oe,null,{default:a(()=>[e(H,{class:"text-gray-500"},{default:a(()=>t[30]||(t[30]=[j("Aucun élève trouvé.")])),_:1})]),_:1})]),_:1},8,["modelValue","options","onFilter","option-label","rules","readonly","error","error-message"])),e(X,{dense:"",filled:"",required:"",modelValue:l.type_maladie,"onUpdate:modelValue":t[4]||(t[4]=r=>l.type_maladie=r),options:[{label:"Chronique",value:1},{label:"Aiguë",value:0}],label:"Type de Maladie ","emit-value":"","map-options":"","option-value":"value","option-label":"label",readonly:x.isViewMode,error:!!f.value.type_maladie,"error-message":f.value.type_maladie,onBlur:t[5]||(t[5]=r=>K("type_maladie")),standout:"bg-sky-50",class:"rounded-md"},null,8,["modelValue","readonly","error","error-message"]),e(I,{dense:"",filled:"",modelValue:l.condition_medicale,"onUpdate:modelValue":t[6]||(t[6]=r=>l.condition_medicale=r),label:"Condition Médicale (ex: Asthme)",readonly:x.isViewMode,error:!!f.value.condition_medicale,"error-message":f.value.condition_medicale,onBlur:t[7]||(t[7]=r=>K("condition_medicale")),standout:"bg-sky-50",class:"rounded-md"},null,8,["modelValue","readonly","error","error-message"]),e(I,{dense:"",filled:"",modelValue:l.nom_medicament_procedure,"onUpdate:modelValue":t[8]||(t[8]=r=>l.nom_medicament_procedure=r),label:"Nom Médicament/Procédure (ex: Ventoline)",readonly:x.isViewMode,error:!!f.value.nom_medicament_procedure,"error-message":f.value.nom_medicament_procedure,onBlur:t[9]||(t[9]=r=>K("nom_medicament_procedure")),standout:"bg-sky-50",class:"rounded-md"},null,8,["modelValue","readonly","error","error-message"]),e(I,{dense:"",filled:"",required:"",modelValue:l.date_debut,"onUpdate:modelValue":t[11]||(t[11]=r=>l.date_debut=r),label:"Date de Début *",mask:"####-##-##",rules:[r=>!!r||"Date de début requise"],readonly:x.isViewMode,error:!!f.value.date_debut,"error-message":f.value.date_debut,onBlur:t[12]||(t[12]=r=>K("date_debut")),standout:"bg-sky-50",class:"rounded-md"},{prepend:a(()=>[e(W,{name:"sym_o_event",class:"cursor-pointer"},{default:a(()=>[x.isViewMode?w("",!0):(p(),V(je,{key:0,cover:"","transition-show":"scale","transition-hide":"scale"},{default:a(()=>[e(Xe,{modelValue:l.date_debut,"onUpdate:modelValue":t[10]||(t[10]=r=>l.date_debut=r),mask:"YYYY-MM-DD",minimal:""},{default:a(()=>[_("div",zt,[ge(e(C,{label:"OK",color:"primary",flat:""},null,512),[[be]])])]),_:1},8,["modelValue"])]),_:1}))]),_:1})]),_:1},8,["modelValue","rules","readonly","error","error-message"]),e(I,{dense:"",filled:"",modelValue:l.date_fin,"onUpdate:modelValue":t[14]||(t[14]=r=>l.date_fin=r),label:"Date de Fin (Optionnel)",mask:"####-##-##",clearable:"",readonly:x.isViewMode,rules:[r=>!r||R(Z).extractDate(r,"YYYY-MM-DD")>=R(Z).extractDate(l.date_debut,"YYYY-MM-DD")||"La date de fin doit être après la date de début."],error:!!f.value.date_fin,"error-message":f.value.date_fin,onBlur:t[15]||(t[15]=r=>K("date_fin")),standout:"bg-sky-50",class:"rounded-md"},{prepend:a(()=>[e(W,{name:"sym_o_event",class:"cursor-pointer"},{default:a(()=>[x.isViewMode?w("",!0):(p(),V(je,{key:0,cover:"","transition-show":"scale","transition-hide":"scale"},{default:a(()=>[e(Xe,{modelValue:l.date_fin,"onUpdate:modelValue":t[13]||(t[13]=r=>l.date_fin=r),mask:"YYYY-MM-DD",minimal:"",options:Ue},{default:a(()=>[_("div",Lt,[ge(e(C,{label:"OK",color:"primary",flat:""},null,512),[[be]])])]),_:1},8,["modelValue"])]),_:1}))]),_:1})]),_:1},8,["modelValue","readonly","rules","error","error-message"]),e(X,{dense:"",filled:"",required:"",modelValue:l.statut,"onUpdate:modelValue":t[16]||(t[16]=r=>l.statut=r),options:R(ce),label:"Statut *","emit-value":"","map-options":"",rules:[r=>!!r||"Statut requis"],readonly:x.isViewMode,error:!!f.value.statut,"error-message":f.value.statut,onBlur:t[17]||(t[17]=r=>K("statut")),standout:"bg-sky-50",class:"rounded-md"},null,8,["modelValue","options","rules","readonly","error","error-message"]),e(Ze,{modelValue:l.administration_par_personnel,"onUpdate:modelValue":t[18]||(t[18]=r=>l.administration_par_personnel=r),label:l.administration_par_personnel?"Administration par personnel scolaire":"Auto-administration par l'élève",disable:x.isViewMode||B.value,class:"md:un-col-span-2"},null,8,["modelValue","label","disable"])]),e(I,{modelValue:l.instructions_dosage,"onUpdate:modelValue":t[19]||(t[19]=r=>l.instructions_dosage=r),type:"textarea",label:"Instructions de Dosage",autogrow:"",dense:"",filled:"",readonly:x.isViewMode,error:!!f.value.instructions_dosage,"error-message":f.value.instructions_dosage,onBlur:t[20]||(t[20]=r=>K("instructions_dosage")),standout:"bg-sky-50",class:"rounded-md"},null,8,["modelValue","readonly","error","error-message"]),e(I,{modelValue:l.instructions_generales_notes,"onUpdate:modelValue":t[21]||(t[21]=r=>l.instructions_generales_notes=r),type:"textarea",label:"Instructions Générales / Notes",autogrow:"",dense:"",filled:"",readonly:x.isViewMode,error:!!f.value.instructions_generales_notes,"error-message":f.value.instructions_generales_notes,onBlur:t[22]||(t[22]=r=>K("instructions_generales_notes")),standout:"bg-sky-50",class:"rounded-md"},null,8,["modelValue","readonly","error","error-message"]),l.administration_par_personnel?w("",!0):(p(),V(I,{key:0,modelValue:l.details_auto_administration,"onUpdate:modelValue":t[23]||(t[23]=r=>l.details_auto_administration=r),type:"textarea",label:"Détails Auto-Administration (si applicable) *",autogrow:"",dense:"",filled:"",rules:[r=>l.administration_par_personnel||!!r||"Détails requis pour auto-administration"],readonly:x.isViewMode,error:!!f.value.details_auto_administration,"error-message":f.value.details_auto_administration,onBlur:t[24]||(t[24]=r=>K("details_auto_administration")),standout:"bg-sky-50",class:"rounded-md"},null,8,["modelValue","rules","readonly","error","error-message"])),x.isViewMode&&l.created_at?(p(),F("div",Rt,[_("p",null,"Créé le: "+h(ke(l.created_at,"DD/MM/YYYY HH:mm"))+" par "+h(l.created_by_user?.nom_complet||l.created_by_user?.nom||"N/A"),1),_("p",null,"Mis à jour le: "+h(ke(l.updated_at,"DD/MM/YYYY HH:mm"))+" par "+h(l.updated_by_user?.nom_complet||l.updated_by_user?.nom||"N/A"),1)])):w("",!0)]),_:1}),e(Fe,{name:"horaires",class:"space-y-4"},{default:a(()=>[_("div",Jt,[t[32]||(t[32]=_("div",{class:"text-lg font-semibold text-slate-700"},"Horaires d'Administration",-1)),x.isViewMode?w("",!0):(p(),V(C,{key:0,label:"Ajouter Horaire",icon:"sym_o_add_alarm",color:"secondary",unelevated:"",onClick:t[25]||(t[25]=r=>ze()),class:"rounded-md",disable:!l.id_traitement},null,8,["disable"]))]),e(It,{horaires:l.horaires,"is-view-mode":x.isViewMode,onEditHoraire:ze,onDeleteHoraire:ot},null,8,["horaires","is-view-mode"])]),_:1}),e(Fe,{name:"fichiers",class:"space-y-4"},{default:a(()=>[t[34]||(t[34]=_("div",{class:"text-lg font-semibold text-slate-700"},"Fichiers Joints (Ordonnances, etc.)",-1)),x.isViewMode?w("",!0):(p(),V(Et,{key:0,ref_key:"uploaderRef",ref:N,label:"Ajouter des fichiers (PDF, Images, Docs)",url:De.value,headers:we.value,multiple:"",batch:"","no-auto-upload":"","field-name":"files[]",onUploaded:it,onFailed:nt,onFinish:rt,factory:Se,accept:".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.txt",color:"primary-light","text-color":"primary-dark",class:"w-full rounded-md",flat:"",bordered:""},{list:a(r=>[e(Ee,{separator:""},{default:a(()=>[(p(!0),F(Te,null,Ye(r.files,g=>(p(),V(oe,{key:g.__key},{default:a(()=>[e(H,null,{default:a(()=>[e(J,{class:"full-width ellipsis"},{default:a(()=>[j(h(g.name),1)]),_:2},1024),e(J,{caption:""},{default:a(()=>[j(h(g.__sizeLabel)+" / "+h(g.__progressLabel),1)]),_:2},1024)]),_:2},1024),g.__img?(p(),V(H,{key:0,thumbnail:""},{default:a(()=>[_("img",{src:g.__img.src},null,8,Xt)]),_:2},1024)):w("",!0),e(H,{top:"",side:""},{default:a(()=>[e(C,{class:"gt-xs",size:"12px",flat:"",dense:"",round:"",icon:"clear",onClick:se=>r.removeFile(g)},null,8,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)]),_:1},8,["url","headers"])),l.pieces_jointes&&l.pieces_jointes.length>0?(p(),F("div",Gt,[t[33]||(t[33]=_("div",{class:"text-md font-medium text-slate-600 mb-2"},"Fichiers existants:",-1)),e(Ee,{bordered:"",separator:"",class:"rounded-md"},{default:a(()=>[(p(!0),F(Te,null,Ye(l.pieces_jointes,r=>(p(),V(oe,{key:r.id||r.fichier,clickable:"",onClick:g=>mt(r)},{default:a(()=>[e(H,{avatar:""},{default:a(()=>[e(W,{name:ut(r.fichier),color:"primary"},null,8,["name"])]),_:2},1024),e(H,null,{default:a(()=>[j(h(r.fichier),1)]),_:2},1024),x.isViewMode?w("",!0):(p(),V(H,{key:0,side:""},{default:a(()=>[e(C,{flat:"",dense:"",round:"",icon:"sym_o_delete",color:"negative",onClick:Me(g=>dt(r),["stop"])},null,8,["onClick"])]),_:2},1024))]),_:2},1032,["onClick"]))),128))]),_:1})])):(p(),F("div",Kt," Aucun fichier joint pour ce protocole de traitement. "))]),_:1})]),_:1},8,["modelValue"])])]),_:1},512)]),_:1}),(p(),V(Nt,{isDialogVisible:G.value,"onUpdate:isDialogVisible":t[27]||(t[27]=r=>G.value=r),"traitement-id":l.id_traitement,"horaire-data":ee.value,onHoraireSaved:st,key:"horaire-"+he.value},null,8,["isDialogVisible","traitement-id","horaire-data"])),e(He,{modelValue:ne.value,"onUpdate:modelValue":t[28]||(t[28]=r=>ne.value=r),maximized:""},{default:a(()=>[e($e,null,{default:a(()=>[e(Be,{class:"bg-primary text-white"},{default:a(()=>[e(Ne,null,{default:a(()=>[j("Aperçu: "+h(de.value),1)]),_:1}),ge(e(C,{flat:"",round:"",dense:"",icon:"sym_o_close"},null,512),[[be]])]),_:1}),e(xe,{class:"p-0 h-[calc(100vh-50px)]"},{default:a(()=>[le.value&&!Le(de.value)?(p(),F("iframe",{key:0,src:`https://docs.google.com/gview?embedded=true&url=${encodeURIComponent(le.value)}`,class:"w-full h-full border-0"},null,8,Zt)):w("",!0),le.value&&Le(de.value)?(p(),V(jt,{key:1,src:le.value,class:"w-full h-full",style:{"object-fit":"contain"}},null,8,["src"])):w("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["modelValue"]))}},ea={class:"p-4"},ta={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3"},aa=["src"],la={class:"mt-3 flex justify-end gap-2"},ra={class:"mb-4 flex justify-between items-center"},sa={class:"text-md text-gray-600"},oa={class:"flex items-center gap-2"},ia={key:0,class:"export-controls-wrapper shadow-sm q-pa-xs rounded-md border border-gray-200 bg-white"},na={key:0,class:"text-center p-10"},da={key:1,class:"text-center p-10 bg-red-50 border border-red-200 rounded-md"},ua={class:"text-gray-600"},ma={key:2,class:"text-center p-10 bg-gray-50 border border-gray-200 rounded-md"},pa=["src"],ca={class:"text-sm text-gray-500"},va={class:"text-sm text-gray-500"},_a={class:"flex gap-1"},Wa={__name:"EleveTraitementPage",setup(x){const ae=bt(()=>Dt(()=>import("./EleveTraitementReport-BqYxTa-6.js"),__vite__mapDeps([0,1,2,3,4,5]),import.meta.url)),S=We(),P=E(()=>S.getters["user/current"]),c=E(()=>S.getters["user/current"]?.annee?.idannee),A=Pe();St();const y=M([]),T=fe({traitements:!1}),i=M(""),{studentOptions:Q,academicYearOptions:v,statutOptions:N,fetchStudents:O,fetchAcademicYears:ie,fetchTraitementStatuts:l}=Oe(),b=fe({id_eleve:P.value?.eleve?.idpers||null,idannee:null,statut:null,condition_medicale:"",nom_medicament_procedure:""}),D=fe({current_page:1,per_page:15,total:0,last_page:1}),f=M(!1),B=M(null),z=M(!1),L=M(0),Y=E(()=>S.getters["ecole/info"]),U=E(()=>S.getters["ecole/invoiceSettings"]),ce=E(()=>!!U.value),k=async()=>{try{await S.dispatch("ecole/fetchInvoiceSettings")}catch(m){console.warn("Could not fetch invoice settings for report header:",m)}},o=E(()=>{let m=[];for(const n of Q.value)n.eleve_classes&&n.eleve_classes.length>0&&(m.find(d=>d.idcycle===n.eleve_classes[0].niveau.cycle.idcycle)||m.push(n.eleve_classes[0].niveau.cycle));return m});E(()=>{let m=[];for(const n of Q.value)n.eleve_classes&&n.eleve_classes.length>0&&(m.find(d=>d.idniveau===n.eleve_classes[0].niveau.idniveau)||m.push(n.eleve_classes[0].niveau));return m}),E(()=>{let m=[];for(const n of Q.value)n.eleve_classes&&n.eleve_classes.length>0&&(m.find(d=>d.idclasse===n.eleve_classes[0].idclasse)||m.push(n.eleve_classes[0]));return m});const s=(m,n="DD/MM/YYYY")=>m?Z.formatDate(m,n):"",G=m=>ht(m),ee=async(m=1)=>{T.traitements=!0,i.value="",D.current_page=m;try{const n={...b,page:D.current_page,per_page:D.per_page};Object.keys(n).forEach(q=>{(n[q]===null||n[q]===""||Array.isArray(n[q])&&n[q].length===0)&&delete n[q]});const d=await te("get","/eleve-traitements",{params:n});d.data&&d.data.data?(y.value=d.data.data,D.total=d.data.total,D.last_page=d.data.last_page,D.current_page=d.data.current_page,D.per_page=d.data.per_page):(y.value=[],D.total=0)}catch(n){console.error("Error fetching traitements:",n),i.value=n.response?.data?.message||"Erreur lors du chargement des protocoles de traitement.",$.create({type:"negative",message:i.value,position:"top"}),y.value=[],D.total=0}finally{T.traitements=!1}},he=Qe((m,n,d)=>{O(m,b.idannee).then(q=>{n(()=>{Q.value=q})}).catch(()=>d())},500),ne=Qe(()=>ee(1),700);Ve(b,ne,{deep:!0});const le=()=>{b.id_eleve=P.value?.eleve?.idpers||null;const m=v.value.find(n=>n.courant===1||n.courant===!0);b.idannee=m?m.idannee:v.value[0]?.idannee||null,b.statut=null,b.condition_medicale="",b.nom_medicament_procedure=""},de=()=>{B.value=null,z.value=!1,L.value++,f.value=!0},De=m=>{B.value=m.id_traitement,z.value=!1,L.value++,f.value=!0},we=m=>{B.value=m.id_traitement,z.value=!0,L.value++,f.value=!0},Se=m=>{ee(D.current_page)},ve=m=>{A.dialog({title:"Confirmer Suppression",message:"Êtes-vous sûr de vouloir supprimer ce protocole de traitement et toutes ses données associées (horaires, journal, fichiers) ? Cette action est irréversible.",cancel:{label:"Annuler",color:"grey",flat:!0,class:"un-rounded-md"},ok:{label:"Supprimer",color:"negative",unelevated:!0,class:"un-rounded-md"},persistent:!0,class:"un-rounded-lg"}).onOk(async()=>{A.loading.show({spinner:Z.QSpinnerDots,message:"Suppression en cours..."});try{await te("delete",`/eleve-traitements/${m}`),$.create({type:"positive",message:"Protocole de traitement supprimé avec succès.",position:"top"}),ee(y.value.length===1&&D.current_page>1?D.current_page-1:D.current_page)}catch(n){console.error("Error deleting traitement:",n),$.create({type:"negative",message:n.response?.data?.message||"Erreur lors de la suppression.",position:"top"})}finally{A.loading.hide()}})},re=m=>({ACTIF:"positive",TERMINE:"grey-7",ANNULE:"negative",SUSPENDU:"warning"})[m]||"grey",Ae=m=>({0:"Aiguë",1:"Chronique"})[m]||"Inconnu",ke=m=>m?m.eleve_classes?m.eleve_classes.map(n=>`${n.classe_fr}`).join(", "):(console.log(m),""):"",Ue=E(()=>P.value?.annee?.courant),_e=E(()=>y.value&&y.value.length>0&&!T.traitements&&!i.value&&!P.value?.eleve),ue=E(()=>{let m="Liste des Protocoles de Traitement";if(b.id_eleve&&Q.value.length>0){const n=Q.value.find(d=>d.idpers===b.id_eleve);n&&(m+=` pour ${n.nom} ${n.prenom}`)}return m}),Ce=E(()=>_e.value?{traitementsList:y.value,schoolInfo:{name:Y.value?.description||"École XYZ",addressLine1:Y.value?.adresse||"",city:Y.value?.ville||"",contactEmail:Y.value?.email||"",paymentEmail:U.value?.payment_email??(Y.value?.email||""),phone:Y.value?.telephone?`+${Y.value.telephone}`:"",logoUrl:U.value?.logo_path??(Y.value.logo?Re(Y.value.logo):"")},partnerInfo:{logoUrl:ce.value?U.value.partner_logo_path?Re(U.value.partner_logo_path):"/medical-part.jpeg":null},filtersApplied:{...b},reportTitle:ue.value,studentOptionsForReport:Q.value,academicYearOptionsForReport:v.value}:{});return ft(async()=>{A.loading.show({delay:300}),await Promise.all([O("",c.value),ie().then(()=>{b.idannee=c.value}),l(),k()]),await ee(1),A.loading.hide()}),(m,n)=>(p(),V(xt,{class:"page-content suivi-traitement-page bg-gray-100 rounded-none"},{default:a(()=>[_("div",ea,[e($e,{flat:"",bordered:"",class:"mb-4 shadow-sm"},{default:a(()=>[e(xe,{class:"bg-slate-50"},{default:a(()=>n[7]||(n[7]=[_("div",{class:"text-xl font-semibold text-slate-700"},"Suivi des Traitements Médicaux",-1),_("p",{class:"text-sm text-slate-500"},"Gérer les protocoles de traitement médical pour les élèves.",-1)])),_:1}),e(xe,null,{default:a(()=>[_("div",ta,[P.value?.eleve?w("",!0):(p(),V(X,{key:0,dense:"",filled:"",modelValue:b.idcycle,"onUpdate:modelValue":n[0]||(n[0]=d=>b.idcycle=d),options:o.value,label:"Cycle","emit-value":"","map-options":"","option-value":"idcycle","option-label":"cycle",clearable:"",standout:"bg-sky-50",class:"rounded-md"},null,8,["modelValue","options"])),P.value?.eleve?w("",!0):(p(),V(X,{key:1,dense:"",filled:"",modelValue:b.id_eleve,"onUpdate:modelValue":n[1]||(n[1]=d=>b.id_eleve=d),options:R(Q),label:"Élève","use-input":"","emit-value":"","map-options":"",clearable:"",onFilter:R(he),"option-value":"idpers","option-label":d=>`${d.nom} ${d.prenom} (${d.code||"N/A"})`,standout:"bg-sky-50",class:"rounded-md"},{"no-option":a(()=>[e(oe,null,{default:a(()=>[e(H,{class:"text-gray-500"},{default:a(()=>n[8]||(n[8]=[j("Aucun élève trouvé.")])),_:1})]),_:1})]),option:a(d=>[e(oe,gt(yt(d.itemProps)),{default:a(()=>[d.opt.photo?(p(),V(H,{key:0,avatar:""},{default:a(()=>[e(Ie,{size:"sm"},{default:a(()=>[_("img",{src:G(d.opt)},null,8,aa)]),_:2},1024)]),_:2},1024)):w("",!0),e(H,null,{default:a(()=>[e(J,null,{default:a(()=>[j(h(d.opt.nom)+" "+h(d.opt.prenom),1)]),_:2},1024),e(J,{caption:""},{default:a(()=>[j(h(d.opt.code),1)]),_:2},1024)]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","options","onFilter","option-label"])),e(X,{dense:"",filled:"",modelValue:b.type_maladie,"onUpdate:modelValue":n[2]||(n[2]=d=>b.type_maladie=d),options:[{label:"Chronique",value:1},{label:"Aiguë",value:0}],label:"Type de Maladie ","emit-value":"","map-options":"","option-value":"value","option-label":"label",clearable:"",standout:"bg-sky-50",class:"rounded-md"},null,8,["modelValue"]),e(X,{dense:"",filled:"",modelValue:b.statut,"onUpdate:modelValue":n[3]||(n[3]=d=>b.statut=d),options:R(N),label:"Statut","emit-value":"","map-options":"",clearable:"",standout:"bg-sky-50",class:"rounded-md"},null,8,["modelValue","options"]),e(I,{dense:"",filled:"",modelValue:b.condition_medicale,"onUpdate:modelValue":[n[4]||(n[4]=d=>b.condition_medicale=d),R(ne)],label:"Condition Médicale",clearable:"",standout:"bg-sky-50",class:"rounded-md"},null,8,["modelValue","onUpdate:modelValue"])]),_("div",la,[e(C,{unelevated:"",label:"Effacer Filtres",color:"grey-7",onClick:le,icon:"sym_o_clear",class:"rounded-md",size:"sm"})])]),_:1})]),_:1}),_("div",ra,[_("div",sa,h(D.total)+" protocole(s) de traitement trouvé(s). ",1),_("div",oa,[_e.value?(p(),F("div",ia,[e(At,{"report-component":R(ae),"report-data":Ce.value,"report-component-styles":[{url:"/reports/traitement.css?v=1.0.0"}],"pdf-filename-prefix":"Protocoles_Traitement","pdf-title":ue.value},null,8,["report-component","report-data","pdf-title"])])):w("",!0),Ue.value?(p(),V(C,{key:1,color:"primary",icon:"sym_o_add",label:"Nouveau Protocole",onClick:de,class:"rounded-md",unelevated:""})):w("",!0)])]),T.traitements?(p(),F("div",na,[e(wt,{color:"primary",size:"xl"}),n[9]||(n[9]=_("p",{class:"text-gray-500 mt-2"},"Chargement des protocoles de traitement...",-1))])):i.value?(p(),F("div",da,[e(W,{name:"sym_o_error",size:"lg",color:"negative"}),n[10]||(n[10]=_("p",{class:"text-negative mt-2 font-semibold"},"Erreur de chargement",-1)),_("p",ua,h(i.value),1)])):y.value.length?(p(),V(Ee,{key:3,bordered:"",separator:"",class:"rounded-lg bg-white shadow"},{default:a(()=>[e(kt,{items:y.value,separator:"",style:{"max-height":"70vh"}},{default:a(({item:d})=>[(p(),V(oe,{key:d.id_traitement,class:"py-3 hover:bg-slate-50"},{default:a(()=>[e(H,{avatar:"",top:""},{default:a(()=>[d.eleve?.photo?(p(),V(Ie,{key:0,size:"lg"},{default:a(()=>[_("img",{src:G(d.eleve)},null,8,pa)]),_:2},1024)):(p(),V(Ie,{key:1,color:re(d.statut)+"-1","text-color":re(d.statut)+"-8",icon:"sym_o_medication",class:"font-bold",size:"lg"},null,8,["color","text-color"]))]),_:2},1024),e(H,null,{default:a(()=>[e(J,{class:"font-semibold text-primary-dark text-md"},{default:a(()=>[j(h(d.eleve?.nom)+" "+h(d.eleve?.prenom)+" ",1),_("span",ca," ("+h(ke(d.eleve))+")",1),d.type_maladie?(p(),V(qe,{key:0,size:"xs",square:"",label:Ae(d.type_maladie),color:"orange-100",class:"font-medium border-l-2 border-l-solid border-orange-400"},null,8,["label"])):w("",!0)]),_:2},1024),e(J,{caption:"",class:"text-gray-600"},{default:a(()=>[e(W,{name:"sym_o_healing",size:"xs",class:"q-mr-xs"}),j(" "+h(d.condition_medicale||"Condition non spécifiée"),1)]),_:2},1024),e(J,{caption:"",class:"text-gray-600"},{default:a(()=>[e(W,{name:"sym_o_vaccines",size:"xs",class:"q-mr-xs"}),j(" "+h(d.nom_medicament_procedure||"Traitement non spécifié"),1)]),_:2},1024),e(J,{caption:"",class:"text-gray-500 text-sm"},{default:a(()=>[j(" Année: "+h(d.annee_scolaire?.description)+" | Début: "+h(s(d.date_debut))+" | Fin: "+h(d.date_fin?s(d.date_fin):"En cours"),1)]),_:2},1024)]),_:2},1024),e(H,{side:"",top:"",class:"pt-sm space-y-1 items-end"},{default:a(()=>[e(qe,{square:"",label:d.statut,color:re(d.statut),"text-color":"white",class:"text-sm font-medium"},null,8,["label","color"]),_("div",va," MàJ par: "+h(d.updated_by?.nom||"N/A"),1),_("div",_a,[e(C,{flat:"",dense:"",round:"",icon:"sym_o_visibility",onClick:Me(q=>we(d),["stop"]),color:"blue-grey-6",size:"sm"},{default:a(()=>[e(ye,{class:"bg-gray-800 text-white rounded"},{default:a(()=>n[13]||(n[13]=[j("Voir Détails")])),_:1})]),_:2},1032,["onClick"]),e(C,{flat:"",dense:"",round:"",icon:"sym_o_edit",onClick:Me(q=>De(d),["stop"]),color:"secondary",size:"sm"},{default:a(()=>[e(ye,{class:"bg-gray-800 text-white rounded"},{default:a(()=>n[14]||(n[14]=[j("Modifier")])),_:1})]),_:2},1032,["onClick"]),e(C,{flat:"",dense:"",round:"",icon:"sym_o_delete",onClick:Me(q=>ve(d.id_traitement),["stop"]),color:"negative",size:"sm"},{default:a(()=>[e(ye,{class:"bg-gray-800 text-white rounded"},{default:a(()=>n[15]||(n[15]=[j("Supprimer")])),_:1})]),_:2},1032,["onClick"])])]),_:2},1024)]),_:2},1024))]),_:1},8,["items"])]),_:1})):(p(),F("div",ma,[e(W,{name:"sym_o_medical_services",size:"lg",color:"grey-5"}),n[11]||(n[11]=_("p",{class:"text-gray-500 mt-2 text-lg"},"Aucun protocole de traitement trouvé.",-1)),n[12]||(n[12]=_("p",{class:"text-gray-400"},"Utilisez les filtres ou ajoutez un nouveau protocole.",-1))])),D.last_page>1?(p(),V(Vt,{key:4,align:"center",class:"py-4"},{default:a(()=>[e(Mt,{modelValue:D.current_page,"onUpdate:modelValue":[n[5]||(n[5]=d=>D.current_page=d),ee],max:D.last_page,"direction-links":"",flat:"",color:"primary","active-color":"primary",class:"rounded-md"},null,8,["modelValue","max"])]),_:1})):w("",!0)]),(p(),V(Wt,{isDialogVisible:f.value,"onUpdate:isDialogVisible":n[6]||(n[6]=d=>f.value=d),"traitement-id":B.value,"is-view-mode":z.value,onTraitementSaved:Se,key:L.value},null,8,["isDialogVisible","traitement-id","is-view-mode"]))]),_:1}))}};export{Wa as default};
