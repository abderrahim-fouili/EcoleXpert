import{Q as S}from"./QImg-BMvxJu3S.js";import{B as _,av as q,R as d,S as n,Q as o,a6 as s,a5 as a,a7 as w,aS as C,ba as I,aB as T,ad as y,ab as m,aE as M,_ as E,b9 as N,b2 as H,b8 as A,as as D,at as j,ag as b,a4 as g,a8 as U,aF as z,a9 as v,aa as B,ay as F,ax as O,af as G,aD as Y,aC as J,a3 as K,bc as W,aY as X,b5 as Z}from"./index-Bl2lQPd7.js";import{Q as L,a as Q}from"./QItem-De3v03wU.js";import{Q as x}from"./QItemLabel-BkJiB6aE.js";import{Q as $}from"./QList-CMzNTEGD.js";import{Q as P}from"./QBadge-Bjfo5tRO.js";import{Q as ee}from"./QPopupProxy-CQ30ymZI.js";import{Q as te,l as se}from"./linkify-html.es-DZPJD58y.js";import re from"./New-CzAiGtek.js";import{C as ae}from"./ClosePopup-BY_YGFBZ.js";import"./QMenu-BNr9Tzvf.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./QToolbarTitle-C8APieXG.js";import"./QToolbar-DR-_wX4W.js";import"./QBreadcrumbs-D5k8AHhT.js";import"./QSelect-DchnWyXK.js";import"./QChip-C9OfA2gn.js";import"./rtl-DFPa-2ov.js";import"./format-IcNrutKL.js";import"./QTooltip-r7WoEuzy.js";import"./QUploaderAddTrigger-OZIUWg9a.js";import"./QUploader-Dwk8_y__.js";import"./QCircularProgress-C_b7NmsY.js";import"./QForm-Dk45GsL9.js";const le={__name:"Sender",props:["data","first"],setup(e){const l=e;console.log(l.first);const h=_(()=>l.data),f=_(()=>l.first?.thread),c=_(()=>l.first.type_sender==="parent"?h.value.eleves.map(i=>i.eleve):[]),r=_(()=>{if(l.first.type_sender==="parent"){let i=f.value.filter.find(u=>u.type==="eleve");return i?c.value.find(u=>u.idpers===i.id):c.value.find(u=>f.value.filter.find(t=>t.type==="personne"&&t.id===u.idpers))}return null}),k=_(()=>l.first.type_sender==="parent"?f.value.filter.find(i=>i.type==="classe"):null);return(i,u)=>h.value?.type_sender==="parent"?q((n(),o(M,{key:0},{default:s(()=>[a(L,null,{default:s(()=>[a(Q,{avatar:""},{default:s(()=>[a(w,null,{default:s(()=>[a(S,{ratio:"1",src:C(T)(r.value),"placeholder-src":C(I)(r.value?.nom)},null,8,["src","placeholder-src"])]),_:1})]),_:1}),a(Q,null,{default:s(()=>[r.value?(n(),o(x,{key:0},{default:s(()=>[y(m(r.value?.nom)+" "+m(r.value?.prenom),1)]),_:1})):d("",!0),k.value?(n(),o(x,{key:1},{default:s(()=>[a(P,{color:"purple"},{default:s(()=>[y(m(k.value?.label),1)]),_:1})]),_:1})):d("",!0)]),_:1})]),_:1})]),_:1})),[[ae]]):d("",!0)}},{getScrollTarget:ne,setVerticalScrollPosition:ie}=W,oe={data(){return{history,showReply:!1,log:""}},components:{NewMessage:re,SenderInfo:le},computed:{...j({user:"user/user",config:"user/config",current:"user/current",message:"message/message"}),eleve(){if(this.current&&this.current.hasOwnProperty("eleve"))return this.current.eleve},annee(){if(this.current&&this.current.hasOwnProperty("annee"))return this.current.annee}},methods:{...D({setStatus:"message/setStatus",setBar:"setBar",getMessage:"message/load",getMessages:"message/getInbox",messageStatus:"message/setStatus"}),openURL:A,toNow:H,userPhotoUrl:T,LetterAvatar:I,fileIcon:N,isImage(e){return Z(this.fileUrl(e))},messageEnvoye(e){this.show=!1,this.log=e,e&&e.id&&(this.$router.push("/prof/messages/view/"+e.id),this.$nextTick(()=>{this.setBar(!0),this.getMessage(e.id).then(()=>{this.message&&(this.scrollToElement(this.message),this.setBar(!1))})}))},canSee(e){return e.type_sender==="prof"?e.sender.id===this.user.id:!0},lu(e){e.sender_id!==this.user.id&&this.messageStatus({id:e.id,status:1}).then(l=>{})},fileUrl(e){return X(e)},text(e){let l=this.$cleanHtml(e.message);return e.quote&&(l="<blockquote>"+e.quote+"</blockquote>"+l),se(l,{defaultProtocol:"https",target:"_blank"})},sub(e){return this.$cleanHtml(e)},isSent(e){return e.sender.idpers!==this.user.idpers},scrollToElement(e){this.$nextTick(()=>{let l=this.$refs["m-"+e.id][0].$el;const h=ne(l),f=l.offsetTop;ie(h,f,500)})}},mounted(){this.$route.params.id&&this.getMessage(this.$route.params.id).then(()=>{this.message&&(this.scrollToElement(this.message),this.message.etat.length||this.lu(this.message))}),this.setTitle("Messagerie")}},ue={key:0},de={class:"text-bold",style:{padding:"20px 16px 20px"}},ce=["innerHTML"];function me(e,l,h,f,c,r){const k=b("sender-info"),i=b("new-message"),u=b("ep-footer");return n(),g(v,null,[a(J,{padding:"",class:"page-content"},{default:s(()=>[e.message?(n(),g("div",ue,[U("div",de,m(e.message.objet),1),a(M,{style:{margin:"0 -8px 0"}},{default:s(()=>[a(z,null,{default:s(()=>[(n(!0),g(v,null,B(e.message.thread.messages,(t,fe)=>(n(),g(v,{key:"m-"+t.id},[r.canSee(t)?(n(),o(te,{key:0,stamp:r.toNow(t.created_at*1e3),sent:r.isSent(t),"text-color":"white","bg-color":r.isSent(t)?"green":"blue",ref_for:!0,ref:"m-"+t.id,class:"q-mb-lg"},{name:s(()=>[y(m(t.sender.nom+" "+t.sender.prenom),1)]),avatar:s(()=>[a(w,{class:G({"q-message-avatar":!0,"q-message-avatar--sent":r.isSent(t),"q-message-avatar--received":!r.isSent(t)})},{default:s(()=>[a(S,{ratio:"1",src:r.userPhotoUrl(t.sender),"placeholder-src":r.LetterAvatar(t.sender.nom)},null,8,["src","placeholder-src"]),r.isSent(t)?(n(),o(P,{key:0,floating:""},{default:s(()=>[y(m(t.type_sender),1)]),_:2},1024)):d("",!0),t.type_sender==="parent"?(n(),o(ee,{key:1},{default:s(()=>[a(k,{data:t,first:e.message},null,8,["data","first"])]),_:2},1024)):d("",!0)]),_:2},1032,["class"])]),default:s(()=>[U("div",{innerHTML:r.text(t),style:{"max-width":"58vw"},class:"contained"},null,8,ce),t.fichiers.length?(n(),o($,{key:0},{default:s(()=>[(n(!0),g(v,null,B(t.fichiers,(p,R)=>(n(),g(v,{key:R},[r.isImage(p)?(n(),o(S,{key:0,src:r.fileUrl(p),onClick:V=>r.openURL(r.fileUrl(p))},null,8,["src","onClick"])):(n(),o(L,{key:1,clickable:"",onClick:V=>r.openURL(r.fileUrl(p))},{default:s(()=>[a(Q,{avatar:""},{default:s(()=>[a(w,{color:"white"},{default:s(()=>[a(F,{name:"img:"+r.fileIcon(p.fichier)},null,8,["name"])]),_:2},1024)]),_:2},1024),a(Q,null,{default:s(()=>[a(x,{line:"1",class:"ellipsis",style:{"max-width":"30vw"}},{default:s(()=>[y(m(p.fichier),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"])),a(O)],64))),128))]),_:2},1024)):d("",!0)]),_:2},1032,["stamp","sent","bg-color"])):d("",!0)],64))),128))]),_:1})]),_:1})])):d("",!0),a(Y,{modelValue:c.showReply,"onUpdate:modelValue":l[0]||(l[0]=t=>c.showReply=t),position:"bottom",maximized:!0},{default:s(()=>[a(i,{message:e.message,title:"Répondre","onMessage:sent":r.messageEnvoye},null,8,["message","onMessage:sent"])]),_:1},8,["modelValue"])]),_:1}),a(u,{to:"#footer-portal"},{default:s(()=>[a(K,{onClick:l[1]||(l[1]=t=>c.showReply=!0),flat:"",icon:"reply",label:"répondre"})]),_:1})],64)}const He=E(oe,[["render",me]]);export{He as default};
