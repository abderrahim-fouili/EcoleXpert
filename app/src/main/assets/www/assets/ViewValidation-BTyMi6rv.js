import{Q as c}from"./QBadge-Bjfo5tRO.js";import{_ as E,b9 as N,ba as H,aB as j,b2 as A,b8 as D,as as z,at as F,ag as _,a4 as i,S as l,a5 as s,a6 as t,R as p,a8 as h,ab as n,aE as O,aF as b,a9 as d,ad as m,ay as y,aa as k,Q as u,ax as C,a7 as B,af as G,a3 as U,aD as Y,aC as J,a as I,bc as K,aY as W,b5 as X}from"./index-Bl2lQPd7.js";import{Q as M,a as w}from"./QBreadcrumbs-D5k8AHhT.js";import{Q as T}from"./QImg-BMvxJu3S.js";import{Q as Z,a as L}from"./QItem-De3v03wU.js";import{Q as $}from"./QItemLabel-BkJiB6aE.js";import{Q as ee}from"./QList-CMzNTEGD.js";import{Q as se}from"./QPopupProxy-CQ30ymZI.js";import{Q as te,l as ae}from"./linkify-html.es-DZPJD58y.js";import re from"./New-zUMJuIKd.js";import{_ as le}from"./Sender-NQvRmfc6.js";import"./QMenu-BNr9Tzvf.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./QToolbarTitle-C8APieXG.js";import"./QToolbar-DR-_wX4W.js";import"./QSelect-DchnWyXK.js";import"./QChip-C9OfA2gn.js";import"./rtl-DFPa-2ov.js";import"./format-IcNrutKL.js";import"./QTooltip-r7WoEuzy.js";import"./QUploaderAddTrigger-OZIUWg9a.js";import"./QUploader-Dwk8_y__.js";import"./QCircularProgress-C_b7NmsY.js";import"./QForm-Dk45GsL9.js";import"./ClosePopup-BY_YGFBZ.js";const{getScrollTarget:ne,setVerticalScrollPosition:oe}=K,ie={data(){return{globalSettings:null,history,showReply:!1,log:""}},components:{NewMessage:re,SenderInfo:le},computed:{...F({user:"user/user",config:"user/config",current:"user/current",message:"message/message"}),eleve(){if(this.current&&this.current.hasOwnProperty("eleve"))return this.current.eleve},annee(){if(this.current&&this.current.hasOwnProperty("annee"))return this.current.annee}},methods:{...z({setStatus:"message/setStatus",setBar:"setBar",getMessage:"message/load",getMessages:"message/getInbox",messageStatus:"message/setStatus"}),retirer(){this.$route.params.id&&I("post","/messages/noreponse-retirer",{message:this.$route.params.id}).then(({data:e})=>{this.$router.push("/admin")})},openURL:D,toNow:A,userPhotoUrl:j,LetterAvatar:H,fileIcon:N,typeColor(e){return e.type==="type"?"grey":e.type==="classe"?"purple":"primary"},isImage(e){return X(this.fileUrl(e))},messageEnvoye(e){this.show=!1,this.log=e,e&&e.id&&(this.$router.push("/admin/messages/view/"+e.id),this.$nextTick(()=>{this.setBar(!0),this.getMessage(e.id).then(()=>{this.message&&(this.scrollToElement(this.message),this.setBar(!1))})}))},canSee(e){return e.type_sender==="prof"?e.sender.id===this.user.id:!0},lu(e){e.sender_id!==this.user.id&&this.messageStatus({id:e.id,status:1}).then(o=>{})},fileUrl(e){return W(e)},text(e){let o=this.$cleanHtml(e.message);return e.quote&&(o="<blockquote>"+e.quote+"</blockquote>"+o),ae(o,{defaultProtocol:"https",target:"_blank"})},sub(e){return this.$cleanHtml(e)},isSent(e){return e.sender.idpers!==this.message.sender_id},scrollToElement(e){this.$nextTick(()=>{let o=this.$refs["m-"+e.id][0].$el;const Q=ne(o),v=o.offsetTop;oe(Q,v,500)})}},mounted(){this.$route.params.id&&this.getMessage(this.$route.params.id).then(()=>{this.message&&(this.scrollToElement(this.message),this.message.etat.length||this.lu(this.message))}),this.setTitle("Messagerie"),this.globalSettings||I("post","/settings").then(e=>{this.globalSettings=e.data})}},me={key:0},de={class:"text-bold",style:{padding:"20px 16px 20px"}},ue={key:0,class:"text-dark"},ge={key:0,class:"text-dark"},pe={class:"text-dark"},fe=["innerHTML"],ce={class:"flex justify-end"};function he(e,o,Q,v,f,r){const R=_("sender-info"),V=_("new-message"),P=_("ep-footer");return l(),i(d,null,[s(J,{padding:"",class:"page-content"},{default:t(()=>[e.message?(l(),i("div",me,[h("div",de,n(e.message.objet),1),s(O,{style:{margin:"0 -8px 0"}},{default:t(()=>[s(b,null,{default:t(()=>[e.message.sender_id===e.message.thread.messages[0].sender_id?(l(),i(d,{key:0},[s(c,{color:"grey"},{default:t(()=>[m(n(e.message.type_sender),1)]),_:1}),m(" "+n(e.message.sender.nom)+" "+n(e.message.sender.prenom)+" ",1),s(y,{name:"arrow_forward"}),s(M,{gutter:"none"},{separator:t(()=>[s(y,{name:"arrow_right",color:"grey-9"})]),default:t(()=>[(l(!0),i(d,null,k(e.message.thread.filter,(a,S)=>(l(),u(w,{key:"s-"+S},{default:t(()=>[a.type==="personne"?(l(),i("span",ue,n(a.label),1)):(l(),u(c,{key:1,color:r.typeColor(a)},{default:t(()=>[m(n(a.label||a.id),1)]),_:2},1032,["color"]))]),_:2},1024))),128))]),_:1})],64)):(l(),i(d,{key:1},[s(c,{color:"grey"},{default:t(()=>[m(n(e.message.type_sender),1)]),_:1}),m(" "+n(e.message.sender.nom)+" "+n(e.message.sender.prenom)+" ",1),s(y,{name:"arrow_forward"}),s(M,{gutter:"none"},{separator:t(()=>[s(y,{name:"arrow_right",color:"grey-9"})]),default:t(()=>[s(w,null,{default:t(()=>[e.f.type==="personne"?(l(),i("span",ge,n(e.f.label),1)):p("",!0),s(c,{color:"grey"},{default:t(()=>[m(n(e.message.thread.messages[0].type_sender),1)]),_:1})]),_:1}),s(w,null,{default:t(()=>[h("template",null,[h("span",pe,n(e.message.thread.messages[0].sender.nom)+" "+n(e.message.thread.messages[0].sender.prenom),1)])]),_:1})]),_:1})],64))]),_:1}),s(C),s(b,null,{default:t(()=>[(l(!0),i(d,null,k(e.message.thread.messages,(a,S)=>(l(),i(d,{key:"m-"+a.id},[r.canSee(a)?(l(),u(te,{key:0,stamp:r.toNow(a.created_at*1e3),sent:r.isSent(a),"text-color":"white","bg-color":r.isSent(a)?"green":"blue",ref_for:!0,ref:"m-"+a.id,class:"q-mb-lg"},{name:t(()=>[m(n(a.sender.nom+" "+a.sender.prenom),1)]),avatar:t(()=>[s(B,{class:G({"q-message-avatar":!0,"q-message-avatar--sent":r.isSent(a),"q-message-avatar--received":!r.isSent(a)})},{default:t(()=>[s(T,{ratio:"1",src:r.userPhotoUrl(a.sender),"placeholder-src":r.LetterAvatar(a.sender.nom)},null,8,["src","placeholder-src"]),r.isSent(a)?(l(),u(c,{key:0,floating:""},{default:t(()=>[m(n(a.type_sender),1)]),_:2},1024)):p("",!0),a.type_sender==="parent"?(l(),u(se,{key:1},{default:t(()=>[s(R,{data:a,first:e.message},null,8,["data","first"])]),_:2},1024)):p("",!0)]),_:2},1032,["class"])]),default:t(()=>[h("div",{innerHTML:r.text(a),style:{"max-width":"58vw"},class:"contained"},null,8,fe),a.fichiers.length?(l(),u(ee,{key:0},{default:t(()=>[(l(!0),i(d,null,k(a.fichiers,(g,q)=>(l(),i(d,{key:q},[r.isImage(g)?(l(),u(T,{key:0,src:r.fileUrl(g),onClick:x=>r.openURL(r.fileUrl(g))},null,8,["src","onClick"])):(l(),u(Z,{key:1,clickable:"",onClick:x=>r.openURL(r.fileUrl(g))},{default:t(()=>[s(L,{avatar:""},{default:t(()=>[s(B,{color:"white"},{default:t(()=>[s(y,{name:"img:"+r.fileIcon(g.fichier)},null,8,["name"])]),_:2},1024)]),_:2},1024),s(L,null,{default:t(()=>[s($,{line:"1",class:"ellipsis",style:{"max-width":"30vw"}},{default:t(()=>[m(n(g.fichier),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"])),s(C)],64))),128))]),_:2},1024)):p("",!0)]),_:2},1032,["stamp","sent","bg-color"])):p("",!0)],64))),128))]),_:1}),s(b,null,{default:t(()=>[h("div",ce,[s(U,{label:"Retirer",onClick:o[0]||(o[0]=a=>r.retirer())})])]),_:1})]),_:1})])):p("",!0),s(Y,{modelValue:f.showReply,"onUpdate:modelValue":o[1]||(o[1]=a=>f.showReply=a),position:"bottom",maximized:!0},{default:t(()=>[s(V,{message:e.message,title:"Répondre","onMessage:sent":r.messageEnvoye,"global-settings":f.globalSettings},null,8,["message","onMessage:sent","global-settings"])]),_:1},8,["modelValue"])]),_:1}),s(P,{to:"#footer-portal"},{default:t(()=>[s(U,{onClick:o[2]||(o[2]=a=>f.showReply=!0),flat:"",icon:"reply",label:"répondre"})]),_:1})],64)}const ze=E(ie,[["render",he]]);export{ze as default};
