import{r as E,t as A,_ as oe,aP as ue,aO as ie,A as i,B as u,Y as ce,C as de,Q as L,S as v,a6 as t,a5 as a,aE as ve,aF as O,a8 as $,a4 as p,R as S,ab as f,ad as _,ay as I,ax as me,af as fe,a3 as ge,aC as pe,a as Q}from"./index-Bl2lQPd7.js";import{Q as P,a as y}from"./QItem-De3v03wU.js";import{Q as _e}from"./QSelect-DchnWyXK.js";import{Q as b}from"./QItemLabel-BkJiB6aE.js";import{Q as z}from"./QInnerLoading-WxvcYHvS.js";import{Q as ye}from"./QBanner-xBGiroIy.js";import{q as N}from"./date-C1Mon-Jj.js";import{u as he}from"./composables-CAkrP3jA.js";import{p as be}from"./index-DXqHobUu.js";import{t as U}from"./index-CbPSoDvq.js";import{h as j}from"./index-BXMW6yyY.js";import"./QChip-C9OfA2gn.js";import"./QMenu-BNr9Tzvf.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./rtl-DFPa-2ov.js";import"./format-IcNrutKL.js";import"./defineProperty-CfK5lsJW.js";import"./index-QVwDN08p.js";var ke=36e5;function De(g,c){E(2,arguments);var l=U(c);return j(g,l*ke)}function xe(g){E(1,arguments);var c=A(g);return c.setHours(0,0,0,0),c}var Se=6e4;function we(g,c){E(2,arguments);var l=U(c);return j(g,l*Se)}function Ce(g,c){E(2,arguments);var l=A(g),T=A(c);return l.getTime()>T.getTime()}const qe={key:0,class:"text-subtitle1 text-grey-8 q-mt-xs"},Me={key:0,class:"q-gutter-y-sm q-mb-md"},Ie={key:2},Qe={class:"text-weight-medium"},Pe={key:0,class:"text-caption"},Ee={key:0},Te={key:1},Ne={key:0,class:"text-negative q-mt-sm text-caption"},Ae={key:3,class:"text-grey text-center q-pa-md"},Re={__name:"CanteenSelfReservation",setup(g){const c=ue(),l=ie(),{setTitle:T}=he(),w=i(!1),C=i(!1),q=i(!1),k=i(!1),M=i([]),o=i(null),d=i(null),m=i(null),r=i("idle"),s=i(""),D=u(()=>c.getters["user/user"]),F=u(()=>M.value.map(e=>({label:`${N.formatDate(e.date_cantine,"DD/MM/YYYY")} - ${e.description||"Programme"}`,value:e.idcantine}))),h=u(()=>o.value?M.value.find(e=>e.idcantine===o.value):null),G=u(()=>h.value?N.formatDate(h.value.date_cantine,"dddd D MMMM YYYY"):"N/A"),J=u(()=>d.value?`${Number(d.value.staff_ticket_tarif||0).toFixed(2)} MAD`:"Chargement..."),K=u(()=>d.value?d.value.ticket_request_deadline_time||"Non défini":"Chargement..."),R=u(()=>{if(!h.value||!d.value?.ticket_request_deadline_time)return null;try{let e;typeof h.value.date_cantine=="string"?e=be(h.value.date_cantine,"yyyy-MM-dd",new Date):e=new Date(h.value.date_cantine);const n=xe(e),[x,le]=d.value.ticket_request_deadline_time.split(":");return we(De(n,parseInt(x)),parseInt(le))}catch(e){return console.error("Error parsing deadline time:",e),null}}),W=u(()=>R.value?Ce(new Date,R.value):!0),Y=u(()=>r.value==="can_reserve"),X=u(()=>{switch(r.value){case"idle":return"Sélectionnez un programme.";case"loading":return"Vérification en cours...";case"can_reserve":return"Vous pouvez réserver votre ticket.";case"deadline_passed":return"L'heure limite de réservation est dépassée.";case"already_reserved":return"Vous avez déjà réservé un ticket pour ce jour.";case"error":return s.value||"Erreur lors de la vérification.";default:return"Statut inconnu."}}),Z=u(()=>{switch(r.value){case"can_reserve":return"bg-green-1 text-green-9";case"already_reserved":return"bg-blue-1 text-blue-9";case"deadline_passed":return"bg-orange-1 text-orange-9";case"error":return"bg-red-1 text-red-9";default:return"bg-grey-2 text-grey-8"}}),ee=u(()=>{switch(r.value){case"can_reserve":return"check_circle_outline";case"already_reserved":return"check_circle";case"deadline_passed":return"timer_off";case"error":return"error_outline";default:return"info"}}),ae=u(()=>{switch(r.value){case"can_reserve":return"positive";case"already_reserved":return"info";case"deadline_passed":return"warning";case"error":return"negative";default:return"grey-7"}}),te=async()=>{w.value=!0,M.value=[],o.value=null;try{const{data:e}=await Q("get","/canteen/programs/active");e?.status==="success"&&Array.isArray(e.data)?M.value=e.data:l.notify({type:"warning",message:"Impossible de charger les programmes de cantine."})}catch(e){console.error("Error fetching canteen programs:",e),l.notify({type:"negative",message:"Erreur lors du chargement des programmes."})}finally{w.value=!1}},re=async()=>{C.value=!0,d.value=null;try{const{data:e}=await Q("get","/canteen/settings");e?.status==="success"&&e.data?d.value=e.data:(s.value="Paramètres de cantine non configurés. Réservation impossible.",r.value="error",l.notify({type:"negative",message:s.value}))}catch(e){console.error("Error fetching canteen settings:",e),s.value="Erreur chargement paramètres cantine. Réservation impossible.",r.value="error",l.notify({type:"negative",message:s.value})}finally{C.value=!1}},V=async()=>{if(!o.value||!D.value?.idpers){r.value="idle",m.value=null;return}k.value=!0,r.value="loading",m.value=null,s.value="";try{const{data:e}=await Q("get",`/canteen/programs/${o.value}/staff-tickets`);if(e?.status==="success"&&Array.isArray(e.data)){const n=e.data.find(x=>x.idpers===D.value.idpers);n?(m.value=n,r.value="already_reserved"):d.value?W.value?r.value="deadline_passed":r.value="can_reserve":(s.value="Paramètres non chargés, impossible de vérifier la date limite.",r.value="error")}else s.value="Impossible de vérifier les réservations existantes.",r.value="error"}catch(e){console.error("Error checking existing reservation:",e),s.value="Erreur lors de la vérification de la réservation.",r.value="error"}finally{k.value=!1}},se=e=>{console.log("Program changed to:",e),e?V():(r.value="idle",m.value=null,s.value="")},ne=async()=>{if(!(!o.value||!Y.value)){q.value=!0,s.value="";try{const{data:e}=await Q("post",`/canteen/programs/${o.value}/self-reserve`);e?.status==="success"&&e.data?(l.notify({type:"positive",message:e.message||"Ticket réservé avec succès !",icon:"check"}),m.value=e.data,r.value="already_reserved"):(s.value=e?.message||"Une erreur est survenue.",r.value="error",l.notify({type:"negative",message:s.value}))}catch(e){console.error("Error reserving ticket:",e),s.value=e.response?.data?.message||"Erreur technique lors de la réservation.",r.value="error",l.notify({type:"negative",message:s.value})}finally{q.value=!1}}},B=e=>e?N.formatDate(e*1e3,"DD/MM/YYYY HH:mm"):"N/A";ce(()=>d.value,e=>{e&&o.value&&r.value!=="already_reserved"&&V()}),de(async()=>{T("Réserver Ticket Cantine"),H.value=!0,await re(),await te(),H.value=!1});const H=i(!1);return(e,n)=>(v(),L(pe,{class:"page-content q-pa-md"},{default:t(()=>[a(ve,{flat:""},{default:t(()=>[a(O,{class:"q-pb-none"},{default:t(()=>[n[1]||(n[1]=$("div",{class:"text-h6"},"Réserver Mon Ticket Cantine",-1)),D.value?(v(),p("div",qe," Bonjour, "+f(D.value.prenom)+" "+f(D.value.nom),1)):S("",!0)]),_:1}),a(O,null,{default:t(()=>[a(_e,{modelValue:o.value,"onUpdate:modelValue":[n[0]||(n[0]=x=>o.value=x),se],options:F.value,label:"Sélectionner le Programme/Jour",filled:"",dense:"","emit-value":"","map-options":"",loading:w.value,disable:w.value,"options-dense":"",class:"q-mb-md"},{"no-option":t(()=>[a(P,null,{default:t(()=>[a(y,{class:"text-grey"},{default:t(()=>n[2]||(n[2]=[_("Aucun programme actif trouvé.")])),_:1})]),_:1})]),_:1},8,["modelValue","options","loading","disable"]),o.value&&!k.value&&!C.value?(v(),p("div",Me,[a(P,{dense:"",class:"q-pa-none"},{default:t(()=>[a(y,{avatar:"",top:""},{default:t(()=>[a(I,{name:"event",color:"grey-7"})]),_:1}),a(y,null,{default:t(()=>[a(b,{caption:""},{default:t(()=>n[3]||(n[3]=[_("Date du programme")])),_:1}),a(b,null,{default:t(()=>[_(f(G.value||"N/A"),1)]),_:1})]),_:1})]),_:1}),a(P,{dense:"",class:"q-pa-none"},{default:t(()=>[a(y,{avatar:"",top:""},{default:t(()=>[a(I,{name:"schedule",color:"grey-7"})]),_:1}),a(y,null,{default:t(()=>[a(b,{caption:""},{default:t(()=>n[4]||(n[4]=[_("Heure limite de réservation")])),_:1}),a(b,null,{default:t(()=>[_(f(K.value),1)]),_:1})]),_:1})]),_:1}),a(P,{dense:"",class:"q-pa-none"},{default:t(()=>[a(y,{avatar:"",top:""},{default:t(()=>[a(I,{name:"mad_symbol",color:"grey-7"})]),_:1}),a(y,null,{default:t(()=>[a(b,{caption:""},{default:t(()=>n[5]||(n[5]=[_("Tarif du Ticket Personnel")])),_:1}),a(b,null,{default:t(()=>[_(f(J.value),1)]),_:1})]),_:1})]),_:1})])):S("",!0),a(z,{showing:C.value,label:"Chargement paramètres..."},null,8,["showing"]),o.value?(v(),L(me,{key:1,class:"q-my-md"})):S("",!0),o.value?(v(),p("div",Ie,[a(ye,{"inline-actions":"",rounded:"",dense:"",class:fe(["q-mb-md",Z.value])},{avatar:t(()=>[a(I,{name:ee.value,color:ae.value},null,8,["name","color"])]),default:t(()=>[$("div",Qe,f(X.value),1),m.value?(v(),p("div",Pe,[_(" Réservé le "+f(B(m.value.created_at))+" ",1),m.value.payed?(v(),p("span",Ee," (Payé le "+f(B(m.value.payed_at))+")",1)):(v(),p("span",Te," (Non Payé)"))])):S("",!0)]),_:1},8,["class"]),a(ge,{label:"Réserver Mon Ticket",color:"primary",icon:"confirmation_number",disable:!Y.value||q.value||k.value,loading:q.value,onClick:ne,class:"full-width"},null,8,["disable","loading"]),s.value?(v(),p("div",Ne,f(s.value),1)):S("",!0)])):(v(),p("div",Ae," Veuillez sélectionner un programme pour voir les détails et réserver. ")),a(z,{showing:k.value,label:"Vérification réservation..."},null,8,["showing"])]),_:1})]),_:1})]),_:1}))}},ta=oe(Re,[["__scopeId","data-v-1a0e09c0"]]);export{ta as default};
