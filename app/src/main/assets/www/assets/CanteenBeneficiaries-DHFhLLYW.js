const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./CanteenBeneficiariesReport-DezIk4y7.js","./index-Bl2lQPd7.js","./index-B-uS9A6y.css","./date-C1Mon-Jj.js","./format-IcNrutKL.js","./CanteenBeneficiariesReport-5Hp-Viip.css","./TicketCantineReport-Cs48oyOS.js","./TicketCantineReport-BphrO9Lr.css"])))=>i.map(i=>d[i]);
import{_ as qe,aO as Ee,aP as Ie,A as i,B as p,aM as j,Y as Qe,C as Be,Q as g,S as u,a6 as l,a5 as r,a8 as n,aE as Me,aF as Ve,a4 as x,R as L,a2 as Pe,ay as f,av as le,a3 as G,aS as se,a$ as oe,ab as _,ad as q,a7 as Le,aw as Re,aC as Ne,a as H,N as y,b0 as ne,b3 as ie,aR as Fe}from"./index-Bl2lQPd7.js";import{Q as Ue}from"./QDate-C_jC-zMt.js";import{Q as $e}from"./QPopupProxy-CQ30ymZI.js";import{Q as ue}from"./QSelect-DchnWyXK.js";import{Q as ze}from"./QSpinnerDots-BW9ZsFNG.js";import{Q as R}from"./QItemLabel-BkJiB6aE.js";import{Q as Oe,a as W}from"./QItem-De3v03wU.js";import{Q as ce}from"./QTooltip-r7WoEuzy.js";import{Q as J}from"./QChip-C9OfA2gn.js";import{Q as Ke}from"./QVirtualScroll-CENgsPEr.js";import{Q as je}from"./QList-CMzNTEGD.js";import{C as Ge}from"./ClosePopup-BY_YGFBZ.js";import{q as C}from"./date-C1Mon-Jj.js";import{u as He}from"./composables-CAkrP3jA.js";import{E as de}from"./ExportControls-UOL0zNKZ.js";import{f as pe}from"./index-C9ZTL5MN.js";import"./use-render-cache-DLxPkVnQ.js";import"./use-datetime-hbLWgGn4.js";import"./format-IcNrutKL.js";import"./QMenu-BNr9Tzvf.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./rtl-DFPa-2ov.js";import"./_commonjsHelpers-D6-XlEtG.js";import"./index-BXMW6yyY.js";import"./index-CbPSoDvq.js";const We={class:"grid grid-cols-1 lg:grid-cols-3 gap-3 lg:gap-5 items-end"},Je={class:"date-picker-container"},Xe={class:"row items-center justify-end q-mt-sm"},Ze={class:"filter-select-container"},et={class:"filter-select-container"},tt={key:0,class:"mt-4 row items-center justify-between"},at={class:"col-auto"},rt={class:"col-auto export-controls-container shadow-1 q-pa-xs rounded-borders"},lt={class:"beneficiaries-list-container"},st={key:0,class:"text-center q-pa-xl"},ot={class:"text-neutral-mid-grey q-mt-md"},nt={key:1,class:"text-center q-pa-xl"},it={class:"text-grey-7"},ut={key:2,class:"text-center q-pa-xl"},ct={key:3,class:"text-center q-pa-xl"},dt=["src"],pt={class:"flex gap-2 items-center"},mt={key:5,class:"text-center q-pa-xl text-neutral-mid-grey"},vt={__name:"CanteenBeneficiaries",setup(ft){const w=Ee(),M=Ie(),{setTitle:me,showFooter:ve}=He(),fe=oe(()=>ne(()=>import("./CanteenBeneficiariesReport-DezIk4y7.js"),__vite__mapDeps([0,1,2,3,4,5]),import.meta.url)),ge=oe(()=>ne(()=>import("./TicketCantineReport-Cs48oyOS.js"),__vite__mapDeps([6,1,2,7]),import.meta.url)),N=i(null),X=i({billet:{},schoolInfo:{},currentDate:new Date().toISOString()}),F=i(!1),V=i(!1),U=i(!1),k=i(null),Z=C.formatDate(new Date,"YYYY-MM-DD"),s=i(Z),c=i(null),h=i(null),b=i("ALL"),Y=i([]),E=i([]),d=i([]),A=i(""),ee=p(()=>M.getters["user/current"]?.annee),D=p(()=>ee.value?.idannee),m=p(()=>M.getters["ecole/info"]),I=p(()=>M.getters["ecole/invoiceSettings"]),_e=p(()=>!!I.value),Q=(e,t="YYYY-MM-DD")=>e?C.formatDate(e,t):"",$=p(()=>{if(!s.value)return"N/A";const e=Q(s.value,"DD/MM/YYYY");if(c.value&&c.value!==s.value){const t=Q(c.value,"DD/MM/YYYY");return`${e} au ${t}`}return e}),z=p(()=>s.value&&c.value&&s.value!==c.value),te=p(()=>E.value.map(e=>({label:e.classe_fr||e.bref||`Classe ${e.idclasse}`,value:e.idclasse}))),O=i([{label:"Tous Types",value:"ALL"},{label:"Abonnés",value:"SUBSCRIBED"},{label:"Ticket",value:"TICKET"}]),ye=e=>{if(U.value||!Y.value.length)return!0;const t=e.replace(/\//g,"");return Y.value.some(a=>C.formatDate(a.date_cantine,"YYYYMMDD")===t)},he=e=>Y.value.length?Y.value.find(t=>C.formatDate(t.date_cantine,"YYYYMMDD")===e):null,S=p(()=>{if(!d.value.length)return[];let e=[...d.value];return h.value&&(e=e.filter(t=>t.classe_id===h.value)),b.value&&b.value!=="ALL"&&(e=e.filter(t=>t.status===b.value)),z.value?e.sort((t,a)=>{const o=new Date(t.program_date).getTime(),v=new Date(a.program_date).getTime();return o<v?-1:o>v?1:t.full_name.localeCompare(a.full_name)}):e.sort((t,a)=>t.full_name.localeCompare(a.full_name)),e}),be=p(()=>`Bénéficiaires Cantine: ${$.value}`),De=p(()=>S.value.length?{students:S.value,reportDateRange:$.value,reportDate:s.value,filters:{classe:h.value?te.value.find(e=>e.value===h.value)?.label:"Toutes",type:O.value.find(e=>e.value===b.value)?.label||"Tous"},schoolInfo:{},partnerInfo:{},isRange:z.value,schoolInfo:{name:m.value.description||"",addressLine1:m.value.adresse||"",city:m.value.ville||"",contactEmail:m.value.email||"",paymentEmail:I.value?.payment_email??(m.value.email||""),phone:m.value.telephone?"+"+m.value.telephone:"",logoUrl:I.value?.logo_path??(m.value.logo?j(m.value.logo):"")},partnerInfo:{logoUrl:_e.value&&I.value.partner_logo_path?j(I.value.partner_logo_path):null}}:{}),ae=async()=>{U.value=!0,Y.value=[];try{const{data:e}=await H("get","/canteen/programs/active",{params:{annee_id:D.value}});e?.status==="success"&&Array.isArray(e.data)?Y.value=e.data:y.create({type:"warning",message:"Impossible de charger les programmes actifs."})}catch(e){console.error("Error fetching active canteen programs:",e),y.create({type:"negative",message:"Erreur chargement des programmes."})}finally{U.value=!1}},re=async()=>{if(D.value){F.value=!0,E.value=[];try{const{data:e}=await H("get",`/filters/classes/${D.value}`);Array.isArray(e)?E.value=e:e?.data&&Array.isArray(e.data)?E.value=e.data:y.create({type:"warning",message:"Format de réponse des classes inattendu."})}catch(e){console.error("Error fetching classes:",e),y.create({type:"negative",message:"Erreur lors du chargement des classes."})}finally{F.value=!1}}},xe=async(e,t)=>{if(!e||!D.value)return[];try{const{data:a}=await H("get",`/canteen/programs/${e}/students-expected?annee_id=${D.value}`);return a?.status==="success"&&Array.isArray(a.data)?a.data.map(o=>({...o,photo_url:o.photo_url&&!o.photo_url.endsWith("-")?o.photo_url:null,program_date:t})):(y.create({type:"warning",message:`Impossible de charger les élèves pour le programme du ${Q(t,"DD/MM/YYYY")}.`}),[])}catch(a){return console.error(`Error fetching students for program ${e}:`,a),y.create({type:"negative",message:`Erreur technique pour le programme du ${Q(t,"DD/MM/YYYY")}.`}),[]}},P=async()=>{if(!s.value){y.create({type:"info",message:"Veuillez sélectionner une date de début."});return}if(c.value&&C.getDateDiff(c.value,s.value,"days")<0){y.create({type:"negative",message:"La date de fin ne peut pas être antérieure à la date de début."});return}k.value="apply_range",V.value=!0,d.value=[],A.value="";const e=[];let t=new Date(s.value.replace(/-/g,"/"));const a=c.value?new Date(c.value.replace(/-/g,"/")):new Date(s.value.replace(/-/g,"/"));for(;t<=a;)e.push(C.formatDate(t,"YYYYMMDD")),t=C.addToDate(t,{days:1});let o=[];const v=[];for(const T of e){const B=he(T);B?v.push(xe(B.idcantine,T)):console.warn(`No active program found for date: ${T}`)}try{(await Promise.all(v)).forEach(B=>{B.length>0&&(o=o.concat(B))}),d.value=o,d.value.length===0&&e.length>0&&(A.value="Aucun bénéficiaire trouvé pour la période et les programmes actifs sélectionnés.")}catch(T){console.error("Error aggregating student data for range:",T),A.value="Une erreur est survenue lors de la récupération des données pour la période.",d.value=[]}finally{V.value=!1,k.value=null}},K=()=>{!c.value&&s.value?P():s.value&&c.value||(d.value=[])},Ce=()=>{s.value=Z,c.value=null,h.value=null,b.value="ALL",d.value=[],A.value="",k.value=null,P()},we=e=>{const t=e.target.closest(".q-avatar");if(t){const a=t.querySelector(".q-icon");a&&(a.style.display="inline-flex")}e.target.style.display="none"},ke=e=>{const t=O.value.find(a=>a.value===e);return t?t.label.replace(" Tous Types",""):e},Ye=e=>{switch(e){case"SUBSCRIBED":return"sym_o_event_available";case"TICKET":return"sym_o_confirmation_number";case"ADD_MANUAL":return"sym_o_person_add";default:return"sym_o_help"}},Ae=e=>{switch(e){case"SUBSCRIBED":return"primary";case"TICKET":return"secondary";case"ADD_MANUAL":return"accent";default:return"neutral-mid-grey"}},Se=async()=>{if(ee.value)try{await M.dispatch("ecole/fetchInvoiceSettings")}catch{}},Te=async e=>{if(!N.value){w.notify({type:"negative",message:"Composant d'impression non prêt."});return}w.loading.show({message:"Préparation du ticket pour impression..."});let t;try{t=e}catch{w.loading.hide(),w.notify({type:"negative",message:"Impossible de charger les détails complets du ticket pour l'impression."});return}const a=m.value||{},o=t||{};console.log(o,t.program_date,pe(ie(t.program_date),"dd/MM/yyyy")),X.value={billet:{studentName:`${o.full_name||""}`,studentClass:o.classe_name||"Non spécifiée",date_billet:pe(ie(t.program_date),"dd/MM/yyyy"),observation:t.observation||"Aucune observation.",studentId:o.idpers||"N/A"},repas:t.program,schoolInfo:{name:a.description||"Nom de l'Établissement",logoUrl:a.logo?j(a.logo):null},currentDate:new Date().toISOString()},await Fe(),w.loading.hide();try{await N.value.printReport()}catch(v){console.error("Error during printReport call:",v),w.notify({type:"negative",message:"Erreur lors du lancement de l'impression."})}};return Qe(D,e=>{e?(re(),ae().then(()=>{P()})):(E.value=[],d.value=[])},{immediate:!0}),Be(async()=>{me("Liste des Bénéficiaires Cantine"),Se(),ve(!1),await ae(),D.value&&await re(),P()}),(e,t)=>(u(),g(Ne,{padding:"",class:"page-content beneficiaries-container"},{default:l(()=>[r(Me,{flat:"",bordered:"",class:"filter-card q-mb-lg"},{default:l(()=>[r(Ve,{class:"bg-neutral-light"},{default:l(()=>[t[4]||(t[4]=n("div",{class:"q-mb-md text-weight-bold text-primary"},"Filtrer les Bénéficiaires",-1)),n("div",We,[n("div",Je,[r(Pe,{dense:"",filled:"",modelValue:s.value,"onUpdate:modelValue":t[1]||(t[1]=a=>s.value=a),label:"Date",mask:"####-##-##",clearable:"",class:"date-input",standout:"","bg-color":"accent-light-blue"},{prepend:l(()=>[r(f,{name:"sym_o_event",class:"cursor-pointer text-primary"},{default:l(()=>[r($e,{cover:"","transition-show":"scale","transition-hide":"scale"},{default:l(()=>[r(Ue,{modelValue:s.value,"onUpdate:modelValue":[t[0]||(t[0]=a=>s.value=a),K],mask:"YYYY-MM-DD",minimal:"",options:ye,"today-btn":"",color:"primary"},{default:l(()=>[n("div",Xe,[le(r(G,{label:"Fermer",color:"primary",flat:""},null,512),[[Ge]])])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),n("div",Ze,[r(ue,{dense:"",filled:"",modelValue:h.value,"onUpdate:modelValue":[t[2]||(t[2]=a=>h.value=a),K],options:te.value,label:"Classe","emit-value":"","map-options":"",clearable:"",loading:F.value,"options-dense":"",standout:"","bg-color":"accent-light-blue",class:"filter-q-select"},null,8,["modelValue","options","loading"])]),n("div",et,[r(ue,{dense:"",filled:"",modelValue:b.value,"onUpdate:modelValue":[t[3]||(t[3]=a=>b.value=a),K],options:O.value,label:"Type Bénéficiaire","emit-value":"","map-options":"","options-dense":"",standout:"","bg-color":"accent-light-blue",class:"filter-q-select"},null,8,["modelValue","options"])])]),d.value.length>0?(u(),x("div",tt,[n("div",at,[r(G,{label:"Effacer Filtres",color:"neutral-mid-grey",flat:"",onClick:Ce,icon:"clear",disable:V.value,class:"q-pl-sm q-pr-md",rounded:""},null,8,["disable"])]),n("div",rt,[r(de,{"report-component":se(fe),"report-data":De.value,"report-component-styles":[{url:"/reports/cantine.css?v=1.0.1"}],"pdf-filename-prefix":"Beneficiaires_Cantine","pdf-title":be.value},null,8,["report-component","report-data","pdf-title"]),r(de,{ref_key:"exportTicket",ref:N,"report-component":se(ge),"report-data":X.value,pdfFilenamePrefix:"Ticket_Cantine",pdfFormat:[76,"auto"],pdfUnit:"mm",pdfMargin:[4,0,4,0],reportComponentStyles:[{url:"/reports/billet.css?v=1.0.0"}],style:{opacity:"0"}},null,8,["report-component","report-data"])])])):L("",!0)]),_:1})]),_:1}),n("div",lt,[V.value?(u(),x("div",st,[r(ze,{color:"primary",size:"50px"}),n("p",ot,_(k.value==="apply_range"?"Chargement des données pour la période...":"Chargement..."),1)])):A.value?(u(),x("div",nt,[r(f,{name:"sym_o_error",size:"4em",color:"negative"}),t[5]||(t[5]=n("p",{class:"text-negative q-mt-md text-h6"},"Erreur de chargement",-1)),n("p",it,_(A.value),1)])):!d.value.length&&(k.value==="apply_range"||k.value==="today")?(u(),x("div",ut,[r(f,{name:"sym_o_no_food",size:"4em",color:"neutral-mid-grey"}),t[6]||(t[6]=n("p",{class:"text-neutral-mid-grey q-mt-md text-h6"},"Aucun bénéficiaire trouvé pour la sélection.",-1)),t[7]||(t[7]=n("p",{class:"text-neutral-mid-grey"},"Vérifiez les dates ou les programmes actifs.",-1))])):!S.value.length&&d.value.length?(u(),x("div",ct,[r(f,{name:"sym_o_filter_alt_off",size:"4em",color:"neutral-mid-grey"}),t[8]||(t[8]=n("p",{class:"text-neutral-mid-grey q-mt-md text-h6"},"Aucun élève ne correspond aux filtres de classe/type.",-1))])):S.value.length?(u(),g(je,{key:4,bordered:"",separator:"",class:"rounded-lg shadow-1"},{default:l(()=>[r(R,{header:"",class:"bg-accent-light-blue text-primary text-weight-medium rounded-t-lg q-px-md"},{default:l(()=>[r(f,{name:"sym_o_restaurant_menu",class:"q-mr-sm"}),q(" "+_(S.value.length)+" élève(s) affiché(s) pour la période du "+_($.value),1)]),_:1}),r(Ke,{items:S.value,separator:"",style:{"max-height":"70vh"}},{default:l(({item:a,index:o})=>[le((u(),g(Oe,{key:a.idpers+"_"+a.program_date,clickable:"",class:"beneficiary-item"},{default:l(()=>[r(W,{avatar:"",top:"",class:"q-pt-sm"},{default:l(()=>[r(Le,{size:"48px"},{default:l(()=>[a.photo_url?(u(),x("img",{key:0,src:a.photo_url,onError:we,alt:"Photo de l'élève"},null,40,dt)):(u(),g(f,{key:1,name:"sym_o_person",size:"md",color:"neutral-mid-grey"}))]),_:2},1024)]),_:2},1024),r(W,null,{default:l(()=>[r(R,{class:"text-weight-bold text-text-dark"},{default:l(()=>[q(_(a.full_name),1)]),_:2},1024),r(R,{caption:"",class:"text-neutral-mid-grey"},{default:l(()=>[r(f,{name:"sym_o_class",size:"xs",class:"q-mr-xs"}),q(" Classe: "+_(a.classe_name||"N/A"),1)]),_:2},1024),z.value?(u(),g(R,{key:0,caption:"",class:"text-neutral-mid-grey"},{default:l(()=>[r(f,{name:"sym_o_calendar_today",size:"xs",class:"q-mr-xs"}),q(" Date Prog: "+_(Q(a.program_date,"DD/MM/YYYY")),1)]),_:2},1024)):L("",!0)]),_:2},1024),r(W,{side:"",top:"",class:"q-pt-sm q-gutter-y-xs items-end"},{default:l(()=>[n("div",pt,[a.status==="TICKET"?(u(),g(G,{key:0,round:"",flat:"",icon:"print",size:"sm",onClick:v=>Te(a)},{default:l(()=>[r(ce,null,{default:l(()=>t[9]||(t[9]=[q("Imprimer Ticket")])),_:1})]),_:2},1032,["onClick"])):L("",!0),r(J,{dense:"",square:"",icon:Ye(a.status),label:ke(a.status),color:Ae(a.status),"text-color":"white",class:"status-chip"},null,8,["icon","label","color"])]),a.is_served?(u(),g(J,{key:0,dense:"",square:"",color:"positive","text-color":"white",icon:"sym_o_check_circle",label:"Servi",class:"served-chip"},{default:l(()=>[r(ce,{anchor:"top middle",self:"bottom middle"},{default:l(()=>[q("Servi à "+_(a.served_at_display),1)]),_:2},1024)]),_:2},1024)):(u(),g(J,{key:1,dense:"",square:"",color:"neutral-mid-grey","text-color":"white",icon:"sym_o_radio_button_unchecked",label:"Non Servi",class:"served-chip"}))]),_:2},1024)]),_:2},1024)),[[Re]])]),_:1},8,["items"])]),_:1})):s.value?L("",!0):(u(),x("div",mt,[r(f,{name:"sym_o_edit_calendar",size:"4em",color:"neutral-mid-grey"}),t[10]||(t[10]=n("p",{class:"q-mt-md text-h6"},"Veuillez sélectionner une date de début pour afficher les bénéficiaires.",-1))]))])]),_:1}))}},Ut=qe(vt,[["__scopeId","data-v-b166875a"]]);export{Ut as default};
