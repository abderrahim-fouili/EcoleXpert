import{_ as $,bt as C,a4 as b,S as v,a8 as o,ad as _,a5 as s,a6 as c,a3 as I,aO as Q,A as V,J as F,ag as L,Q as E,aE as B,ax as k,aF as z,R as P,ay as A,a2 as f,aC as N,aP as M,B as q,Y as T,C as j}from"./index-Bl2lQPd7.js";import{Q as O}from"./QForm-Dk45GsL9.js";import{Q as R}from"./QSpinnerGears-DmolwAR1.js";import{Q as W}from"./QInnerLoading-WxvcYHvS.js";import{S as G}from"./SchoolLogoUpload-C_tSxVbI.js";import{Q as H}from"./QImg-BMvxJu3S.js";import{Q as D}from"./QTooltip-r7WoEuzy.js";import{Q as J}from"./QSpinnerDots-BW9ZsFNG.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";const Y=C({name:"PartnerLogoUpload",props:{modelValue:{type:String,default:null},settings:{type:Object,required:!0}},emits:["update:modelValue"],setup(t,{emit:a}){const i=Q(),n=V(null),d=V(!1),g=()=>{n.value.click()},m=()=>{a("update:modelValue",null)},p=()=>{i.notify({type:"warning",message:"Impossible de charger l'image. L'URL pourrait être incorrecte."})},e=()=>t.settings&&t.settings.imgbb?t.settings.imgbb:t.settings&&t.settings.imgcdndev?t.settings.imgcdndev:(i.notify({type:"warning",message:"Paramètres d'hébergement d'images non trouvés. Utilisation du service par défaut."}),{url:"https://api.imgbb.com/1/upload",key:"your-fallback-key"});return{fileInput:n,isUploading:d,triggerFileInput:g,onFileSelected:async r=>{const l=r.target.files[0];if(l){if(!l.type.startsWith("image/")){i.notify({type:"negative",message:"Veuillez sélectionner une image valide"});return}if(l.size>2*1024*1024){i.notify({type:"negative",message:`Le fichier est trop volumineux (max 2MB): ${l.name}`});return}d.value=!0;try{const y=e(),S=new FormData;S.append("image",l);const h=await F.create().post(`${y.url}?key=${y.key}`,S,{headers:{"Content-Type":"multipart/form-data"},transformRequest:(U,w)=>(delete w.Authorization,delete w["x-user-as"],U)});if(h.data&&h.data.success)a("update:modelValue",h.data.data.image.url),i.notify({type:"positive",message:"Logo partenaire téléchargé avec succès"});else throw new Error("Upload failed: "+(h.data.message||"Unknown error"))}catch(y){console.error("Error uploading image:",y),i.notify({type:"negative",message:"Échec du téléchargement du logo: "+(y.message||"Erreur inconnue")})}finally{d.value=!1,n.value&&(n.value.value="")}}},clearLogo:m,handleImageError:p}}}),x={key:0},K={key:0,class:"logo-upload-container"},X={key:1,class:"logo-preview-wrapper"},Z={class:"logo-actions q-mt-sm"},ee={key:1,class:"upload-loading"};function ae(t,a,i,n,d,g){return v(),b("div",null,[t.isUploading?(v(),b("div",ee,[s(J,{color:"primary",size:"40px"}),a[5]||(a[5]=o("div",{class:"q-mt-sm"},"Téléchargement en cours...",-1))])):(v(),b("div",x,[t.modelValue?(v(),b("div",X,[s(H,{src:t.modelValue,class:"logo-preview",fit:"contain",onError:t.handleImageError},null,8,["src","onError"]),o("div",Z,[s(I,{flat:"",dense:"",color:"primary",icon:"edit",onClick:t.triggerFileInput},{default:c(()=>[s(D,null,{default:c(()=>a[3]||(a[3]=[_("Modifier le logo")])),_:1})]),_:1},8,["onClick"]),s(I,{flat:"",dense:"",color:"negative",icon:"delete",onClick:t.clearLogo},{default:c(()=>[s(D,null,{default:c(()=>a[4]||(a[4]=[_("Supprimer le logo")])),_:1})]),_:1},8,["onClick"])])])):(v(),b("div",K,[o("div",{class:"dropbox cursor-pointer",onClick:a[1]||(a[1]=(...m)=>t.triggerFileInput&&t.triggerFileInput(...m))},[o("input",{type:"file",class:"input-file",accept:"image/*",onChange:a[0]||(a[0]=(...m)=>t.onFileSelected&&t.onFileSelected(...m)),ref:"fileInput"},null,544),a[2]||(a[2]=o("p",null,[_(" Déposez votre logo partenaire ici"),o("br"),_(" ou cliquez pour sélectionner une image ")],-1))])]))]))])}const te=$(Y,[["render",ae],["__scopeId","data-v-2a067d46"]]),oe=C({name:"InvoiceSettingsPage",components:{SchoolLogoUpload:G,PartnerLogoUpload:te},setup(){const t=M(),a=Q(),i=V(null),n=V(!1),d=V({due_date_days:15,currency:"MAD",payment_email:"",logo_path:null,partner_logo_path:null,bank_account_name:"",bank_name:"",bank_iban:"",bank_swift_code:""}),g=q(()=>t.getters["ecole/invoiceSettings"]),m=q(()=>!!g.value),p=q(()=>t.getters["media/settings"]);return T(g,u=>{u?Object.assign(d.value,u):Object.assign(d.value,{due_date_days:15,currency:"MAD",payment_email:"",logo_path:null,partner_logo_path:null,bank_account_name:"",bank_name:"",bank_iban:"",bank_swift_code:""})},{immediate:!0}),j(async()=>{if(!g.value){n.value=!0;try{await t.dispatch("ecole/fetchInvoiceSettings")}catch(u){console.error("Échec de la récupération des paramètres de facturation:",u),a.notify({type:"negative",message:"Échec du chargement des paramètres de facturation. "+(u.message||"Erreur inconnue")})}finally{n.value=!1}}if(!p.value||!p.value.imgbb&&!p.value.imgcdndev)try{await t.dispatch("media/getSettings")}catch(u){console.error("Échec du chargement des paramètres d'hébergement d'images:",u),a.notify({type:"warning",message:"Impossible de charger les paramètres d'hébergement d'images. Les téléchargements pourraient ne pas fonctionner."})}}),{loading:n,formData:d,form:i,onSubmit:async()=>{if(!await i.value.validate()){a.notify({type:"negative",message:"Veuillez corriger les erreurs de validation."});return}n.value=!0;try{const r={...d.value};let l;m.value?l=await t.dispatch("ecole/updateInvoiceSettings",r):l=await t.dispatch("ecole/initializeInvoiceSettings",r),a.notify({type:"positive",message:l.message||"Paramètres enregistrés avec succès!",icon:"save"})}catch(r){console.error("Échec de l'enregistrement:",r);let l="Échec de l'enregistrement des paramètres.";r.response?r.response.status===422?l="Validation échouée. Veuillez vérifier vos données.":r.response.status===404?l="Erreur: Paramètres non trouvés sur le serveur. Veuillez actualiser la page.":r.response.data&&r.response.data.message?l=r.response.data.message:l=`La requête a échoué avec le statut ${r.response.status}.`:r.message&&(l=r.message),a.notify({type:"negative",message:l,icon:"error"})}finally{n.value=!1}},settingsExist:m,settings:p}}}),se={key:0,class:"q-mb-md bg-yellow-1 q-pa-md rounded-borders"},le={class:"row q-col-gutter-md"},re={class:"col-12 col-md-4"},ne={class:"col-12 col-md-4"},ie={class:"col-12 col-md-4"},de={class:"row q-col-gutter-md"},me={class:"col-12 col-md-6"},ue={class:"col-12 col-md-6"},ce={class:"col-12 col-md-6"},pe={class:"col-12 col-md-6"},ge={class:"row q-col-gutter-lg"},fe={class:"col-12 col-md-6"},ve={class:"logo-section q-pa-md"},be={class:"col-12 col-md-6"},ye={class:"logo-section q-pa-md"},_e={class:"q-mt-lg"};function Ve(t,a,i,n,d,g){const m=L("school-logo-upload"),p=L("partner-logo-upload");return v(),E(N,{class:"page-content"},{default:c(()=>[s(B,{flat:""},{default:c(()=>[s(k),s(z,null,{default:c(()=>[a[15]||(a[15]=o("div",{class:"text-h6 q-mb-md"},"Paramètres de Facturation",-1)),s(O,{onSubmit:t.onSubmit,class:"q-gutter-md",ref:"form"},{default:c(()=>[t.settingsExist?P("",!0):(v(),b("div",se,[s(A,{name:"warning",color:"warning",class:"q-mr-sm"}),a[9]||(a[9]=_(" Paramètres de facturation non trouvés. Veuillez remplir les détails ci-dessous pour les créer. "))])),a[12]||(a[12]=o("div",{class:"text-subtitle1 q-mt-md text-primary"},"Paramètres Généraux",-1)),s(k,{spaced:""}),o("div",le,[o("div",re,[s(f,{modelValue:t.formData.due_date_days,"onUpdate:modelValue":a[0]||(a[0]=e=>t.formData.due_date_days=e),modelModifiers:{number:!0},label:"Date d'échéance (jours après émission)",type:"number",filled:"",rules:[e=>e!==null&&e!==""||"Les jours de date d'échéance sont requis",e=>e>=0||"Les jours de date d'échéance ne peuvent pas être négatifs"]},null,8,["modelValue","rules"])]),o("div",ne,[s(f,{modelValue:t.formData.currency,"onUpdate:modelValue":a[1]||(a[1]=e=>t.formData.currency=e),label:"Code de devise (ex: MAD, USD, EUR)",filled:"",rules:[e=>!!e||"La devise est requise",e=>e&&e.length<=20||"La devise doit comporter 20 caractères maximum"]},null,8,["modelValue","rules"])]),o("div",ie,[s(f,{modelValue:t.formData.payment_email,"onUpdate:modelValue":a[2]||(a[2]=e=>t.formData.payment_email=e),label:"Adresse e-mail de paiement",type:"email",filled:"",rules:[e=>!!e||"L'email de paiement est requis",e=>e&&e.length<=255||"L'email de paiement doit comporter 255 caractères maximum",e=>/.+@.+\..+/.test(e)||"Format d'email invalide"]},null,8,["modelValue","rules"])])]),a[13]||(a[13]=o("div",{class:"text-subtitle1 q-mt-lg text-primary"},"Coordonnées Bancaires",-1)),s(k,{spaced:""}),o("div",de,[o("div",me,[s(f,{modelValue:t.formData.bank_account_name,"onUpdate:modelValue":a[3]||(a[3]=e=>t.formData.bank_account_name=e),label:"Nom du compte bancaire",filled:"",rules:[e=>!!e||"Le nom du compte bancaire est requis",e=>e&&e.length<=200||"Le nom du compte bancaire doit comporter 200 caractères maximum"]},null,8,["modelValue","rules"])]),o("div",ue,[s(f,{modelValue:t.formData.bank_name,"onUpdate:modelValue":a[4]||(a[4]=e=>t.formData.bank_name=e),label:"Nom de la banque",filled:"",rules:[e=>!!e||"Le nom de la banque est requis",e=>e&&e.length<=200||"Le nom de la banque doit comporter 200 caractères maximum"]},null,8,["modelValue","rules"])]),o("div",ce,[s(f,{modelValue:t.formData.bank_iban,"onUpdate:modelValue":a[5]||(a[5]=e=>t.formData.bank_iban=e),label:"IBAN bancaire",filled:"",rules:[e=>!!e||"L'IBAN bancaire est requis",e=>e&&e.length<=50||"L'IBAN bancaire doit comporter 50 caractères maximum"]},null,8,["modelValue","rules"])]),o("div",pe,[s(f,{modelValue:t.formData.bank_swift_code,"onUpdate:modelValue":a[6]||(a[6]=e=>t.formData.bank_swift_code=e),label:"Code SWIFT/BIC",filled:"",rules:[e=>!!e||"Le code SWIFT/BIC est requis",e=>e&&e.length<=20||"Le code SWIFT/BIC doit comporter 20 caractères maximum"]},null,8,["modelValue","rules"])])]),a[14]||(a[14]=o("div",{class:"text-subtitle1 q-mt-lg text-primary"},"Logos",-1)),s(k,{spaced:""}),o("div",ge,[o("div",fe,[o("div",ve,[a[10]||(a[10]=o("div",{class:"text-subtitle2 q-mb-sm"},"Logo de l'école",-1)),s(m,{modelValue:t.formData.logo_path,"onUpdate:modelValue":a[7]||(a[7]=e=>t.formData.logo_path=e),settings:t.settings},null,8,["modelValue","settings"])])]),o("div",be,[o("div",ye,[a[11]||(a[11]=o("div",{class:"text-subtitle2 q-mb-sm"},"Logo partenaire (Optionnel)",-1)),s(p,{modelValue:t.formData.partner_logo_path,"onUpdate:modelValue":a[8]||(a[8]=e=>t.formData.partner_logo_path=e),settings:t.settings},null,8,["modelValue","settings"])])])]),o("div",_e,[s(I,{label:"Enregistrer les paramètres",type:"submit",color:"primary",loading:t.loading,icon:"save",class:"q-px-md"},null,8,["loading"])])]),_:1},8,["onSubmit"])]),_:1}),s(W,{showing:t.loading},{default:c(()=>[s(R,{size:"50px",color:"primary"})]),_:1},8,["showing"])]),_:1})]),_:1})}const Qe=$(oe,[["render",Ve],["__scopeId","data-v-1717170a"]]);export{Qe as default};
