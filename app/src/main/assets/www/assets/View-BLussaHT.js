import{Q as p}from"./QImg-BMvxJu3S.js";import{_ as U,b9 as M,ba as B,aB as I,b2 as T,b8 as L,as as R,at as V,ag as _,a4 as o,S as l,a5 as a,a6 as r,R as g,a8 as y,ab as h,aE as q,aF as E,a9 as m,aa as v,Q as u,a7 as k,ay as N,ad as b,ax as P,af as H,aD as A,aC as D,a3 as j,bc as z,aY as F,b5 as O}from"./index-Bl2lQPd7.js";import{Q as G,a as Q}from"./QItem-De3v03wU.js";import{Q as Y}from"./QItemLabel-BkJiB6aE.js";import{Q as J}from"./QList-CMzNTEGD.js";import{Q as K}from"./QBadge-Bjfo5tRO.js";import{Q as W,l as X}from"./linkify-html.es-DZPJD58y.js";import Z from"./New-DkyEryGV.js";import"./QToolbarTitle-C8APieXG.js";import"./QToolbar-DR-_wX4W.js";import"./QBreadcrumbs-D5k8AHhT.js";import"./QSelect-DchnWyXK.js";import"./QChip-C9OfA2gn.js";import"./QMenu-BNr9Tzvf.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./rtl-DFPa-2ov.js";import"./format-IcNrutKL.js";import"./QTooltip-r7WoEuzy.js";import"./QUploaderAddTrigger-OZIUWg9a.js";import"./QUploader-Dwk8_y__.js";import"./QCircularProgress-C_b7NmsY.js";import"./QForm-Dk45GsL9.js";import"./ClosePopup-BY_YGFBZ.js";const{getScrollTarget:$,setVerticalScrollPosition:ee}=z,se={data(){return{history,showReply:!1,log:""}},components:{NewMessage:Z},computed:{...V({user:"user/user",config:"user/config",current:"user/current",message:"message/message"}),eleve(){if(this.current&&this.current.hasOwnProperty("eleve"))return this.current.eleve},annee(){if(this.current&&this.current.hasOwnProperty("annee"))return this.current.annee}},methods:{...R({setStatus:"message/setStatus",setBar:"setBar",getMessage:"message/load",getMessages:"message/getInbox",messageStatus:"message/setStatus"}),openURL:L,toNow:T,userPhotoUrl:I,LetterAvatar:B,fileIcon:M,isImage(e){return O(this.fileUrl(e))},messageEnvoye(e){this.show=!1,this.log=e,e&&e.id&&(this.$router.push("/messages/view/"+e.id),this.$nextTick(()=>{this.setBar(!0),this.getMessage(e.id).then(()=>{this.message&&(this.scrollToElement(this.message),this.setBar(!1))})}))},canSee(e){return e.type_sender==="parent"?e.sender.id===this.user.id:!0},lu(e){e.sender_id!==this.user.id&&this.messageStatus({id:e.id,status:1}).then(i=>{this.getMessages({page:1,filter:{kids:this.config.meta.eleves.map(c=>c.idpers)}})})},fileUrl(e){return F(e)},text(e){let i=this.$cleanHtml(e.message);return e.quote&&(i="<blockquote>"+e.quote+"</blockquote>"+i),X(i,{defaultProtocol:"https",target:"_blank"})},sub(e){return this.$cleanHtml(e)},isSent(e){return e.sender.idpers!==this.user.idpers},scrollToElement(e){this.$nextTick(()=>{let i=this.$refs["m-"+e.id][0].$el;const c=$(i),f=i.offsetTop;ee(c,f,500)})}},mounted(){this.$route.params.id&&this.getMessage(this.$route.params.id).then(()=>{this.message&&(this.scrollToElement(this.message),this.message.etat.length||this.lu(this.message))}),this.setTitle("Messagerie")}},te={key:0},ae={class:"text-bold",style:{padding:"20px 16px 20px"}},re=["innerHTML"];function ie(e,i,c,f,d,t){const w=_("new-message"),S=_("ep-footer");return l(),o(m,null,[a(D,{padding:"",class:"page-content"},{default:r(()=>[e.message?(l(),o("div",te,[y("div",ae,h(e.message.objet),1),a(q,{style:{margin:"0 -8px 0"}},{default:r(()=>[a(E,null,{default:r(()=>[(l(!0),o(m,null,v(e.message.thread.messages,(s,le)=>(l(),o(m,{key:"m-"+s.id},[t.canSee(s)?(l(),u(W,{key:0,name:s.sender.nom+" "+s.sender.prenom,stamp:t.toNow(s.created_at*1e3),sent:t.isSent(s),"text-color":"white","bg-color":t.isSent(s)?"green":"blue",ref_for:!0,ref:"m-"+s.id,class:"q-mb-lg"},{avatar:r(()=>[a(k,{class:H({"q-message-avatar":!0,"q-message-avatar--sent":t.isSent(s),"q-message-avatar--received":!t.isSent(s)})},{default:r(()=>[a(p,{src:t.userPhotoUrl(s.sender),"placeholder-src":t.LetterAvatar(s.sender.nom)},null,8,["src","placeholder-src"]),t.isSent(s)?(l(),u(K,{key:0,floating:""},{default:r(()=>[b(h(s.type_sender),1)]),_:2},1024)):g("",!0)]),_:2},1032,["class"])]),default:r(()=>[y("div",{innerHTML:t.text(s),style:{"max-width":"58vw"},class:"contained"},null,8,re),s.fichiers.length?(l(),u(J,{key:0},{default:r(()=>[(l(!0),o(m,null,v(s.fichiers,(n,x)=>(l(),o(m,{key:x},[t.isImage(n)?(l(),u(p,{key:0,src:t.fileUrl(n),onClick:C=>t.openURL(t.fileUrl(n))},null,8,["src","onClick"])):(l(),u(G,{key:1,clickable:"",onClick:C=>t.openURL(t.fileUrl(n))},{default:r(()=>[a(Q,{avatar:""},{default:r(()=>[a(k,{color:"white"},{default:r(()=>[a(N,{name:"img:"+t.fileIcon(n.fichier)},null,8,["name"])]),_:2},1024)]),_:2},1024),a(Q,null,{default:r(()=>[a(Y,{line:"1",class:"ellipsis",style:{"max-width":"30vw"}},{default:r(()=>[b(h(n.fichier),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"])),a(P)],64))),128))]),_:2},1024)):g("",!0)]),_:2},1032,["name","stamp","sent","bg-color"])):g("",!0)],64))),128))]),_:1})]),_:1})])):g("",!0),a(A,{modelValue:d.showReply,"onUpdate:modelValue":i[0]||(i[0]=s=>d.showReply=s),position:"bottom",maximized:!0},{default:r(()=>[a(w,{message:e.message,title:"Répondre","onMessage:sent":t.messageEnvoye},null,8,["message","onMessage:sent"])]),_:1},8,["modelValue"])]),_:1}),a(S,{to:"#footer-portal"},{default:r(()=>[a(j,{onClick:i[1]||(i[1]=s=>d.showReply=!0),flat:"",icon:"reply",label:"répondre"})]),_:1})],64)}const Te=U(se,[["render",ie]]);export{Te as default};
