import{_ as C,as as x,at as T,a as w,aW as S,J as F,Q as d,S as n,a6 as i,a5 as r,av as v,a3 as p,ad as m,ab as h,b6 as q,aF as A,a8 as c,a4 as y,a9 as U,aa as V,ay as O,R as f,aZ as j,a_ as P,a2 as _,b7 as B,aG as L,aE as z}from"./index-Bl2lQPd7.js";import{Q as M}from"./QToolbarTitle-C8APieXG.js";import{Q as b}from"./QBadge-Bjfo5tRO.js";import{Q as N}from"./QToolbar-DR-_wX4W.js";import{Q as D,a as E}from"./QBreadcrumbs-D5k8AHhT.js";import{Q as I}from"./QItemLabel-BkJiB6aE.js";import{Q as R,a as k}from"./QItem-De3v03wU.js";import{Q as G}from"./QSelect-DchnWyXK.js";import{Q as g}from"./QTooltip-r7WoEuzy.js";import{Q as H}from"./QUploaderAddTrigger-OZIUWg9a.js";import{Q as J}from"./QUploader-Dwk8_y__.js";import{Q as W}from"./QForm-Dk45GsL9.js";import{C as Z}from"./ClosePopup-BY_YGFBZ.js";import"./QChip-C9OfA2gn.js";import"./QMenu-BNr9Tzvf.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./rtl-DFPa-2ov.js";import"./format-IcNrutKL.js";import"./QCircularProgress-C_b7NmsY.js";const K={data(){return{form:{objet:null,message:null,quote:null,destinataire:null,thread_id:null},destinataire:null,destType:"parent",cfiles:0,step:null,steps:[],options:[]}},props:{message:{default:()=>null},globalSettings:{default:()=>null},title:{default:()=>"Nouveau message"}},computed:{...T({user:"user/user",config:"user/config",current:"user/current"}),headers(){return[{name:"Authorization",value:F.defaults.headers.common.Authorization}]},url(){return S("api")+"/messages/pj"}},methods:{...x({envoyer:"message/send"}),added(l){this.cfiles=l.length},removed(l){this.cfiles-=l.length},attach(){this.$nextTick(()=>{this.$refs.uploader.pickFiles()})},send(){this.$refs.form.validate().then(l=>{if(!l)return this.$q.notify({color:"negative",message:this.$t("stats.fields"),position:"bottom",icon:"error_outline",actions:[{label:this.$q.lang.label.close,color:"yellow"}]}),!1;this.cfiles>0?this.$refs.uploader.upload():this.sendMessage()})},sendMessage(l){let a=[];l&&(a=JSON.parse(l.xhr.response).result),console.log(this.steps),this.message&&this.message.thread_id&&(this.form.thread_id=this.message.thread_id,this.form.objet=this.message.objet),this.envoyer({form:this.form,files:a,filter:this.steps.map(e=>e.step==="service"?{type:"service",value:e.value?e.value.idrole:0,id:e.value?e.value.idrole:0,label:e.label}:e)}).then(e=>{this.$emit("message:sent",e)}).catch(e=>{this.$emit("message:error",e)})},removeStep(l){this.destinataire=null,l.type&&l.type==="type"?this.clear():(this.steps.splice(this.steps.indexOf(l),this.steps.length),this.step=this.steps[this.steps.length-1].step,this.setOptions())},choice(l){this.step=l.value.step,this.$nextTick(()=>{if(this.form.destinataire=this.destinataire.map(e=>e.value.idpers?{type:"personne",id:e.value.idpers,value:"personne_"+e.value.idpers,label:e.label}:e),this.step!=="personnes"&&l.value.value)this.destinataire=null,this.setOptions(),this.$refs.dest.refresh(),this.steps.push(l.value);else if(l.value.value===0)for(var a=0;a<this.steps.length;a++)this.steps[a].step===l.value.step&&delete this.steps[a]})},clear(){this.destinataire=null,this.step=null,this.steps=[],this.setOptions()},filterFn(l,a){if(console.log(l),!l||l===""){a(()=>{this.setOptions()});return}a(()=>{const e=l.toLowerCase();this.setOptions(),this.options=this.options.filter(u=>u.label.toLowerCase().indexOf(e)>-1)})},setOptions(){let l=[{label:"Parents",id:"parent",value:"parent",type:"type",step:"parent"},{label:"Profs",id:"prof",value:"prof",type:"type",step:"profs"},{label:"Administration",type:"type",value:"admin",id:"admin",step:"admin"}];if(this.config&&this.config.hasOwnProperty("meta")){let a=this.config.meta,e=[];this.form.destinataire&&this.form.destinataire.length>1&&(this.form.destinataire=[this.form.destinataire[this.form.destinataire.length-1]]);let u=this.form.destinataire;if(this.step)switch(this.step){case"admin":e=a.admins.map(s=>({label:s.description,value:s,step:"service",type:"service"})),this.options=[{label:"Tous les services",step:"service",type:"service",value:0,id:0},...e];break;case"service":u[0].value&&(e=u[0].value.utilisateurs.map(s=>({label:s.personnes.nom+" "+s.personnes.prenom,value:s.personnes,step:"personnes"})),this.options=[{label:"Tous les administrateurs",value:0,id:0,step:"personnes",type:"personne",ids:u[0].value.utilisateurs.map(s=>s.idpers)},...e]);break;case"profs":this.destType="prof",this.globalSettings&&(e=this.globalSettings.classes.map(s=>({label:s.classe_fr,value:s,step:"classes"})),this.options=[{label:"Toutes les classes",value:0,id:0,type:"classe",step:"classes"},...e]);break;case"parent":this.destType="parent",this.globalSettings&&(e=this.globalSettings.niveaux.map(s=>({label:s.niveau_fr,value:s,step:"niveaux"})),this.options=[{label:"Touts les niveaux",value:0,id:0,type:"niveau",step:"niveaux"},...e]);break;case"niveaux":this.globalSettings&&(e=this.globalSettings.classes.filter(s=>s.idniveau===u[0].value.idniveau).map(s=>({label:s.classe_fr,value:s,step:"classes"})),this.options=[{label:"Toutes les classes",value:0,id:0,type:"classe",step:"classes"},...e]);break;case"classes":this.current.annee&&w("post","/messages/dest",{classe:u[0].value.idclasse,annee:this.current.annee.idannee,type:this.destType}).then(({data:s})=>{e=s.map(o=>({label:o.nom+" "+o.prenom,value:o,step:"personnes"})),this.options=[{label:"Tous les "+(this.destType==="prof"?"profs":"parents"),value:0,id:0,type:"personne",step:"personnes",ids:s.map(o=>o.idpers)},...e],this.$nextTick(()=>{})});break}else this.options=l}},hasDiscs(l){return l.value.disciplines&&l.value.disciplines.length},discs(l){return l.value.disciplines[0].description}},mounted(){this.setOptions()}},X={class:"q-pb-md"},Y={key:2},$={class:"row"},ee={class:"col-xs-12"},se={class:"row no-wrap items-center q-pa-sm q-gutter-xs",style:{}},te={class:"col"},le={class:"q-uploader__subtitle"};function ae(l,a,e,u,s,o){return n(),d(z,null,{default:i(()=>[r(N,{class:"bg-secondary text-white shadow-2"},{default:i(()=>[v(r(p,{flat:"",dense:"",icon:"arrow_back"},null,512),[[Z]]),r(M,null,{default:i(()=>[m(h(e.title),1)]),_:1}),r(p,{flat:"",dense:"",icon:"attach_file",onClick:o.attach},{default:i(()=>[v(r(b,{floating:"",color:"yellow-9"},{default:i(()=>[m(h(s.cfiles),1)]),_:1},512),[[q,s.cfiles>0]])]),_:1},8,["onClick"]),r(p,{class:"q-ml-lg",flat:"",icon:"send",onClick:o.send},null,8,["onClick"])]),_:1}),r(A,{style:{"overflow-y":"scroll"}},{default:i(()=>[c("div",X,[r(D,{gutter:"none"},{separator:i(()=>[r(O,{name:"arrow_forward",color:"grey-9"})]),default:i(()=>[(n(!0),y(U,null,V(s.steps,(t,Q)=>(n(),d(E,{key:"s-"+Q,onClick:ie=>o.removeStep(t)},{default:i(()=>[r(b,{color:"grey-4","text-color":"grey-9"},{default:i(()=>[m(h(t.label),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})]),r(W,{class:"q-gutter-lg",ref:"form"},{default:i(()=>[e.message?f("",!0):(n(),d(G,{key:0,ref:"dest",behavior:"menu",filled:"",modelValue:s.destinataire,"onUpdate:modelValue":a[0]||(a[0]=t=>s.destinataire=t),options:s.options,"use-chips":"",multiple:"",label:"Destinataire","lazy-rules":"",rules:[t=>!!t||"Champ requis"],onAdd:o.choice,onFilter:o.filterFn},{option:i(t=>[r(R,j(P(t.itemProps)),{default:i(()=>[r(k,null,{default:i(()=>[r(I,{innerHTML:t.opt.label},null,8,["innerHTML"])]),_:2},1024),t.opt.step==="personnes"?(n(),d(k,{key:0,side:""},{default:i(()=>[o.hasDiscs(t.opt)?(n(),d(b,{key:0},{default:i(()=>[m(h(o.discs(t.opt)),1)]),_:2},1024)):f("",!0)]),_:2},1024)):f("",!0)]),_:2},1040)]),_:1},8,["modelValue","options","rules","onAdd","onFilter"])),e.message?(n(),y("div",Y," RE:"+h(e.message.objet),1)):(n(),d(_,{key:1,filled:"",modelValue:s.form.objet,"onUpdate:modelValue":a[1]||(a[1]=t=>s.form.objet=t),label:"Objet",hint:"","lazy-rules":"",rules:[t=>!!t||"Champ requis"]},null,8,["modelValue","rules"])),r(_,{filled:"",modelValue:s.form.message,"onUpdate:modelValue":a[2]||(a[2]=t=>s.form.message=t),autogrow:"",type:"textarea",label:"Message",rules:[t=>!!t||"Champ requis"],"lazy-rules":"","input-style":"min-height:150px"},null,8,["modelValue","rules"]),c("div",$,[c("div",ee,[r(J,{"field-name":t=>"pieces_jointe[]",style:{width:"100%"},url:o.url,flat:"",multiple:"",headers:o.headers,ref:"uploader",batch:"",onAdded:o.added,onRemoved:o.removed,onUploaded:o.sendMessage},{header:i(t=>[c("div",se,[t.queuedFiles.length>0?(n(),d(p,{key:0,icon:"clear_all",onClick:t.removeQueuedFiles,round:"",dense:"",flat:""},{default:i(()=>[r(g,null,{default:i(()=>a[3]||(a[3]=[m("Clear All")])),_:1})]),_:2},1032,["onClick"])):f("",!0),t.uploadedFiles.length>0?(n(),d(p,{key:1,icon:"done_all",onClick:t.removeUploadedFiles,round:"",dense:"",flat:""},{default:i(()=>[r(g,null,{default:i(()=>a[4]||(a[4]=[m("Remove Uploaded Files")])),_:1})]),_:2},1032,["onClick"])):f("",!0),t.isUploading?(n(),d(B,{key:2,class:"q-uploader__spinner"})):f("",!0),c("div",te,[a[5]||(a[5]=c("div",{class:"q-uploader__title"},"Fichiers joint",-1)),c("div",le,h(t.uploadSizeLabel)+" / "+h(t.uploadProgressLabel),1)]),t.canAddFiles?(n(),d(p,{key:3,type:"a",icon:"add_box",round:"",dense:"",flat:""},{default:i(()=>[r(H),r(g,null,{default:i(()=>a[6]||(a[6]=[m("Pick Files")])),_:1})]),_:1})):f("",!0),t.isUploading?(n(),d(p,{key:4,icon:"clear",onClick:t.abort,round:"",dense:"",flat:""},{default:i(()=>[r(g,null,{default:i(()=>a[7]||(a[7]=[m("Abort Upload")])),_:1})]),_:2},1032,["onClick"])):f("",!0)])]),_:1},8,["url","headers","onAdded","onRemoved","onUploaded"])])])]),_:1},512)]),_:1}),r(L,{align:"right",class:""},{default:i(()=>[r(p,{label:"Envoyer",icon:"send",onClick:o.send},null,8,["onClick"])]),_:1})]),_:1})}const we=C(K,[["render",ae]]);export{we as default};
