import{Q as x}from"./QSelect-DchnWyXK.js";import{Q as W}from"./QDate-C_jC-zMt.js";import{Q as X}from"./QPopupProxy-CQ30ymZI.js";import{aP as le,B as U,A as c,Y as J,Q as y,S as g,a6 as i,a5 as t,aE as se,aF as G,a8 as o,av as Ve,ab as _,a3 as w,ah as he,aV as O,aG as xe,aD as we,_ as ke,aO as Se,C as Qe,a4 as Z,R as Q,a2 as R,ay as L,d4 as ee,ax as De,ac as $e,af as Ce,ad as ae,aC as qe,a as H}from"./index-Bl2lQPd7.js";import{Q as Ae}from"./QExpansionItem-EMhshZ_3.js";import{Q as A}from"./QTd-CpEgdqvP.js";import{Q as D}from"./QChip-C9OfA2gn.js";import{Q as Ue}from"./QTooltip-r7WoEuzy.js";import{Q as Ye}from"./QTable-D-OlObRI.js";import{q as Me}from"./date-C1Mon-Jj.js";import{Q as Pe}from"./QSpace-CKKoNTi_.js";import{Q as Te}from"./QForm-Dk45GsL9.js";import{C as Ne}from"./ClosePopup-BY_YGFBZ.js";import{u as je}from"./composables-CAkrP3jA.js";import"./QItem-De3v03wU.js";import"./QItemLabel-BkJiB6aE.js";import"./QMenu-BNr9Tzvf.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./rtl-DFPa-2ov.js";import"./format-IcNrutKL.js";import"./use-render-cache-DLxPkVnQ.js";import"./use-datetime-hbLWgGn4.js";import"./QSlideTransition-CrdUnXBf.js";import"./QVirtualScroll-CENgsPEr.js";import"./QList-CMzNTEGD.js";import"./QLinearProgress-DW1NPbfx.js";const Ee={class:"text-h6"},Fe={class:"q-gutter-y-md"},Be={__name:"AbsenceValidationDialog",props:{show:Boolean,title:{type:String,default:"Valider Absence(s)"},initialData:{type:Object,default:()=>({active:!0,send_sms:!1,send_email:!1})}},emits:["close","validated"],setup(Y,{emit:f}){const $=Y,N=f,k=le(),V=U(()=>k.getters["absence/validation/isSubmitting"]),d=c({active:!0,send_sms:!1,send_email:!1});J(()=>$.show,m=>{m&&(d.value={...$.initialData})}),J(()=>d.value.active,m=>{m||(d.value.send_sms=!1,d.value.send_email=!1)});const h=()=>{N("validated",{...d.value})};return(m,n)=>(g(),y(we,{"model-value":Y.show,onHide:n[4]||(n[4]=p=>m.$emit("close")),persistent:""},{default:i(()=>[t(se,{style:{"min-width":"400px"}},{default:i(()=>[t(G,{class:"row items-center q-pb-none"},{default:i(()=>[o("div",Ee,_(Y.title),1),t(Pe),Ve(t(w,{icon:"close",flat:"",round:"",dense:""},null,512),[[Ne]])]),_:1}),t(Te,{onSubmit:he(h,["prevent"])},{default:i(()=>[t(G,{class:"q-pt-md"},{default:i(()=>[o("div",Fe,[t(O,{modelValue:d.value.active,"onUpdate:modelValue":n[0]||(n[0]=p=>d.value.active=p),label:"Absence Active/Valide",color:"primary"},null,8,["modelValue"]),n[5]||(n[5]=o("div",{class:"text-caption q-ml-sm text-grey-7"}," Désactiver pour annuler l'absence ou la marquer comme non pertinente. ",-1)),t(O,{modelValue:d.value.send_sms,"onUpdate:modelValue":n[1]||(n[1]=p=>d.value.send_sms=p),label:"Notifier par SMS/Notification Push",color:"secondary",disable:!d.value.active},null,8,["modelValue","disable"]),n[6]||(n[6]=o("div",{class:"text-caption q-ml-sm text-grey-7"}," Active la notification si l'absence est valide. ",-1)),t(O,{modelValue:d.value.send_email,"onUpdate:modelValue":n[2]||(n[2]=p=>d.value.send_email=p),label:"Notifier par Email",color:"accent",disable:!d.value.active},null,8,["modelValue","disable"]),n[7]||(n[7]=o("div",{class:"text-caption q-ml-sm text-grey-7"}," Active la notification par email si l'absence est valide. ",-1))])]),_:1}),t(xe,{align:"right",class:"q-pa-md"},{default:i(()=>[t(w,{label:"Annuler",color:"grey-7",flat:"",onClick:n[3]||(n[3]=p=>m.$emit("close")),disable:V.value},null,8,["disable"]),t(w,{label:"Appliquer Validation",type:"submit",color:"primary",loading:V.value},null,8,["loading"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model-value"]))}},ze={class:"row q-col-gutter-md items-start"},Ie={class:"col-12 col-sm-6 col-md-3"},Oe={class:"col-12 col-sm-6 col-md-3"},Re={class:"col-12 col-sm-6 col-md-3"},Le={class:"col-12 col-sm-6 col-md-4"},He={class:"col-12 col-sm-6 col-md-4"},Je={class:"col-12 col-sm-6 col-md-4"},Ge={class:"col-12 col-sm-6 col-md-3"},Ke={class:"col-12 col-sm-6 col-md-3"},We={class:"col-12 col-sm-6 col-md-3"},Xe={class:"col-12 col-sm-6 col-md-3"},Ze={class:"col-12 col-md-auto filter-checkbox-container"},ea={class:"col-12 col-md-auto filter-checkbox-container"},aa={class:"row justify-end q-mt-md"},la={class:"text-subtitle2 q-mr-md text-weight-medium"},sa={key:0},ta={class:"text-weight-medium"},ia={class:"text-caption text-grey-7"},oa={class:"text-weight-medium"},na={class:"text-caption text-grey-7"},ua={class:"full-width row flex-center text-primary q-gutter-sm q-pa-lg"},da={__name:"AbsenceValidationPage",setup(Y){const f=le(),$=Se(),{setTitle:N}=je(),k=U(()=>f.getters["user/current"]?.annee),V=c([]),d=c([]),h=c([]),m=c([]),n=c([]),p=c([]),j=c([]),v=c({academicYears:!1,cycles:!1,niveaux:!1,classes:!1,students:!1,professors:!1,matieres:!1}),K=()=>({idannee:k.value?.idannee||null,idcycle:null,idniveau:null,idclasse:null,idpers_student:null,idpers_prof:null,idmatiere:null,date_from:null,date_to:null,jour:null,debut_seance:null,status_active:!1,status_justifier:null,status_send_sms:null,status_send_email:null}),l=c(K()),te=[{label:"Lundi",value:1},{label:"Mardi",value:2},{label:"Mercredi",value:3},{label:"Jeudi",value:4},{label:"Vendredi",value:5},{label:"Samedi",value:6},{label:"Dimanche",value:7}],ie=U(()=>f.getters["absence/validation/absencesList"]),M=c(f.getters["absence/validation/pagination"]),P=U(()=>f.getters["absence/validation/isLoading"]),oe=U(()=>f.getters["absence/validation/isSubmitting"]),b=c([]),C=c(!1),E=c(""),F=c({}),T=c(null),B=c(null),ne=[{name:"personne",label:"Élève",field:a=>a.personne,format:a=>a?`${a.nom} ${a.prenom}`:"",sortable:!1,align:"left"},{name:"date_absence",label:"Date Absence",field:"date_absence",sortable:!0,align:"left"},{name:"matiere",label:"Matière",field:a=>a.matiere?.matiere_fr||a.matiere?.bref||"",sortable:!1,align:"left"},{name:"classe",label:"Classe",field:a=>a.classe?.classe_fr||"",sortable:!1,align:"left"},{name:"prof",label:"Signalé par",field:a=>a.prof,format:a=>a?`${a.nom} ${a.prenom}`:"Système",sortable:!1,align:"left"},{name:"status",label:"Statuts",field:"status",sortable:!1,align:"center"},{name:"actions",label:"Actions",field:"actions",align:"right"}],u=async(a,s=null)=>{v.value[a]=!0;let e="",r={anneeId:l.value.idannee};switch(a){case"academicYears":e="/infirmary/form-data/academic-years",r={};break;case"cycles":e=`/filters/cycles/${l.value.idannee}`,r={};break;case"niveaux":e=`/filters/niveaux/${l.value.idannee}`,r={idcycle:l.value.idcycle};break;case"classes":e=`/filters/classes/${l.value.idannee}`,r={idniveau:l.value.idniveau,idcycle:l.value.idcycle};break;case"matieres":e=`/filters/matieres/${l.value.idannee}`,r={};break;default:v.value[a]=!1;return}try{const S=await H("get",e,{params:r});let q=S.data.data||S.data;a==="academicYears"?V.value=q:a==="cycles"?d.value=q:a==="niveaux"?h.value=q:a==="classes"?m.value=q:a==="matieres"&&(n.value=q)}catch(S){console.error(`Error fetching ${a}:`,S),$.notify({type:"negative",message:`Erreur chargement ${a}.`})}finally{v.value[a]=!1}},ue=a=>{l.value.idcycle=null,l.value.idniveau=null,l.value.idclasse=null,d.value=[],h.value=[],m.value=[],n.value=[],a&&(u("cycles"),u("niveaux"),u("classes"),u("matieres")),z()},de=async a=>{console.log("Cycle changed:",a),l.value.idniveau=null,l.value.idclasse=null,a&&(h.value=[],m.value=[],await u("niveaux"),await u("classes"))},re=a=>{l.value.idclasse=null,m.value=[],a&&a!==null&&u("classes",a)},ce=async(a,s,e)=>{if(a.length<2||!l.value.idannee){e();return}v.value.students=!0;try{const r=await H("get",`/filters/students/${l.value.idannee}`,{params:{term:a,idclasse:l.value.idclasse}});s(()=>{p.value=r.data.data||r.data})}catch{e()}finally{v.value.students=!1}},me=async(a,s,e)=>{if(a.length<2||!l.value.idannee){e();return}v.value.professors=!0;try{const r=await H("get",`/filters/professors/${l.value.idannee}`,{params:{term:a}});s(()=>{j.value=r.data.data||r.data})}catch{e()}finally{v.value.professors=!1}},z=()=>{M.value.page=1,I()},ve=()=>{l.value=K(),k.value?.idannee?(l.value.idannee=k.value.idannee,u("cycles"),u("matieres"),u("classes"),u("niveaux")):V.value.length>0&&(l.value.idannee=V.value.find(a=>a.courant===1)?.idannee||V.value[0].idannee,u("cycles"),u("matieres"),u("classes"),u("niveaux")),d.value=[],h.value=[],m.value=[],n.value=[],p.value=[],j.value=[],b.value=[],z()},I=()=>{if(!l.value.idannee){f.commit("absence/validation/SET_ABSENCES",{data:[],total:0,current_page:1,per_page:M.value.rowsPerPage});return}const a={...l.value};for(const s of["status_active","status_justifier","status_send_sms","status_send_email"])a[s]===null||a[s]===void 0?delete a[s]:a[s]=a[s]?1:0;f.dispatch("absence/validation/fetchAbsencesForValidation",a)},fe=a=>{const{page:s,rowsPerPage:e,sortBy:r,descending:S}=a.pagination;f.commit("absence/validation/SET_PAGINATION",{page:s,rowsPerPage:e,sortBy:r,descending:S}),I()},pe=a=>{B.value=a,F.value={active:a.active,send_sms:a.send_sms,send_email:a.send_email},E.value=`Valider Absence: ${a.personne?.nom||""} ${a.personne?.prenom||""}`,T.value="single",C.value=!0},be=()=>{if(b.value.length===0){$.notify({type:"warning",message:"Aucune absence sélectionnée."});return}F.value={active:!0,send_sms:!1,send_email:!1},E.value=`Valider ${b.value.length} absence(s) en lot`,T.value="batch",C.value=!0},ge=async a=>{T.value==="single"&&B.value?await f.dispatch("absence/validation/performSingleValidation",{absenceId:B.value.id,validationData:a}):T.value==="batch"&&b.value.length>0&&(await f.dispatch("absence/validation/performBatchValidation",{absence_ids:b.value.map(s=>s.id),...a}),b.value=[]),C.value=!1},_e=a=>{if(!a)return"";try{return Me.formatDate(a,"DD/MM/YYYY")}catch{return a}},ye=a=>{if(a==null)return"";const s=String(a).padStart(4,"0");return`${s.substring(0,2)}:${s.substring(2,4)}`};return Qe(async()=>{N("Validation des Absences"),await u("academicYears"),u("cycles"),u("matieres"),u("classes"),u("niveaux"),I()}),J(k,a=>{a&&a.idannee&&a.idannee!==l.value.idannee&&(l.value.idannee=a.idannee,ue(a.idannee))}),(a,s)=>(g(),y(qe,{padding:"",class:"page-content"},{default:i(()=>[t(se,{flat:"",bordered:"",class:"card-shadow"},{default:i(()=>[t(Ae,{"expand-separator":"",icon:"filter_list",label:"Filtres de Recherche","header-class":"bg-primary text-white filter-header"},{default:i(()=>[t(G,null,{default:i(()=>[o("div",ze,[o("div",Ie,[t(x,{outlined:"",modelValue:l.value.idcycle,"onUpdate:modelValue":[s[0]||(s[0]=e=>l.value.idcycle=e),de],options:d.value,label:"Cycle","option-value":"idcycle","option-label":"cycle","emit-value":"","map-options":"",clearable:"",loading:v.value.cycles,disable:!l.value.idannee,class:"filter-select"},null,8,["modelValue","options","loading","disable"])]),o("div",Oe,[t(x,{outlined:"",modelValue:l.value.idniveau,"onUpdate:modelValue":[s[1]||(s[1]=e=>l.value.idniveau=e),re],options:h.value,label:"Niveau","option-value":"idniveau","option-label":"niveau_fr","emit-value":"","map-options":"",clearable:"",loading:v.value.niveaux,disable:!l.value.idannee,class:"filter-select"},null,8,["modelValue","options","loading","disable"])]),o("div",Re,[t(x,{outlined:"",modelValue:l.value.idclasse,"onUpdate:modelValue":s[2]||(s[2]=e=>l.value.idclasse=e),options:m.value,label:"Classe","option-value":"idclasse","option-label":"classe_fr","emit-value":"","map-options":"",clearable:"",loading:v.value.classes,disable:!l.value.idannee,class:"filter-select"},null,8,["modelValue","options","loading","disable"])]),o("div",Le,[t(x,{outlined:"",modelValue:l.value.idpers_student,"onUpdate:modelValue":s[3]||(s[3]=e=>l.value.idpers_student=e),"use-input":"","hide-selected":"","fill-input":"","input-debounce":"500",label:"Élève",options:p.value,onFilter:ce,"option-value":"idpers","option-label":e=>`${e.nom} ${e.prenom} (${e.classe_name||"N/A"})`,"emit-value":"","map-options":"",clearable:"",loading:v.value.students,disable:!l.value.idannee,class:"filter-select"},null,8,["modelValue","options","option-label","loading","disable"])]),o("div",He,[t(x,{outlined:"",modelValue:l.value.idpers_prof,"onUpdate:modelValue":s[4]||(s[4]=e=>l.value.idpers_prof=e),"use-input":"","hide-selected":"","fill-input":"","input-debounce":"500",label:"Professeur (ayant marqué)",options:j.value,onFilter:me,"option-value":"idpers","option-label":"nom_complet","emit-value":"","map-options":"",clearable:"",loading:v.value.professors,disable:!l.value.idannee,class:"filter-select"},null,8,["modelValue","options","loading","disable"])]),o("div",Je,[t(x,{outlined:"",modelValue:l.value.idmatiere,"onUpdate:modelValue":s[5]||(s[5]=e=>l.value.idmatiere=e),options:n.value,label:"Matière","option-value":"idmatiere","option-label":"matiere_fr","emit-value":"","map-options":"",clearable:"",loading:v.value.matieres,disable:!l.value.idannee,class:"filter-select"},null,8,["modelValue","options","loading","disable"])]),o("div",Ge,[t(R,{outlined:"",modelValue:l.value.date_from,"onUpdate:modelValue":s[7]||(s[7]=e=>l.value.date_from=e),label:"Date Du",mask:"####-##-##",clearable:"",class:"filter-input"},{append:i(()=>[t(L,{name:"event",class:"cursor-pointer text-primary"},{default:i(()=>[t(X,{cover:""},{default:i(()=>[t(W,{modelValue:l.value.date_from,"onUpdate:modelValue":s[6]||(s[6]=e=>l.value.date_from=e),mask:"YYYY-MM-DD"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),o("div",Ke,[t(R,{outlined:"",modelValue:l.value.date_to,"onUpdate:modelValue":s[9]||(s[9]=e=>l.value.date_to=e),label:"Date Au",mask:"####-##-##",clearable:"",class:"filter-input"},{append:i(()=>[t(L,{name:"event",class:"cursor-pointer text-primary"},{default:i(()=>[t(X,{cover:""},{default:i(()=>[t(W,{modelValue:l.value.date_to,"onUpdate:modelValue":s[8]||(s[8]=e=>l.value.date_to=e),mask:"YYYY-MM-DD"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),o("div",We,[t(x,{outlined:"",modelValue:l.value.jour,"onUpdate:modelValue":s[10]||(s[10]=e=>l.value.jour=e),options:te,label:"Jour de Semaine","emit-value":"","map-options":"",clearable:"",class:"filter-select"},null,8,["modelValue"])]),o("div",Xe,[t(R,{outlined:"",modelValue:l.value.debut_seance,"onUpdate:modelValue":s[11]||(s[11]=e=>l.value.debut_seance=e),label:"Début Séance (HHMM)",mask:"####",clearable:"",placeholder:"Ex: 0800",class:"filter-input"},null,8,["modelValue"])]),o("div",Ze,[t(ee,{modelValue:l.value.status_active,"onUpdate:modelValue":s[12]||(s[12]=e=>l.value.status_active=e),label:"Validées",class:"filter-checkbox"},null,8,["modelValue"])]),o("div",ea,[t(ee,{modelValue:l.value.status_justifier,"onUpdate:modelValue":s[13]||(s[13]=e=>l.value.status_justifier=e),label:"Justifiées",class:"filter-checkbox"},null,8,["modelValue"])])]),o("div",aa,[t(w,{label:"Réinitialiser",color:"grey-7",flat:"",class:"filter-button",onClick:ve,disable:P.value},null,8,["disable"]),t(w,{label:"Rechercher",color:"primary",icon:"search",onClick:z,class:"q-ml-sm filter-button",loading:P.value},null,8,["loading"])])]),_:1})]),_:1}),t(De),b.value.length>0?(g(),Z("div",{key:0,class:Ce(["q-pa-md row items-center bg-grey-1 selection-actions",{"animated-height":!0}]),style:$e({height:b.value.length?"60px":"0"})},[o("div",la,_(b.value.length)+" absence(s) sélectionnée(s) ",1),t(w,{label:"Valider en lot",color:"secondary",icon:"checklist",onClick:be,disable:P.value||oe.value,class:"batch-action-button"},null,8,["disable"])],4)):Q("",!0),t(Ye,{flat:"",rows:ie.value,columns:ne,"row-key":"id",selection:"multiple",selected:b.value,"onUpdate:selected":s[14]||(s[14]=e=>b.value=e),pagination:M.value,"onUpdate:pagination":s[15]||(s[15]=e=>M.value=e),loading:P.value,onRequest:fe,"binary-state-sort":"",class:"sticky-header-table data-table"},{"body-cell-date_absence":i(e=>[t(A,{props:e,class:"text-weight-medium"},{default:i(()=>[ae(_(_e(e.row.date_absence))+" "+_(e.row.debut?ye(e.row.debut):""),1)]),_:2},1032,["props"])]),"body-cell-personne":i(e=>[t(A,{props:e,style:{"min-width":"150px"},class:"student-cell"},{default:i(()=>[e.row.personne?(g(),Z("div",sa,[o("div",ta,_(e.row.personne.nom)+" "+_(e.row.personne.prenom),1),o("div",ia,_(e.row.personne.code),1)])):Q("",!0)]),_:2},1032,["props"])]),"body-cell-classe":i(e=>[t(A,{props:e,class:"class-cell"},{default:i(()=>[o("div",oa,_(e.row.classe?.classe_fr||"N/A"),1),o("div",na,_(e.row.classe?.niveau?.niveau_fr),1)]),_:2},1032,["props"])]),"body-cell-status":i(e=>[t(A,{props:e,class:"status-cell"},{default:i(()=>[e.row.active?(g(),y(D,{key:0,dense:"",color:e.row.active?"positive":"grey-5","text-color":"white",size:"sm",class:"q-mr-xs status-chip",label:"Active"},null,8,["color"])):(g(),y(D,{key:1,dense:"",color:e.row.active?"grey-5":"negative","text-color":"white",size:"sm",class:"q-mr-xs status-chip",label:"Inactive"},null,8,["color"])),e.row.justifier?(g(),y(D,{key:2,dense:"",color:e.row.justifier?"teal":"grey-5","text-color":"white",size:"sm",class:"q-mr-xs status-chip",label:"Justifiée"},null,8,["color"])):Q("",!0),e.row.send_sms?(g(),y(D,{key:3,dense:"",color:e.row.send_sms?"blue":"grey-5","text-color":"white",size:"sm",class:"q-mr-xs status-chip",label:"SMS"},null,8,["color"])):Q("",!0),e.row.send_email?(g(),y(D,{key:4,dense:"",color:e.row.send_email?"orange":"grey-5","text-color":"white",size:"sm",label:"Email",class:"status-chip"},null,8,["color"])):Q("",!0),e.row.is_absence?Q("",!0):(g(),y(D,{key:5,dense:"",size:"sm",label:"Retard",class:"status-chip"}))]),_:2},1032,["props"])]),"body-cell-actions":i(e=>[t(A,{props:e,class:"text-right"},{default:i(()=>[t(w,{flat:"",round:"",dense:"",icon:"edit_note",color:"primary",onClick:r=>pe(e.row),class:"action-button"},{default:i(()=>[t(Ue,null,{default:i(()=>s[17]||(s[17]=[ae("Valider/Modifier Statut")])),_:1})]),_:2},1032,["onClick"])]),_:2},1032,["props"])]),"no-data":i(()=>[o("div",ua,[t(L,{size:"2em",name:"sentiment_dissatisfied"}),s[18]||(s[18]=o("span",null,"Aucune absence à valider pour les filtres actuels.",-1))])]),_:1},8,["rows","selected","pagination","loading"])]),_:1}),t(Be,{show:C.value,title:E.value,"initial-data":F.value,onClose:s[16]||(s[16]=e=>C.value=!1),onValidated:ge},null,8,["show","title","initial-data"])]),_:1}))}},Na=ke(da,[["__scopeId","data-v-84b016f6"]]);export{Na as default};
