import{Q as I,a as g}from"./QItem-De3v03wU.js";import{Q as R}from"./QSelect-DchnWyXK.js";import{Q as K}from"./QDate-C_jC-zMt.js";import{Q as W}from"./QPopupProxy-CQ30ymZI.js";import{_ as ge,aP as _e,aO as xe,A as Y,B as w,Y as he,C as ye,Q as _,S as r,a6 as a,a5 as s,aE as S,aF as A,a8 as l,ad as u,a2 as X,ay as Q,a3 as D,a4 as p,a9 as z,aa as U,R as P,af as Z,aS as k,a7 as be,aB as we,ab as n,ax as De,aD as Pe,av as ee,aY as ke,aG as qe,aC as Ne}from"./index-Bl2lQPd7.js";import{Q as x}from"./QSkeleton-CAzJcT8b.js";import{Q as E}from"./QItemLabel-BkJiB6aE.js";import{Q as te}from"./QChip-C9OfA2gn.js";import{Q as G}from"./QTooltip-r7WoEuzy.js";import{Q as se}from"./QList-CMzNTEGD.js";import{Q as Ye}from"./QPagination-UgiQF7o2.js";import{Q as Qe}from"./QInnerLoading-WxvcYHvS.js";import{C as ae}from"./ClosePopup-BY_YGFBZ.js";import{q}from"./date-C1Mon-Jj.js";import{u as Ce}from"./composables-CAkrP3jA.js";import"./QMenu-BNr9Tzvf.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./rtl-DFPa-2ov.js";import"./format-IcNrutKL.js";import"./use-render-cache-DLxPkVnQ.js";import"./use-datetime-hbLWgGn4.js";const Ve={class:"row q-col-gutter-md items-end"},Ae={class:"col-12 col-md-3"},Ee={class:"col-12 col-md-3"},Me={class:"col-12 col-md-3"},Ie={class:"col-12 col-md-3"},Se={class:"col-12 text-right"},ze={class:"row q-mt-sm items-center q-col-gutter-sm"},Fe={class:"col-xs-12 col-sm-auto"},Te={class:"col-xs-12 col-sm-auto"},Be={class:"q-gutter-xs"},Oe={key:1,class:"empty-state-container"},$e={class:"full-width row flex-center q-pa-xl empty-state"},Re={key:2,class:"relative-position"},Ue=["src"],Ge=["onClick"],je={class:"text-grey-7 q-ml-sm text-caption"},Le={class:"col-xs-12 col-sm-auto"},Je={class:"col-xs-12 col-sm-auto"},He={class:"column items-end justify-between",style:{"min-width":"180px",height:"100%"}},Ke={class:"q-gutter-xs q-mb-xs"},We={key:0,class:"q-mt-xs text-right"},Xe={class:"text-caption text-grey-7"},Ze={key:1,class:"q-mt-xs text-right",style:{height:"18px"}},et={key:0,class:"row items-center justify-between q-pa-md bg-grey-1 rounded-borders-bottom"},tt={key:1,style:{"min-height":"36px"}},st={class:"q-gutter-y-md"},at={key:0},lt={__name:"AbsenceNotificationPage",setup(ot){const c=_e(),y=xe(),{setTitle:le}=Ce(),f={PENDING:0,APPROVED:1,REJECTED:2},j=()=>({personne_id:null,status:null,date_from:null,date_to:null}),m=Y(j()),F=Y([]),b=w(()=>c.getters["absence/notifications/notificationsList"]),v=w(()=>c.getters["absence/notifications/isLoading"]),C=w(()=>c.getters["absence/notifications/statusMap"]),d=w(()=>c.getters["absence/notifications/currentNotification"]),i=Y({...c.getters["absence/notifications/pagination"]}),oe=Y([{label:"10",value:10},{label:"15",value:15},{label:"25",value:25},{label:"50",value:50}]);he(()=>c.getters["absence/notifications/pagination"],o=>{i.value.page=o.page,i.value.rowsPerPage=o.rowsPerPage,i.value.rowsNumber=o.rowsNumber,i.value.sortBy=o.sortBy,i.value.descending=o.descending},{deep:!0});const T=Y(!1),re=Y(null),ne=w(()=>c.getters["user/currentAnnee"]),ie=w(()=>Object.entries(C.value||{}).map(([o,e])=>({label:e,value:parseInt(o)}))),B=w(()=>!i.value.rowsPerPage||!i.value.rowsNumber?0:Math.ceil(i.value.rowsNumber/i.value.rowsPerPage)),ue=o=>{const e=o.target,t=e.parentNode;if(e.style.display="none",t&&t.querySelector){const h=t.querySelector("i.q-icon");h&&(h.style.display="inline-flex")}},M=async(o={})=>{const e={...m.value,...o};e.date_from&&typeof e.date_from=="string"&&e.date_from.includes("/")?e.date_from=q.formatDate(q.extractDate(e.date_from,"DD/MM/YYYY"),"YYYY-MM-DD"):e.date_from&&typeof e.date_from=="object"&&(e.date_from=q.formatDate(e.date_from,"YYYY-MM-DD")),e.date_to&&typeof e.date_to=="string"&&e.date_to.includes("/")?e.date_to=q.formatDate(q.extractDate(e.date_to,"DD/MM/YYYY"),"YYYY-MM-DD"):e.date_to&&typeof e.date_to=="object"&&(e.date_to=q.formatDate(e.date_to,"YYYY-MM-DD")),await c.dispatch("absence/notifications/fetchNotifications",e)},L=()=>{v.value&&b.value.length>0||(c.commit("absence/notifications/SET_PAGINATION",{...i.value,page:1}),M())},de=()=>{m.value=j(),F.value=[],L()},ce=o=>{v.value||(c.commit("absence/notifications/SET_PAGINATION",{...i.value,page:o}),M())},me=o=>{v.value||(c.commit("absence/notifications/SET_PAGINATION",{...i.value,page:1,rowsPerPage:o}),M())},pe=(o,e,t)=>{if(o.length<2){t();return}c.dispatch("absence/notifications/searchStudents",{term:o,anneeId:ne.value?.idannee}).then(h=>{e(()=>{F.value=h})}).catch(()=>t())},N=(o,e=!1)=>o?q.formatDate(o,e?"DD/MM/YYYY HH:mm":"DD/MM/YYYY"):"N/A",O=o=>{switch(o){case f.PENDING:return"warning";case f.APPROVED:return"positive";case f.REJECTED:return"negative";default:return"grey-6"}},J=o=>o.status===f.PENDING,ve=(o,e)=>{re.value=o,o.status===f.PENDING&&$(o,f.APPROVED)},$=(o,e)=>{const t=C.value[e]||"ce statut",h=C.value[o.status];y.dialog({title:"Confirmer Changement de Statut",message:`Voulez-vous vraiment changer le statut de cette notification de "${h}" à "${t}" pour l'élève ${o.personne?.nom} ${o.personne?.prenom}?`,cancel:{label:"Annuler",flat:!0,color:"grey-8"},persistent:!0,ok:{label:"Confirmer",color:O(e),unelevated:!0,class:"q-px-md"}}).onOk(()=>{fe(o,e)})},fe=async(o,e)=>{try{await c.dispatch("absence/notifications/updateNotificationStatus",{id:o.id,status:e})}catch{}},H=async o=>{try{await c.dispatch("absence/notifications/fetchNotificationById",o.id),T.value=!0}catch{y.notify({type:"negative",message:"Impossible de charger les détails."})}};return ye(async()=>{le("Notifications d'Absence"),await c.dispatch("absence/notifications/fetchStatuses"),(!v.value||b.value.length===0)&&M()}),(o,e)=>(r(),_(Ne,{padding:"",class:"page-content"},{default:a(()=>[s(S,{flat:"",bordered:"",class:"filter-card shadow-2 rounded-borders"},{default:a(()=>[s(A,null,{default:a(()=>[e[10]||(e[10]=l("h5",{class:"text-h5 q-mt-none q-mb-md text-primary"},"Filtrer les Notifications d'Absence",-1)),l("div",Ve,[l("div",Ae,[s(R,{outlined:"",modelValue:m.value.personne_id,"onUpdate:modelValue":e[0]||(e[0]=t=>m.value.personne_id=t),"use-input":"","hide-selected":"","fill-input":"","input-debounce":"500",label:"Rechercher Élève",options:F.value,onFilter:pe,"option-value":"idpers","option-label":t=>`${t.nom} ${t.prenom} (${t.code||"N/A"})`,"emit-value":"","map-options":"",clearable:""},{"no-option":a(()=>[s(I,null,{default:a(()=>[s(g,{class:"text-grey"},{default:a(()=>e[9]||(e[9]=[u("Aucun élève trouvé.")])),_:1})]),_:1})]),_:1},8,["modelValue","options","option-label"])]),l("div",Ee,[s(R,{outlined:"",modelValue:m.value.status,"onUpdate:modelValue":e[1]||(e[1]=t=>m.value.status=t),options:ie.value,label:"Statut","emit-value":"","map-options":"",clearable:""},null,8,["modelValue","options"])]),l("div",Me,[s(X,{outlined:"",modelValue:m.value.date_from,"onUpdate:modelValue":e[3]||(e[3]=t=>m.value.date_from=t),label:"Du",mask:"####-##-##",clearable:""},{append:a(()=>[s(Q,{name:"event",class:"cursor-pointer text-primary"},{default:a(()=>[s(W,{cover:"","transition-show":"scale","transition-hide":"scale"},{default:a(()=>[s(K,{modelValue:m.value.date_from,"onUpdate:modelValue":e[2]||(e[2]=t=>m.value.date_from=t),mask:"YYYY-MM-DD",color:"primary"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),l("div",Ie,[s(X,{outlined:"",modelValue:m.value.date_to,"onUpdate:modelValue":e[5]||(e[5]=t=>m.value.date_to=t),label:"Au",mask:"####-##-##",clearable:""},{append:a(()=>[s(Q,{name:"event",class:"cursor-pointer text-primary"},{default:a(()=>[s(W,{cover:"","transition-show":"scale","transition-hide":"scale"},{default:a(()=>[s(K,{modelValue:m.value.date_to,"onUpdate:modelValue":e[4]||(e[4]=t=>m.value.date_to=t),mask:"YYYY-MM-DD",color:"primary"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),l("div",Se,[s(D,{label:"Filtrer",color:"primary",icon:"search",onClick:L,loading:v.value&&b.value.length===0,class:"q-mr-sm",rounded:""},null,8,["loading"]),s(D,{label:"Réinitialiser",color:"grey-7",flat:"",icon:"refresh",onClick:de,rounded:""})])])]),_:1})]),_:1}),s(S,{flat:"",bordered:"",class:"q-mt-lg shadow-2 rounded-borders"},{default:a(()=>[s(A,{class:"bg-primary text-white q-py-sm"},{default:a(()=>e[11]||(e[11]=[l("div",{class:"text-h6"},"Notifications d'Absence des Parents",-1)])),_:1}),v.value&&b.value.length===0?(r(),_(A,{key:0,class:"q-pa-lg"},{default:a(()=>[(r(!0),p(z,null,U(i.value.rowsPerPage>5?5:i.value.rowsPerPage,t=>(r(),p("div",{key:`skel-${t}`,class:"q-mb-md"},[s(S,{flat:"",bordered:""},{default:a(()=>[s(I,{class:"q-py-md"},{default:a(()=>[s(g,{avatar:"",top:"",class:"q-pr-md"},{default:a(()=>[s(x,{type:"QAvatar",size:"56px"})]),_:1}),s(g,null,{default:a(()=>[s(x,{type:"text",width:"40%",class:"q-mb-sm",style:{height:"20px"}}),s(x,{type:"text",width:"60%",style:{height:"16px"}}),s(x,{type:"text",class:"q-mt-sm",width:"80%"}),l("div",ze,[l("div",Fe,[s(x,{type:"text",width:"100px"})]),l("div",Te,[s(x,{type:"text",width:"100px"})])])]),_:1}),s(g,{side:"",top:""},{default:a(()=>[s(x,{type:"QChip",width:"90px",height:"28px",class:"q-mb-sm"}),l("div",Be,[s(x,{type:"QBtn",width:"36px",height:"36px"}),s(x,{type:"QBtn",width:"36px",height:"36px"})])]),_:1})]),_:1})]),_:1})]))),128))]),_:1})):!v.value&&b.value.length===0?(r(),p("div",Oe,[l("div",$e,[s(Q,{name:"notifications_paused",size:"5rem",color:"grey-5"}),e[12]||(e[12]=l("div",{class:"text-h6 text-grey-7 q-mt-md"},"Aucune notification d'absence trouvée",-1)),e[13]||(e[13]=l("div",{class:"text-body2 text-grey q-mt-xs"},"Ajustez vos filtres ou attendez de nouvelles notifications.",-1))])])):(r(),p("div",Re,[s(se,{separator:""},{default:a(()=>[(r(!0),p(z,null,U(b.value,(t,h)=>(r(),p(z,{key:t.id},[s(I,{class:"notification-list-item q-py-md"},{default:a(()=>[s(g,{avatar:"",top:"",class:Z({"q-pr-md":k(y).screen.gt.xs})},{default:a(()=>[s(be,{size:k(y).screen.gt.xs?"56px":"40px"},{default:a(()=>[l("img",{src:k(we)(t.personne),onError:ue},null,40,Ue)]),_:2},1032,["size"])]),_:2},1032,["class"]),s(g,null,{default:a(()=>[s(E,{lines:"1"},{default:a(()=>[l("span",{class:"text-weight-bold text-primary cursor-pointer",onClick:V=>H(t)},n(t.personne?.nom)+" "+n(t.personne?.prenom),9,Ge),l("span",je," ("+n(t.personne?.classes&&t.personne?.classes[0]?t.personne.classes[0].classe_fr:"Classe N/A")+") ",1)]),_:2},1024),s(E,{caption:"",lines:"1"},{default:a(()=>[u("Soumis le: "+n(N(t.created_at,!0)),1)]),_:2},1024),s(E,{class:"q-mt-xs text-wrap",style:{"max-height":"4.5em"}},{default:a(()=>[e[14]||(e[14]=l("strong",{class:"text-body2"},"Motif:",-1)),u(" "+n(t.motif),1)]),_:2},1024),l("div",{class:Z(["row q-mt-sm items-center",{"q-col-gutter-sm":k(y).screen.gt.xs}])},[l("div",Le,[e[15]||(e[15]=l("span",{class:"text-caption text-weight-medium"},"Du:",-1)),u(" "+n(N(t.du)),1)]),l("div",Je,[e[16]||(e[16]=l("span",{class:"text-caption text-weight-medium"},"Au:",-1)),u(" "+n(N(t.au)),1)])],2)]),_:2},1024),s(g,{side:"",top:""},{default:a(()=>[l("div",He,[s(te,{color:O(t.status),"text-color":"white",size:"sm",class:"q-mb-sm text-capitalize",clickable:"",onClick:V=>J(t)?ve(t,V):null,ripple:J(t)},{default:a(()=>[u(n(t.status_text||C.value[t.status]||"Inconnu"),1)]),_:2},1032,["color","onClick","ripple"]),l("div",Ke,[s(D,{flat:"",round:"",icon:"visibility",color:"info",size:"sm",onClick:V=>H(t)},{default:a(()=>[s(G,null,{default:a(()=>e[17]||(e[17]=[u("Voir Détails")])),_:1})]),_:2},1032,["onClick"]),t.status===f.PENDING?(r(),_(D,{key:0,flat:"",round:"",icon:"check_circle_outline",color:"positive",size:"sm",onClick:V=>$(t,f.APPROVED)},{default:a(()=>[s(G,null,{default:a(()=>e[18]||(e[18]=[u("Approuver")])),_:1})]),_:2},1032,["onClick"])):P("",!0),t.status===f.PENDING?(r(),_(D,{key:1,flat:"",round:"",icon:"highlight_off",color:"negative",size:"sm",onClick:V=>$(t,f.REJECTED)},{default:a(()=>[s(G,null,{default:a(()=>e[19]||(e[19]=[u("Rejeter")])),_:1})]),_:2},1032,["onClick"])):P("",!0)]),t.fichiers&&t.fichiers.length>0?(r(),p("div",We,[s(Q,{name:"attach_file",color:"grey-7",size:"xs",class:"q-mr-xs"}),l("span",Xe,n(t.fichiers.length)+" PJ"+n(t.fichiers.length>1?"s":""),1)])):(r(),p("div",Ze))])]),_:2},1024)]),_:2},1024),h<b.value.length-1?(r(),_(De,{key:0,spaced:"none",inset:"item-thumbnail"})):P("",!0)],64))),128))]),_:1}),B.value>1||v.value?(r(),p("div",et,[s(R,{modelValue:i.value.rowsPerPage,"onUpdate:modelValue":[e[6]||(e[6]=t=>i.value.rowsPerPage=t),me],options:oe.value,label:"Par page",dense:"",borderless:"","emit-value":"","map-options":"","options-dense":"",style:{"min-width":"100px"},class:"q-mr-md",disable:v.value},null,8,["modelValue","options","disable"]),B.value>1?(r(),_(Ye,{key:0,modelValue:i.value.page,"onUpdate:modelValue":[e[7]||(e[7]=t=>i.value.page=t),ce],max:B.value,"max-pages":k(y).screen.lt.sm?3:6,"direction-links":"","boundary-links":"",color:"primary",size:k(y).screen.lt.sm?"sm":"md","active-design":"unelevated",disable:v.value},null,8,["modelValue","max","max-pages","size","disable"])):(r(),p("div",tt))])):P("",!0),s(Qe,{showing:v.value,color:"primary",label:"Chargement...","label-style":"font-size: 1.1em;"},null,8,["showing"])]))]),_:1}),s(Pe,{modelValue:T.value,"onUpdate:modelValue":e[8]||(e[8]=t=>T.value=t),position:"standard"},{default:a(()=>[d.value?(r(),_(S,{key:0,style:{width:"600px","max-width":"90vw"}},{default:a(()=>[s(A,{class:"bg-primary text-white"},{default:a(()=>[e[20]||(e[20]=l("div",{class:"text-h6"},"Détails de la Notification",-1)),ee(s(D,{icon:"close",flat:"",round:"",dense:"",class:"absolute-top-right q-ma-xs"},null,512),[[ae]])]),_:1}),s(A,{class:"q-pt-lg"},{default:a(()=>[l("div",st,[l("div",null,[e[21]||(e[21]=l("strong",null,"Élève:",-1)),u(" "+n(d.value.personne?.nom)+" "+n(d.value.personne?.prenom),1)]),l("div",null,[e[22]||(e[22]=l("strong",null,"Classe:",-1)),u(" "+n(d.value.personne?.classes&&d.value.personne?.classes[0]?d.value.personne.classes[0].classe_fr:"N/A"),1)]),l("div",null,[e[23]||(e[23]=l("strong",null,"Motif:",-1)),u(" "+n(d.value.motif),1)]),l("div",null,[e[24]||(e[24]=l("strong",null,"Du:",-1)),u(" "+n(N(d.value.du,!0)),1)]),l("div",null,[e[25]||(e[25]=l("strong",null,"Au:",-1)),u(" "+n(N(d.value.au,!0)),1)]),l("div",null,[e[26]||(e[26]=l("strong",null,"Soumis le:",-1)),u(" "+n(N(d.value.created_at,!0)),1)]),l("div",null,[e[27]||(e[27]=l("strong",null,"Statut:",-1)),s(te,{color:O(d.value.status),"text-color":"white",size:"sm",class:"q-ml-sm text-capitalize"},{default:a(()=>[u(n(d.value.status_text||C.value[d.value.status]||"Inconnu"),1)]),_:1},8,["color"])]),d.value.fichiers&&d.value.fichiers.length>0?(r(),p("div",at,[l("strong",null,"Pièces jointes ("+n(d.value.fichiers.length)+"):",1),s(se,{bordered:"",separator:"",dense:"",class:"q-mt-xs rounded-borders"},{default:a(()=>[(r(!0),p(z,null,U(d.value.fichiers,t=>(r(),_(I,{key:t.id||t.name,clickable:"",tag:"a",href:k(ke)(t),target:"_blank",rel:"noopener noreferrer"},{default:a(()=>[s(g,{avatar:""},{default:a(()=>[s(Q,{name:"attachment",color:"primary"})]),_:1}),s(g,null,{default:a(()=>[s(E,{class:"text-primary text-ellipsis"},{default:a(()=>[u(n(t.fichier||"Fichier joint"),1)]),_:2},1024),t.size?(r(),_(E,{key:0,caption:""},{default:a(()=>[u(n((t.size/1024).toFixed(1))+" KB",1)]),_:2},1024)):P("",!0)]),_:2},1024),s(g,{side:""},{default:a(()=>[s(Q,{name:"open_in_new"})]),_:1})]),_:2},1032,["href"]))),128))]),_:1})])):P("",!0)])]),_:1}),s(qe,{align:"right",class:"q-pa-md"},{default:a(()=>[ee(s(D,{flat:"",label:"Fermer",color:"primary"},null,512),[[ae]])]),_:1})]),_:1})):P("",!0)]),_:1},8,["modelValue"])]),_:1}))}},Yt=ge(lt,[["__scopeId","data-v-c7664812"]]);export{Yt as default};
