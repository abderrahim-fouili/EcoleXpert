import{Q as fe}from"./QSelect-DchnWyXK.js";import{bm as me,aP as te,aO as se,A as O,B as I,C as ae,bv as _e,da as ve,a4 as _,S as r,Q as u,R as d,a5 as s,a6 as e,a9 as g,aa as w,aF as Y,ad as n,ab as i,ax as Z,a7 as M,a8 as v,ay as b,aE as ye,av as ke,a3 as G,aD as ge,du as B,aB as be,b8 as Te,aC as Pe}from"./index-Bl2lQPd7.js";import{u as De}from"./composables-CAkrP3jA.js";import{Q as m}from"./QItemLabel-BkJiB6aE.js";import{Q as T,a as f}from"./QItem-De3v03wU.js";import{Q as C}from"./QChip-C9OfA2gn.js";import{Q as k}from"./QBadge-Bjfo5tRO.js";import{Q as U}from"./QList-CMzNTEGD.js";import{Q as ee}from"./QExpansionItem-EMhshZ_3.js";import{Q as Se}from"./QToolbarTitle-C8APieXG.js";import{Q as he}from"./QToolbar-DR-_wX4W.js";import{C as Ee}from"./ClosePopup-BY_YGFBZ.js";import"./QMenu-BNr9Tzvf.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./rtl-DFPa-2ov.js";import"./format-IcNrutKL.js";import"./QSlideTransition-CrdUnXBf.js";const xe={key:2},qe=["src"],Qe={class:"q-mb-sm"},we={class:"q-gutter-xs"},Ce={key:0},Oe=["src"],Ie=["src"],Ae={__name:"Trips",props:{park:{type:Object,required:!0,default:()=>null}},setup(K){const P=K,{registerTimeout:L,removeTimeout:h}=me(),D=te(),N=se(),c=O(null),y=O(!1),x=O(!1),A=O(["","Aller","Retour","Aller-Retour"]),S=I(()=>D.state.transport.data),p=I(()=>D.state.transport.lastTrip),F=I(()=>p.value?.events.find(a=>a.event_type==="TRIP_START")?.event_time),V=I(()=>p.value?.events.find(a=>a.event_type==="TRIP_END")?.event_time),q=a=>D.getters["transport/getStudentLastTripStatus"](a),re=()=>D.dispatch("transport/getLastTrip",P.park.idauto),W=async()=>{await D.dispatch("transport/getData",P.park.idauto),re()},j=(a,t)=>{c.value=a,y.value=!0},$=a=>be(a),le=a=>a.trip&&a.trip>0&&a.trip<A.value.length?A.value[a.trip]:"",ne=(a,t)=>S.value?.data?.[a.idauto]?.sorties?S.value.data[a.idauto].sorties.includes(t.idpers):!1,ue=(a,t)=>S.value?.data?.[a.idauto]?.absences?S.value.data[a.idauto].absences.some(l=>l.idpers===t.idpers):!1,oe=a=>p&&p.value?.events?.length?p.value.events.find(t=>t.student_idpers===a.idpers):!1,Q=(a,t)=>p&&p.value?.events?.length?p.value.events.find(l=>l.student_idpers===a.idpers&&l.event_type===t):!1,z=a=>p&&p.value?.events?.length?p.value.events.filter(t=>t.student_idpers===a.idpers):[],ie=a=>{switch(a){case"PICKUP":return"Ramassé";case"STUDENT_ABSENT":return"Absent";case"BUS_STOP":return"Bus en arrêt";case"DROPPED_OFF":return"Déposé"}},de=a=>{let t=Q(a,"BUS_STOP"),l=Q(a,"DROPPED_OFF"),E=Q(a,"PICKUP"),o=Q(a,"STUDENT_ABSENT");if(t){if(l)return B(new Date(t.event_time),new Date(l.event_time));if(E)return B(new Date(t.event_time),new Date(E.event_time));if(o)return B(new Date(t.event_time),new Date(o.event_time))}return null},H=()=>{if(p.value)return B(new Date(F.value),new Date(V.value))},pe=a=>{if(a){const l=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(a)}`;Te(l)}else N.notify({type:"info",message:"Adresse non disponible."})},J=a=>{if(a&&a.length>=9){const t=(""+a).replace(/\s+/g,"");return t.startsWith("212")?"0"+t.substring(3):t.startsWith("+212")?"0"+t.substring(4):t.length===9&&!t.startsWith("0")?"0"+t:t}return a},ce=a=>{const t=J(a);return t?`tel:${t}`:null},X=()=>{L(()=>{P.park&&W(),X()},1e3*60*2)};return ae(()=>{X()}),_e(()=>{h()}),ve(()=>{P.park&&W()}),(a,t)=>(r(),_(g,null,[S.value&&S.value.autos?(r(),u(U,{key:0,style:{margin:"0"},flat:""},{default:e(()=>[(r(!0),_(g,null,w(S.value.autos,l=>(r(),u(ee,{key:l.idauto,"expand-icon-class":"text-white",class:"shadow-1 overflow-hidden q-mb-md",icon:"icon_bus","header-class":"bg-secondary text-white","expand-separator":"","default-opened":"",label:l.marque+" | "+l.matricule+" | "+l.chaufeur?.nom+" "+l.chaufeur?.prenom},{default:e(()=>[s(Y,{class:"q-pa-none"},{default:e(()=>[s(U,null,{default:e(()=>[p.value.trip_type==="DROPOFF"?(r(),u(T,{key:0},{default:e(()=>[s(f,null,{default:e(()=>[s(m,{style:{"font-weight":"600","text-transform":"uppercase"}},{default:e(()=>t[2]||(t[2]=[n(" dépose ")])),_:1})]),_:1}),s(f,{side:""},{default:e(()=>[p.value.status==="IN_PROGRESS"?(r(),u(C,{key:0,outline:"",square:"",size:"sm",color:"orange","text-color":"white",icon:"schedule"},{default:e(()=>[n(i(F.value)+" - En cours .. ",1)]),_:1})):p.value.status==="COMPLETED"?(r(),u(C,{key:1,color:"positive",outline:"",square:"",size:"sm"},{default:e(()=>[n(i(V.value)+" - Terminée ",1)]),_:1})):d("",!0),p.value.status==="COMPLETED"?(r(),_("div",xe,i(H()),1)):d("",!0)]),_:1})]),_:1})):p.value.trip_type==="PICKUP"?(r(),u(T,{key:1},{default:e(()=>[s(f,null,{default:e(()=>[s(m,{style:{"font-weight":"600","text-transform":"uppercase"}},{default:e(()=>t[3]||(t[3]=[n(" ramassage ")])),_:1})]),_:1}),s(f,{side:""},{default:e(()=>[p.value.status==="IN_PROGRESS"?(r(),u(C,{key:0,outline:"",square:"",size:"sm",color:"orange",icon:"schedule"},{default:e(()=>[n(i(F.value)+" - En cours .. ",1)]),_:1})):p.value.status==="COMPLETED"?(r(),u(C,{key:1,color:"positive",icon:"check_circle",outline:"",square:"",size:"sm"},{default:e(()=>[n(i(V.value)+" - Terminée ",1)]),_:1})):d("",!0),p.value.status==="COMPLETED"?(r(),u(k,{key:2,class:"q-mr-xs"},{default:e(()=>[n(i(H()),1)]),_:1})):d("",!0)]),_:1})]),_:1})):d("",!0)]),_:1})]),_:1}),s(Z),(r(!0),_(g,null,w(l.secteur,E=>(r(),_(g,{key:"s"+E.idsecteur},[s(m,{header:""},{default:e(()=>[n(i(E.description),1)]),_:2},1024),(r(!0),_(g,null,w(E.eleve,o=>(r(),_(g,{key:"e"+o.idpers},[s(T,null,{default:e(()=>[s(f,{avatar:"",onClick:R=>j(o,l)},{default:e(()=>[s(M,{square:"",size:"xl"},{default:e(()=>[v("img",{src:$(o)},null,8,qe)]),_:2},1024)]),_:2},1032,["onClick"]),s(f,{onClick:R=>j(o,l)},{default:e(()=>[s(m,{lines:"1",style:{"font-weight":"600"}},{default:e(()=>[n(i(o.nom)+" "+i(o.prenom),1)]),_:2},1024),s(m,{lines:"2"},{default:e(()=>[o.trip>0?(r(),u(k,{key:0,color:"grey"},{default:e(()=>[n(i(le(o)),1)]),_:2},1024)):d("",!0),t[4]||(t[4]=n()),t[5]||(t[5]=v("br",null,null,-1)),o.classes&&o.classes.length?(r(),u(k,{key:1,color:"secondary"},{default:e(()=>[n(i(o.classes[0].bref),1)]),_:2},1024)):d("",!0)]),_:2},1024)]),_:2},1032,["onClick"]),s(f,{side:""},{default:e(()=>[v("div",Qe,[q(o.idpers)==="PICKED_UP"?(r(),u(k,{key:0,color:"positive",class:"q-mr-xs"},{default:e(()=>[s(b,{name:"check_circle",class:"q-mr-xs"}),t[6]||(t[6]=n(" Ramassé "))]),_:1})):d("",!0),q(o.idpers)==="BUS_STOPPED"?(r(),u(k,{key:1,color:"secondary",class:"q-mr-xs"},{default:e(()=>[s(b,{name:"directions_bus",class:"q-mr-xs"}),t[7]||(t[7]=n(" Bus en arrêt "))]),_:1})):d("",!0),q(o.idpers)==="DROPPED_OFF"?(r(),u(k,{key:2,color:"info",class:"q-mr-xs"},{default:e(()=>[s(b,{name:"check_circle",class:"q-mr-xs"}),t[8]||(t[8]=n(" Déposé "))]),_:1})):d("",!0),q(o.idpers)==="ABSENT"?(r(),u(k,{key:3,color:"negative",class:"q-mr-xs"},{default:e(()=>[s(b,{name:"cancel",class:"q-mr-xs"}),t[9]||(t[9]=n(" Absent "))]),_:1})):d("",!0),!x.value&&ue(l,o)?(r(),u(k,{key:4,color:"negative"},{default:e(()=>[s(b,{name:"icon_absences",class:"q-mr-xs"}),t[10]||(t[10]=n(" Absent (École)"))]),_:1})):d("",!0),!x.value&&ne(l,o)?(r(),u(k,{key:5,color:"info"},{default:e(()=>[s(b,{name:"icon_voiture",class:"q-mr-xs"}),t[11]||(t[11]=n(" Sortie (École)"))]),_:1})):d("",!0)]),v("div",we,[p.value.trip_type==="DROPOFF"&&q(o.idpers)==="PENDING"?(r(),u(C,{key:0,outline:"",square:"",size:"sm",color:"orange","text-color":"white",icon:"schedule"},{default:e(()=>t[12]||(t[12]=[n(" En attente ")])),_:1})):d("",!0)]),Q(o,"BUS_STOP")?(r(),u(m,{key:0,lines:"2"},{default:e(()=>[t[13]||(t[13]=n(" Bus en arrêt: ")),t[14]||(t[14]=v("br",null,null,-1)),n(" "+i(de(o)),1)]),_:2},1024)):d("",!0)]),_:2},1024)]),_:2},1024),oe(o)?(r(),_("div",Ce,[s(ee,{label:z(o).length+" événement"+(z(o).length>1?"s":"")},{default:e(()=>[s(U,{dense:"",bordered:""},{default:e(()=>[(r(!0),_(g,null,w(z(o),(R,Ue)=>(r(),u(T,null,{default:e(()=>[s(f,null,{default:e(()=>[s(m,null,{default:e(()=>[n(i(ie(R.event_type)),1)]),_:2},1024)]),_:2},1024),s(f,{side:""},{default:e(()=>[s(m,null,{default:e(()=>[n(i(R.event_time),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),256))]),_:2},1024)]),_:2},1032,["label"])])):d("",!0),s(Z)],64))),128))],64))),128))]),_:2},1032,["label"]))),128))]),_:1})):d("",!0),s(ge,{modelValue:y.value,"onUpdate:modelValue":t[1]||(t[1]=l=>y.value=l),position:"bottom",maximized:""},{default:e(()=>[c.value?(r(),u(ye,{key:0},{default:e(()=>[s(he,{class:"bg-primary text-white"},{default:e(()=>[s(M,{square:"",size:"lg"},{default:e(()=>[v("img",{src:$(c.value)},null,8,Oe)]),_:1}),s(Se,null,{default:e(()=>[n(i(c.value.nom)+" "+i(c.value.prenom),1)]),_:1}),ke(s(G,{flat:"",round:"",dense:"",icon:"close"},null,512),[[Ee]])]),_:1}),s(Y,null,{default:e(()=>[s(U,{dense:""},{default:e(()=>[c.value.classes&&c.value.classes.length?(r(),u(T,{key:0},{default:e(()=>[s(f,{avatar:""},{default:e(()=>[s(b,{name:"school"})]),_:1}),s(f,null,{default:e(()=>[n(i(c.value.classes[0].description)+" ("+i(c.value.classes[0].bref)+")",1)]),_:1})]),_:1})):d("",!0),c.value.adresse?(r(),u(T,{key:1},{default:e(()=>[s(f,{avatar:""},{default:e(()=>[s(b,{name:"home"})]),_:1}),s(f,null,{default:e(()=>[v("div",null,i(c.value.adresse),1),c.value.secteur&&c.value.secteur.length?(r(),u(m,{key:0,caption:""},{default:e(()=>[n(" Secteur: "+i(c.value.secteur[0].description),1)]),_:1})):d("",!0)]),_:1}),s(f,{side:""},{default:e(()=>[s(G,{flat:"",round:"",color:"info",icon:"map",onClick:t[0]||(t[0]=l=>pe(c.value.adresse)),title:"Ouvrir dans Maps"})]),_:1})]),_:1})):d("",!0),s(m,{header:""},{default:e(()=>t[15]||(t[15]=[n("Contacts Parents")])),_:1}),c.value.parents&&c.value.parents.length?(r(!0),_(g,{key:2},w(c.value.parents,l=>(r(),u(T,{key:l.idpers},{default:e(()=>[s(f,{avatar:""},{default:e(()=>[s(M,null,{default:e(()=>[v("img",{src:$(l)},null,8,Ie)]),_:2},1024)]),_:2},1024),s(f,null,{default:e(()=>[s(m,null,{default:e(()=>[n(i(l.nom)+" "+i(l.prenom)+" ("+i(l?.pivot?.presentation)+")",1)]),_:2},1024),l.gsm?(r(),u(m,{key:0,caption:""},{default:e(()=>[n(i(J(l.gsm)),1)]),_:2},1024)):d("",!0),l.email?(r(),u(m,{key:1,caption:""},{default:e(()=>[n(i(l.email),1)]),_:2},1024)):d("",!0)]),_:2},1024),l.gsm?(r(),u(f,{key:0,side:""},{default:e(()=>[s(G,{flat:"",round:"",color:"positive",icon:"phone",href:ce(l.gsm),title:"Appeler"},null,8,["href"])]),_:2},1024)):d("",!0)]),_:2},1024))),128)):(r(),u(T,{key:3},{default:e(()=>[s(f,{class:"text-grey"},{default:e(()=>t[16]||(t[16]=[n("Aucun contact parent trouvé.")])),_:1})]),_:1}))]),_:1})]),_:1})]),_:1})):d("",!0)]),_:1},8,["modelValue"])],64))}},Re={style:{padding:"0"}},Be={class:"q-pa-md"},st={__name:"Index",setup(K){const P=te();se();const{setTitle:L}=De(),h=O(null),D=I(()=>P.state.transport.parks),N=y=>y.marque+" | "+y.matricule+" | "+y.chaufeur?.nom+" "+y.chaufeur?.prenom,c=()=>P.dispatch("transport/getParcks");return ae(()=>{L("Transport"),c()}),(y,x)=>(r(),u(Pe,{class:"page-content"},{default:e(()=>[v("div",Re,[v("div",Be,[s(fe,{filled:"",modelValue:h.value,"onUpdate:modelValue":x[0]||(x[0]=A=>h.value=A),label:"Park auto","option-label":N,options:D.value},null,8,["modelValue","options"])])]),h.value?(r(),u(Ae,{key:0,park:h.value},null,8,["park"])):d("",!0)]),_:1}))}};export{st as default};
