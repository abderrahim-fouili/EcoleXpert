const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./SchoolBadge-CGiyD4S7.js","./index-Bl2lQPd7.js","./index-B-uS9A6y.css","./SchoolBadge-C0II5LEc.css"])))=>i.map(i=>d[i]);
import{_ as K,aP as X,B as Q,aM as ee,A as i,Y as R,N as d,C as ae,Q as S,S as r,a6 as t,a5 as l,aE as se,aF as L,a4 as _,ad as v,ay as $,a8 as y,ab as x,aZ as te,a_ as le,a3 as U,R as M,b7 as oe,aS as re,a$ as ne,aC as ie,a as V,aR as ue,b0 as de}from"./index-Bl2lQPd7.js";import{Q as Y}from"./QItemLabel-BkJiB6aE.js";import{Q as P,a as z}from"./QItem-De3v03wU.js";import{Q as G}from"./QSelect-DchnWyXK.js";import{Q as ce}from"./QChip-C9OfA2gn.js";import{Q as E}from"./QTooltip-r7WoEuzy.js";import{Q as ve}from"./QTable-D-OlObRI.js";import{Q as pe}from"./QSpinnerGears-DmolwAR1.js";import{Q as me}from"./QInnerLoading-WxvcYHvS.js";import{E as ge}from"./ExportControls-UOL0zNKZ.js";import"./QMenu-BNr9Tzvf.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./rtl-DFPa-2ov.js";import"./format-IcNrutKL.js";import"./QVirtualScroll-CENgsPEr.js";import"./QList-CMzNTEGD.js";import"./QLinearProgress-DW1NPbfx.js";import"./date-C1Mon-Jj.js";import"./_commonjsHelpers-D6-XlEtG.js";const fe={key:0,class:"q-mb-md bg-red-1 q-pa-md rounded-borders text-negative"},_e={key:1,class:"pl-md q-gutter-md"},ye={class:"grid grid-cols-1 lg:grid-cols-2 gap-4"},be={class:""},he={class:""},Se={key:0},xe={key:1},Ce={key:0},Qe={key:0,class:"text-center text-grey-6 q-pa-md"},we={class:"text-subtitle1"},ke={class:"flex gap-2"},Ae={key:1,class:"text-center q-pa-md"},Fe={__name:"BadgeList",setup(Be){const O=ne(()=>de(()=>import("./SchoolBadge-CGiyD4S7.js"),__vite__mapDeps([0,1,2,3]),import.meta.url)),w=X(),m=Q(()=>w.getters["user/current"]?.annee),n=Q(()=>w.getters["ecole/badgeSettings"]),q=Q(()=>w.getters["ecole/info"]),W=Q(()=>n.value.logo_url??(q.value?.logo?ee(q.value.logo):"")),g=i({classes:!1,students:!1}),C=i(!1),b=i(!1),k=i([]),u=i([]),h=i([]),c=i([]),A=Q(()=>{if(c.value&&c.value.length>0){const s=new Set(c.value);return u.value.filter(e=>s.has(e.idpers))}return u.value}),o=i([]),j=[{name:"nom_complet",label:"Nom Complet",field:"nom_complet",align:"left",sortable:!0}],I=i({badgeData:[],logoUrl:null,disclaimer:null,svgPrimary:null,svgSecondary:null,svgAccent:null,svgWhite:null}),F=i(null),p=i([]),B=i(""),Z=(s,e)=>{if(B.value=s,s===null||s===""){e(()=>{p.value=u.value.slice(0,100)});return}e(()=>{const a=s.toLowerCase();p.value=u.value.filter(f=>f.nom_complet.toLowerCase().includes(a))})},H=s=>{console.log("Student filter selection changed:",s)},J=async s=>{if(s){g.value.classes=!0;try{const{data:e}=await V("get",`/filters/classes/${s}`);e?.status==="success"&&Array.isArray(e.data)?k.value=e.data.map(a=>({idclasse:a.idclasse,classe_fr:a.classe_fr||a.name,bref:a.bref})):(k.value=[],d.create({type:"warning",message:e?.message||"Impossible de charger la liste des classes."}))}catch(e){console.error("Error fetching available classes:",e),k.value=[],d.create({type:"negative",message:"Erreur lors du chargement des classes."})}finally{g.value.classes=!1}}},T=async()=>{const s=m.value?.idannee;if(!s){u.value=[],o.value=[],c.value=[],p.value=[];return}g.value.students=!0,C.value=!0;try{const e=h.value.length>0?{class_ids:h.value}:{},{data:a}=await V("get",`/filters/students/${s}`,{params:e});a?.status==="success"&&Array.isArray(a.data)?(u.value=a.data.map(f=>({idpers:f.idpers,nom_complet:f.nom_complet,classe:f.classe_bref||"N/A",regime:f.regime_code||"N/A"})),B.value="",p.value=u.value):(u.value=[],d.create({type:"warning",message:a?.message||"Impossible de charger la liste des élèves."})),o.value=[],c.value=[]}catch(e){console.error("Error fetching available students for filters:",e),u.value=[],d.create({type:"negative",message:"Erreur lors du chargement des élèves."}),o.value=[],c.value=[],p.value=[]}finally{g.value.students=!1,C.value=!1}},D=async()=>{if(!n.value)try{await w.dispatch("ecole/fetchBadgeSettings")}catch(s){s.response&&s.response.status===404||(console.error("Failed to fetch badge settings:",s),d.create({type:"warning",message:"Impossible de charger les paramètres des badges. La génération PDF pourrait être limitée."}))}},N=async(s=!1)=>{if(o.value.length===0||!m.value?.idannee||!n.value){d.create({type:"warning",message:"Veuillez sélectionner au moins un élève et assurez-vous que l'année scolaire et les paramètres des badges sont chargés."});return}b.value=!0,C.value=!0;const e=o.value.map(a=>a.idpers);try{const{data:a}=await V("post","/admin/badges/data",{annee_id:m.value.idannee,student_ids:e});if(a?.status==="success"&&Array.isArray(a.data)){if(a.data.length===0){d.create({type:"info",message:"Aucune donnée de badge trouvée pour les élèves sélectionnés."});return}I.value={badgeData:a.data,logoUrl:W.value,disclaimer:n.value.disclaimer_text,svgPrimary:n.value.primary_color,svgSecondary:n.value.secondary_color,svgAccent:n.value.accent_color,svgWhite:n.value.white_color},await ue(),F.value?s?await F.value.printReport():await F.value.exportToPDF():d.create({type:"negative",message:"Composant ExportControls non trouvé."})}else d.create({type:"negative",message:a?.message||"Erreur lors de la récupération des données des badges."})}catch(a){console.error("Error generating badges:",a),d.create({type:"negative",message:`Échec de la génération des badges : ${a.message||"Erreur inconnue"}`})}finally{b.value=!1,C.value=!1}};return R(()=>m.value?.idannee,(s,e)=>{s&&s>0?(console.log(`Year changed to ${s}. Fetching classes and students.`),h.value=[],o.value=[],c.value=[],u.value=[],p.value=[],J(s),T(),D()):s||(h.value=[],o.value=[],c.value=[],u.value=[],p.value=[],d.create({type:"warning",message:"Aucune année scolaire sélectionnée."}))},{immediate:!0}),R(A,()=>{o.value=[]}),ae(()=>{D()}),(s,e)=>(r(),S(ie,{class:"page-content"},{default:t(()=>[l(se,{flat:"",bordered:""},{default:t(()=>[l(L),l(L,null,{default:t(()=>[m.value?.idannee?(r(),_("div",_e,[y("div",ye,[y("div",be,[l(G,{dense:"",filled:"",modelValue:h.value,"onUpdate:modelValue":[e[0]||(e[0]=a=>h.value=a),T],options:k.value,label:"Filtrer par Classe(s)","option-label":"classe_fr","option-value":"idclasse",multiple:"","use-chips":"","emit-value":"","map-options":"",clearable:"",loading:g.value.classes},{option:t(a=>[l(P,te(le(a.itemProps)),{default:t(()=>[l(z,null,{default:t(()=>[l(Y,null,{default:t(()=>[v(x(a.opt.classe_fr),1)]),_:2},1024),l(Y,{caption:""},{default:t(()=>[v(x(a.opt.bref),1)]),_:2},1024)]),_:2},1024)]),_:2},1040)]),"no-option":t(()=>[l(P,null,{default:t(()=>[l(z,{class:"text-grey"},{default:t(()=>[v(" Aucune classe trouvée"+x(m.value?.idannee?" pour l'année "+m.value.description:"")+". ",1)]),_:1})]),_:1})]),_:1},8,["modelValue","options","loading"])]),y("div",he,[l(G,{dense:"",filled:"",modelValue:c.value,"onUpdate:modelValue":[e[1]||(e[1]=a=>c.value=a),H],options:p.value,label:"Rechercher un élève","option-label":"nom_complet","option-value":"idpers",multiple:"","use-chips":"","emit-value":"","map-options":"",clearable:"",loading:g.value.students,"use-input":"","hide-selected":"","input-debounce":"300",onFilter:Z},{"no-option":t(()=>[l(P,null,{default:t(()=>[l(z,{class:"text-grey"},{default:t(()=>[B.value?(r(),_("span",Se,'Aucun élève correspondant à "'+x(B.value)+'"',1)):(r(),_("span",xe,"Aucun élève trouvé pour les filtres sélectionnés."))]),_:1})]),_:1})]),"selected-item":t(a=>[l(ce,{removable:"",dense:"",onRemove:f=>a.toggleOption(a.index),tabindex:a.tabindex,color:"primary","text-color":"white",class:"q-ma-none"},{default:t(()=>[v(x(a.opt.nom_complet),1)]),_:2},1032,["onRemove","tabindex"])]),_:1},8,["modelValue","options","loading"])])]),g.value.students?(r(),_("div",Ae,[l(oe,{color:"primary",size:"2em"}),e[11]||(e[11]=y("div",null,"Chargement des élèves...",-1))])):(r(),_("div",Ce,[A.value.length===0?(r(),_("div",Qe,[l($,{name:"person_search",size:"2em"}),e[6]||(e[6]=y("div",{class:"q-mt-sm"},"Aucun élève trouvé pour les filtres appliqués.",-1))])):(r(),S(ve,{key:1,rows:A.value,columns:j,"row-key":"idpers",selection:"multiple",selected:o.value,"onUpdate:selected":e[4]||(e[4]=a=>o.value=a),dense:"",pagination:{rowsPerPage:15},"rows-per-page-options":[15,30,50,0]},{"top-left":t(()=>[y("div",we,"Élèves Trouvés ("+x(A.value.length)+")",1)]),"top-right":t(()=>[y("div",ke,[l(U,{color:"primary",onClick:e[2]||(e[2]=a=>N(!1)),disable:o.value.length===0||b.value||!n.value,loading:b.value,icon:"picture_as_pdf"},{default:t(()=>[n.value?o.value.length===0?(r(),S(E,{key:1},{default:t(()=>e[8]||(e[8]=[v("Sélectionnez au moins un élève.")])),_:1})):M("",!0):(r(),S(E,{key:0},{default:t(()=>e[7]||(e[7]=[v("Veuillez configurer les paramètres des badges d'abord.")])),_:1}))]),_:1},8,["disable","loading"]),l(U,{color:"primary",onClick:e[3]||(e[3]=a=>N(!0)),disable:o.value.length===0||b.value||!n.value,loading:b.value,icon:"print"},{default:t(()=>[n.value?o.value.length===0?(r(),S(E,{key:1},{default:t(()=>e[10]||(e[10]=[v("Sélectionnez au moins un élève.")])),_:1})):M("",!0):(r(),S(E,{key:0},{default:t(()=>e[9]||(e[9]=[v("Veuillez configurer les paramètres des badges d'abord.")])),_:1}))]),_:1},8,["disable","loading"])])]),_:1},8,["rows","selected"]))])),l(ge,{ref_key:"exportControls",ref:F,"report-component":re(O),"report-data":I.value,pdfFilenamePrefix:"Badges_Eleves",pdfFormat:[54,85.6],pdfUnit:"mm",pdfMargin:[0,0,0,0],reportComponentStyles:[{url:"/reports/badge.css?v=1.0.5"}],style:{opacity:"0"}},null,8,["report-component","report-data"])])):(r(),_("div",fe,[l($,{name:"warning",color:"negative",class:"q-mr-sm"}),e[5]||(e[5]=v(" Veuillez sélectionner une année scolaire dans le menu de navigation pour charger les données des élèves. "))]))]),_:1}),l(me,{showing:C.value},{default:t(()=>[l(pe,{size:"50px",color:"primary"})]),_:1},8,["showing"])]),_:1})]),_:1}))}},He=K(Fe,[["__scopeId","data-v-19c3bb74"]]);export{He as default};
