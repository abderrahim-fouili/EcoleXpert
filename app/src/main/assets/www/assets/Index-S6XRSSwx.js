import{Q as x}from"./QBadge-Bjfo5tRO.js";import{_ as T,dw as V,at as U,aY as S,J as j,a4 as m,S as n,R as c,a8 as d,ad as f,a5 as s,a6 as r,a3 as u,ac as J,a9 as b,b8 as q,cR as W,cS as Y,b4 as H,as as N,aB as z,b5 as L,aW as P,ag as C,af as A,av as k,Q as w,ab as v,b6 as K,aF as y,a2 as _,aa as O,ah as R,aG as X,aE as I,aD as $,b9 as Z,b2 as ee,ay as te,aC as se,c$ as ie,cT as ae}from"./index-Bl2lQPd7.js";import{Q as B}from"./QImg-BMvxJu3S.js";import{Q as F}from"./QToolbarTitle-C8APieXG.js";import{Q as M}from"./QToolbar-DR-_wX4W.js";import{Q as re}from"./QSelect-DchnWyXK.js";import{Q}from"./QForm-Dk45GsL9.js";import{C as E}from"./ClosePopup-BY_YGFBZ.js";import{Q as le}from"./QSpinnerDots-BW9ZsFNG.js";import{f as oe}from"./index-C9ZTL5MN.js";import"./QChip-C9OfA2gn.js";import"./QItem-De3v03wU.js";import"./QItemLabel-BkJiB6aE.js";import"./QMenu-BNr9Tzvf.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./rtl-DFPa-2ov.js";import"./format-IcNrutKL.js";import"./index-BXMW6yyY.js";import"./index-CbPSoDvq.js";const ne={props:["process","media"],data(){return{statues:{STATUS_INITIAL:0,STATUS_SAVING:1,STATUS_SUCCESS:2,STATUS_FAILED:3},rotate:{transform:"","max-height":"200px","min-height":"100px"},deg:0,fileCount:0,uploadedFiles:[],uploadError:null,currentStatus:null,uploadFieldName:"image"}},computed:{...U({user:"user/user",config:"user/config",current:"user/current",form:"media/form",settings:"media/settings"}),host(){return this.settings.imgbb?this.settings.imgbb:this.settings.imgcdndev},isInitial(){return this.currentStatus===this.statues.STATUS_INITIAL},isSaving(){return this.currentStatus===this.statues.STATUS_SAVING},isSuccess(){return this.currentStatus===this.statues.STATUS_SUCCESS},isFailed(){return this.currentStatus===this.statues.STATUS_FAILED}},methods:{drawRotated:V,rotateSave(){var e=V(this.deg,this.$refs.img),t=new FormData;t.append("image",e.replace("data:image/png;base64,","")),this.currentStatus=this.statues.STATUS_SAVING,this.upload(t).then(a=>{a&&a.success&&(this.media.lien=a.data.image.url),this.currentStatus=this.statues.STATUS_SUCCESS}).catch(a=>{this.uploadError=a.response,this.currentStatus=this.statues.STATUS_FAILED})},left(){this.deg-=90,this.rotate.transform="rotate("+this.deg+"deg)"},right(){this.deg+=90,this.rotate.transform="rotate("+this.deg+"deg)"},reset(){this.currentStatus=this.statues.STATUS_INITIAL,this.uploadedFiles=[],this.uploadError=null},save(e){return this.currentStatus=this.statues.STATUS_SAVING,this.upload(e).then(t=>{console.log(t),t.success?(this.uploadedFiles=this.uploadedFiles.concat({lien:t.data.image.url}),this.currentStatus=this.statues.STATUS_SUCCESS):(this.uploadError=t.data.imageFile[0],this.currentStatus=this.statues.STATUS_FAILED)}).catch(t=>{this.uploadError=t.response,this.currentStatus=this.statues.STATUS_FAILED,console.log(t)})},async filesChange(e){let t=e.target.name,a=e.target.files;if(this.fileCount=e.target.files.length,!!a.length){for(const p of a){const l=new FormData;l.append(t,p,p.name),console.log(p,t),await this.save(l)}this.process(this.uploadedFiles)}},upload(e){return j.create().post(this.host.url+"?key="+this.host.key,e,{headers:{"Content-Type":"multipart/form-data"},transformRequest:(t,a)=>(delete a.Authorization,delete a["x-user-as"],t)}).then(function(t){return console.log(t.data),t.data})},image(e){return e.hasOwnProperty("lien")?e.lien:S({type:"media",fichier:e.fichier})}},mounted(){this.media&&this.media.lien?(this.uploadedFiles.push(this.media),this.currentStatus=this.statues.STATUS_SUCCESS):this.reset()}},de={key:0,class:"dropbox"},ue=["name","disabled"],me={key:0},he={key:1},ce={style:{background:"#fff",bottom:"0",left:"0",overflow:"hidden",position:"absolute",right:"0",top:"0"}},fe={key:1,style:{"text-align":"center","max-height":"250px",overflow:"hidden",position:"relative"}},pe=["src"],ge={style:{position:"absolute",bottom:"0",right:"0"}},ve={key:2},ye={class:""};function Se(e,t,a,p,l,i){return n(),m(b,null,[i.isInitial||i.isSaving?(n(),m("div",de,[d("input",{type:"file",multiple:"",name:l.uploadFieldName,disabled:i.isSaving,onChange:t[0]||(t[0]=(...g)=>i.filesChange&&i.filesChange(...g)),accept:"image/*",class:"input-file"},null,40,ue),i.isInitial?(n(),m("p",me,t[3]||(t[3]=[f(" Déposez vos fichiers pour les téléverser"),d("br",null,null,-1),f(" ou sélectionnez une image ")]))):c("",!0),i.isSaving?(n(),m("div",he,[d("div",ce,[s(le,{color:"primary",class:"absolute-center",size:"3em"})])])):c("",!0)])):c("",!0),i.isSuccess?(n(),m("div",fe,[d("p",null,[s(u,{color:"primary",onClick:t[1]||(t[1]=g=>i.reset()),outline:""},{default:r(()=>t[4]||(t[4]=[f("Modifier")])),_:1})]),d("img",{src:this.image(l.uploadedFiles[0]),style:J(l.rotate),ref:"img",crossorigin:"",fit:"contain"},null,12,pe),d("div",ge,[s(u,{color:"deep-purple-2",onClick:i.left,dense:"",flat:"",icon:"rotate_left"},null,8,["onClick"]),s(u,{color:"deep-purple-2",onClick:i.right,dense:"",flat:"",icon:"rotate_right"},null,8,["onClick"]),s(u,{color:"deep-purple-2",onClick:i.rotateSave,ouline:"",flat:"",icon:"save"},null,8,["onClick"])])])):c("",!0),i.isFailed?(n(),m("div",ve,[d("div",ye,[d("p",null,[t[6]||(t[6]=f(" Une erreur est survenu ")),t[7]||(t[7]=d("br",null,null,-1)),s(u,{color:"negative",onClick:t[2]||(t[2]=g=>i.reset()),outline:""},{default:r(()=>t[5]||(t[5]=[f("Réessayer")])),_:1})])])])):c("",!0)],64)}const be=T(ne,[["render",Se],["__scopeId","data-v-673b6dd4"]]),_e={emits:["media:edit","media:remove","media:hold","media:sent","media:error"],data(){return{videoDialog:!1,video:{titre:null,description:null}}},components:{UploadInput:be},props:{title:{default:()=>"Nouvelle ressource"}},computed:{...U({user:"user/user",config:"user/config",current:"user/current",form:"media/form",settings:"media/settings"}),uploadFields(){return[{name:"notReponse",value:!0}]},classe(){if(this.current&&this.current.hasOwnProperty("classe"))return this.current.classe},options(){return this.classes},classes(){return this.current&&this.current.hasOwnProperty("classes")?this.current.classes:[]},annee(){if(this.current&&this.current.hasOwnProperty("annee"))return this.current.annee},url(){return P("api")+"/medias/pj"}},methods:{...N({create:"media/create",update:"media/update"}),isDate:H,ytbUrls:Y,imgFormVid:W,openURL:q,pjUrl:S,addMedia(){this.video=this.initMedia(),this.form.meta.media.push(this.video)},removeMedia(e){var t=this.form.meta.media.indexOf(e);t>-1&&this.form.meta.media.splice(t,1)},attach(){this.addMedia(),this.videoDialog=!0},process(e){for(var t=0;t<e.length;t++)t===0?this.video.lien=this.image(e[t]):this.addMediaFromLien(this.image(e[t]))},addMediaFromLien(e){let t=this.initMedia();t.lien=e,this.hasMedia(t)||this.form.meta.media.push(t)},hasMedia(e){return this.form.meta.media.find(t=>t.lien===e.lien)},initMedia(){return{titre:null,description:null,type:this.form.media,lien:null,id:this.form.meta.media.length+1}},image(e){return e.hasOwnProperty("lien")?e.lien:S({type:"media",fichier:e.fichier})},edit(e){this.video=e,this.videoDialog=!0},minDate(e){return e>=oe(new Date,"yyyy/MM/dd")},isImage(e){return L(this.fileUrl(e))},fileUrl(e){return S(e)},personAvatar(e){return z(e)},send(){this.$refs.form.validate().then(e=>{if(!e)return this.$q.notify({color:"negative",message:this.$t("stats.fields"),position:"bottom",icon:"error_outline",actions:[{label:this.$q.lang.label.close,color:"yellow"}]}),!1;this.sendMessage()})},sendMessage(){let e=Object.assign({},this.form);e.visibility=e.classes.map(a=>{let l=this.classes.find(i=>i.idclasse==a).classe_fr;return{type:"classe",id:a.toString(),value:"classe_"+a.toString(),label:l}});let t={...e};this.form.id?this.update(t).then(a=>{this.$emit("media:sent",{d:a,isNew:!1})}).catch(a=>{this.$q.notify({color:"negative",message:this.$t("stats.fields"),position:"bottom",icon:"error_outline",actions:[{label:this.$q.lang.label.close,color:"yellow"}]}),this.$emit("media:error",a)}):this.create(t).then(a=>{this.$emit("media:sent",{d:a,isNew:!0})}).catch(a=>{this.$q.notify({color:"negative",message:this.$t("stats.fields"),position:"bottom",icon:"error_outline",actions:[{label:this.$q.lang.label.close,color:"yellow"}]}),this.$emit("media:error",a)})}}},Ce={class:"row"},we={class:"col-6 col-md-4"},ke={class:"absolute-top bg-transparent",style:{"text-align":"right",padding:"5px"}},Te={key:0,class:"absolute-bottom",style:{padding:"5px"}};function Ue(e,t,a,p,l,i){const g=C("upload-input");return n(),m(b,null,[s(I,null,{default:r(()=>[s(M,{class:A({"bg-secondary":e.form.status!==1,"bg-positive":e.form.status===1,"text-white":!0,"shadow-2":!0})},{default:r(()=>[k(s(u,{flat:"",dense:"",icon:"arrow_back"},null,512),[[E]]),s(F,null,{default:r(()=>[f(v(a.title),1)]),_:1}),s(u,{flat:"",dense:"",icon:"attach_file",onClick:i.attach,disable:e.form.status===1||!e.form.titre},{default:r(()=>[k(s(x,{floating:"",color:"yellow-9"},{default:r(()=>[f(v(e.form.meta.media.length),1)]),_:1},512),[[K,e.form.meta.media.length>0]])]),_:1},8,["onClick","disable"]),e.form.titre?(n(),w(u,{key:0,class:"q-ml-lg",flat:"",icon:"send",onClick:i.send,disable:e.form.status===1},null,8,["onClick","disable"])):c("",!0)]),_:1},8,["class"]),s(y,{style:{"overflow-y":"scroll"}},{default:r(()=>[s(Q,{class:"q-gutter-lg",ref:"form"},{default:r(()=>[s(re,{filled:"",modelValue:e.form.classes,"onUpdate:modelValue":t[0]||(t[0]=o=>e.form.classes=o),multiple:"",options:i.options,rules:[o=>o.length>0||"Champ requis"],label:"Classes","emit-value":"","option-value":"idclasse","option-label":"classe_fr","map-options":""},null,8,["modelValue","options","rules"]),s(_,{filled:"",modelValue:e.form.titre,"onUpdate:modelValue":t[1]||(t[1]=o=>e.form.titre=o),label:"Titre",rules:[o=>!!o||"Champ requis"],"lazy-rules":""},null,8,["modelValue","rules"]),s(_,{filled:"",modelValue:e.form.description,"onUpdate:modelValue":t[2]||(t[2]=o=>e.form.description=o),autogrowfor:"",type:"textarea",label:"Description","lazy-rules":"","input-style":"min-height:150px"},null,8,["modelValue"])]),_:1},512)]),_:1}),s(y,null,{default:r(()=>[s(u,{icon:"add",onClick:i.attach},null,8,["onClick"])]),_:1}),s(y,null,{default:r(()=>[d("div",Ce,[(n(!0),m(b,null,O(e.form.meta.media,(o,D)=>(n(),m("div",we,[s(B,{src:o.lien,ratio:16/9,onClick:h=>i.edit(o)},{default:r(()=>[d("div",ke,[s(u,{color:"negative",flat:"",dense:"",icon:"delete",onClick:R(h=>i.removeMedia(o),["stop"])},null,8,["onClick"])]),o.titre?(n(),m("div",Te,v(o.titre),1)):c("",!0)]),_:2},1032,["src","onClick"])]))),256))])]),_:1}),s(X,{align:"right",class:""},{default:r(()=>[s(u,{label:"Envoyer",icon:"send",onClick:i.send,disable:e.form.status===1||!e.form.titre},null,8,["onClick","disable"])]),_:1})]),_:1}),s($,{modelValue:l.videoDialog,"onUpdate:modelValue":t[5]||(t[5]=o=>l.videoDialog=o),maximized:"",position:"bottom"},{default:r(()=>[s(M,{class:A({"bg-secondary":!0,"text-white":!0,"shadow-2":!0})},{default:r(()=>[k(s(u,{flat:"",dense:"",icon:"arrow_back"},null,512),[[E]]),l.video?(n(),w(F,{key:0},{default:r(()=>[f(" #"+v(l.video.id)+" "+v(l.video.titre),1)]),_:1})):c("",!0)]),_:1}),s(I,null,{default:r(()=>[s(y,null,{default:r(()=>[s(g,{media:l.video,process:i.process},null,8,["media","process"])]),_:1}),s(y,{style:{"overflow-y":"scroll"}},{default:r(()=>[s(Q,{class:"q-gutter-lg",ref:"itemForm"},{default:r(()=>[s(_,{filled:"",modelValue:l.video.titre,"onUpdate:modelValue":t[3]||(t[3]=o=>l.video.titre=o),label:"Titre","lazy-rules":""},null,8,["modelValue"]),s(_,{filled:"",modelValue:l.video.description,"onUpdate:modelValue":t[4]||(t[4]=o=>l.video.description=o),autogrow:"",type:"textarea",label:"Description","lazy-rules":"","input-style":"min-height:150px"},null,8,["modelValue"])]),_:1},512)]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}const De=T(_e,[["render",Ue]]),Ve={data(){return{type:0,show:!1,title:null,icon:"videocam"}},components:{EditForm:De},watch:{$route(){this.type=1,this.icon=this.type===1?"image":"videocam",this.$route.params.id||this.getData()},classe(){this.getData()}},computed:{...U({user:"user/user",config:"user/config",current:"user/current",data:"media/data",form:"media/form",settings:"media/settings"}),tab:{get(){return this.type},set(e){e==1?this.go("photos"):this.go("videos")}},medias(){return this.data?this.data.data:[]},classe(){if(this.current&&this.current.hasOwnProperty("classe"))return this.current.classe},annee(){if(this.current&&this.current.hasOwnProperty("annee"))return this.current.annee}},methods:{...N({getMedia:"media/getDataProf",getSettings:"media/getSettings",remove:"media/remove",setRefresh:"setRefresh"}),openURL:q,toNow:ee,userPhotoUrl:z,fileIcon:Z,removeMedia(e){this.remove(e).then(()=>{this.getData(),this.$q.notify({color:"positive",message:this.$t("stats.success"),position:"bottom",icon:"check",actions:[{label:this.$q.lang.label.close,color:"white"}]})})},edit(e){e&&e.status===2&&(Object.assign(this.form,e),this.$emit("media:edit",{med:e,title:"Modifier"}),this.title=this.form.titre,this.form.classes=this.form.visibility.map(t=>parseInt(t.id)),this.form.media=this.type,this.show=!0)},mediaEnvoye({isNew:e}){e?this.getMedia({page:1,filter:this.filter()}):this.getData(),this.show=!1,this.$q.notify({color:"positive",message:this.$t("stats.success"),position:"bottom",icon:"check",actions:[{label:this.$q.lang.label.close,color:"white"}]})},showDialog(){this.show=!0,this.title="",this.form.reset(),this.form.media=this.type,this.form.meta.user={id:this.user.idpers,type:"PROF",name:this.user.nom+" "+this.user.prenom},this.form.classes.push(this.classe.idclasse)},view(e){e.media===1?e.status===2?this.edit(e):this.go("/prof/media/photos/"+e.id):this.go("/prof/media/videos/"+e.id)},photo:function(e){return e.meta.media&&e.meta.media.length?e.media&&e.meta.media[0].lien?e.meta.media[0].lien.includes("http")?e.meta.media[0].lien:ie(P("api")+e.meta.media[0].lien):"https://img.youtube.com/vi/"+ae(e.meta.media[0].lien)+"/hqdefault.jpg":null},isImage(e){return L(this.fileUrl(e))},filter(){let e={classe:this.annee.pivot.idclasse};return this.type!==null&&(e.type=this.type),e},getData(){this.getSettings().then(()=>{this.getMedia({page:this.data?this.data.current_page:1,filter:this.filter()})})},fileUrl(e){return S(e)}},mounted(){this.type=1,this.icon=this.type===1?"image":"videocam",this.getData(),this.setTitle("Multimedia"),this.zoom(),this.setRefresh(e=>{this.getData(),e()})}},Ae={class:"q-pa-lg flex flex-center"},Ie={class:"row"},Fe={class:"col-6 col-md-4"},Me={key:0,style:{padding:"0 5px","font-size":"2rem"},class:"absolute-top-left text-left bg-transparent"},Qe={style:{padding:"2px 5px"},class:"absolute-bottom text-center"},Ee={style:{padding:"0 5px","font-size":"2rem"},class:"absolute-top-right text-right bg-transparent"};function xe(e,t,a,p,l,i){const g=C("ep-pagination"),o=C("edit-form"),D=C("ep-footer");return n(),m(b,null,[s(se,{padding:"",class:"page-content"},{default:r(()=>[d("div",Ae,[e.data?(n(),w(g,{key:0,modelValue:e.data.current_page,"onUpdate:modelValue":[t[0]||(t[0]=h=>e.data.current_page=h),i.getData],max:e.data.last_page,"direction-links":"","boundary-links":!1,div:"",divClass:"full-width text-center text-white text-bold",dark:"",color:"white",class:"bg-primary full-width",style:{"border-radius":"10rem",height:"30px"}},{content:r(()=>[f(" Page "+v(e.data.current_page),1)]),_:1},8,["modelValue","max","onUpdate:modelValue"])):c("",!0)]),d("div",Ie,[(n(!0),m(b,null,O(i.medias,(h,qe)=>(n(),m("div",Fe,[s(B,{src:i.photo(h),fit:"cover",ratio:16/9,onClick:G=>i.view(h)},{default:r(()=>[h.status===2?(n(),m("div",Me,[s(x,{color:"warning",label:"en cours"})])):c("",!0),d("div",Qe,v(h.titre),1),d("div",Ee,[s(te,{name:l.icon},null,8,["name"]),h.status===2?(n(),w(u,{key:0,color:"negative",flat:"",dense:"",icon:"delete",onClick:R(G=>i.removeMedia(h),["stop"])},null,8,["onClick"])):c("",!0)])]),_:2},1032,["src","onClick"])]))),256))])]),_:1}),s($,{modelValue:l.show,"onUpdate:modelValue":t[1]||(t[1]=h=>l.show=h),maximized:"",position:"bottom"},{default:r(()=>[s(o,{"onMedia:sent":i.mediaEnvoye,title:l.title},null,8,["onMedia:sent","title"])]),_:1},8,["modelValue"]),s(D,{to:"#footer-portal"},{default:r(()=>[s(u,{flat:"",onClick:i.showDialog,icon:"add",label:""},null,8,["onClick"])]),_:1})],64)}const it=T(Ve,[["render",xe]]);export{it as default};
