import{aP as ze,aO as De,A as n,B as v,aB as Ae,Y as Z,C as Pe,Q as y,S as r,a6 as l,a8 as o,a5 as t,R as w,a4 as x,aE as b,aF as u,a3 as g,a7 as D,ad as m,ab as d,ay as C,af as J,aS as Ee,a9 as K,aa as W,aD as X,aZ as Ue,a_ as Ie,aG as He,av as A,aA as Re,a2 as ue,az as Te,d4 as Le,ah as L,ax as Be,b6 as Me,aw as je,aC as Fe}from"./index-Bl2lQPd7.js";import{Q as ce}from"./QTooltip-r7WoEuzy.js";import{Q as ee,a as V}from"./QItem-De3v03wU.js";import{Q as B}from"./QItemLabel-BkJiB6aE.js";import{Q as Ne}from"./QList-CMzNTEGD.js";import{Q as Oe}from"./QSelect-DchnWyXK.js";import{Q as ve}from"./QToolbarTitle-C8APieXG.js";import{Q as Ge}from"./QSpace-CKKoNTi_.js";import{Q as Ye}from"./QBadge-Bjfo5tRO.js";import{Q as te}from"./QToolbar-DR-_wX4W.js";import{Q as Ze}from"./QHeader-B4MlZ-LM.js";import{Q as Je}from"./QSkeleton-CAzJcT8b.js";import{Q as Ke}from"./QSlideTransition-CrdUnXBf.js";import{Q as We}from"./QPagination-UgiQF7o2.js";import{Q as me}from"./QFooter-BqOQs2Wv.js";import{C as le}from"./ClosePopup-BY_YGFBZ.js";import{u as Xe}from"./composables-CAkrP3jA.js";import{_ as et}from"./StudentScan-BWckmCLy.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./QChip-C9OfA2gn.js";import"./QMenu-BNr9Tzvf.js";import"./rtl-DFPa-2ov.js";import"./format-IcNrutKL.js";import"./QBanner-xBGiroIy.js";import"./QBtnGroup-CdugIB7Z.js";import"./QSpinnerDots-BW9ZsFNG.js";const tt={class:"content-container"},lt={key:0,class:"q-pa-sm q-pa-md-md"},at={class:"row items-center justify-between"},st={class:"row q-col-gutter-md items-center"},ot={class:"col-auto"},nt=["src"],rt={class:"col"},it={class:"text-h6 text-weight-bold text-primary"},dt={class:"text-subtitle1 q-mt-sm"},ut={key:1,class:"q-pa-sm q-pa-md-md"},ct={class:"row justify-center items-center q-col-gutter-lg"},vt={class:"col-12 col-sm-6"},mt={key:0,class:"col-12 col-sm-6"},pt={class:"row q-col-gutter-lg"},ft={class:"col-12 col-lg-8"},gt={class:"col-12 q-pa-sm q-pa-md-md"},xt={class:"row items-center justify-between"},_t={key:0,class:"text-center q-pa-lg text-grey"},yt={class:"text-primary"},ht={class:"text-subtitle1 text-weight-bold text-primary"},bt={class:"text-subtitle1"},kt={class:"text-weight-bold text-primary"},wt={class:"col-12 col-lg-4"},qt={class:"q-pa-sm q-pa-md-md sticky-column"},Qt={class:"text-h4 q-mt-sm"},St={class:"text-h5 text-weight-bold q-mb-lg"},Ct={key:0,class:"row q-col-gutter-md"},Vt={key:1,class:"text-center q-pa-xl"},$t={key:2,class:"menu-container"},zt={class:"row q-col-gutter-xs"},Dt={class:"row items-center no-wrap"},At={class:"col"},Pt={class:"text-subtitle1 text-weight-medium ellipsis"},Et={class:"text-h6 text-primary text-weight-bold q-mt-sm"},Ut={class:"col-auto"},It={class:"row justify-center q-py-sm"},Ht={class:"text-h6 text-primary"},vl={__name:"Ordre",setup(Rt){const S=ze(),q=De(),{setTitle:pe}=Xe(),M=n(!1),P=n(!1);n(!1),n(!1);const j=n(!1),ae=n(null),F=n(1),p=n([]),Q=n(0),h=n([]),i=n(null);n(!1),n(!1);const E=n(!1),$=n(!1),U=n(!1);n({nom:"",prenom:"",login:"",classe:null}),n({designation:"",prix:null,active:!0});const I=n(1),se=n(15),oe=n(0),fe=v(()=>Math.ceil(oe.value/se.value)),ge=v(()=>S.getters["user/user"]),xe=v(()=>S.getters["user/current"]?.annee?.idannee),_e=v(()=>{if(!i.value)return"";const s=h.value.find(e=>e.idpers===i.value);return s?`${s.nom} ${s.prenom}`:""}),ye=v(()=>{if(!i.value)return"";const s=h.value.find(e=>e.idpers===i.value);return!s||!s.eleve_classes?.length?"":s.eleve_classes[0].classe_fr}),ne=v(()=>{if(!i.value)return null;const s=h.value.find(e=>e.idpers===i.value);return s?Ae(s):null}),z=v(()=>ge.value?.type==="USER"),he=v(()=>z.value&&!i.value?0:Q.value),H=v(()=>z.value&&!i.value?0:Q.value-R.value);v(()=>ae.value&&F.value>0&&F.value<=99);const R=v(()=>p.value.reduce((s,e)=>s+e.prix*e.quantite,0)),N=v(()=>z.value&&!i.value?!1:p.value.length>0&&H.value>=0),be=v(()=>{if(!i.value)return"";const s=h.value.find(e=>e.idpers===i.value);return s?`${s.nom.charAt(0)}${s.prenom.charAt(0)}`.toUpperCase():""}),ke=s=>{p.value=p.value.filter(e=>e.idsnack!==s)},we=()=>{i.value=null,Q.value=0,p.value=[]},qe=async(s,e)=>{if(s.length<2){e(()=>{h.value=[]});return}try{j.value=!0;const a=await S.dispatch("user/getData",{page:1,filter:{search:s,with_eleve_classe:xe.value}});e(()=>{h.value=a.data?.data||[]})}catch(a){console.error("Error searching students:",a),e(()=>{h.value=[]}),q.notify({color:"negative",message:"Erreur lors de la recherche des élèves",icon:"error"})}finally{j.value=!1}},O=n([]),k=n(""),_=n([]),f=n({});n({sortBy:"designation",descending:!1,page:1,rowsPerPage:10,rowsNumber:10});const re=v(()=>{if(!k.value)return O.value;const s=k.value.toLowerCase();return O.value.filter(e=>e.designation.toLowerCase().includes(s))}),Qe=()=>{_.value.forEach(s=>{const e=f.value[s.idsnack]||1;Se({...s,quantite:e})}),_.value=[],f.value={},$.value=!1,q.notify({color:"positive",message:"Articles ajoutés au panier",icon:"shopping_cart"})},G=async(s=1)=>{M.value=!0;try{const e=await S.dispatch("snack/fetchMenus",{page:s,per_page:se.value,filters:{search:k.value}});O.value=e.data,oe.value=e.total,I.value=s}catch{q.notify({color:"negative",message:"Erreur lors du chargement des articles",icon:"error"})}finally{M.value=!1}};Z(k,()=>{I.value=1,G(1)}),Z(_,s=>{s.forEach(e=>{f.value[e.idsnack]||(f.value[e.idsnack]=1)})});const Se=s=>{const e=p.value.find(a=>a.idsnack===s.idsnack);e?e.quantite+=s.quantite:p.value.push(s)},T=async()=>{try{const s=await S.dispatch("snack/fetchSolde",i.value);Q.value=s.solde}catch(s){console.error("Error loading solde:",s),q.notify({color:"negative",message:"Erreur lors du chargement du solde",icon:"error"})}},ie=async()=>{if(N.value)try{P.value=!0,await S.dispatch("snack/placeOrder",{user_id:i.value,items:p.value.map(s=>({idsnack:s.idsnack,quantite:s.quantite}))}),q.notify({color:"positive",message:"Commande effectuée avec succès",icon:"check"}),T(),p.value=[],F.value=1,ae.value=null}catch(s){console.error("Error placing order:",s),q.notify({color:"negative",message:"Erreur lors de la commande",icon:"error"})}finally{P.value=!1}},Ce=()=>{E.value=!1,T()},Ve=s=>{i.value=s.idpers,h.value=[s],U.value=!1,T()};Z(i,async s=>{s?await T():Q.value=0}),Pe(async()=>{pe("Commander"),G()});const de=s=>{const e=s.row,a=_.value.findIndex(c=>c.idsnack===e.idsnack);a===-1?(_.value.push(e),f.value[e.idsnack]||(f.value[e.idsnack]=1)):_.value.splice(a,1)},Y=s=>_.value.some(e=>e.idsnack===s.idsnack);return(s,e)=>(r(),y(Fe,{class:"page-content bg-grey-1"},{default:l(()=>[o("div",tt,[i.value?(r(),x("div",lt,[t(b,{flat:"",bordered:"",class:"student-card"},{default:l(()=>[t(u,{class:"bg-primary text-white"},{default:l(()=>[o("div",at,[e[13]||(e[13]=o("div",{class:"text-h6 text-weight-bold"},"Élève sélectionné",-1)),z.value?(r(),y(g,{key:0,flat:"",round:"",dense:"",color:"white",icon:"close",onClick:we})):w("",!0)])]),_:1}),t(u,{class:"q-pa-md"},{default:l(()=>[o("div",st,[o("div",ot,[ne.value?(r(),y(D,{key:0,size:"80px",color:"grey-3","text-color":"primary"},{default:l(()=>[o("img",{src:ne.value},null,8,nt)]),_:1})):(r(),y(D,{key:1,size:"80px",color:"grey-3","text-color":"primary"},{default:l(()=>[m(d(be.value),1)]),_:1}))]),o("div",rt,[o("div",it,d(_e.value),1),o("div",dt,[t(C,{name:"school",size:"xs",class:"q-mr-xs"}),m(" "+d(ye.value),1)]),o("div",{class:J(["text-subtitle1",{"text-negative":Q.value<=0}])},[t(C,{name:"account_balance_wallet",size:"xs",class:"q-mr-xs"}),m(" Solde: "+d(Q.value)+" DH ",1)],2)])])]),_:1})]),_:1})])):z.value?(r(),x("div",ut,[t(b,{flat:"",bordered:"",class:"student-selection-card"},{default:l(()=>[t(u,{class:"bg-primary text-white"},{default:l(()=>e[14]||(e[14]=[o("div",{class:"text-h6 text-weight-bold"},"Sélectionner l'élève",-1)])),_:1}),t(u,{class:"q-pa-lg"},{default:l(()=>[o("div",ct,[o("div",vt,[t(b,{flat:"",bordered:"",class:"selection-option-card cursor-pointer",onClick:e[0]||(e[0]=a=>E.value=!0)},{default:l(()=>[t(u,{class:"text-center q-pa-lg"},{default:l(()=>[t(D,{size:"72px",color:"primary","text-color":"white",icon:"person_add"}),e[15]||(e[15]=o("div",{class:"text-h6 text-primary q-mt-md"},"Rechercher",-1)),e[16]||(e[16]=o("div",{class:"text-subtitle2 text-grey-7"},"Rechercher un élève par nom",-1))]),_:1})]),_:1})]),Ee(q).platform.is.cordova?(r(),x("div",mt,[t(b,{flat:"",bordered:"",class:"selection-option-card cursor-pointer",onClick:e[1]||(e[1]=a=>U.value=!0)},{default:l(()=>[t(u,{class:"text-center q-pa-lg"},{default:l(()=>[t(D,{size:"72px",color:"secondary","text-color":"white",icon:"qr_code_scanner"}),e[17]||(e[17]=o("div",{class:"text-h6 text-secondary q-mt-md"},"Scanner",-1)),e[18]||(e[18]=o("div",{class:"text-subtitle2 text-grey-7"},"Scanner le code QR d'un élève",-1))]),_:1})]),_:1})])):w("",!0)])]),_:1})]),_:1})])):w("",!0),o("div",pt,[o("div",ft,[o("div",gt,[t(b,{flat:"",bordered:"",class:"order-items-card"},{default:l(()=>[t(u,{class:"bg-primary text-white"},{default:l(()=>[o("div",xt,[e[20]||(e[20]=o("div",{class:"text-h6 text-weight-bold"},"Articles commandés",-1)),t(g,{flat:"",round:"",dense:"",color:"white",icon:"add_shopping_cart",onClick:e[2]||(e[2]=a=>$.value=!0)},{default:l(()=>[t(ce,null,{default:l(()=>e[19]||(e[19]=[m("Ajouter un article")])),_:1})]),_:1})])]),_:1}),t(u,{class:"q-pa-none"},{default:l(()=>[p.value.length?w("",!0):(r(),x("div",_t,[t(C,{name:"shopping_cart",size:"48px",color:"grey-4"}),e[21]||(e[21]=o("div",{class:"text-subtitle1 q-mt-sm"},"Aucun article sélectionné",-1)),t(g,{flat:"",color:"primary",class:"q-mt-md",icon:"add_shopping_cart",label:"Ajouter un article",onClick:e[3]||(e[3]=a=>$.value=!0)})])),t(Ne,{separator:""},{default:l(()=>[(r(!0),x(K,null,W(p.value,a=>(r(),y(ee,{key:a.idsnack,class:"q-py-md"},{default:l(()=>[t(V,{avatar:""},{default:l(()=>[t(D,{rounded:"",size:"48px",color:"primary","text-color":"white","font-size":"16px"},{default:l(()=>[m(d(a.quantite)+"x ",1)]),_:2},1024)]),_:2},1024),t(V,null,{default:l(()=>[t(B,{class:"text-subtitle1 text-weight-medium"},{default:l(()=>[m(d(a.designation),1)]),_:2},1024),t(B,{caption:""},{default:l(()=>[o("span",yt,d(a.prix)+" DH",1),e[22]||(e[22]=m(" par unité "))]),_:2},1024)]),_:2},1024),t(V,{side:""},{default:l(()=>[o("div",ht,d(a.prix*a.quantite)+" DH ",1)]),_:2},1024),t(V,{side:""},{default:l(()=>[t(g,{flat:"",round:"",dense:"",color:"negative",icon:"delete",onClick:c=>ke(a.idsnack)},{default:l(()=>[t(ce,null,{default:l(()=>e[23]||(e[23]=[m("Supprimer")])),_:1})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),p.value.length?(r(),y(u,{key:0,class:"bg-grey-2 text-right q-pa-sm"},{default:l(()=>[o("div",bt,[e[24]||(e[24]=m(" Total: ")),o("span",kt,d(R.value)+" DH",1)])]),_:1})):w("",!0)]),_:1})])]),o("div",wt,[o("div",qt,[t(b,{flat:"",bordered:"",class:"my-card balance-card"},{default:l(()=>[t(u,{class:"bg-primary text-white text-center"},{default:l(()=>[e[25]||(e[25]=o("div",{class:"text-h5 text-weight-bold"},"Solde disponible",-1)),o("div",Qt,d(he.value)+" DH",1)]),_:1})]),_:1}),t(b,{flat:"",bordered:"",class:"my-card q-mt-md gt-md"},{default:l(()=>[t(u,null,{default:l(()=>[e[26]||(e[26]=o("div",{class:"text-h6 text-weight-bold text-primary q-mb-sm"},"Résumé de la commande",-1)),o("div",St," Total: "+d(R.value)+" DH ",1),t(g,{class:"full-width",size:"lg",color:"primary",icon:"shopping_cart_checkout",disable:!N.value,loading:P.value,label:"Commander",onClick:ie},null,8,["disable","loading"])]),_:1})]),_:1})])])])]),t(X,{modelValue:E.value,"onUpdate:modelValue":e[5]||(e[5]=a=>E.value=a)},{default:l(()=>[t(b,{class:"dialog-card",style:{width:"90vw","max-width":"500px"}},{default:l(()=>[t(u,null,{default:l(()=>e[27]||(e[27]=[o("div",{class:"text-h6"},"Sélectionner un élève",-1)])),_:1}),t(u,{class:"q-pt-none"},{default:l(()=>[t(Oe,{modelValue:i.value,"onUpdate:modelValue":e[4]||(e[4]=a=>i.value=a),options:h.value,"option-label":({nom:a,prenom:c,eleve_classes:$e})=>`${a} ${c} (${$e[0].classe_fr})`,"option-value":"idpers","emit-value":"","map-options":"",loading:j.value,onFilter:qe,"use-input":"","input-debounce":"300",label:"Rechercher un élève",clearable:""},{"no-option":l(()=>[t(ee,null,{default:l(()=>[t(V,{class:"text-grey"},{default:l(()=>e[28]||(e[28]=[m(" Aucun élève trouvé ")])),_:1})]),_:1})]),option:l(a=>[t(ee,Ue(Ie(a.itemProps)),{default:l(()=>[t(V,null,{default:l(()=>[t(B,null,{default:l(()=>[m(d(a.opt.nom)+" "+d(a.opt.prenom),1)]),_:2},1024),t(B,{caption:""},{default:l(()=>[m(d(a.opt.eleve_classes[0].classe_fr),1)]),_:2},1024)]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","options","option-label","loading"])]),_:1}),t(He,{align:"right",class:"text-primary"},{default:l(()=>[A(t(g,{flat:"",label:"Annuler"},null,512),[[le]]),A(t(g,{flat:"",label:"Sélectionner",onClick:Ce,disable:!i.value},null,8,["disable"]),[[le]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(X,{modelValue:U.value,"onUpdate:modelValue":e[6]||(e[6]=a=>U.value=a),position:"right",maximized:"","transition-show":"slide-up","transition-hide":"slide-down"},{default:l(()=>[t(et,{onStudentSelected:Ve})]),_:1},8,["modelValue"]),t(X,{modelValue:$.value,"onUpdate:modelValue":e[12]||(e[12]=a=>$.value=a),maximized:"","transition-show":"slide-up","transition-hide":"slide-down"},{default:l(()=>[t(Re,{view:"hHh LpR fFf",container:"",class:"bg-grey-2"},{default:l(()=>[t(Ze,{elevated:"",class:"bg-primary text-white"},{default:l(()=>[t(te,null,{default:l(()=>[A(t(g,{flat:"",round:"",dense:"",icon:"close"},null,512),[[le]]),t(ve,{class:"text-weight-bold"},{default:l(()=>e[29]||(e[29]=[m(" Sélectionner les articles ")])),_:1}),t(Ge),t(g,{flat:"",round:"",dense:"",icon:"done",onClick:Qe,disable:!_.value.length},{default:l(()=>[_.value.length?(r(),y(Ye,{key:0,color:"red",floating:"",transparent:""},{default:l(()=>[m(d(_.value.length),1)]),_:1})):w("",!0)]),_:1},8,["disable"])]),_:1}),t(te,{class:"q-px-md q-pb-md"},{default:l(()=>[t(ue,{modelValue:k.value,"onUpdate:modelValue":e[8]||(e[8]=a=>k.value=a),dense:"",outlined:"",placeholder:"Rechercher un article...",class:"full-width","bg-color":"white",borderless:""},{prepend:l(()=>[t(C,{name:"search"})]),append:l(()=>[k.value?(r(),y(C,{key:0,name:"close",class:"cursor-pointer",onClick:e[7]||(e[7]=a=>k.value="")})):w("",!0)]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(Te,{class:"q-pa-md"},{default:l(()=>[e[32]||(e[32]=o("div",{style:{height:"20px"}},null,-1)),M.value?(r(),x("div",Ct,[(r(),x(K,null,W(12,a=>o("div",{key:a,class:"col-12 col-sm-6 col-md-4"},[t(Je,{type:"rect",height:"120px",class:"rounded-borders"})])),64))])):re.value.length===0?(r(),x("div",Vt,[t(C,{name:"sentiment_dissatisfied",size:"56px",color:"grey-6"}),e[30]||(e[30]=o("div",{class:"text-h6 text-grey-8 q-mt-md"},"Aucun article trouvé",-1)),e[31]||(e[31]=o("div",{class:"text-body1 text-grey-6 q-mt-sm"},"Essayez une autre recherche",-1))])):(r(),x("div",$t,[o("div",zt,[(r(!0),x(K,null,W(re.value,a=>(r(),x("div",{key:a.idsnack,class:"col-12 col-sm-6 col-md-4"},[A((r(),y(b,{class:J({"cursor-pointer":!0,"bg-grey-2":Y(a)}),onClick:c=>de({row:a}),flat:"",bordered:"",style:{"margin-bottom":"0"}},{default:l(()=>[t(u,{class:"q-pa-md"},{default:l(()=>[o("div",Dt,[o("div",At,[o("div",Pt,d(a.designation),1),o("div",Et,d(a.prix)+" DH ",1)]),o("div",Ut,[t(Le,{dense:"","model-value":Y(a),"onUpdate:modelValue":c=>de({row:a}),onClick:e[9]||(e[9]=L(()=>{},["stop"]))},null,8,["model-value","onUpdate:modelValue"])])])]),_:2},1024),t(Ke,null,{default:l(()=>[A(o("div",null,[t(Be),t(u,{class:"q-pa-md bg-grey-1"},{default:l(()=>[t(ue,{modelValue:f.value[a.idsnack],"onUpdate:modelValue":c=>f.value[a.idsnack]=c,modelModifiers:{number:!0},type:"number",dense:"",outlined:"",label:"Quantité",class:"full-width",rules:[c=>c>0||"La quantité doit être supérieure à 0",c=>c<=99||"La quantité maximale est 99"],onClick:e[10]||(e[10]=L(()=>{},["stop"]))},{prepend:l(()=>[t(g,{round:"",flat:"",dense:"",icon:"remove",onClick:L(c=>f.value[a.idsnack]--,["stop"]),disable:f.value[a.idsnack]<=1},null,8,["onClick","disable"])]),append:l(()=>[t(g,{round:"",flat:"",dense:"",icon:"add",onClick:L(c=>f.value[a.idsnack]++,["stop"]),disable:f.value[a.idsnack]>=99},null,8,["onClick","disable"])]),_:2},1032,["modelValue","onUpdate:modelValue","rules"])]),_:2},1024)],512),[[Me,Y(a)]])]),_:2},1024)]),_:2},1032,["class","onClick"])),[[je]])]))),128))])]))]),_:1}),t(me,{elevated:"",class:"bg-white"},{default:l(()=>[o("div",It,[t(We,{modelValue:I.value,"onUpdate:modelValue":[e[11]||(e[11]=a=>I.value=a),G],max:fe.value,"direction-links":"","boundary-links":"","max-pages":5,color:"primary"},null,8,["modelValue","max"])])]),_:1})]),_:1})]),_:1},8,["modelValue"]),p.value.length>0?(r(),y(me,{key:0,style:{"margin-bottom":"50px"},bordered:"",class:"mobile-order-summary bg-white lt-lg"},{default:l(()=>[t(te,null,{default:l(()=>[t(ve,{class:"row items-center q-gutter-x-md"},{default:l(()=>[o("div",null,[e[33]||(e[33]=o("div",{class:"text-subtitle2 text-grey-7"},"Total",-1)),o("div",Ht,d(R.value)+" DH",1)]),o("div",null,[e[34]||(e[34]=o("div",{class:"text-subtitle2 text-grey-7"},"Solde après",-1)),o("div",{class:J(["text-h6",{"text-negative":H.value<0,"text-positive":H.value>0}])},d(H.value)+" DH ",3)])]),_:1}),t(g,{color:"primary",icon:"shopping_cart_checkout",disable:!N.value,loading:P.value,label:"Commander",onClick:ie},null,8,["disable","loading"])]),_:1})]),_:1})):w("",!0)]),_:1}))}};export{vl as default};
