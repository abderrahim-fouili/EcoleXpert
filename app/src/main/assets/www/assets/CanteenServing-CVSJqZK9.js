const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./CanteenServingListReport-Bbli_Spq.js","./date-C1Mon-Jj.js","./index-Bl2lQPd7.js","./index-B-uS9A6y.css","./format-IcNrutKL.js","./CanteenServingListReport-D5lWyi8P.css"])))=>i.map(i=>d[i]);
import{_ as pa,aP as ga,aO as _a,A as c,B as v,Y as ya,C as ba,Q as d,S as o,a6 as s,a5 as l,aE as j,R as f,aF as L,a8 as u,a4 as b,ad as p,ay as g,b7 as ha,a3 as w,aS as T,af as ka,a7 as ne,ab as _,ax as oe,aG as Ae,a2 as fe,a$ as wa,aD as pe,a9 as xa,aa as Sa,av as Ve,aw as Ca,aC as $a,a as C,b0 as Ea,aB as ie}from"./index-Bl2lQPd7.js";import{Q as ge,a as K}from"./QItem-De3v03wU.js";import{Q as De}from"./QSelect-DchnWyXK.js";import{Q as h}from"./QTooltip-r7WoEuzy.js";import{Q as Pa,a as Qe}from"./QTabs-yl5EIOig.js";import{Q as ue}from"./QBadge-Bjfo5tRO.js";import{Q as F}from"./QTd-CpEgdqvP.js";import{Q as _e}from"./QInnerLoading-WxvcYHvS.js";import{Q as qe}from"./QTable-D-OlObRI.js";import{Q as Aa,a as Le}from"./QTabPanels-Bqg1c7oo.js";import{Q as Va}from"./QSpinnerGears-DmolwAR1.js";import{Q as Te}from"./QItemLabel-BkJiB6aE.js";import{Q as Da}from"./QList-CMzNTEGD.js";import{C as Qa}from"./ClosePopup-BY_YGFBZ.js";import{q as de}from"./date-C1Mon-Jj.js";import{_ as qa}from"./StudentScan-BWckmCLy.js";import{_ as La}from"./StaffScan-AD3bmvlA.js";import{_ as Ta}from"./StudentScanBrowser-ChZDgZVt.js";import{u as za}from"./composables-CAkrP3jA.js";import{E as ze}from"./ExportControls-UOL0zNKZ.js";import{u as Ma,H as Ra,i as Na,a as ja,b as Fa,c as Ba}from"./index.esm.min-FpMw1SSI.js";import{i as Ua,a as Ya,b as Oa}from"./install-qCEEq-uE.js";import"./QChip-C9OfA2gn.js";import"./QMenu-BNr9Tzvf.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./rtl-DFPa-2ov.js";import"./format-IcNrutKL.js";import"./QVirtualScroll-CENgsPEr.js";import"./QLinearProgress-DW1NPbfx.js";import"./TouchSwipe-jpsGI2FR.js";import"./touch-BjYP5sR0.js";import"./use-render-cache-DLxPkVnQ.js";import"./QToolbarTitle-C8APieXG.js";import"./QToolbar-DR-_wX4W.js";import"./QSpace-CKKoNTi_.js";import"./QBanner-xBGiroIy.js";import"./QBtnGroup-CdugIB7Z.js";import"./QSpinnerDots-BW9ZsFNG.js";import"./_commonjsHelpers-D6-XlEtG.js";const Ga={key:0,class:"mt-md bg-red-1 q-pa-md rounded-borders text-negative"},Ha={key:0,class:"row flex-center text-grey q-py-lg"},Ka={key:1,class:"row flex-center text-grey q-py-lg"},Wa={class:"row items-center justify-between"},Ja={class:"row items-center gap-x-sm"},Xa=["src"],Za={class:"text-weight-bold text-body1"},Ia={class:"text-caption text-grey-7"},et={key:0},at={class:"row items-center gap-x-sm"},tt={class:"text-weight-medium text-subtitle1"},st={key:0,class:"text-caption text-grey-8 mt-xs"},lt={key:1,class:"text-caption text-negative mt-xs"},rt={class:"q-gutter-y-md"},nt={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 md:gap-4 lg:gap-6 mb-md"},ot={class:""},it={class:""},ut={class:"col-12 md:col-4 flex flex-wrap justify-center md:justify-end gap-sm pt-sm md:pt-0"},dt={class:"q-pa-xs col-xs-12 col-sm-6"},ct={class:"row items-center justify-between no-wrap"},vt={class:"row items-center gap-x-sm overflow-hidden mr-sm"},mt=["src"],ft={class:"overflow-hidden"},pt={class:"text-weight-medium text-body2 truncate"},gt={class:"text-caption text-grey-7"},_t={class:"col-auto"},yt={key:0,class:"text-grey-8"},bt={class:"w-full row flex-center text-grey gap-sm q-pa-md text-center"},ht={class:"q-gutter-y-md"},kt={class:"row q-col-gutter-x-md q-col-gutter-y-sm items-center mb-md"},wt={class:"col-12 sm:flex-1"},xt={class:"col-12 sm:col-auto flex justify-center sm:justify-end gap-sm pt-sm sm:pt-0"},St={key:0,class:"text-caption text-grey-7"},Ct={class:"q-pa-xs col-xs-12 col-sm-6"},$t={class:"row items-center justify-between no-wrap"},Et={class:"row items-center gap-x-sm overflow-hidden mr-sm"},Pt=["src"],At={class:"overflow-hidden"},Vt={class:"text-weight-medium text-body2 truncate"},Dt={class:"col-auto"},Qt={key:0,class:"text-grey-8"},qt={class:"text-grey-8 text-right"},Lt={class:"w-full row flex-center text-grey gap-sm q-pa-md text-center"},Tt=["src"],zt={key:1,class:"text-grey q-pa-md text-center"},Mt={__name:"CanteenServing",setup(Rt){Ma([Ua,Na,ja,Fa,Ba,Ya,Oa]);const ye=wa(()=>Ea(()=>import("./CanteenServingListReport-Bbli_Spq.js"),__vite__mapDeps([0,1,2,3,4,5]),import.meta.url)),Me=ga(),i=_a(),{setTitle:Re}=za(),B=c(!1),W=c(!1),k=c(!1),ce=c(!1),U=c(!1),$=c(!1),x=c([]),n=c(null),R=c("students"),E=c([]),P=c([]),Y=c([]),O=c(""),G=c(""),A=c(null),S=c(null),V=c(null),D=c(null),J=c(!1),X=c(!1),Z=c(!1),I=c(!1),z=c(""),M=c([]),r=c(null),y=v(()=>Me.getters["user/current"]?.annee),Ne=v(()=>x.value.map(a=>({label:`${de.formatDate(a.date_cantine,"DD/MM/YYYY")} - ${a.description||"Programme"}`,value:a.idcantine}))),be=v(()=>Y.value.map(a=>({label:a.classe_fr||a.name||a.bref,value:a.idclasse}))),he=v(()=>{let a=E.value;if(A.value&&(a=a.filter(e=>e.classe_id===A.value)),O.value){const e=O.value.toLowerCase();a=a.filter(t=>t.full_name?.toLowerCase().includes(e))}return a}),ke=v(()=>{if(!G.value)return P.value;const a=G.value.toLowerCase();return P.value.filter(e=>e.staff_name?.toLowerCase().includes(a))}),je=v(()=>E.value.length),Fe=v(()=>E.value.filter(a=>a.is_served).length),Be=v(()=>P.value.length),Ue=v(()=>P.value.filter(a=>a.is_served).length),ee=v(()=>je.value+Be.value),we=v(()=>Fe.value+Ue.value),Ye=v(()=>ee.value-we.value),Oe=v(()=>{const a=we.value,e=Ye.value,t=ee.value,m=t>0?Math.round(a/t*100):0;return{tooltip:{trigger:"item",formatter:"{b}: {c} ({d}%)"},legend:{show:!1},graphic:{type:"text",left:"center",top:"center",style:{text:`${a} / ${t}
Servis (${m}%)`,textAlign:"center",fill:i.dark.isActive?"#eee":"#333",fontSize:14,fontWeight:"bold"}},series:[{name:"Progression Service",type:"pie",radius:["85%","90%"],avoidLabelOverlap:!0,itemStyle:{borderRadius:5,borderColor:i.dark.isActive?"#333":"#fff",borderWidth:1},label:{show:!1,position:"center"},emphasis:{label:{show:!1}},labelLine:{show:!1},data:[{value:a,name:"Servis",itemStyle:{color:"#85b9e8"}},{value:e,name:"Restants",itemStyle:{color:"#B0BEC5"}}].filter(re=>re.value>0)}]}}),Ge=v(()=>{if(!r.value)return"";switch(r.value.scan_status||r.value.check_status){case"served_successfully":case"added_and_served":case"ok_paid":case"ok":return"bg-green-1 text-green-10";case"already_served":return"bg-blue-1 text-blue-10";case"ok_unpaid":return"bg-orange-1 text-orange-10";case"not_eligible":return"bg-red-1 text-red-10";default:return"bg-grey-2 text-grey-9"}}),xe=v(()=>{if(!r.value)return"info";switch(r.value.scan_status||r.value.check_status){case"served_successfully":return"check_circle";case"added_and_served":return"person_add";case"already_served":return"check_circle";case"ok_paid":return"check_circle_outline";case"ok":return"check_circle_outline";case"ok_unpaid":return"warning";case"not_eligible":return"block";default:return"error_outline"}}),He=v(()=>{if(!r.value)return"grey";switch(r.value.scan_status||r.value.check_status){case"served_successfully":case"added_and_served":case"already_served":case"ok_paid":case"ok":return"positive";case"ok_unpaid":return"warning";case"not_eligible":return"negative";default:return"negative"}}),Ke=v(()=>r.value?.message||"Vérification..."),Se=v(()=>{if(!r.value)return null;let a=null;if(r.value.served_details)a=r.value.served_details;else if(r.value.log&&r.value.log.served_at){const e=r.value.log.served_at;return`Servi à ${de.formatDate(e*1e3,"H:mm:ss")}`}return a&&a.served_at_display?`Servi à ${a.served_at_display}${a.served_by_name?` par ${a.served_by_name}`:""}`:null}),We=v(()=>{const a=r.value?.check_status;return a==="ok_paid"||a==="ok_unpaid"||a==="ok"});v(()=>{const a=r.value?.check_status;return(a==="ok_paid"||a==="ok_unpaid"||a==="ok")&&!r.value?.already_served});const Je=v(()=>r.value?.check_status==="ok_unpaid"||r.value?.check_status==="ok_paid"),Xe=v(()=>r.value?.person?.type==="ELEV"&&r.value?.check_status==="not_eligible"&&r.value?.reason==="not_on_list"),Ce=v(()=>{const a=he.value.filter(e=>!e.is_served).map(e=>({name:e.full_name||"N/A",detail:e.classe_name||"Classe Inconnue",status:ve(e.status)}));return{title:`Cantine - Élèves à Servir (${de.formatDate(x.value.find(e=>e.idcantine===n.value)?.date_cantine||Date.now(),"DD/MM/YYYY")})`,items:a,itemType:"student"}}),$e=v(()=>{const a=ke.value.filter(e=>!e.is_served).map(e=>({name:e.staff_name||"N/A",detail:`Tarif: ${e.tarif?.toFixed(2)||"0.00"} MAD`,status:e.payed?"Payé":"Non Payé"}));return{title:`Cantine - Personnel à Servir (${de.formatDate(x.value.find(e=>e.idcantine===n.value)?.date_cantine||Date.now(),"DD/MM/YYYY")})`,items:a,itemType:"staff"}}),Ze=[{name:"full_name",label:"Nom Complet",field:"full_name",align:"left",sortable:!0,style:"min-width: 150px"},{name:"classe_name",label:"Classe",field:"classe_name",align:"left",sortable:!0},{name:"status",label:"Statut",field:"status",align:"center",sortable:!0},{name:"is_served",label:"Servi",field:"is_served",align:"center",sortable:!0},{name:"actions",label:"Action",field:"actions",align:"center"}],Ie=[{name:"staff_name",label:"Nom Personnel",field:"staff_name",align:"left",sortable:!0,style:"min-width: 150px"},{name:"tarif",label:"Tarif",field:"tarif",align:"right",sortable:!0,format:a=>`${a?.toFixed(2)||"0.00"} MAD`},{name:"payed",label:"Payé",field:"payed",align:"center",sortable:!0},{name:"is_served",label:"Servi",field:"is_served",align:"center",sortable:!0},{name:"actions",label:"Actions",field:"actions",align:"center"}],ea=async()=>{W.value=!0;try{const{data:a}=await C("get","/canteen/programs/active");a?.status==="success"&&Array.isArray(a.data)?(x.value=a.data,x.value.length>0&&!n.value?(n.value=x.value[0].idcantine,y.value?.idannee&&H(n.value)):x.value.length===0&&(n.value=null,E.value=[],P.value=[])):(x.value=[],n.value=null,i.notify({type:"warning",message:"Impossible de charger les programmes."}))}catch(a){console.error("Error fetching canteen programs:",a),x.value=[],n.value=null,i.notify({type:"negative",message:"Erreur chargement programmes."})}finally{W.value=!1}},N=async a=>{if(!(!a||!y.value?.idannee)){k.value=!0,E.value=[];try{const{data:e}=await C("get",`/canteen/programs/${a}/students`,{params:{annee_id:y.value.idannee}});e?.status==="success"&&Array.isArray(e.data)?E.value=e.data.map(t=>({...t,photo_url:t.photo?ie(t.photo):null})):(E.value=[],e?.message&&!e.message.includes("aucun")&&i.notify({type:"info",position:"bottom",timeout:2500,message:e?.message||"Liste élèves vide."}))}catch(e){console.error("Error fetching student list:",e),E.value=[],e.response?.status!==404&&i.notify({type:"negative",message:e.response?.data?.message||"Erreur chargement élèves."})}finally{k.value=!1}}},ae=async a=>{if(a){k.value=!0,P.value=[];try{const{data:e}=await C("get",`/canteen/programs/${a}/staff-tickets`);e?.status==="success"&&Array.isArray(e.data)?P.value=e.data.map(t=>({...t,staff_photo_url:t.photo?ie(t.photo):null})):(P.value=[],e?.message&&!e.message.includes("aucun")&&i.notify({type:"info",position:"bottom",timeout:2500,message:e.message}))}catch(e){console.error("Error fetching staff list:",e),P.value=[],i.notify({type:"negative",message:e.response?.data?.message||"Erreur chargement personnel."})}finally{k.value=!1}}},aa=async()=>{if(y.value?.idannee){ce.value=!0;try{const{data:a}=await C("get",`/filters/classes/${y.value.idannee}`);a?.status==="success"&&Array.isArray(a.data)?Y.value=a.data:Y.value=[]}catch(a){console.error("Error fetching classes:",a),Y.value=[]}finally{ce.value=!1}}},H=a=>{a?(N(a),ae(a)):(E.value=[],P.value=[])},ta=a=>{H(a),A.value=null,O.value="",G.value="",q()},Q=async a=>{if(!(!n.value||!a)){B.value=!0,r.value=null;try{const{data:e}=await C("get",`/canteen/programs/${n.value}/check-served/${a}`);if(e?.status==="success"&&e.data)r.value={...e.data,message:e.message,person:{...e.data.person,photo_url:e.data.person?.photo?ie(e.data.person.photo):null}},e.data.person?.type&&e.data.person.type!=="ELEV"?R.value="staff":R.value="students";else throw new Error(e?.message||"Réponse invalide de la vérification.")}catch(e){console.error(`Error checking person ${a}:`,e);const t=e.response?.data?.message||"Erreur lors de la vérification.",m=e.response?.data?.data?.reason||"check_failed";r.value={person:{idpers:a,full_name:"Erreur"},check_status:e.response?.status===404?"not_found":"error",reason:m,message:t},i.notify({type:"negative",message:t})}finally{B.value=!1}}},sa=async a=>{if(!n.value||!a||S.value||V.value||D.value)return;S.value=a;const e=r.value;try{const{data:t}=await C("post",`/canteen/programs/${n.value}/serve/${a}`);if(t?.status==="success"){i.notify({type:"positive",message:t.message||"Personne servie.",icon:"check",position:"top",timeout:2e3}),q();const m=e?.person?.type;m==="ELEV"?N(n.value):m?ae(n.value):H(n.value)}else i.notify({type:"negative",message:t?.message||"Échec service."}),Q(a)}catch(t){console.error(`Error manually serving person ${a}:`,t),i.notify({type:"negative",message:t.response?.data?.message||"Erreur service."}),Q(a)}finally{S.value=null}},la=async(a,e)=>{if(!(!a||S.value||V.value||D.value)){D.value=a;try{const{data:t}=await C("post",`/canteen/staff-tickets/${a}/mark-paid`);t?.status==="success"?(i.notify({type:"positive",message:t.message||"Ticket payé.",icon:"price_check",position:"top",timeout:2e3}),ae(n.value),r.value?.person?.idpers===e&&Q(e)):i.notify({type:"negative",message:t?.message||"Échec paiement."})}catch(t){console.error(`Error marking ticket ${a} paid:`,t),i.notify({type:"negative",message:t.response?.data?.message||"Erreur paiement."})}finally{D.value=null}}},ra=async a=>{if(!(!n.value||!a||S.value||V.value||D.value)){V.value=a;try{const{data:e}=await C("post",`/canteen/programs/${n.value}/add-student/${a}`);e?.status==="success"?(i.notify({type:"positive",message:e.message||"Élève ajouté.",icon:"person_add",position:"top",timeout:2e3}),N(n.value).then(()=>{Q(a)})):(i.notify({type:"negative",message:e?.message||"Échec ajout."}),Q(a))}catch(e){console.error(`Error manually adding student ${a}:`,e),i.notify({type:"negative",message:e.response?.data?.message||"Erreur ajout."}),Q(a)}finally{V.value=null}}},na=async()=>{if(!n.value||!A.value||!y.value?.idannee){i.notify({type:"warning",message:"Sélectionnez programme et classe."});return}const a=be.value.find(e=>e.value===A.value)?.label||"la classe sélectionnée";i.dialog({title:"Confirmer Service Classe",message:`Marquer tous les élèves éligibles de la classe '${a}' comme servis ?`,cancel:!0,persistent:!0,ok:{label:"Oui, Servir",color:"primary",flat:!1},cancel:{label:"Annuler",color:"grey",flat:!0}}).onOk(async()=>{J.value=!0,q();try{const{data:e}=await C("post",`/canteen/programs/${n.value}/serve-class/${A.value}`,{annee_id:y.value.idannee});let t=e.message||"Opération terminée.";const m=e.failed_students?.length||0;m>0&&(t+=` ${m} échec${m>1?"s":""}.`),i.notify({type:e.status==="success"?"positive":e.status==="partial_success"?"warning":"negative",message:t,timeout:e.status==="partial_success"?5e3:3e3,actions:m>0?[{label:"Détails",color:"white",handler:()=>{oa(e.failed_students)}}]:[],position:"top"}),N(n.value)}catch(e){console.error("Error serving class:",e),i.notify({type:"negative",message:e.response?.data?.message||"Erreur service classe."})}finally{J.value=!1}})},oa=a=>{let e='<ul class="q-pl-md q-gutter-y-xs">';a.forEach(t=>{e+=`<li><strong>${t.name||"ID "+t.id}</strong>: ${t.reason||"Inconnue"}</li>`}),e+="</ul>",i.dialog({title:"Échecs Service Classe",message:e,html:!0,ok:"Fermer"})},te=(a,e)=>{if(X.value=!1,Z.value=!1,I.value=!1,z.value="",M.value=[],!a||!a.idpers){i.notify({type:"warning",message:"Données personne invalides."}),q();return}if(!n.value||!y.value?.idannee){i.notify({type:"negative",message:"Programme ou année non sélectionné."}),q();return}e?ia(a.idpers):Q(a.idpers)},ia=async a=>{if(!(!n.value||!y.value?.idannee)){B.value=!0,r.value=null;try{const{data:e,status:t}=await C("post",`/canteen/programs/${n.value}/scan-serve/${a}`,{annee_id:y.value.idannee});if(r.value={person:e.data?.person||{idpers:a,full_name:"Détails indisponibles"},log:e.data?.log||null,scan_status:e.data?.scan_status||"error",reason:e.data?.reason||null,message:e.message||"Action terminée.",is_paid:e.data?.is_paid,ticket_id:e.data?.ticket_id},e.data?.scan_status==="served_successfully"||e.data?.scan_status==="added_and_served"){const re=e.data?.person?.type;re==="ELEV"?N(n.value):re?ae(n.value):H(n.value)}let m="info";e.data?.scan_status==="served_successfully"||e.data?.scan_status==="added_and_served"?m="positive":(e.data?.scan_status==="not_eligible"||e.data?.scan_status==="error")&&(m="negative"),i.notify({type:m,message:e.message,icon:xe.value,position:"top",timeout:3e3})}catch(e){console.error(`Error during scan action for person ${a}:`,e);const t=e.response?.data?.message||"Erreur lors de l'action scan.",m=e.response?.data?.data?.reason||"scan_failed";r.value={person:{idpers:a,full_name:"Erreur"},scan_status:e.response?.status===403?"not_eligible":"error",reason:m,message:t},i.notify({type:"negative",message:t})}finally{B.value=!1}}},ua=()=>{n.value&&(q(),X.value=!0,se(!0))},da=()=>{n.value&&(q(),Z.value=!0,se(!0))},ca=()=>{n.value&&(q(),z.value="",M.value=[],I.value=!0)},va=async()=>{if(!z.value||z.value.length<2){M.value=[],U.value=!1;return}U.value=!0;const a=y.value?.idannee;try{const{data:e}=await C("get",`/filters/students/${a}`,{params:{term:z.value,annee_id:a,program_id:n.value}});e?.status==="success"&&Array.isArray(e.data)?M.value=e.data.map(t=>({...t,photo_url:t.photo?ie(t.photo):null})):M.value=[]}catch(e){console.error("Error searching people:",e),M.value=[],i.notify({type:"negative",message:"Erreur recherche.",position:"bottom",timeout:2e3})}finally{U.value=!1}},ma=a=>{a&&a.idpers&&te({idpers:a.idpers},!1)},q=()=>{r.value=null},se=a=>{a?document.body.classList.add("scan-active"):document.body.classList.remove("scan-active")},le=a=>{a.target.style.display="none"},ve=a=>{switch(a){case"SUBSCRIBED":return"Abonné";case"TICKET":return"Ticket";case"ADD_MANUAL":return"Ajout Man.";default:return a||"N/A"}},Ee=a=>{switch(a){case"SUBSCRIBED":return"primary";case"TICKET":return"secondary";case"ADD_MANUAL":return"info";default:return"grey"}},fa=a=>{switch(a){case"cutoff_time":return"Heure limite";case"not_on_list":return"Non listé (ajout possible si éligible)";case"no_ticket":return"Pas de ticket";case"unsupported_type":return"Type non supporté";case"not_subscribed_or_ticketed":return"Non abonné / Pas de ticket";case"absent":return"Marqué Absent";case"service_id_missing":return"Config Service Manquante";case"eligibility_check_error":return"Erreur Vérif. Éligibilité";case"serve_failed":return"Échec Service (Vérif. finale)";case"db_error":return"Erreur Base de Données";case"ok":return"Éligible";case"internal_error":return"Erreur interne";default:return a||"Inconnue"}},Pe=a=>{switch(a){case"ELEV":return"Élève";case"PROF":return"Prof.";case"STAFF":return"Personnel";case"ADMIN":return"Admin";default:return a||"Inconnu"}},me=async()=>{if(!n.value||!y.value?.idannee){i.notify({type:"warning",message:"Sélectionnez programme & année.",position:"top"});return}$.value=!0,q();try{const{data:a}=await C("post",`/canteen/programs/${n.value}/generate-list`,{annee_id:y.value.idannee});a?.status==="success"?(i.notify({type:"positive",message:"Génération lancée...",position:"top",timeout:2e3}),setTimeout(()=>{N(n.value)},1500)):i.notify({type:"negative",message:a?.message||"Échec génération.",position:"top"})}catch(a){console.error("Error triggering list generation:",a),i.notify({type:"negative",message:a.response?.data?.message||"Erreur génération.",position:"top"})}finally{setTimeout(()=>{$.value=!1},1500)}};return ya(()=>y.value?.idannee,(a,e)=>{a!==e?(x.value=[],n.value=null,E.value=[],P.value=[],Y.value=[],A.value=null,q(),a&&(aa(),ea())):a&&!n.value&&x.value.length>0&&(n.value=x.value[0].idcantine,H(n.value))},{immediate:!0}),ba(()=>{Re("Service Cantine")}),(a,e)=>(o(),d($a,{class:"page-content q-pa-xs sm:q-pa-md"},{default:s(()=>[l(j,{flat:"",bordered:""},{default:s(()=>[l(L,{class:"q-pb-none"},{default:s(()=>[e[19]||(e[19]=u("div",{class:"text-h6"},"Service Cantine",-1)),y.value?.idannee?f("",!0):(o(),b("div",Ga,[l(g,{name:"warning",color:"negative",class:"mr-sm"}),e[18]||(e[18]=p(" Veuillez sélectionner une année scolaire dans le menu de navigation. "))]))]),_:1}),y.value?.idannee?(o(),d(L,{key:0},{default:s(()=>[l(De,{modelValue:n.value,"onUpdate:modelValue":[e[0]||(e[0]=t=>n.value=t),ta],options:Ne.value,label:"Sélectionner le Programme/Jour",filled:"",dense:"","emit-value":"","map-options":"",loading:W.value,disable:W.value||!y.value,"options-dense":"",class:"mb-md"},{"no-option":s(()=>[l(ge,null,{default:s(()=>[l(K,{class:"text-grey"},{default:s(()=>e[20]||(e[20]=[p("Aucun programme actif trouvé.")])),_:1})]),_:1})]),_:1},8,["modelValue","options","loading","disable"]),n.value?(o(),d(j,{key:0,flat:"",bordered:"",class:"mb-md"},{default:s(()=>[l(L,{class:"q-pa-sm"},{default:s(()=>[e[23]||(e[23]=u("div",{class:"text-subtitle2 text-center text-grey-8 q-mb-xs"},"Progression Service",-1)),k.value&&ee.value===0?(o(),b("div",Ha,[l(ha,{color:"primary",size:"2em"}),e[21]||(e[21]=u("span",{class:"q-ml-sm"},"Chargement des listes...",-1))])):!k.value&&ee.value===0&&!$.value?(o(),b("div",Ka,[l(g,{name:"info",size:"1.5em",class:"q-mr-xs"}),e[22]||(e[22]=u("span",null,"Aucune personne listée pour ce programme.",-1)),E.value.length===0?(o(),d(w,{key:0,label:"Générer Liste Élèves?",color:"primary",size:"sm",onClick:me,loading:$.value,disable:!n.value||$.value,outline:"",dense:"",class:"q-ml-md"},null,8,["loading","disable"])):f("",!0)])):(o(),d(T(Ra),{key:2,class:"chart",option:Oe.value,autoresize:"",style:{height:"150px"}},null,8,["option"]))]),_:1})]),_:1})):f("",!0),r.value?(o(),d(j,{key:1,flat:"",bordered:"",class:ka(["mb-md check-result-card",Ge.value])},{default:s(()=>[l(L,{class:"py-sm px-md"},{default:s(()=>[u("div",Wa,[u("div",Ja,[l(ne,{size:"40px"},{default:s(()=>[r.value.person?.photo_url?(o(),b("img",{key:0,src:r.value.person.photo_url,onError:le},null,40,Xa)):(o(),d(g,{key:1,name:"person",size:"40px",color:"grey-7"}))]),_:1}),u("div",null,[u("div",Za,_(r.value.person?.full_name||"Chargement..."),1),u("div",Ia,[p(_(Pe(r.value.person?.type))+" ",1),r.value.is_paid!==void 0&&r.value.is_paid!==null?(o(),b("span",et," - Ticket "+_(r.value.is_paid?"Payé":"Non Payé"),1)):f("",!0)])])]),l(w,{flat:"",round:"",dense:"",icon:"close",onClick:q})])]),_:1}),l(oe),l(L,null,{default:s(()=>[u("div",at,[l(g,{name:xe.value,color:He.value,size:"md"},null,8,["name","color"]),u("div",tt,_(Ke.value),1)]),(r.value?.scan_status==="already_served"||r.value?.check_status==="already_served")&&Se.value?(o(),b("div",st,_(Se.value),1)):f("",!0),r.value?.scan_status==="not_eligible"||r.value?.check_status==="not_eligible"?(o(),b("div",lt," Raison: "+_(fa(r.value.reason)),1)):f("",!0)]),_:1}),r.value?.check_status?(o(),d(Ae,{key:0,align:"right",class:"q-gutter-sm flex-wrap"},{default:s(()=>[Je.value||r.value?.served_details&&r.value?.person&&r.value?.person.type!=="ELEV"&&!r.value?.is_paid&&!r.value?.served_details?.is_paid?(o(),d(w,{key:0,label:"Marquer Payé",color:"warning",icon:"price_check",dense:"",onClick:e[1]||(e[1]=t=>la(r.value.ticket_id,r.value.person.idpers)),loading:D.value===r.value.ticket_id,disable:!!S.value||!!V.value||!!D.value},null,8,["loading","disable"])):f("",!0),We.value?(o(),d(w,{key:1,label:"Servir",color:"positive",icon:"check_circle",dense:"",onClick:e[2]||(e[2]=t=>sa(r.value.person.idpers)),loading:S.value===r.value.person.idpers,disable:!!S.value||!!V.value||!!D.value},null,8,["loading","disable"])):f("",!0),Xe.value?(o(),d(w,{key:2,label:"Ajouter",color:"primary",icon:"person_add_alt_1",dense:"",onClick:e[3]||(e[3]=t=>ra(r.value.person.idpers)),loading:V.value===r.value.person.idpers,disable:!!S.value||!!V.value||!!D.value},{default:s(()=>[l(h,null,{default:s(()=>e[24]||(e[24]=[p("Ajouter cet élève à la liste pour pouvoir le servir")])),_:1})]),_:1},8,["loading","disable"])):f("",!0)]),_:1})):f("",!0)]),_:1},8,["class"])):f("",!0),l(Pa,{modelValue:R.value,"onUpdate:modelValue":e[4]||(e[4]=t=>R.value=t),dense:"",class:"text-grey","active-color":"primary","indicator-color":"primary",align:"justify","narrow-indicator":""},{default:s(()=>[l(Qe,{name:"students",label:"Élèves"}),l(Qe,{name:"staff",label:"Personnel"})]),_:1},8,["modelValue"]),l(oe),l(Aa,{modelValue:R.value,"onUpdate:modelValue":e[8]||(e[8]=t=>R.value=t),animated:""},{default:s(()=>[l(Le,{name:"students",class:"q-pa-none pt-2"},{default:s(()=>[u("div",rt,[u("div",nt,[u("div",ot,[l(De,{modelValue:A.value,"onUpdate:modelValue":e[5]||(e[5]=t=>A.value=t),options:be.value,label:"Filtrer par Classe",filled:"",dense:"","emit-value":"","map-options":"",clearable:"",loading:ce.value,"options-dense":"",disable:!n.value||k.value},{"no-option":s(()=>[l(ge,null,{default:s(()=>[l(K,{class:"text-grey"},{default:s(()=>e[25]||(e[25]=[p("Aucune classe.")])),_:1})]),_:1})]),_:1},8,["modelValue","options","loading","disable"])]),u("div",it,[l(fe,{modelValue:O.value,"onUpdate:modelValue":e[6]||(e[6]=t=>O.value=t),label:"Rechercher un élève...",filled:"",dense:"",clearable:"",debounce:"300",disable:!n.value||k.value},{prepend:s(()=>[l(g,{name:"search"})]),_:1},8,["modelValue","disable"])]),u("div",ut,[l(w,{label:"Servir Classe",color:"secondary",onClick:na,icon:"groups",dense:"",disable:!A.value||k.value||J.value,loading:J.value},{default:s(()=>[A.value?f("",!0):(o(),d(h,{key:0},{default:s(()=>e[26]||(e[26]=[p("Sélectionnez une classe")])),_:1}))]),_:1},8,["disable","loading"]),Ce.value.items.length>0&&!T(i).screen.lt.md?(o(),d(ze,{key:0,"report-component":T(ye),"report-data":Ce.value,"report-component-styles":[{url:"/reports/base.css"}],"pdf-filename-prefix":"Canteen_Students_ToServe",class:"inline-block",dense:""},null,8,["report-component","report-data"])):f("",!0),l(w,{flat:"",round:"",dense:"",icon:"qr_code_scanner",onClick:ua,disable:!n.value},{default:s(()=>[l(h,null,{default:s(()=>e[27]||(e[27]=[p("Scanner")])),_:1})]),_:1},8,["disable"]),l(w,{flat:"",round:"",dense:"",icon:"person_search",onClick:ca,disable:!n.value},{default:s(()=>[l(h,null,{default:s(()=>e[28]||(e[28]=[p("Recherche")])),_:1})]),_:1},8,["disable"])])]),l(qe,{rows:he.value,columns:Ze,"row-key":"idpers",dense:"",flat:"",bordered:"",loading:k.value,pagination:{rowsPerPage:15},"rows-per-page-options":[15,30,50,0],grid:T(i).screen.lt.md},{"body-cell-status":s(t=>[l(F,{props:t,class:"text-center"},{default:s(()=>[l(ue,{color:Ee(t.value),label:ve(t.value)},null,8,["color","label"])]),_:2},1032,["props"])]),"body-cell-is_served":s(t=>[l(F,{props:t,class:"text-center"},{default:s(()=>[t.value?(o(),d(g,{key:0,name:"check_circle",color:"positive",size:"sm"},{default:s(()=>[l(h,null,{default:s(()=>[p("Servi "+_(t.row.served_at_display?`à ${t.row.served_at_display}`:""),1)]),_:2},1024)]),_:2},1024)):(o(),d(g,{key:1,name:"radio_button_unchecked",color:"grey-5",size:"sm"}))]),_:2},1032,["props"])]),"body-cell-actions":s(t=>[l(F,{props:t,class:"text-center"},{default:s(()=>[t.row.is_served?(o(),d(g,{key:1,name:"check_circle",color:"positive",size:"sm"},{default:s(()=>[l(h,null,{default:s(()=>[p("Déjà Servi "+_(t.row.served_at_display?`à ${t.row.served_at_display}`:""),1)]),_:2},1024)]),_:2},1024)):(o(),d(w,{key:0,flat:"",round:"",dense:"",color:"grey-7",icon:"check_circle_outline",onClick:m=>Q(t.row.idpers,!1),loading:S.value===t.row.idpers,disable:!!S.value||!!V.value||!!D.value},{default:s(()=>[l(h,null,{default:s(()=>e[29]||(e[29]=[p("Vérifier/Servir Manuellement")])),_:1})]),_:2},1032,["onClick","loading","disable"]))]),_:2},1032,["props"])]),item:s(t=>[u("div",dt,[l(j,{flat:"",bordered:"",onClick:m=>Q(t.row.idpers,!1)},{default:s(()=>[l(L,{class:"q-pa-sm"},{default:s(()=>[u("div",ct,[u("div",vt,[l(ne,{size:"36px"},{default:s(()=>[t.row.photo_url?(o(),b("img",{key:0,src:t.row.photo_url,onError:le},null,40,mt)):(o(),d(g,{key:1,name:"person",size:"36px",color:"grey-6"}))]),_:2},1024),u("div",ft,[u("div",pt,_(t.row.full_name),1),u("div",gt,_(t.row.classe_name||"Classe N/A"),1)])]),u("div",_t,[t.row.is_served?(o(),d(g,{key:0,name:"check_circle",color:"positive",size:"sm"},{default:s(()=>[l(h,null,{default:s(()=>e[30]||(e[30]=[p("Déjà Servi")])),_:1})]),_:1})):(o(),d(g,{key:1,name:"radio_button_unchecked",color:"grey-5",size:"sm"},{default:s(()=>[l(h,null,{default:s(()=>e[31]||(e[31]=[p("Non servi")])),_:1})]),_:1}))])])]),_:2},1024),l(oe),l(L,{class:"q-pa-sm text-caption row items-center justify-between gap-x-sm"},{default:s(()=>[l(ue,{color:Ee(t.row.status),label:ve(t.row.status)},null,8,["color","label"]),t.row.is_served&&t.row.served_at_display?(o(),b("div",yt," Servi à "+_(t.row.served_at_display),1)):f("",!0)]),_:2},1024)]),_:2},1032,["onClick"])])]),"no-data":s(()=>[u("div",bt,[l(g,{size:"2em",name:"sentiment_dissatisfied"}),e[32]||(e[32]=u("span",null,"Aucun élève trouvé.",-1)),!k.value&&!$.value&&!T(i).screen.lt.md?(o(),d(w,{key:0,label:"Générer Liste?",color:"primary",size:"sm",onClick:me,loading:$.value,disable:!n.value||$.value,outline:"",dense:""},null,8,["loading","disable"])):f("",!0),!k.value&&!$.value&&T(i).screen.lt.md?(o(),d(w,{key:1,label:"Générer Liste?",color:"primary",size:"sm",onClick:me,loading:$.value,disable:!n.value||$.value,unelevated:"",class:"mt-sm"},null,8,["loading","disable"])):f("",!0)])]),loading:s(()=>[l(_e,{showing:"",color:"primary"})]),_:1},8,["rows","loading","grid"])])]),_:1}),l(Le,{name:"staff",class:"q-pa-none pt-2"},{default:s(()=>[u("div",ht,[u("div",kt,[u("div",wt,[l(fe,{modelValue:G.value,"onUpdate:modelValue":e[7]||(e[7]=t=>G.value=t),label:"Rechercher un membre du personnel...",filled:"",dense:"",clearable:"",debounce:"300",disable:!n.value||k.value},{prepend:s(()=>[l(g,{name:"search"})]),_:1},8,["modelValue","disable"])]),u("div",xt,[$e.value.items.length>0&&!T(i).screen.lt.md?(o(),d(ze,{key:0,"report-component":T(ye),"report-data":$e.value,"report-component-styles":[{url:"/reports/base.css"}],"pdf-filename-prefix":"Canteen_Staff_ToServe",class:"inline-block",dense:""},null,8,["report-component","report-data"])):f("",!0),l(w,{flat:"",round:"",dense:"",icon:"qr_code_scanner",onClick:da,disable:!n.value},{default:s(()=>[l(h,null,{default:s(()=>e[33]||(e[33]=[p("Scanner")])),_:1})]),_:1},8,["disable"])])]),l(qe,{rows:ke.value,columns:Ie,"row-key":"id",dense:"",flat:"",bordered:"",loading:k.value,pagination:{rowsPerPage:15},"rows-per-page-options":[15,30,50,0],grid:T(i).screen.lt.md},{"body-cell-payed":s(t=>[l(F,{props:t,class:"text-center"},{default:s(()=>[l(ue,{color:t.value?"positive":"warning",label:t.value?"Payé":"Non Payé"},null,8,["color","label"]),t.value&&t.row.payed_at_display?(o(),b("div",St,_(t.row.payed_at_display),1)):f("",!0)]),_:2},1032,["props"])]),"body-cell-is_served":s(t=>[l(F,{props:t,class:"text-center"},{default:s(()=>[t.value?(o(),d(g,{key:0,name:"check_circle",color:"positive",size:"sm"},{default:s(()=>[l(h,null,{default:s(()=>[p("Servi "+_(t.row.served_at_display?`à ${t.row.served_at_display}`:""),1)]),_:2},1024)]),_:2},1024)):(o(),d(g,{key:1,name:"radio_button_unchecked",color:"grey-5",size:"sm"}))]),_:2},1032,["props"])]),"body-cell-actions":s(t=>[l(F,{props:t,class:"text-center q-gutter-x-xs"},{default:s(()=>[l(w,{flat:"",round:"",dense:"",color:"grey-7",icon:"person_search",onClick:m=>Q(t.row.idpers,!1),disable:!!S.value||!!V.value||!!D.value},{default:s(()=>[l(h,null,{default:s(()=>e[34]||(e[34]=[p("Vérifier Statut")])),_:1})]),_:2},1032,["onClick","disable"])]),_:2},1032,["props"])]),item:s(t=>[u("div",Ct,[l(j,{flat:"",bordered:"",onClick:m=>Q(t.row.idpers,!1)},{default:s(()=>[l(L,{class:"q-pa-sm"},{default:s(()=>[u("div",$t,[u("div",Et,[l(ne,{size:"36px"},{default:s(()=>[t.row.staff_photo_url?(o(),b("img",{key:0,src:t.row.staff_photo_url,onError:le},null,40,Pt)):(o(),d(g,{key:1,name:"badge",size:"36px",color:"grey-6"}))]),_:2},1024),u("div",At,[u("div",Vt,_(t.row.staff_name),1)])]),u("div",Dt,[t.row.is_served?(o(),d(g,{key:0,name:"check_circle",color:"positive",size:"sm"},{default:s(()=>[l(h,null,{default:s(()=>e[35]||(e[35]=[p("Déjà Servi")])),_:1})]),_:1})):(o(),d(g,{key:1,name:"radio_button_unchecked",color:"grey-5",size:"sm"},{default:s(()=>[l(h,null,{default:s(()=>e[36]||(e[36]=[p("Non servi")])),_:1})]),_:1}))])])]),_:2},1024),l(oe),l(L,{class:"q-pa-sm text-caption row items-center justify-between gap-x-sm"},{default:s(()=>[l(ue,{color:t.row.payed?"positive":"warning",label:t.row.payed?"Payé":"Non Payé"},{default:s(()=>[t.row.payed&&t.row.payed_at_display?(o(),d(h,{key:0},{default:s(()=>[p("Payé le "+_(t.row.payed_at_display),1)]),_:2},1024)):f("",!0)]),_:2},1032,["color","label"]),t.row.is_served&&t.row.served_at_display?(o(),b("div",Qt," Servi à "+_(t.row.served_at_display),1)):f("",!0),u("div",qt,[p(_(t.row.tarif?.toFixed(2)||"0.00")+" ",1),e[37]||(e[37]=u("span",{class:"text-xs"},"MAD",-1))])]),_:2},1024)]),_:2},1032,["onClick"])])]),"no-data":s(()=>[u("div",Lt,[l(g,{size:"2em",name:"sentiment_dissatisfied"}),e[38]||(e[38]=u("span",null,"Aucun ticket personnel trouvé.",-1))])]),loading:s(()=>[l(_e,{showing:"",color:"primary"})]),_:1},8,["rows","loading","grid"])])]),_:1})]),_:1},8,["modelValue"])]),_:1})):f("",!0),l(_e,{showing:B.value},{default:s(()=>[l(Va,{size:"50px",color:"primary"})]),_:1},8,["showing"])]),_:1}),l(pe,{modelValue:X.value,"onUpdate:modelValue":e[11]||(e[11]=t=>X.value=t),maximized:"","transition-show":"slide-left","transition-hide":"slide-right",onHide:e[12]||(e[12]=t=>se(!1))},{default:s(()=>[T(i).platform.is.cordova?(o(),d(qa,{key:0,onStudentSelected:e[9]||(e[9]=t=>te(t,!0))})):(o(),d(Ta,{key:1,onStudentSelected:e[10]||(e[10]=t=>te(t,!0))}))]),_:1},8,["modelValue"]),l(pe,{modelValue:Z.value,"onUpdate:modelValue":e[14]||(e[14]=t=>Z.value=t),maximized:"","transition-show":"slide-left","transition-hide":"slide-right",onHide:e[15]||(e[15]=t=>se(!1))},{default:s(()=>[T(i).platform.is.cordova?(o(),d(La,{key:0,onStaffSelected:e[13]||(e[13]=t=>te(t,!0))})):f("",!0)]),_:1},8,["modelValue"]),l(pe,{modelValue:I.value,"onUpdate:modelValue":e[17]||(e[17]=t=>I.value=t)},{default:s(()=>[l(j,{style:{width:"90vw","max-width":"600px"}},{default:s(()=>[l(L,null,{default:s(()=>e[39]||(e[39]=[u("div",{class:"text-h6"},"Rechercher Personne",-1)])),_:1}),l(L,{class:"q-pt-none"},{default:s(()=>[l(fe,{modelValue:z.value,"onUpdate:modelValue":[e[16]||(e[16]=t=>z.value=t),va],label:"Nom ou prénom",filled:"",dense:"",autofocus:"",debounce:"300",loading:U.value},{prepend:s(()=>[l(g,{name:"search"})]),_:1},8,["modelValue","loading"]),M.value.length>0?(o(),d(Da,{key:0,bordered:"",separator:"",class:"mt-md max-h-[50vh] overflow-y-auto"},{default:s(()=>[(o(!0),b(xa,null,Sa(M.value,t=>Ve((o(),d(ge,{key:t.idpers,clickable:"",onClick:m=>ma(t)},{default:s(()=>[l(K,{avatar:""},{default:s(()=>[l(ne,{size:"md"},{default:s(()=>[t.photo_url?(o(),b("img",{key:0,src:t.photo_url,onError:le},null,40,Tt)):(o(),d(g,{key:1,name:"person",size:"md",color:"grey"}))]),_:2},1024)]),_:2},1024),l(K,null,{default:s(()=>[l(Te,{class:"text-body2"},{default:s(()=>[p(_(t.nom_complet),1)]),_:2},1024),l(Te,{caption:""},{default:s(()=>[p(_(Pe(t.type))+" "+_(t.type==="ELEV"?`(${t.classe_name||"N/A"})`:""),1)]),_:2},1024)]),_:2},1024),l(K,{side:"",top:""},{default:s(()=>[l(g,{name:"chevron_right"})]),_:1})]),_:2},1032,["onClick"])),[[Ca]])),128))]),_:1})):z.value&&!U.value?(o(),b("div",zt,'Aucun résultat pour "'+_(z.value)+'".',1)):f("",!0)]),_:1}),l(Ae,{align:"right"},{default:s(()=>[Ve(l(w,{flat:"",label:"Fermer",color:"primary"},null,512),[[Qa]])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}},Cs=pa(Mt,[["__scopeId","data-v-ccda7875"]]);export{Cs as default};
