import{aP as he,B as ae,A as u,Y as G,N as v,C as we,ag as Ce,a4 as c,S as o,a5 as s,a6 as n,aE as H,ad as g,ay as W,a8 as y,Q as x,b7 as ke,a9 as le,aa as Se,R as D,ab as d,a3 as b,ah as se,aD as te,af as Ae,av as T,aF as ne,a2 as Y,aZ as Ve,a_ as xe,aG as re,a7 as De,aC as Qe,a as h}from"./index-Bl2lQPd7.js";import{Q as A}from"./QItemLabel-BkJiB6aE.js";import{Q as Z,a as j}from"./QItem-De3v03wU.js";import{Q as $e}from"./QList-CMzNTEGD.js";import{Q as Ee}from"./QToolbarTitle-C8APieXG.js";import{Q as qe}from"./QToolbar-DR-_wX4W.js";import{Q as Fe}from"./QDate-C_jC-zMt.js";import{Q as Me}from"./QPopupProxy-CQ30ymZI.js";import{Q as Ne}from"./QSelect-DchnWyXK.js";import{C as B}from"./ClosePopup-BY_YGFBZ.js";import{u as Le}from"./composables-CAkrP3jA.js";import{p as J,g as Ue}from"./index-DAmqNgqn.js";import{f as oe,i as K}from"./index-C9ZTL5MN.js";import"./use-render-cache-DLxPkVnQ.js";import"./use-datetime-hbLWgGn4.js";import"./date-C1Mon-Jj.js";import"./format-IcNrutKL.js";import"./QMenu-BNr9Tzvf.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./QChip-C9OfA2gn.js";import"./rtl-DFPa-2ov.js";import"./index-QVwDN08p.js";import"./index-CbPSoDvq.js";import"./index-BXMW6yyY.js";const Pe={key:0,class:"q-mb-md bg-red-1 q-pa-md rounded-borders text-negative"},ze={key:1,class:"q-gutter-md"},Re={class:"q-mt-md"},Te={key:0,class:"text-center q-pa-md"},Ye={key:1,class:"text-center text-grey-6 q-pa-md"},je={key:0},Be={key:1,class:"text-negative"},Ie={key:0},Oe={key:1},Ge={class:"row items-center q-gutter-xs"},He={class:"row items-center justify-end"},We={key:0,class:"text-grey"},Ze={key:0},Je={key:0},Ke={key:1},Xe={key:2},ea={key:0,class:"text-grey"},aa={key:1},Da={__name:"Index",setup(la){const{setTitle:ie}=Le(),ue=he(),Q=ae(()=>ue.getters["user/current"]?.annee),w=u({classes:!1,matieres:!1,professors:!1,cancellingUsers:!1}),I=u(!1),$=u(!1),F=u(!1),M=u(!1),k=u({date_from:null,date_to:null,annee_id:null,classe_id:null,matiere_id:null,professor_id:null,is_compensated:null}),N=u([]),L=u([]),U=u([]),P=u([]),S=u([]),E=u(!1),m=u("add"),i=u({id:null,emploi_classe_id:null,date_cancellation:null,reason:null,is_compensated:!1,compensation_notes:null}),C=u(null),p=u([]),_=u([]),q=u(""),z=u(!1),R=u(null),X=ae(()=>{const a=i.value?.emploi_classe;if(!a)return"Chargement...";const e=a.classe?.bref||"N/A",r=a.matiere?.bref||"N/A",l=V(a.debut),t=V(a.fin);return`${ee(i.value.date_cancellation)}: ${e} - ${r} (${l} - ${t})`}),ee=a=>{if(!a)return"";const e=J(a);return K(e)?oe(e,"dd/MM/yyyy"):a},ce=a=>{if(!a)return"";const e=J(a);return K(e)?oe(e,"dd/MM/yyyy HH:mm"):(console.warn("parseISO failed for:",a),a)},V=a=>{if(a==null)return"";const e=Math.floor(a/100),r=a%100;return`${String(e).padStart(2,"0")}:${String(r).padStart(2,"0")}`},de=async a=>{if(a){w.value.classes=!0;try{const{data:e}=await h("get",`/filters/classes/${a}`);e?.status==="success"&&Array.isArray(e.data)?N.value=e.data.map(r=>({idclasse:r.idclasse,classe_fr:r.classe_fr||r.name,bref:r.bref})):(N.value=[],console.error("Failed to fetch classes:",e?.message))}catch(e){console.error("Error fetching classes:",e),N.value=[]}finally{w.value.classes=!1}w.value.matieres=!0;try{const{data:e}=await h("get","/filters/matieres/"+a);e?.status==="success"&&Array.isArray(e.data)?L.value=e.data.filter(r=>r.active===1):(L.value=[],console.error("Failed to fetch matieres:",e?.message))}catch(e){console.error("Error fetching matieres:",e),L.value=[]}finally{w.value.matieres=!1}w.value.professors=!0;try{const{data:e}=await h("get","/filters/professors/"+a);e?.status==="success"&&Array.isArray(e.data)?U.value=e.data.map(r=>({idpers:r.idpers,nom_complet:`${r.nom} ${r.prenom}`})):(U.value=[],console.error("Failed to fetch professors:",e?.message))}catch(e){console.error("Error fetching professors:",e),U.value=[]}finally{w.value.professors=!1}w.value.cancellingUsers=!0;try{const{data:e}=await h("get","/cancelled-sessions/users");e?.status==="success"&&Array.isArray(e.data)?P.value=e.data:(P.value=[],console.error("Failed to fetch cancelling users:",e?.message))}catch(e){console.error("Error fetching cancelling users:",e),P.value=[]}finally{w.value.cancellingUsers=!1}}},O=async()=>{const a=Q.value?.idannee;if(!a){S.value=[];return}I.value=!0,k.value.annee_id=a;try{const{data:e}=await h("get","/cancelled-sessions",{params:k.value});e?.status==="success"&&Array.isArray(e.data)?S.value=e.data:(S.value=[],v.create({type:"warning",message:e?.message||"Impossible de charger la liste des séances annulées."}))}catch(e){console.error("Error fetching cancelled sessions:",e),S.value=[],v.create({type:"negative",message:`Erreur lors du chargement des annulations : ${e.message||"Erreur inconnue"}`})}finally{I.value=!1}},me=async()=>{const a=Q.value?.idannee,e=i.value.date_cancellation;if(!a||!e){p.value=[],_.value=[];return}$.value=!0;let r=null;try{const t=J(e);if(K(t))r=Ue(t);else{console.error("Invalid date for day calculation:",e),$.value=!1,p.value=[],_.value=[];return}}catch(t){console.error("Error parsing date for day calculation:",t),$.value=!1,p.value=[],_.value=[];return}const l={annee_id:a,jour:r};try{const{data:t}=await h("get","/cancelled-sessions/schedulable",{params:l});t?.status==="success"&&Array.isArray(t.data)?(p.value=t.data.map(f=>(f.display_text=`${f.classe?.bref||"N/A"} - ${f.matiere?.bref||"N/A"} (${V(f.debut)} - ${V(f.fin)})`,f.details_text=`Salle: ${f.salle?.bref||"N/A"}, ID: ${f.id}`,f)),_.value=[...p.value]):(p.value=[],_.value=[],console.error("Failed to fetch schedulable sessions:",t?.message))}catch(t){console.error("Error fetching schedulable sessions:",t),p.value=[],_.value=[],v.create({type:"negative",message:`Erreur lors du chargement des séances planifiées : ${t.message||"Erreur inconnue"}`})}finally{$.value=!1}},fe=(a,e)=>{if(q.value=a,console.log("Filtering sessions with input:",a,p.value),a===null||a===""){e(()=>{_.value=[...p.value]});return}e(()=>{const r=a.toLowerCase(),l=p.value.filter(t=>t.display_text.toLowerCase().includes(r)||t.details_text.toLowerCase().includes(r)||t.classe?.classe_fr&&t.classe.classe_fr.toLowerCase().includes(r)||t.classe?.bref&&t.classe.bref.toLowerCase().includes(r)||t.matiere?.matiere_fr&&t.matiere.matiere_fr.toLowerCase().includes(r)||t.matiere?.bref&&t.matiere.bref.toLowerCase().includes(r)||t.salle?.salle&&t.salle.salle.toLowerCase().includes(r)||t.salle?.bref&&t.salle.bref.toLowerCase().includes(r));_.value=l})},pe=()=>{i.value={id:null,emploi_classe_id:null,date_cancellation:null,reason:null,is_compensated:!1,compensation_notes:null},C.value=null,p.value=[],_.value=[],q.value=""},ve=()=>{pe(),m.value="add",E.value=!0},_e=a=>{const e={...a,is_compensated:!!a.is_compensated};i.value=e,m.value="edit",C.value=null,p.value=[],_.value=[],E.value=!0},ge=a=>{R.value=a,z.value=!0},ye=async()=>{if(R.value?.id){M.value=!0;try{const{data:a}=await h("delete",`/cancelled-sessions/${R.value.id}`);a?.status==="success"?(v.create({type:"success",message:a.message}),O()):v.create({type:"negative",message:a?.message||"Échec de la suppression de l'annulation."})}catch(a){console.error("Error deleting cancellation:",a),v.create({type:"negative",message:`Échec de la suppression de l'annulation : ${a.message||"Erreur inconnue"}`})}finally{M.value=!1,z.value=!1,R.value=null}}},be=async()=>{if(!i.value.date_cancellation||m.value==="add"&&!C.value){v.create({type:"warning",message:"Veuillez remplir les champs requis (Date, Séance)."});return}F.value=!0;try{let a;const e={...i.value};if(m.value==="add"?(e.emploi_classe_id=C.value?.id,e.is_compensated=!!e.is_compensated,a=await h("post","/cancelled-sessions",e)):(delete e.emploi_classe_id,delete e.date_cancellation,e.is_compensated=!!e.is_compensated,a=await h("put",`/cancelled-sessions/${i.value.id}`,e)),a?.data?.status==="success")v.create({type:"success",message:a.data.message}),E.value=!1,O();else{const r=a?.data?.message||a?.message||"Une erreur est survenue.",l=a?.data?.errors;if(l){let t="";for(const f in l)t+=`${f}: ${l[f].join(", ")}
`;v.create({type:"negative",message:`Erreur de validation:
${t}`,multiLine:!0})}else v.create({type:"negative",message:r})}}catch(a){console.error("Error saving cancellation:",a),v.create({type:"negative",message:`Échec de l'enregistrement de l'annulation : ${a.message||"Erreur inconnue"}`})}finally{F.value=!1}};return G(()=>Q.value?.idannee,a=>{a&&a>0?(console.log(`Year changed to ${a}. Fetching filters and cancelled sessions.`),k.value.classe_id=null,k.value.matiere_id=null,k.value.professor_id=null,k.value.is_compensated=null,de(a),O()):(k.value={date_from:null,date_to:null,annee_id:null,classe_id:null,matiere_id:null,professor_id:null,is_compensated:null},N.value=[],L.value=[],U.value=[],P.value=[],S.value=[],v.create({type:"warning",message:"Aucune année scolaire sélectionnée."}))},{immediate:!0}),G(()=>i.value.date_cancellation,(a,e)=>{m.value==="add"&&a!==e&&(me(),C.value=null,q.value="")}),G(C,a=>{m.value==="add"&&(i.value.emploi_classe_id=a?.id||null)}),we(()=>{ie("Gestion des Séances Annulées")}),(a,e)=>{const r=Ce("ep-footer");return o(),c(le,null,[s(Qe,{class:"page-content"},{default:n(()=>[s(H,{flat:""},{default:n(()=>[Q.value?.idannee?(o(),c("div",ze,[e[12]||(e[12]=y("div",{class:"row justify-between items-center q-mt-md"},[y("div",{class:"p-6"})],-1)),y("div",Re,[I.value?(o(),c("div",Te,[s(ke,{color:"primary",size:"3em"}),e[9]||(e[9]=y("div",null,"Chargement des annulations...",-1))])):S.value.length===0?(o(),c("div",Ye,[s(W,{name:"event_busy",size:"2em"}),e[10]||(e[10]=y("div",{class:"q-mt-sm"},"Aucune séance annulée trouvée pour les filtres appliqués.",-1))])):(o(),x($e,{key:2,bordered:"",separator:""},{default:n(()=>[(o(!0),c(le,null,Se(S.value,l=>(o(),x(Z,{key:l.id,class:"q-py-sm"},{default:n(()=>[s(j,null,{default:n(()=>[s(A,{class:"text-bold"},{default:n(()=>[g(d(ee(l.date_cancellation))+" - ",1),l.emploi_classe?(o(),c("span",je,d(l.emploi_classe.classe?.bref||"N/A")+" - "+d(l.emploi_classe.matiere?.bref||"N/A")+" ("+d(V(l.emploi_classe.debut))+" - "+d(V(l.emploi_classe.fin))+") ",1)):(o(),c("span",Be,"(Séance planifiée non trouvée)"))]),_:2},1024),l.reason?(o(),x(A,{key:0,caption:""},{default:n(()=>[g(" Raison: "+d(l.reason),1)]),_:2},1024)):D("",!0),s(A,{caption:""},{default:n(()=>[e[11]||(e[11]=g(" Annulé(e) par: ")),l.cancelled_by?(o(),c("span",Ie,d(l.cancelled_by.nom)+" "+d(l.cancelled_by.prenom),1)):(o(),c("span",Oe,"-"))]),_:2},1024),s(A,{caption:""},{default:n(()=>[g(" Déclaré le: "+d(ce(l.created_at)),1)]),_:2},1024),l.is_compensated&&l.compensation_notes?(o(),x(A,{key:1,caption:""},{default:n(()=>[g(" Notes Rémunération: "+d(l.compensation_notes),1)]),_:2},1024)):D("",!0)]),_:2},1024),s(j,{side:""},{default:n(()=>[y("div",Ge,[s(b,{flat:"",dense:"",icon:"edit",color:"primary",onClick:se(t=>_e(l),["stop"]),title:"Modifier"},null,8,["onClick"]),s(b,{flat:"",dense:"",icon:"delete",color:"negative",onClick:se(t=>ge(l),["stop"]),title:"Supprimer"},null,8,["onClick"])])]),_:2},1024)]),_:2},1024))),128))]),_:1}))])])):(o(),c("div",Pe,[s(W,{name:"warning",color:"negative",class:"q-mr-sm"}),e[8]||(e[8]=g(" Veuillez sélectionner une année scolaire dans le menu de navigation pour gérer les séances annulées. "))]))]),_:1}),s(te,{modelValue:E.value,"onUpdate:modelValue":e[6]||(e[6]=l=>E.value=l),persistent:""},{default:n(()=>[s(H,{style:{"min-width":"400px"}},{default:n(()=>[s(qe,{class:Ae({"bg-secondary":!0,"text-white":!0,"shadow-2":!0})},{default:n(()=>[T(s(b,{flat:"",dense:"",icon:"arrow_back"},null,512),[[B]]),s(Ee,null,{default:n(()=>[g(d(m.value==="add"?"Déclarer une Annulation":"Modifier Annulation"),1)]),_:1})]),_:1}),s(ne,{class:"q-gutter-md"},{default:n(()=>[y("div",null,[s(Y,{filled:"",dense:"",modelValue:i.value.date_cancellation,"onUpdate:modelValue":e[1]||(e[1]=l=>i.value.date_cancellation=l),label:"Date de l'annulation",disable:m.value==="edit",rules:[l=>!!l||"Date requise"]},{append:n(()=>[s(W,{name:"event",class:"cursor-pointer"},{default:n(()=>[s(Me,{cover:"","transition-show":"scale","transition-hide":"scale",disable:m.value==="edit"},{default:n(()=>[s(Fe,{modelValue:i.value.date_cancellation,"onUpdate:modelValue":e[0]||(e[0]=l=>i.value.date_cancellation=l),mask:"YYYY-MM-DD",minimal:""},{default:n(()=>[y("div",He,[T(s(b,{label:"Fermer",color:"primary",flat:""},null,512),[[B]])])]),_:1},8,["modelValue"])]),_:1},8,["disable"])]),_:1})]),_:1},8,["modelValue","disable","rules"]),m.value==="add"?(o(),c("small",We,"Sélectionnez la date de la séance annulée.")):D("",!0)]),m.value==="add"?(o(),c("div",Ze,[s(Ne,{filled:"",dense:"",modelValue:C.value,"onUpdate:modelValue":e[2]||(e[2]=l=>C.value=l),options:_.value,label:"Séance Planifiée à Annuler","option-label":"display_text","return-value":"",loading:$.value,rules:[l=>!!l||"Séance requise"],onFilter:fe,"use-input":"","hide-selected":"","fill-input":""},{option:n(l=>[s(Z,Ve(xe(l.itemProps)),{default:n(()=>[s(j,null,{default:n(()=>[s(A,null,{default:n(()=>[g(d(l.opt.display_text),1)]),_:2},1024),s(A,{caption:""},{default:n(()=>[g(d(l.opt.details_text),1)]),_:2},1024)]),_:2},1024)]),_:2},1040)]),"no-option":n(()=>[s(Z,null,{default:n(()=>[s(j,{class:"text-grey"},{default:n(()=>[i.value.date_cancellation?q.value?(o(),c("span",Ke,'Aucune séance planifiée correspondante pour la date et le filtre "'+d(q.value)+'"',1)):(o(),c("span",Xe,"Entrez la classe, matière ou prof pour filtrer les séances planifiées à cette date.")):(o(),c("span",Je,"Veuillez d'abord sélectionner une date."))]),_:1})]),_:1})]),_:1},8,["modelValue","options","loading","rules"]),i.value.date_cancellation&&m.value==="add"?(o(),c("small",ea," Filtrer par classe, matière, salle ou prof pour trouver la séance. ")):D("",!0)])):(o(),c("div",aa,[s(Y,{filled:"",dense:"",modelValue:X.value,"onUpdate:modelValue":e[3]||(e[3]=l=>X.value=l),label:"Séance Annulée",disable:"",readonly:""},null,8,["modelValue"])])),s(Y,{filled:"",dense:"",modelValue:i.value.reason,"onUpdate:modelValue":e[4]||(e[4]=l=>i.value.reason=l),label:"Raison de l'annulation",type:"textarea",autogrow:""},null,8,["modelValue"]),i.value.is_compensated?(o(),x(Y,{key:2,filled:"",dense:"",modelValue:i.value.compensation_notes,"onUpdate:modelValue":e[5]||(e[5]=l=>i.value.compensation_notes=l),label:"Notes de rémunération/compensation",type:"textarea",autogrow:""},null,8,["modelValue"])):D("",!0)]),_:1}),s(re,{align:"right",class:"text-primary"},{default:n(()=>[T(s(b,{flat:"",label:"Annuler",disable:F.value},null,8,["disable"]),[[B]]),s(b,{flat:"",label:m.value==="add"?"Déclarer":"Modifier",onClick:be,loading:F.value},null,8,["label","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(te,{modelValue:z.value,"onUpdate:modelValue":e[7]||(e[7]=l=>z.value=l),persistent:""},{default:n(()=>[s(H,null,{default:n(()=>[s(ne,{class:"row items-center"},{default:n(()=>[s(De,{icon:"warning",color:"negative","text-color":"white"}),e[13]||(e[13]=y("span",{class:"q-ml-sm"},"Êtes-vous sûr de vouloir supprimer cette annulation ? Cette action est irréversible.",-1))]),_:1}),s(re,{align:"right"},{default:n(()=>[T(s(b,{flat:"",label:"Annuler",color:"primary",disable:M.value},null,8,["disable"]),[[B]]),s(b,{flat:"",label:"Supprimer",color:"negative",onClick:ye,loading:M.value},null,8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),s(r,{to:"#footer-portal"},{default:n(()=>[Q.value?(o(),x(b,{key:0,flat:"",label:"Déclarer une Annulation",icon:"add_circle",onClick:ve})):D("",!0)]),_:1})],64)}}};export{Da as default};
