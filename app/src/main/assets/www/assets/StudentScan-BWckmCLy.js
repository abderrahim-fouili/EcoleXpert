import{aO as A,aP as F,A as i,B as w,C as M,bv as U,Q as x,S as u,a6 as s,a5 as a,av as C,a3 as m,ad as v,aF as h,R as q,a4 as b,a8 as r,aD as $,aE as _,af as k,ab as G,ay as H,aS as O,ax as W}from"./index-Bl2lQPd7.js";import{Q as j}from"./QToolbarTitle-C8APieXG.js";import{Q as y}from"./QTooltip-r7WoEuzy.js";import{Q as J}from"./QToolbar-DR-_wX4W.js";import{Q as K}from"./QSpace-CKKoNTi_.js";import{Q as X}from"./QBanner-xBGiroIy.js";import{Q as Y}from"./QBtnGroup-CdugIB7Z.js";import{Q as Z}from"./QSpinnerDots-BW9ZsFNG.js";import{C as E}from"./ClosePopup-BY_YGFBZ.js";const ee={key:1,class:"camera-controls qrscanner"},ae={key:0,class:"scan-status bg-transparent"},se={key:2,class:"text-center q-mt-lg text-white qrscanner"},ve={__name:"StudentScan",emits:["student-selected"],setup(re,{emit:B}){const z=B,d=A(),f=F(),l=i(""),o=i("error"),p=i(!1),g=i(!1),c=i(!1),Q=i(!1),D=w(()=>f.getters["user/current"].annee),L=w(()=>f.getters["ecole/id"]),V=async()=>{await f.dispatch("ecole/getId")},I=n=>{let e="EP-"+L.value+"-PERS-";return n.startsWith(e)?n.substring(e.length):null};function N(){p.value=!p.value,p.value?QRScanner.useFrontCamera():QRScanner.useBackCamera()}function P(){g.value=!g.value,g.value?QRScanner.enableLight():QRScanner.disableLight()}function S(){QRScanner.destroy(()=>{}),c.value=!1,document.body.classList.remove("ecp-scanner")}async function T(){l.value="",d.platform.is.cordova&&(d.platform.is.ios&&QRScanner.prepare((n,e)=>{n&&(console.error(n),l.value="Erreur de préparation du scanner",o.value="error"),e.authorized||(l.value="Accès à la caméra non autorisé",o.value="error")}),QRScanner.scan(async(n,e)=>{if(c.value=!1,n){l.value="Erreur de scan: "+n._message,o.value="error",console.error(n._message);return}try{const t=I(e);if(console.log("studentId",t),isNaN(t)||!t)throw new Error("Code QR invalide");const R=await f.dispatch("user/getData",{page:1,filter:{id:t,with_eleve_classe:D.value.idannee}});if(R.data?.data?.[0])z("student-selected",R.data.data[0]),S();else throw new Error("Élève non trouvé")}catch(t){l.value=t.message||"Erreur lors de la lecture du code QR",o.value="error"}}),c.value=!0,document.body.classList.add("ecp-scanner"),QRScanner.show())}return M(async()=>{d.platform.is.cordova&&(await V(),T())}),U(()=>{d.platform.is.cordova&&S()}),(n,e)=>(u(),x(_,{class:"student-scan-card"},{default:s(()=>[a(J,{class:"bg-primary text-white qrscanner"},{default:s(()=>[C(a(m,{flat:"",round:"",dense:"",icon:"arrow_back",class:"qrscanner"},null,512),[[E]]),a(j,{class:"qrscanner"},{default:s(()=>e[2]||(e[2]=[v("Scanner le code QR de l'élève")])),_:1}),a(m,{flat:"",round:"",dense:"",icon:"help",onClick:e[0]||(e[0]=t=>Q.value=!0),class:"qrscanner"},{default:s(()=>[a(y,{class:"qrscanner"},{default:s(()=>e[3]||(e[3]=[v("Aide")])),_:1})]),_:1})]),_:1}),a(h,{class:"scanner-container qrscanner"},{default:s(()=>[a($,{modelValue:Q.value,"onUpdate:modelValue":e[1]||(e[1]=t=>Q.value=t),class:"qrscanner"},{default:s(()=>[a(_,{style:{width:"300px"}},{default:s(()=>[a(h,{class:"row items-center qrscanner"},{default:s(()=>[e[4]||(e[4]=r("div",{class:"text-h6 qrscanner"},"Comment scanner ?",-1)),a(K,{class:"qrscanner"}),C(a(m,{icon:"close",flat:"",round:"",dense:"",class:"qrscanner"},null,512),[[E]])]),_:1}),a(h,{class:"q-pt-none qrscanner"},{default:s(()=>e[5]||(e[5]=[r("ol",{class:"text-body1 qrscanner"},[r("li",{class:"q-mb-sm qrscanner"},"Assurez-vous que le code QR est bien visible"),r("li",{class:"q-mb-sm qrscanner"},"Centrez le code QR dans le cadre"),r("li",{class:"q-mb-sm qrscanner"},"Maintenez votre appareil stable"),r("li",{class:"qrscanner"},"Le scan se fera automatiquement")],-1)])),_:1})]),_:1})]),_:1},8,["modelValue"]),l.value?(u(),x(X,{key:0,class:k([o.value==="error"?"bg-negative":"bg-positive","text-white banner-animation qrscanner"]),rounded:""},{avatar:s(()=>[a(H,{name:o.value==="error"?"error":"check_circle",class:"qrscanner"},null,8,["name"])]),default:s(()=>[v(" "+G(l.value),1)]),_:1},8,["class"])):q("",!0),O(d).platform.is.cordova?(u(),b("div",ee,[a(Y,{rounded:"",class:"bg-dark"},{default:s(()=>[a(m,{flat:"",color:p.value?"primary":"grey-7",icon:"camera_front",onClick:N,class:"qrscanner"},{default:s(()=>[a(y,{class:"qrscanner"},{default:s(()=>e[6]||(e[6]=[v("Changer de caméra")])),_:1})]),_:1},8,["color"]),a(W,{vertical:"",class:""}),a(m,{flat:"",color:g.value?"primary":"grey-7",icon:"flashlight_on",onClick:P,class:"qrscanner"},{default:s(()=>[a(y,{class:"qrscanner"},{default:s(()=>e[7]||(e[7]=[v("Activer/Désactiver la lampe")])),_:1})]),_:1},8,["color"])]),_:1})])):q("",!0),r("div",{class:k(["scanner-area qrscanner",{"hide-scanner":!c.value}])},[e[9]||(e[9]=r("div",{class:"scan-region qrscanner"},[r("div",{class:"scan-region-highlight qrscanner"},[r("div",{class:"corner-highlight top-left qrscanner"}),r("div",{class:"corner-highlight top-right qrscanner"}),r("div",{class:"corner-highlight bottom-left qrscanner"}),r("div",{class:"corner-highlight bottom-right qrscanner"}),r("div",{class:"scanning-line qrscanner"})])],-1)),c.value?(u(),b("div",ae,[a(Z,{color:"primary",size:"40px",class:"qrscanner"}),e[8]||(e[8]=r("div",{class:"text-subtitle1 text-grey-8 q-mt-sm qrscanner"},"Recherche de code QR...",-1))])):q("",!0)],2),c.value?q("",!0):(u(),b("div",se,e[10]||(e[10]=[r("div",{class:"text-subtitle1"},"Placez le code QR dans le cadre",-1),r("div",{class:"text-caption"},"Le scan démarrera automatiquement",-1)])))]),_:1})]),_:1}))}};export{ve as _};
