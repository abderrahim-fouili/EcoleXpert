import{aO as le,a4 as v,S as r,a5 as s,a6 as n,Q as y,R as x,ax as oe,a9 as k,aa as z,af as K,ad as h,ab as m,d4 as W,aS as Q,_ as fe,aP as ve,A as N,B as D,C as ye,Y as ge,ag as _e,a8 as d,a7 as C,ay as S,aE as R,aD as he,av as X,a3 as V,aF as xe,aG as be,aC as we,aB as ee,b8 as Se}from"./index-Bl2lQPd7.js";import{Q as O,a as b}from"./QItem-De3v03wU.js";import{Q as T}from"./QItemLabel-BkJiB6aE.js";import{Q as G}from"./QTooltip-r7WoEuzy.js";import{Q as Qe}from"./QToolbarTitle-C8APieXG.js";import{Q as ke}from"./QToolbar-DR-_wX4W.js";import{Q as B}from"./QList-CMzNTEGD.js";import{Q as qe}from"./QScrollArea-DbARZhEV.js";import{Q as Pe}from"./QSpinnerGears-DmolwAR1.js";import{Q as Ee}from"./QInnerLoading-WxvcYHvS.js";import{Q as De}from"./QBadge-Bjfo5tRO.js";import{C as te}from"./ClosePopup-BY_YGFBZ.js";import{u as Ve}from"./composables-CAkrP3jA.js";import{a as ae,Q as Ce}from"./QTabs-yl5EIOig.js";import{Q as se}from"./QChip-C9OfA2gn.js";import{a as ne,Q as Te}from"./QTabPanels-Bqg1c7oo.js";import{Q as ze}from"./QExpansionItem-EMhshZ_3.js";import{f as Ue}from"./index-C9ZTL5MN.js";import"./position-engine-o8Q2RudZ.js";import"./selection-DaBtDCZ0.js";import"./TouchPan-jBhMORlX.js";import"./touch-BjYP5sR0.js";import"./format-IcNrutKL.js";import"./rtl-DFPa-2ov.js";import"./TouchSwipe-jpsGI2FR.js";import"./use-render-cache-DLxPkVnQ.js";import"./QSlideTransition-CrdUnXBf.js";import"./index-BXMW6yyY.js";import"./index-CbPSoDvq.js";const Ae={__name:"ServiceList",props:{eleve:{type:Object,required:!0},paiement:{type:Object,required:!0},isCheckboxDisabled:{type:Function,required:!0},formatPrice:{type:Function,required:!0},formatMois:{type:Function,required:!0}},setup(p){le();const w=p,c=Ue(new Date,"yyyyMM");console.log(w.paiement,w.eleve);const U=()=>{};return(q,g)=>(r(),v(k,null,[s(Ce,{modelValue:p.eleve.activeTab,"onUpdate:modelValue":g[0]||(g[0]=l=>p.eleve.activeTab=l),dense:"",class:"text-grey","active-color":"primary","indicator-color":"primary",align:"left","narrow-indicator":"",breakpoint:"0"},{default:n(()=>[p.paiement?.service_annuel?.length?(r(),y(ae,{key:0,name:"annual",label:"Services Annuels"})):x("",!0),s(ae,{name:"monthly",label:"Services Mensuels"})]),_:1},8,["modelValue"]),s(oe),s(Te,{modelValue:p.eleve.activeTab,"onUpdate:modelValue":g[1]||(g[1]=l=>p.eleve.activeTab=l),animated:""},{default:n(()=>[s(ne,{name:"annual",class:"q-pa-none"},{default:n(()=>[s(B,null,{default:n(()=>[(r(!0),v(k,null,z(p.paiement.service_annuel,l=>(r(),y(O,{key:l.id,class:K(["service-item",{"text-positive":l.a_payer===0,"text-negative":l.a_payer>0,"bg-green-1":l.a_payer===0,"bg-red-1":l.a_payer>0}])},{default:n(()=>[s(b,null,{default:n(()=>[s(T,{class:"text-subtitle1"},{default:n(()=>[h(m(l.designation),1)]),_:2},1024),s(T,{caption:""},{default:n(()=>[s(se,{color:l.a_payer===0?"positive":"negative",icon:l.a_payer===0?"check_circle":"pending",size:"sm",outline:""},{default:n(()=>[h(m(l.a_payer===0?"Payé":`${p.formatPrice(l.a_payer)} DH`),1)]),_:2},1032,["color","icon"])]),_:2},1024)]),_:2},1024),l.a_payer>0?(r(),y(b,{key:0,side:""},{default:n(()=>[s(W,{modelValue:l.selected,"onUpdate:modelValue":[o=>l.selected=o,U],color:"primary"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)):x("",!0)]),_:2},1032,["class"]))),128))]),_:1})]),_:1}),s(ne,{name:"monthly",class:"q-pa-none"},{default:n(()=>[s(B,null,{default:n(()=>[(r(!0),v(k,null,z(p.paiement.service_mensuel,l=>(r(),y(ze,{key:l.mois,label:p.formatMois(l.mois),caption:l.montant?`Total: ${p.formatPrice(l.montant)} DH`:"","default-opened":l.montant>0,icon:l.montant===0?"check_circle":"pending","dense-toggle":"",class:"month-item","header-class":{"month-header":!0,"text-positive":l.montant===0,"text-negative":l.montant>0&&l.mois<=Q(c),"bg-green-1":l.montant===0,"bg-red-1":l.montant>0&&l.mois<=Q(c),"text-blue-grey":l.montant>0&&l.mois>Q(c),"bg-blue-grey-1":l.montant>0&&l.mois>Q(c)}},{default:n(()=>[s(B,{padding:""},{default:n(()=>[(r(!0),v(k,null,z(l.services,o=>(r(),y(O,{key:o.id,class:K(["service-item",{"bg-grey-1":o.a_payer===0}])},{default:n(()=>[s(b,null,{default:n(()=>[s(T,{class:"text-subtitle1"},{default:n(()=>[h(m(o.designation),1)]),_:2},1024),s(T,{caption:""},{default:n(()=>[s(se,{color:o.a_payer===0?"positive":l.mois>Q(c)?"blue-grey":"negative",icon:o.a_payer===0?"check_circle":"pending",size:"sm",outline:""},{default:n(()=>[h(m(o.a_payer===0?"Payé":`${p.formatPrice(o.a_payer)} DH`),1)]),_:2},1032,["color","icon"])]),_:2},1024)]),_:2},1024),o.a_payer>0?(r(),y(b,{key:0,side:""},{default:n(()=>[s(W,{disable:p.isCheckboxDisabled(o,l.mois,p.eleve.ideleve),modelValue:o.selected,"onUpdate:modelValue":[Y=>o.selected=Y,U],color:"primary"},null,8,["disable","modelValue","onUpdate:modelValue"])]),_:2},1024)):x("",!0)]),_:2},1032,["class"]))),128))]),_:2},1024)]),_:2},1032,["label","caption","default-opened","icon","header-class"]))),128))]),_:1})]),_:1})]),_:1},8,["modelValue"])],64))}},Le={class:"bg-white text-black q-pa-sm flex flex-center"},Me={class:""},Ie={class:"text-h6 text-primary"},Fe={key:0,class:"transaction-status q-mb-md bg-white"},Ne={key:0,class:"text-subtitle1 q-pa-md flex items-center status-container bg-green-1 rounded-borders"},Be={key:1,class:"text-subtitle1 q-pa-md flex items-center status-container bg-red-1 rounded-borders"},Oe={key:2,class:"text-subtitle1 q-pa-md flex items-center status-container bg-orange-1 rounded-borders"},He={key:3,class:"text-subtitle1 q-pa-md flex items-center status-container bg-blue-1 rounded-borders"},$e={class:"row q-col-gutter-md"},je=["src"],Ge={class:"text-h6"},We={class:"row items-center"},Ye={class:"text-subtitle1"},Ze={class:"row items-center q-mt-sm text-grey-7"},Je={class:"row items-center"},Ke={key:1,class:"row items-center"},Re={class:"text-subtitle1 text-weight-medium text-primary"},Xe={class:"row items-center justify-between q-mb-md"},et={class:"column"},tt={class:"text-h6 text-primary"},at={class:"column items-end"},st={class:"text-subtitle1"},nt={key:1,class:"text-center q-pa-xl column items-center"},lt={__name:"Index",setup(p){const w=le(),c=ve(),{setTitle:U}=Ve(),q=N(!1),g=D(()=>c.getters["user/current"]?.eleve||null||null),l=N([]),o=N(null);(()=>{if(!g.value)return[];let a=[{ideleve:g.value.idpers,nom:g.value.nom,prenom:g.value.prenom,photo:ee(g.value),activeTab:"monthly"}];return(c.getters["user/config"]?.meta?.eleves).forEach(u=>{u.idpers!=g.value?.idpers&&a.push({ideleve:u.idpers,nom:u.nom,prenom:u.prenom,photo:ee(u),activeTab:"monthly"})}),l.value=a})();const A=D(()=>c.getters["pay/payments"]),_=D(()=>{const a=[];return A.value.forEach(e=>{let u=l.value.find(t=>t.ideleve===e.ideleve);e.service_annuel?.forEach(t=>{t.selected&&t.a_payer>0&&a.push({...t,mois:null,eleve:u})}),e.service_mensuel?.forEach(t=>{t.services.forEach(i=>{i.selected&&i.a_payer>0&&a.push({...i,mois:t.mois,eleve:u})})})}),a}),Z=D(()=>_.value.length>0),L=D(()=>_.value.reduce((a,e)=>a+Number(e.a_payer),0)),M=D(()=>c.getters["pay/transaction"]),P=a=>Number(a).toLocaleString("fr-FR",{minimumFractionDigits:2,maximumFractionDigits:2}),J=a=>{if(isNaN(a))return"";const e=Math.floor(a/100),u=a%100;return new Date(e,u-1).toLocaleDateString("fr-FR",{month:"long",year:"numeric"})},E=a=>A.value.find(e=>e.ideleve===a),H=(a,e,u)=>{if(a.a_payer===0)return!0;const t=E(u);if(!t||a.type_paiement!=="MENSUELLE")return!1;const i=t.service_mensuel.findIndex(f=>f.mois===e);if(i===-1)return!1;if(a.selected){for(let f=i+1;f<t.service_mensuel.length;f++)if(t.service_mensuel[f].services.find(j=>j.id===a.id)?.selected)return!0;return!1}else{for(let f=0;f<i;f++){const F=t.service_mensuel[f].services.find(j=>j.id===a.id);if(F&&!F.selected&&F.a_payer>0)return!0}return!1}},re=()=>{w.notify({message:`Paiement de ${P(L.value)} DH initié`,color:"secondary",position:"top"}),de()},ie=a=>{const e=A.value.find(t=>t.ideleve===a.eleve.ideleve);if(console.log(e),e)if(a.type_paiement==="ANNUELLE"){const t=e.service_annuel.find(i=>i.id===a.id);t&&(t.selected=!1),console.log(a,t)}else e.service_mensuel.forEach(t=>{if(t.mois===a.mois){const i=t.services.find(f=>f.id===a.id);i&&(i.selected=!1),console.log(a,t,i)}console.log(a,t)});const u=_.value.findIndex(t=>t.id===a.id&&t.mois===a.mois&&t.eleve.ideleve===a.eleve.ideleve);u!==-1&&_.value.splice(u,1),_.value.length===0&&(q.value=!1)};async function de(){if(console.log("initierPaiement",_.value),await c.dispatch("pay/createTransaction",_.value),M.value.payServiceResponse&&M.value.payServiceResponse.success){const a=Se(M.value.payServiceResponse.payment_url,!0);a&&(a.addEventListener("message",e=>{e?.data?.message?.name!="WINDOW_SIZE"&&(console.log(e.data.message),e.data.message?.name&&e.data.message.name==="PURCHASE_STATUS"&&(o.value=e.data.message,ue(M.value)),(e.data.message.close||e.data.message==="payment_completed")&&a.close())}),a.addEventListener("loaderror",e=>{console.log("Error "+e)}),a.addEventListener("exit",()=>{console.log("inAppBrowser exit event"),a.close()}))}}async function ue(a){o.value.success?(await c.dispatch("pay/setTransactionStatus",{reference:a.transaction.reference,status:"success"}),w.notify({message:"Transaction effectuée avec succès",color:"positive"}),$()):o.value.pending?(await c.dispatch("pay/setTransactionStatus",{reference:a.transaction.reference,status:"pending"}),w.notify({message:"Traitement de la transaction en cours...",color:"warning"})):!o.value.success&&(o.value.hasOwnProperty("success")||o.value.hasOwnProperty("close"))&&(await c.dispatch("pay/setTransactionStatus",{reference:a.transaction.reference,status:"failed"}),w.notify({message:"Échec de la transaction",color:"negative"})),q.value=!1}async function $(){try{return await c.dispatch("pay/getPayments",{eleves:l.value.map(e=>e.ideleve)})}catch(a){console.error(a),w.notify({message:"Erreur lors du chargement des données",color:"negative"})}}ye(async()=>{U("Paiements"),await $()});const I=N({}),ce=a=>{const e=E(a);return e?e.service_annuel?.some(t=>t.a_payer>0)?!0:e.service_mensuel?.some(t=>t.services.some(i=>i.a_payer>0)):!1},me=a=>{const e=I.value[a],u=E(a);u&&(u.service_annuel?.forEach(t=>{t.a_payer>0&&(t.selected=e)}),u.service_mensuel?.forEach(t=>{t.services.forEach(i=>{i.a_payer>0&&(i.selected=e)})}))};return ge(_,()=>{l.value.forEach(a=>{const e=E(a.ideleve);if(!e)return;let u=!0,t=!1;e.service_annuel?.forEach(i=>{i.a_payer>0&&(t=!0,i.selected||(u=!1))}),e.service_mensuel?.forEach(i=>{i.services.forEach(f=>{f.a_payer>0&&!H(f,i.mois,a.ideleve)&&(t=!0,f.selected||(u=!1))})}),t&&(I.value[a.ideleve]=u)})},{deep:!0}),(a,e)=>{const u=_e("ep-footer");return r(),y(we,{class:"bg-grey-2 page-content"},{default:n(()=>[A.value?.length?(r(),v(k,{key:0},[d("div",Le,[d("div",Me,[e[2]||(e[2]=d("div",{class:"text-subtitle2 text-grey-7"},"Total à payer",-1)),d("div",Ie,m(P(L.value))+" DH",1)])]),d("div",null,[o.value&&(o.value.hasOwnProperty("success")||o.value.hasOwnProperty("close"))?(r(),v("div",Fe,[o.value.success?(r(),v("div",Ne,[s(C,{size:"42px",class:"shadow-3 bg-green text-white q-mr-md"},{default:n(()=>[s(S,{name:"check_circle",size:"28px"})]),_:1}),e[3]||(e[3]=d("span",{class:"text-green text-h6"},"Transaction effectuée avec succès",-1))])):!o.value.pending&&o.value.hasOwnProperty("success")?(r(),v("div",Be,[s(C,{size:"42px",class:"shadow-3 bg-red text-white q-mr-md"},{default:n(()=>[s(S,{name:"error_outline",size:"28px"})]),_:1}),e[4]||(e[4]=d("span",{class:"text-red text-h6"},"Échec de la transaction",-1))])):o.value.pending?(r(),v("div",He,[s(C,{size:"42px",class:"shadow-3 bg-blue text-white q-mr-md"},{default:n(()=>[s(S,{name:"schedule",size:"28px"})]),_:1}),e[6]||(e[6]=d("span",{class:"text-blue text-h6"},"Traitement de la transaction en cours...",-1))])):(r(),v("div",Oe,[s(C,{size:"42px",class:"shadow-3 bg-orange text-white q-mr-md"},{default:n(()=>[s(S,{name:"cancel",size:"28px"})]),_:1}),e[5]||(e[5]=d("span",{class:"text-orange text-h6"},"Transaction annulée",-1))]))])):x("",!0),d("div",$e,[(r(!0),v(k,null,z(l.value,t=>(r(),v("div",{key:t.ideleve,class:"col-12"},[s(R,{flat:"",class:"student-card q-mb-md"},{default:n(()=>[s(O,{class:"q-pa-md"},{default:n(()=>[s(b,{avatar:""},{default:n(()=>[s(C,{size:"52px",class:"shadow-2"},{default:n(()=>[d("img",{src:t.photo||"https://cdn.quasar.dev/img/boy-avatar.png"},null,8,je)]),_:2},1024)]),_:2},1024),s(b,null,{default:n(()=>[s(T,{class:"text-h6"},{default:n(()=>[h(m(t.nom)+" "+m(t.prenom),1)]),_:2},1024)]),_:2},1024),s(b,{side:""},{default:n(()=>[ce(t.ideleve)?(r(),y(W,{key:0,modelValue:I.value[t.ideleve],"onUpdate:modelValue":[i=>I.value[t.ideleve]=i,i=>me(t.ideleve)],color:"primary"},{default:n(()=>[s(G,null,{default:n(()=>e[7]||(e[7]=[h("Tout sélectionner")])),_:1})]),_:2},1032,["modelValue","onUpdate:modelValue"])):x("",!0)]),_:2},1024)]),_:2},1024),E(t.ideleve)?(r(),y(Ae,{key:0,paiement:E(t.ideleve),eleve:t,isCheckboxDisabled:H,formatPrice:P,formatMois:J},null,8,["paiement","eleve"])):x("",!0)]),_:2},1024)]))),128))])]),s(he,{modelValue:q.value,"onUpdate:modelValue":e[0]||(e[0]=t=>q.value=t),position:"bottom",maximized:Q(w).platform.is.mobile,persistent:""},{default:n(()=>[s(R,{class:"payment-dialog"},{default:n(()=>[s(ke,{class:"bg-primary text-white"},{default:n(()=>[s(Qe,null,{default:n(()=>[e[8]||(e[8]=d("div",{class:"text-subtitle1"},"Résumé des paiements",-1)),d("div",Ge,m(P(L.value))+" DH",1)]),_:1}),X((r(),y(V,{flat:"",round:"",dense:"",icon:"close"},{default:n(()=>[s(G,null,{default:n(()=>e[9]||(e[9]=[h("Fermer")])),_:1})]),_:1})),[[te]])]),_:1}),s(qe,{style:{height:"calc(100vh - 300px)","max-height":"600px"}},{default:n(()=>[s(B,{padding:"",separator:""},{default:n(()=>[(r(!0),v(k,null,z(_.value,t=>(r(),y(O,{key:t.id,class:"q-py-md service-item"},{default:n(()=>[s(b,null,{default:n(()=>[d("div",We,[s(S,{name:"school",size:"sm",class:"q-mr-sm",color:"primary"}),d("div",Ye,m(t.designation),1)]),d("div",Ze,[d("div",Je,[s(S,{name:"person",size:"xs",class:"q-mr-xs"}),h(" "+m(t.eleve.nom)+" "+m(t.eleve.prenom),1)]),t.mois?(r(),y(oe,{key:0,vertical:"",inset:"",spaced:"sm"})):x("",!0),t.mois?(r(),v("div",Ke,[s(S,{name:"event",size:"xs",class:"q-mr-xs"}),h(" "+m(J(t.mois)),1)])):x("",!0)])]),_:2},1024),s(b,{side:""},{default:n(()=>[d("div",Re,m(P(t.a_payer))+" DH ",1)]),_:2},1024),s(b,{side:""},{default:n(()=>[s(V,{flat:"",round:"",dense:"",color:"grey-6",icon:"delete",disable:H(t,t?.mois,t.eleve.ideleve),onClick:i=>ie(t)},{default:n(()=>[s(G,null,{default:n(()=>e[10]||(e[10]=[h("Retirer du panier")])),_:1})]),_:2},1032,["disable","onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),s(xe,{class:"bg-grey-2"},{default:n(()=>[d("div",Xe,[d("div",et,[e[11]||(e[11]=d("div",{class:"text-caption text-grey-7"},"Total à payer",-1)),d("div",tt,m(P(L.value))+" DH",1)]),d("div",at,[e[12]||(e[12]=d("div",{class:"text-caption text-grey-7"},"Services sélectionnés",-1)),d("div",st,m(_.value.length),1)])])]),_:1}),s(be,{align:"right",class:"bg-white q-pa-md"},{default:n(()=>[X(s(V,{flat:"",label:o.value?"Fermer":"Annuler",color:"grey-7"},null,8,["label"]),[[te]]),s(V,{disable:o.value&&o.value.hasOwnProperty("name"),unelevated:"",class:"q-ml-sm",color:"primary","icon-right":"icon_credit_card",label:"Payer ",onClick:re},null,8,["disable"])]),_:1}),s(Ee,{showing:Q(c).getters["pay/transactionLoading"]},{default:n(()=>[s(Pe,{size:"50px",color:"primary"})]),_:1},8,["showing"])]),_:1})]),_:1},8,["modelValue","maximized"]),Z.value?(r(),y(u,{key:0,to:"#footer-portal"},{default:n(()=>[s(V,{flat:"",label:"Payer","icon-right":"icon_credit_card",onClick:e[1]||(e[1]=t=>{q.value=!0,o.value=null}),padding:"sm lg"},{default:n(()=>[Z.value?(r(),y(De,{key:0,color:"primary",floating:""},{default:n(()=>[h(m(_.value.length),1)]),_:1})):x("",!0)]),_:1})]),_:1})):x("",!0)],64)):(r(),v("div",nt,[s(S,{name:"check_circle",color:"positive",size:"64px",class:"q-mb-md"}),e[13]||(e[13]=d("div",{class:"text-h5 text-weight-medium q-mb-sm"},"Aucun paiement à effectuer",-1)),e[14]||(e[14]=d("div",{class:"text-grey-7"},"Tous vos paiements sont à jour",-1)),s(V,{onClick:$,flat:"",color:"primary",label:"Actualiser",icon:"refresh",class:"q-mt-lg"})]))]),_:1})}}},At=fe(lt,[["__scopeId","data-v-d5d11bf7"]]);export{At as default};
